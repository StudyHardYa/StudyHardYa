<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>HashMap源码讲解</title>
      <link href="/2022/07/01/HashMap%E6%BA%90%E7%A0%81%E8%AE%B2%E8%A7%A3/"/>
      <url>/2022/07/01/HashMap%E6%BA%90%E7%A0%81%E8%AE%B2%E8%A7%A3/</url>
      
        <content type="html"><![CDATA[<h1 id="HashMap源码："><a href="#HashMap源码：" class="headerlink" title="HashMap源码："></a>HashMap源码：</h1><h2 id="结论："><a href="#结论：" class="headerlink" title="结论："></a>结论：</h2><p>先说下结论，有的小伙伴可能没有心思看看完！</p><p><strong>数据结构：</strong></p><p>加载因子为0.75f</p><p>默认初始容量为16</p><p>扩容为原来的1倍  &lt;&lt;1  临界点也会随着增加1倍 &lt;&lt;1</p><p>依靠每次在数组中添加成功都会自增的size与临界点做比较，是否需要扩容</p><p>如果添加key相同的键值对会进行value的替换，并返回替换掉的value值</p><p>链表未大于等于8位时：</p><p>​    数组加链表，其实就是一个Node类型的数组，而而每个下表都是Node类，Node它的结构为链表的形式，记录下一个、本身键值对，为<strong>单向链表</strong></p><p>转换红黑树条件：</p><p>​    数组长度大于64，并且链表长度大于8才会进行转换</p><p>​    </p><p>与HashTable的区别：</p><p>JDK1.8 ：</p><p>HashMap在添加时进行数组实例化，HashTable实例化时就会进行数组实例化</p><p>HashTable不会转换为红黑树</p><p>线程安全性不同。HashMap线程不安全；Hashtable 中的方法是Synchronize的。<br>key、value是否允许null。HashMap的key和value都是可以是null，key只允许一个null；Hashtable的key和value都不可为null。<br>迭代器不同。HashMap的Iterator是fail-fast迭代器；Hashtable还使用了enumerator迭代器。<br>hash的计算方式不同。HashMap计算了hash值；Hashtable使用了key的hashCode方法。<br>默认初始大小和扩容方式不同。HashMap默认初始大小16，容量必须是2的整数次幂，扩容时将容量变为原来的2倍；Hashtable默认初始大小11，扩容时将容量变为原来的2倍加1。<br>是否有contains方法。HashMap没有contains方法；Hashtable包含contains方法，类似于containsValue。<br>父类不同。HashMap继承自AbstractMap；Hashtable继承自Dictionary。</p><h2 id="HashMap初始化："><a href="#HashMap初始化：" class="headerlink" title="HashMap初始化："></a>HashMap初始化：</h2><p><strong>HashMap有着多个重载的构造方法，接下来 一 一来看看分别有着什么作用！！</strong></p><h3 id="无参构造："><a href="#无参构造：" class="headerlink" title="无参构造："></a>无参构造：</h3><p>无参构造中可以看出我们没有做其他的初始化，只是赋予了一个默认加载因子</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//常量，加载因子</span><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">float</span> DEFAULT_LOAD_FACTOR <span class="token operator">=</span> <span class="token number">0.75f</span><span class="token punctuation">;</span><span class="token comment">//真正使用在hashMap中的加载因子</span><span class="token keyword">final</span> <span class="token keyword">float</span> loadFactor<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>loadFactor <span class="token operator">=</span> DEFAULT_LOAD_FACTOR<span class="token punctuation">;</span> <span class="token comment">// 所有字段均为默认值</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="有参构造："><a href="#有参构造：" class="headerlink" title="有参构造："></a>有参构造：</h3><h4 id="设置默认容量构造器："><a href="#设置默认容量构造器：" class="headerlink" title="设置默认容量构造器："></a>设置默认容量构造器：</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//常量，加载因子</span><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">float</span> DEFAULT_LOAD_FACTOR <span class="token operator">=</span> <span class="token number">0.75f</span><span class="token punctuation">;</span><span class="token comment">//最大容量   1,073,741,824</span><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> MAXIMUM_CAPACITY <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">30</span><span class="token punctuation">;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//可设置初始容量</span><span class="token keyword">public</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token keyword">int</span> initialCapacity<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment">//调用其他构造方法</span>    <span class="token keyword">this</span><span class="token punctuation">(</span>initialCapacity<span class="token punctuation">,</span> DEFAULT_LOAD_FACTOR<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>调用的构造方法</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"> <span class="token comment">//真正实例化的构造器   参数：1、默认容量   2、加载因子</span> <span class="token keyword">public</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token keyword">int</span> initialCapacity<span class="token punctuation">,</span> <span class="token keyword">float</span> loadFactor<span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token comment">//判断当前设置的默认容量是否为0 ，为0抛出异常</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>initialCapacity <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"Illegal initial capacity: "</span> <span class="token operator">+</span>                                               initialCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//判断是否超出最大容量，如果超出就赋予最大容量</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>initialCapacity <span class="token operator">&gt;</span> MAXIMUM_CAPACITY<span class="token punctuation">)</span>            initialCapacity <span class="token operator">=</span> MAXIMUM_CAPACITY<span class="token punctuation">;</span>     <span class="token comment">//判断当前加载因子是否小于等于0 Float.isNaN这个方法目前还不是很清楚</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>loadFactor <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token class-name">Float</span><span class="token punctuation">.</span><span class="token function">isNaN</span><span class="token punctuation">(</span>loadFactor<span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"Illegal load factor: "</span> <span class="token operator">+</span>                                               loadFactor<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>loadFactor <span class="token operator">=</span> loadFactor<span class="token punctuation">;</span>  <span class="token comment">//为加载因素赋值</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>threshold <span class="token operator">=</span> <span class="token function">tableSizeFor</span><span class="token punctuation">(</span>initialCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//根据当前容量得出下次需要扩容的临界点</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="Put："><a href="#Put：" class="headerlink" title="Put："></a>Put：</h2><p>在初始化我们可以看出都没有进行数据结构的创建，其实HashMap使用的是懒加载默认，但我们真正要存储时再进行创建</p><h3 id="添加方法："><a href="#添加方法：" class="headerlink" title="添加方法："></a>添加方法：</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">V</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">K</span> key<span class="token punctuation">,</span> <span class="token class-name">V</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token keyword">return</span> <span class="token function">putVal</span><span class="token punctuation">(</span><span class="token function">hash</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//更加key获取hash值</span><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">hash</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">int</span> h<span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token punctuation">(</span>key <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> <span class="token punctuation">(</span>h <span class="token operator">=</span> key<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span>h <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="第一次添加："><a href="#第一次添加：" class="headerlink" title="第一次添加："></a>第一次添加：</h4><h5 id="主方法："><a href="#主方法：" class="headerlink" title="主方法："></a>主方法：</h5><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">transient</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> table<span class="token punctuation">;</span><span class="token comment">//执行方法</span><span class="token keyword">final</span> <span class="token class-name">V</span> <span class="token function">putVal</span><span class="token punctuation">(</span><span class="token keyword">int</span> hash<span class="token punctuation">,</span> <span class="token class-name">K</span> key<span class="token punctuation">,</span> <span class="token class-name">V</span> value<span class="token punctuation">,</span> <span class="token keyword">boolean</span> onlyIfAbsent<span class="token punctuation">,</span>                   <span class="token keyword">boolean</span> evict<span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token comment">// 1、 tab为当前map数组，p为当前节点，n为数组长度，i为当键值对在数值的下表位置</span>        <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> tab<span class="token punctuation">;</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> p<span class="token punctuation">;</span> <span class="token keyword">int</span> n<span class="token punctuation">,</span> i<span class="token punctuation">;</span>          <span class="token comment">//2、 tab为空 n为0  此处判断的同时也为我们的tab指向了table  n值为0</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>tab <span class="token operator">=</span> table<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token punctuation">(</span>n <span class="token operator">=</span> tab<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>            <span class="token comment">//3、调用初始化方法  返回新map数组赋值为局部tab，并获取容量大小赋值给局部n</span>            n <span class="token operator">=</span> <span class="token punctuation">(</span>tab <span class="token operator">=</span> <span class="token function">resize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>    <span class="token comment">// 4、获取当前数组长度减一 并使用 ‘与’ 逻辑运算符获取 数组下表位置赋值给i 并获取当前下表下的内容赋值给p，判断是否为空</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>p <span class="token operator">=</span> tab<span class="token punctuation">[</span>i <span class="token operator">=</span> <span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> hash<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>            <span class="token comment">//5、没有内容就进行创建一个node（非树型）节点，放入当前下标中</span>            tab<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">newNode</span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> e<span class="token punctuation">;</span> <span class="token class-name">K</span> k<span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>hash <span class="token operator">==</span> hash <span class="token operator">&amp;&amp;</span>                <span class="token punctuation">(</span><span class="token punctuation">(</span>k <span class="token operator">=</span> p<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token operator">==</span> key <span class="token operator">||</span> <span class="token punctuation">(</span>key <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> key<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                e <span class="token operator">=</span> p<span class="token punctuation">;</span>            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token keyword">instanceof</span> <span class="token class-name">TreeNode</span><span class="token punctuation">)</span>                e <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">TreeNode</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>p<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">putTreeVal</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> tab<span class="token punctuation">,</span> hash<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">else</span> <span class="token punctuation">{</span>                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> binCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token operator">++</span>binCount<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>e <span class="token operator">=</span> p<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                        p<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token function">newNode</span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token keyword">if</span> <span class="token punctuation">(</span>binCount <span class="token operator">&gt;=</span> TREEIFY_THRESHOLD <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// -1 for 1st</span>                            <span class="token function">treeifyBin</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> hash<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token keyword">break</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>hash <span class="token operator">==</span> hash <span class="token operator">&amp;&amp;</span>                        <span class="token punctuation">(</span><span class="token punctuation">(</span>k <span class="token operator">=</span> e<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token operator">==</span> key <span class="token operator">||</span> <span class="token punctuation">(</span>key <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> key<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                        <span class="token keyword">break</span><span class="token punctuation">;</span>                    p <span class="token operator">=</span> e<span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// existing mapping for key</span>                <span class="token class-name">V</span> oldValue <span class="token operator">=</span> e<span class="token punctuation">.</span>value<span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>onlyIfAbsent <span class="token operator">||</span> oldValue <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>                    e<span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>                <span class="token function">afterNodeAccess</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> oldValue<span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token comment">//6、modCount进行计数  这个便利店作用显目有解释</span>        <span class="token operator">++</span>modCount<span class="token punctuation">;</span>    <span class="token comment">//7、size++ 判断当前加入数组中的数量是否大于临界值</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>size <span class="token operator">&gt;</span> threshold<span class="token punctuation">)</span>            <span class="token function">resize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">afterNodeInsertion</span><span class="token punctuation">(</span>evict<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="HashMap初始化及调整大小方法："><a href="#HashMap初始化及调整大小方法：" class="headerlink" title="HashMap初始化及调整大小方法："></a><strong>HashMap初始化及调整大小方法：</strong></h5><p>​    这个方法主要是为了当我们数组为null没有进行初始化时进行初始化，并设置临界值，</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">final</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">resize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> oldTab <span class="token operator">=</span> table<span class="token punctuation">;</span> <span class="token comment">//3.1、hashMap数组</span>    <span class="token keyword">int</span> oldCap <span class="token operator">=</span> <span class="token punctuation">(</span>oldTab <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> oldTab<span class="token punctuation">.</span>length<span class="token punctuation">;</span>  <span class="token comment">//3.2、旧数组大小，如果数组为空则为0 ，不为空则为数组大小</span>    <span class="token keyword">int</span> oldThr <span class="token operator">=</span> threshold<span class="token punctuation">;</span> <span class="token comment">//3.3、临界点 旧</span>    <span class="token keyword">int</span> newCap<span class="token punctuation">,</span> newThr <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token comment">//3.4、newCap 数组大小 新    newThr：临界点 新</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldCap <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//3.5、判断旧数组大小是否大于0 第一次不会进入</span>        <span class="token comment">//判断旧容量是否为最大值了</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>oldCap <span class="token operator">&gt;=</span> MAXIMUM_CAPACITY<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment">//如果数值为最大值了就将最大值为临界点</span>            threshold <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">;</span>            <span class="token comment">//并返回就数组回去，不进行扩容</span>            <span class="token keyword">return</span> oldTab<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment">//进行扩容参数初始化，新长度为原来的1倍，新临界点也为原来的1倍</span>        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>newCap <span class="token operator">=</span> oldCap <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> MAXIMUM_CAPACITY <span class="token operator">&amp;&amp;</span>                 oldCap <span class="token operator">&gt;=</span> DEFAULT_INITIAL_CAPACITY<span class="token punctuation">)</span>            newThr <span class="token operator">=</span> oldThr <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// double threshold</span>    <span class="token punctuation">}</span>    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldThr <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">//3.6、判断临界值 旧 是否大于0 第一次不会进入</span>        newCap <span class="token operator">=</span> oldThr<span class="token punctuation">;</span>    <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token comment">//3.7、进行基础数据初始化</span>        newCap <span class="token operator">=</span> DEFAULT_INITIAL_CAPACITY<span class="token punctuation">;</span> <span class="token comment">//将默认容量大小 16 赋予新数组大小</span>        <span class="token comment">//新数组容量与加载因子进行计算得出 临界点 并赋值为临界点局部变量 新</span>        newThr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>DEFAULT_LOAD_FACTOR <span class="token operator">*</span> DEFAULT_INITIAL_CAPACITY<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">//3.8判断临界值 新 是否为0  一般情况下不会进入</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>newThr <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">float</span> ft <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>newCap <span class="token operator">*</span> loadFactor<span class="token punctuation">;</span>        newThr <span class="token operator">=</span> <span class="token punctuation">(</span>newCap <span class="token operator">&lt;</span> MAXIMUM_CAPACITY <span class="token operator">&amp;&amp;</span> ft <span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>MAXIMUM_CAPACITY <span class="token operator">?</span>                  <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>ft <span class="token operator">:</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">//3.9、将局部临界点赋值给全局临界点</span>    threshold <span class="token operator">=</span> newThr<span class="token punctuation">;</span>         <span class="token comment">//3.10、初始化新map数组 长度为局部newCap大小 </span>        <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> newTab <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">[</span>newCap<span class="token punctuation">]</span><span class="token punctuation">;</span>     <span class="token comment">//3.11、将新map数组</span>    table <span class="token operator">=</span> newTab<span class="token punctuation">;</span>     <span class="token comment">//3.12、判断旧map数组是否为空 第一次不会进入</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldTab <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> oldCap<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> e<span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>e <span class="token operator">=</span> oldTab<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                oldTab<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>next <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>                    newTab<span class="token punctuation">[</span>e<span class="token punctuation">.</span>hash <span class="token operator">&amp;</span> <span class="token punctuation">(</span>newCap <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> e<span class="token punctuation">;</span>                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token keyword">instanceof</span> <span class="token class-name">TreeNode</span><span class="token punctuation">)</span>                    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">TreeNode</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>e<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> newTab<span class="token punctuation">,</span> j<span class="token punctuation">,</span> oldCap<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// preserve order</span>                    <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> loHead <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> loTail <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>                    <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> hiHead <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> hiTail <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>                    <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> next<span class="token punctuation">;</span>                    <span class="token keyword">do</span> <span class="token punctuation">{</span>                        next <span class="token operator">=</span> e<span class="token punctuation">.</span>next<span class="token punctuation">;</span>                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>hash <span class="token operator">&amp;</span> oldCap<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                            <span class="token keyword">if</span> <span class="token punctuation">(</span>loTail <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>                                loHead <span class="token operator">=</span> e<span class="token punctuation">;</span>                            <span class="token keyword">else</span>                                loTail<span class="token punctuation">.</span>next <span class="token operator">=</span> e<span class="token punctuation">;</span>                            loTail <span class="token operator">=</span> e<span class="token punctuation">;</span>                        <span class="token punctuation">}</span>                        <span class="token keyword">else</span> <span class="token punctuation">{</span>                            <span class="token keyword">if</span> <span class="token punctuation">(</span>hiTail <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>                                hiHead <span class="token operator">=</span> e<span class="token punctuation">;</span>                            <span class="token keyword">else</span>                                hiTail<span class="token punctuation">.</span>next <span class="token operator">=</span> e<span class="token punctuation">;</span>                            hiTail <span class="token operator">=</span> e<span class="token punctuation">;</span>                        <span class="token punctuation">}</span>                    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>e <span class="token operator">=</span> next<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>loTail <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                        loTail<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>                        newTab<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> loHead<span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>hiTail <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                        hiTail<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>                        newTab<span class="token punctuation">[</span>j <span class="token operator">+</span> oldCap<span class="token punctuation">]</span> <span class="token operator">=</span> hiHead<span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment">//返回map数组 新</span>    <span class="token keyword">return</span> newTab<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="创建节点方法："><a href="#创建节点方法：" class="headerlink" title="创建节点方法："></a>创建节点方法：</h5><p>​    创建非树型节点</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token function">newNode</span><span class="token punctuation">(</span><span class="token keyword">int</span> hash<span class="token punctuation">,</span> <span class="token class-name">K</span> key<span class="token punctuation">,</span> <span class="token class-name">V</span> value<span class="token punctuation">,</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>       <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h5 id="modCount作用："><a href="#modCount作用：" class="headerlink" title="modCount作用："></a>modCount作用：</h5><p>Fail-Fast 机制<br>我们知道 java.util.HashMap 不是线程安全的，因此如果在使用迭代器的过程中有其他线程修改了map，那么将抛出ConcurrentModificationException，这就是所谓fail-fast策略。这一策略在源码中的实现是通过 modCount 域，modCount 顾名思义就是修改次数，对HashMap 内容的修改都将增加这个值，那么在迭代器初始化过程中会将这个值赋给迭代器的 expectedModCount。在迭代过程中，判断 modCount 跟 expectedModCount 是否相等，如果不相等就表示已经有其他线程修改了 Map：注意到 modCount 声明为 volatile，保证线程之间修改的可见性。</p><h4 id="二次添加："><a href="#二次添加：" class="headerlink" title="二次添加："></a>二次添加：</h4><h5 id="主方法：-1"><a href="#主方法：-1" class="headerlink" title="主方法："></a>主方法：</h5><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">transient</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> table<span class="token punctuation">;</span><span class="token comment">//执行方法</span><span class="token keyword">final</span> <span class="token class-name">V</span> <span class="token function">putVal</span><span class="token punctuation">(</span><span class="token keyword">int</span> hash<span class="token punctuation">,</span> <span class="token class-name">K</span> key<span class="token punctuation">,</span> <span class="token class-name">V</span> value<span class="token punctuation">,</span> <span class="token keyword">boolean</span> onlyIfAbsent<span class="token punctuation">,</span>                   <span class="token keyword">boolean</span> evict<span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token comment">// 1、 tab为当前map数组，p为当前节点，n为数组长度，i为当键值对在数值的下表位置</span>        <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> tab<span class="token punctuation">;</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> p<span class="token punctuation">;</span> <span class="token keyword">int</span> n<span class="token punctuation">,</span> i<span class="token punctuation">;</span>          <span class="token comment">//2、此处判断的同时也为我们的tab指向了table  n值为tab的长度 由于不为空 不进入该方法</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>tab <span class="token operator">=</span> table<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token punctuation">(</span>n <span class="token operator">=</span> tab<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>            n <span class="token operator">=</span> <span class="token punctuation">(</span>tab <span class="token operator">=</span> <span class="token function">resize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>    <span class="token comment">// 3、获取当前数组长度减一 并使用 ‘与’ 逻辑运算符获取 数组下表位置赋值给i 并获取当前下表下的内容赋值给p，判断是否为空</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>p <span class="token operator">=</span> tab<span class="token punctuation">[</span>i <span class="token operator">=</span> <span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> hash<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>            <span class="token comment">//4、没有内容就进行创建一个node（非树型）节点，放入当前下标中</span>            tab<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">newNode</span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> e<span class="token punctuation">;</span> <span class="token class-name">K</span> k<span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>hash <span class="token operator">==</span> hash <span class="token operator">&amp;&amp;</span>                <span class="token punctuation">(</span><span class="token punctuation">(</span>k <span class="token operator">=</span> p<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token operator">==</span> key <span class="token operator">||</span> <span class="token punctuation">(</span>key <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> key<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                e <span class="token operator">=</span> p<span class="token punctuation">;</span>            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token keyword">instanceof</span> <span class="token class-name">TreeNode</span><span class="token punctuation">)</span>                e <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">TreeNode</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>p<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">putTreeVal</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> tab<span class="token punctuation">,</span> hash<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">else</span> <span class="token punctuation">{</span>                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> binCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token operator">++</span>binCount<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>e <span class="token operator">=</span> p<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                        p<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token function">newNode</span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token keyword">if</span> <span class="token punctuation">(</span>binCount <span class="token operator">&gt;=</span> TREEIFY_THRESHOLD <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// -1 for 1st</span>                            <span class="token function">treeifyBin</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> hash<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token keyword">break</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>hash <span class="token operator">==</span> hash <span class="token operator">&amp;&amp;</span>                        <span class="token punctuation">(</span><span class="token punctuation">(</span>k <span class="token operator">=</span> e<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token operator">==</span> key <span class="token operator">||</span> <span class="token punctuation">(</span>key <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> key<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                        <span class="token keyword">break</span><span class="token punctuation">;</span>                    p <span class="token operator">=</span> e<span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// existing mapping for key</span>                <span class="token class-name">V</span> oldValue <span class="token operator">=</span> e<span class="token punctuation">.</span>value<span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>onlyIfAbsent <span class="token operator">||</span> oldValue <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>                    e<span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>                <span class="token function">afterNodeAccess</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> oldValue<span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token comment">//5、modCount进行计数  这个便利店作用显目有解释</span>        <span class="token operator">++</span>modCount<span class="token punctuation">;</span>    <span class="token comment">//6、size++ 判断当前加入数组中的数量是否大于临界值</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>size <span class="token operator">&gt;</span> threshold<span class="token punctuation">)</span>            <span class="token function">resize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">afterNodeInsertion</span><span class="token punctuation">(</span>evict<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="添加至同一个下标中："><a href="#添加至同一个下标中：" class="headerlink" title="添加至同一个下标中："></a>添加至同一个下标中：</h4><p>此处是第二次添加，第一次添加于上面无差别</p><p><strong>注意，要两个key的Hash值相同</strong></p><h5 id="主方法：-2"><a href="#主方法：-2" class="headerlink" title="主方法："></a>主方法：</h5><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">transient</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> table<span class="token punctuation">;</span><span class="token comment">//执行方法</span><span class="token keyword">final</span> <span class="token class-name">V</span> <span class="token function">putVal</span><span class="token punctuation">(</span><span class="token keyword">int</span> hash<span class="token punctuation">,</span> <span class="token class-name">K</span> key<span class="token punctuation">,</span> <span class="token class-name">V</span> value<span class="token punctuation">,</span> <span class="token keyword">boolean</span> onlyIfAbsent<span class="token punctuation">,</span>                   <span class="token keyword">boolean</span> evict<span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token comment">// 1、 tab为当前map数组，p为当前节点（会随着循环链表成为循环到的那个结构），n为数组长度，i为当键值对在数值的下表位置</span>        <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> tab<span class="token punctuation">;</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> p<span class="token punctuation">;</span> <span class="token keyword">int</span> n<span class="token punctuation">,</span> i<span class="token punctuation">;</span>          <span class="token comment">//2、此处判断的同时也为我们的tab指向了table  n值为tab的长度 由于不为空 不进入该方法</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>tab <span class="token operator">=</span> table<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token punctuation">(</span>n <span class="token operator">=</span> tab<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>            n <span class="token operator">=</span> <span class="token punctuation">(</span>tab <span class="token operator">=</span> <span class="token function">resize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>    <span class="token comment">// 3、获取当前数组长度减一 并使用 ‘与’ 逻辑运算符获取 数组下表位置赋值给i 并获取当前下表下的内容赋值给p，判断是否为空</span>    <span class="token comment">//此次hash碰撞，下表相同，进行else</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>p <span class="token operator">=</span> tab<span class="token punctuation">[</span>i <span class="token operator">=</span> <span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> hash<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>            tab<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">newNode</span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token comment">//4、e 局部e为临时存储变量，会一直改变 ，  k为当前数值中需要对比节点的key</span>            <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> e<span class="token punctuation">;</span> <span class="token class-name">K</span> k<span class="token punctuation">;</span>             <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>hash <span class="token operator">==</span> hash <span class="token operator">&amp;&amp;</span> <span class="token comment">//5、判断当前比较的节点的hash值与本次添加的hash值是否相同</span>                <span class="token comment">//此处为k进行赋值并判断他们的值是否相同 </span>                <span class="token punctuation">(</span><span class="token punctuation">(</span>k <span class="token operator">=</span> p<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token operator">==</span> key <span class="token operator">||</span> <span class="token punctuation">(</span>key <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> key<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token comment">//如果key相同，将当前节点赋值给我们的e，下面会将我们要添加的与当前的value进行替换</span>                e <span class="token operator">=</span> p<span class="token punctuation">;</span>            <span class="token comment">//6、判断当前是否为树节点</span>            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token keyword">instanceof</span> <span class="token class-name">TreeNode</span><span class="token punctuation">)</span>                e <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">TreeNode</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>p<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">putTreeVal</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> tab<span class="token punctuation">,</span> hash<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">else</span> <span class="token punctuation">{</span>                <span class="token comment">//7、无限循环</span>                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> binCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token operator">++</span>binCount<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token comment">//8、将局部e赋值为当前数组上的节点的下一个节点，并判断是否为空</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>e <span class="token operator">=</span> p<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token comment">//9、创建一个节点赋值在当前循环到的节点的下一个节点</span>                        p<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token function">newNode</span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token comment">//10、判断当前循环长度是否大于等于8为，注意从0开始的，如果为true则转换为红黑树</span>                        <span class="token keyword">if</span> <span class="token punctuation">(</span>binCount <span class="token operator">&gt;=</span> TREEIFY_THRESHOLD <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// -1 for 1st</span>                            <span class="token function">treeifyBin</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> hash<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token keyword">break</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                    <span class="token comment">//11、判断循环中的节点是否与我们当前要添加的key相同，相同就终止循环</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>hash <span class="token operator">==</span> hash <span class="token operator">&amp;&amp;</span>                        <span class="token punctuation">(</span><span class="token punctuation">(</span>k <span class="token operator">=</span> e<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token operator">==</span> key <span class="token operator">||</span> <span class="token punctuation">(</span>key <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> key<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                        <span class="token keyword">break</span><span class="token punctuation">;</span>                    <span class="token comment">//不一样就将当前遍历到的节点赋值给p进行下一轮遍历</span>                    p <span class="token operator">=</span> e<span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>            <span class="token comment">//判断e是否为null，不为null</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// existing mapping for key</span>                <span class="token comment">//将原来的旧值赋值给我们的oldValue，等会将这个值返回给我们</span>                <span class="token class-name">V</span> oldValue <span class="token operator">=</span> e<span class="token punctuation">.</span>value<span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>onlyIfAbsent <span class="token operator">||</span> oldValue <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>                    <span class="token comment">//将我们新添加的value赋给当前节点的value进行替换</span>                    e<span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>                <span class="token function">afterNodeAccess</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">//返回旧值</span>                <span class="token keyword">return</span> oldValue<span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token comment">//5、modCount进行计数  这个便利店作用显目有解释</span>        <span class="token operator">++</span>modCount<span class="token punctuation">;</span>    <span class="token comment">//6、size++ 判断当前加入数组中的数量是否大于临界值</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>size <span class="token operator">&gt;</span> threshold<span class="token punctuation">)</span>            <span class="token function">resize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">afterNodeInsertion</span><span class="token punctuation">(</span>evict<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="链表超出8位："><a href="#链表超出8位：" class="headerlink" title="链表超出8位："></a>链表超出8位：</h4><p>多余的就不多看了，都是上面一样了，我们直接看转红黑树的过程</p><p>如果数组小于64则不会进行红黑树的转换，还是进行扩容</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">treeifyBin</span><span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> tab<span class="token punctuation">,</span> <span class="token keyword">int</span> hash<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">int</span> n<span class="token punctuation">,</span> index<span class="token punctuation">;</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> e<span class="token punctuation">;</span>    <span class="token comment">//判断数组长度是否小于64，小于则是进行扩容</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>tab <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token punctuation">(</span>n <span class="token operator">=</span> tab<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token operator">&lt;</span> MIN_TREEIFY_CAPACITY<span class="token punctuation">)</span>      <span class="token comment">//小于64于则进行扩容，还不会进行红黑树转换</span>        <span class="token function">resize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>e <span class="token operator">=</span> tab<span class="token punctuation">[</span>index <span class="token operator">=</span> <span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> hash<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">TreeNode</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> hd <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> tl <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token keyword">do</span> <span class="token punctuation">{</span>            <span class="token class-name">TreeNode</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> p <span class="token operator">=</span> <span class="token function">replacementTreeNode</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>tl <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>                hd <span class="token operator">=</span> p<span class="token punctuation">;</span>            <span class="token keyword">else</span> <span class="token punctuation">{</span>                p<span class="token punctuation">.</span>prev <span class="token operator">=</span> tl<span class="token punctuation">;</span>                tl<span class="token punctuation">.</span>next <span class="token operator">=</span> p<span class="token punctuation">;</span>            <span class="token punctuation">}</span>            tl <span class="token operator">=</span> p<span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>e <span class="token operator">=</span> e<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>tab<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> hd<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>            hd<span class="token punctuation">.</span><span class="token function">treeify</span><span class="token punctuation">(</span>tab<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Java集合框架 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 缓存 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>hibernate快速入门</title>
      <link href="/2022/06/30/Hibernate%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/"/>
      <url>/2022/06/30/Hibernate%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/</url>
      
        <content type="html"><![CDATA[<h1 id="Hibernate快速使用："><a href="#Hibernate快速使用：" class="headerlink" title="Hibernate快速使用："></a>Hibernate快速使用：</h1><p>主流ORM框架 Object Relation Mapping 对象关系映射，将面向对象映射成面向关系。</p><h2 id="如何使用："><a href="#如何使用：" class="headerlink" title="如何使用："></a>如何使用：</h2><p>1、导入相关依赖</p><p>2、创建Hibernate配置文件</p><p>3、创建实体类</p><p>4、创建实体类-关系映射文件</p><p>5、调用Hubernate API 完成操作</p><h2 id="具体操作："><a href="#具体操作：" class="headerlink" title="具体操作："></a>具体操作：</h2><h3 id="1、导入基础依赖："><a href="#1、导入基础依赖：" class="headerlink" title="1、导入基础依赖："></a>1、导入基础依赖：</h3><pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>  <span class="token comment">&lt;!-- https://mvnrepository.com/artifact/junit/junit --&gt;</span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>junit<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>junit<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>4.13.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>  <span class="token comment">&lt;!-- https://mvnrepository.com/artifact/mysql/mysql-connector-java --&gt;</span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>mysql<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>mysql-connector-java<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>5.1.32<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>  <span class="token comment">&lt;!-- https://mvnrepository.com/artifact/org.hibernate/hibernate-core --&gt;</span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.hibernate<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>hibernate-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>5.6.5.Final<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.projectlombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>lombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.18.22<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2、创建Hibernate配置文件"><a href="#2、创建Hibernate配置文件" class="headerlink" title="2、创建Hibernate配置文件"></a>2、创建Hibernate配置文件</h3><p>文件名称不能随意修改：hibernate.cfg.xml</p><pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token prolog">&lt;?xml version='1.0' encoding='utf-8'?&gt;</span><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">hibernate-configuration</span> <span class="token name">PUBLIC</span>        <span class="token string">"-//Hibernate/Hibernate Configuration DTD//EN"</span>        <span class="token string">"http://www.hibernate.org/dtd/hibernate-configuration-3.0.dtd"</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hibernate-configuration</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>session-factory</span><span class="token punctuation">&gt;</span></span><span class="token comment">&lt;!--    数据源配置    --&gt;</span>        <span class="token comment">&lt;!--使用 Hibernate 自带的连接池配置--&gt;</span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>connection.url<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>jdbc:mysql://localhost:3306/hibernate<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>hibernate.connection.username<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>root<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>hibernate.connection.password<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Admin123<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>connection.driver_class<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>com.mysql.jdbc.Driver<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span><span class="token comment">&lt;!--        &amp;lt;!&amp;ndash;  使用连接池 （内置的）  &amp;ndash;&amp;gt;--&gt;</span><span class="token comment">&lt;!--        &lt;property name="connection.pool_size"&gt;1&lt;/property&gt;--&gt;</span><span class="token comment">&lt;!--hibernate 方言  根据不同数据库有不同的方言生成对应特性的SQL语句--&gt;</span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dialect<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>org.hibernate.dialect.MySQL5Dialect<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span><span class="token comment">&lt;!--打印sql语句--&gt;</span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>show_sql<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span><span class="token comment">&lt;!--格式化sql--&gt;</span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>format_sql<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span><span class="token comment">&lt;!--   根据实体类生自动生成对应数据库     --&gt;</span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>hibernate.hbm2ddl.auto<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span><span class="token comment">&lt;!--  C3P0 连接池 --&gt;</span>        <span class="token comment">&lt;!-- 最大连接数 --&gt;</span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>hibernate.c3p0.max_size<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>20<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>        <span class="token comment">&lt;!-- 最小连接数 --&gt;</span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>hibernate.c3p0.min_size<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>5<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>        <span class="token comment">&lt;!-- 获得连接的超时时间,如果超过这个时间,会抛出异常，单位毫秒 --&gt;</span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>hibernate.c3p0.timeout<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>120<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>        <span class="token comment">&lt;!-- 最大的PreparedStatement的数量 也就是用于执行sql语句的对象，底层就是jdbc --&gt;</span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>hibernate.c3p0.max_statements<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>100<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>        <span class="token comment">&lt;!-- 每隔120秒检查连接池里的空闲连接 ，单位是秒--&gt;</span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>hibernate.c3p0.idle_test_period<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>120<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>        <span class="token comment">&lt;!-- 当连接池里面的连接用完的时候，C3P0一下获取的新的连接数 --&gt;</span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>hibernate.c3p0.acquire_increment<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>        <span class="token comment">&lt;!-- 每次都验证连接是否可用 --&gt;</span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>hibernate.c3p0.validate<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span><span class="token comment">&lt;!--    对象关系映射文件    --&gt;</span>        <span class="token comment">&lt;!-- 加载映射文件 --&gt;</span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mapping</span> <span class="token attr-name">resource</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>User.hbm.xml<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>session-factory</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>hibernate-configuration</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="其它标签属性："><a href="#其它标签属性：" class="headerlink" title="其它标签属性："></a>其它标签属性：</h4><p><strong>property：</strong></p><p>1、name为hibernate.hbm2ddl.auto：</p><p>​        此属性用于根据实体类生自动生成对应数据库有4个类型，<strong>在标签中写</strong></p><p>​        upate：动态创建表，如果表存在，则直接使用，如果表不存在，则创建</p><p>​        create：无论表是否存在，都会重新创建</p><p>​        create-drop：初始化创建表，程序结束时删除表</p><p>​        validate：校验实体类关系映射文件和数据库表是否对应，不能对应直接报错</p><h3 id="3、创建实体类"><a href="#3、创建实体类" class="headerlink" title="3、创建实体类"></a>3、创建实体类</h3><p><strong>单表：</strong></p><pre class="line-numbers language-none"><code class="language-none">@Data@ToString@NoArgsConstructor@AllArgsConstructorpublic class People {    private Integer id;    private String name;    private Double money;}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>一对多：</strong></p><p>用户类  一个用户可以对应多个订单</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Data</span><span class="token annotation punctuation">@ToString</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Customer</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token class-name">Integer</span> id<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Orders</span><span class="token punctuation">&gt;</span></span> orders<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>订单类 一个订单对应一个用户</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Data</span><span class="token annotation punctuation">@ToString</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Orders</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token class-name">Integer</span> id<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token class-name">Customer</span> customer<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>多对多：</strong></p><pre class="line-numbers language-none"><code class="language-none">@Datapublic class Account {    private Integer id;    private String name;    private Set&lt;Course&gt; course;}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-none"><code class="language-none">@Datapublic class Course {    private Integer id;    private String name;    private Set&lt;Account&gt; accounts;}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="4、实体关系映射文件"><a href="#4、实体关系映射文件" class="headerlink" title="4、实体关系映射文件"></a>4、实体关系映射文件</h3><h4 id="单表："><a href="#单表：" class="headerlink" title="单表："></a><strong>单表：</strong></h4><pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token prolog">&lt;?xml version='1.0' encoding='utf-8'?&gt;</span><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">hibernate-mapping</span> <span class="token name">PUBLIC</span>        <span class="token string">"-//Hibernate/Hibernate Mapping DTD 3.0//EN"</span>        <span class="token string">"http://www.hibernate.org/dtd/hibernate-mapping-3.0.dtd"</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hibernate-mapping</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>class</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.study.hibernate.pojo.People<span class="token punctuation">"</span></span> <span class="token attr-name">table</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>people<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>        <span class="token comment">&lt;!--   设置主键 name 类型属性  column 对应表字段    --&gt;</span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>java.lang.Integer<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>            <span class="token comment">&lt;!--  设置主键自增      --&gt;</span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>generator</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>identity<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>generator</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">&gt;</span></span>        <span class="token comment">&lt;!--    type数据类型    --&gt;</span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>name<span class="token punctuation">"</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>name<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>java.lang.String<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>money<span class="token punctuation">"</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>money<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>java.lang.Double<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>class</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>hibernate-mapping</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="一对多："><a href="#一对多：" class="headerlink" title="一对多："></a><strong>一对多：</strong></h4><p><strong>用户可以有多个订单</strong></p><pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token prolog">&lt;?xml version='1.0' encoding='utf-8'?&gt;</span><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">hibernate-mapping</span> <span class="token name">PUBLIC</span>        <span class="token string">"-//Hibernate/Hibernate Mapping DTD 3.0//EN"</span>        <span class="token string">"http://www.hibernate.org/dtd/hibernate-mapping-3.0.dtd"</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hibernate-mapping</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>class</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.study.hibernate.pojo.Customer<span class="token punctuation">"</span></span> <span class="token attr-name">table</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>customer<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>        <span class="token comment">&lt;!--   设置主键 name 类型属性  column 对应表字段    --&gt;</span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>            <span class="token comment">&lt;!--  设置主键自增      --&gt;</span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>generator</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>identity<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>generator</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">&gt;</span></span>        <span class="token comment">&lt;!--    types数据类型    --&gt;</span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>name<span class="token punctuation">"</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>name<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>java.lang.String<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>        <span class="token comment">&lt;!--  设置set name当前类中的set属性   table 这个属性的值重哪个表中获取      --&gt;</span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>set</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>orders<span class="token punctuation">"</span></span> <span class="token attr-name">table</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>orders<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>            <span class="token comment">&lt;!--   配置关联的字段 也就是外键 cid 要与当前表的id相同        --&gt;</span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>key</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>cid<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>key</span><span class="token punctuation">&gt;</span></span>            <span class="token comment">&lt;!--  一对多的意思   根据关联的字段查找到对象放入set中       --&gt;</span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>one-to-many</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.study.hibernate.pojo.Orders<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>one-to-many</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>set</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>class</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>hibernate-mapping</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>name 实体类属性名</p><p>table 表名</p><p>set 标签来配置实例类中的集合属性orsers （实体类的类型就是set的 如果是List集合 可以使用list标签）</p><p>​    one-to-many与集合泛型的实力类对应  表示这个的一对多中的多</p><p>​    key 外键</p><p><strong>一个订单只能有一个用户</strong></p><pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token prolog">&lt;?xml version='1.0' encoding='utf-8'?&gt;</span><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">hibernate-mapping</span> <span class="token name">PUBLIC</span>        <span class="token string">"-//Hibernate/Hibernate Mapping DTD 3.0//EN"</span>        <span class="token string">"http://www.hibernate.org/dtd/hibernate-mapping-3.0.dtd"</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hibernate-mapping</span><span class="token punctuation">&gt;</span></span>    <span class="token comment">&lt;!-- name:类的全路径:--&gt;</span>    <span class="token comment">&lt;!-- table:表的名称:(可以省略的.使用类的名称作为表名.)--&gt;</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>class</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.study.hibernate.pojo.Orders<span class="token punctuation">"</span></span> <span class="token attr-name">table</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>oders<span class="token punctuation">"</span></span> <span class="token punctuation">&gt;</span></span>        <span class="token comment">&lt;!-- 主键--&gt;</span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>            <span class="token comment">&lt;!--主键生成策略--&gt;</span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>generator</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>identity<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>generator</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">&gt;</span></span>        <span class="token comment">&lt;!--type:三种写法--&gt;</span>        <span class="token comment">&lt;!--Java类型 :java.lang.String--&gt;</span>        <span class="token comment">&lt;!--Hibernate类型:string--&gt;</span>        <span class="token comment">&lt;!--SQL类型 :不能直接使用type属性,需要子标签&lt;column&gt;--&gt;</span>        <span class="token comment">&lt;!--&lt;column name="name" sql-type="varchar(20)"/&gt;--&gt;</span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>name<span class="token punctuation">"</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>name<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>java.lang.String<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>many-to-one</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>customer<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.study.hibernate.pojo.Customer<span class="token punctuation">"</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>cid<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>many-to-one</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>class</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>hibernate-mapping</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>many-to-one标签 配置实体类对应的对象属性</p><p>​    name 属性名称</p><p>​    class 属性对应的类</p><p>​    column 外键</p><p><strong>使用api：</strong></p><pre class="line-numbers language-none"><code class="language-none">@Testpublic void CustomerTest(){    Configuration configuration = new Configuration().configure();    SessionFactory sessionFactory = configuration.buildSessionFactory();    Session session = sessionFactory.openSession();    Customer customer = new Customer(null,"张三",null);    //我们需要将订单需要的用户放入 他会获取用户的id并插入cid    Orders orders = new Orders(null,"订单一",customer);    session.save(customer);    session.save(orders);    session.beginTransaction().commit();    session.close();}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="多对多："><a href="#多对多：" class="headerlink" title="多对多："></a>多对多：</h4><pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token prolog">&lt;?xml version='1.0' encoding='utf-8'?&gt;</span><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">hibernate-mapping</span> <span class="token name">PUBLIC</span>        <span class="token string">"-//Hibernate/Hibernate Mapping DTD 3.0//EN"</span>        <span class="token string">"http://www.hibernate.org/dtd/hibernate-mapping-3.0.dtd"</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hibernate-mapping</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>class</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.study.hibernate.pojo.Course<span class="token punctuation">"</span></span> <span class="token attr-name">table</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>course<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>        <span class="token comment">&lt;!--   设置主键 name 类型属性  column 对应表字段    --&gt;</span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>            <span class="token comment">&lt;!--  设置主键自增      --&gt;</span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>generator</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>identity<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>generator</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">&gt;</span></span>        <span class="token comment">&lt;!--    types数据类型    --&gt;</span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>name<span class="token punctuation">"</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>name<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>java.lang.String<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>        <span class="token comment">&lt;!--  设置set name当前类中的set属性   table 这个属性的值重哪个表中获取      --&gt;</span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>set</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>accounts<span class="token punctuation">"</span></span> <span class="token attr-name">table</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>account_course<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>            <span class="token comment">&lt;!--  根据cid去account_course表中查询有哪些account  --&gt;</span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>key</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>cid<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>key</span><span class="token punctuation">&gt;</span></span>            <span class="token comment">&lt;!--  多对多的意思   更加account的aid去Account表中查询并放入set中      --&gt;</span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>many-to-many</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.study.hibernate.pojo.Account<span class="token punctuation">"</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aid<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>many-to-many</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>set</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>class</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>hibernate-mapping</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token prolog">&lt;?xml version='1.0' encoding='utf-8'?&gt;</span><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">hibernate-mapping</span> <span class="token name">PUBLIC</span>        <span class="token string">"-//Hibernate/Hibernate Mapping DTD 3.0//EN"</span>        <span class="token string">"http://www.hibernate.org/dtd/hibernate-mapping-3.0.dtd"</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hibernate-mapping</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>class</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.study.hibernate.pojo.Account<span class="token punctuation">"</span></span> <span class="token attr-name">table</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>account<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>        <span class="token comment">&lt;!--   设置主键 name 类型属性  column 对应表字段    --&gt;</span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>            <span class="token comment">&lt;!--  设置主键自增      --&gt;</span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>generator</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>identity<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>generator</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">&gt;</span></span>        <span class="token comment">&lt;!--    types数据类型    --&gt;</span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>name<span class="token punctuation">"</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>name<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>java.lang.String<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>        <span class="token comment">&lt;!--  设置set name当前类中的set属性   table 这个属性的值重哪个表中获取      --&gt;</span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>set</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>course<span class="token punctuation">"</span></span> <span class="token attr-name">table</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>account_course<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>            <span class="token comment">&lt;!--   根据aid去account_course表中查询有哪些Customer关联了        --&gt;</span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>key</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aid<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>key</span><span class="token punctuation">&gt;</span></span>            <span class="token comment">&lt;!--  一对多的意思   根据关联的字段查找到对象放入set中       --&gt;</span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>many-to-many</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.study.hibernate.pojo.Course<span class="token punctuation">"</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>cid<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>many-to-many</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>set</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>class</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>hibernate-mapping</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>使用api</strong></p><pre class="line-numbers language-none"><code class="language-none">    @Test    public void account_courseTest(){        Configuration configuration = new Configuration().configure();        SessionFactory sessionFactory = configuration.buildSessionFactory();        Session session = sessionFactory.openSession();        Account account = new Account();        account.setName("李四");        Course course = new Course();        course.setName("C#");//这两个都是可以 都会去关联表中插入数据，因为都是有配置set多对多关系设置的//        Set&lt;Course&gt; courses = new HashSet&lt;&gt;();//        courses.add(course);//        account.setCourse(courses);        Set&lt;Account&gt; accounts = new HashSet&lt;&gt;();        accounts.add(account);        course.setAccounts(accounts);        session.save(account);        session.save(course);        session.beginTransaction().commit();        session.close();    }<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="在hibernate映射文件中配置："><a href="#在hibernate映射文件中配置：" class="headerlink" title="在hibernate映射文件中配置："></a><strong>在hibernate映射文件中配置：</strong></h4><pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token comment">&lt;!-- 配置映射文件 --&gt;</span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mapping</span> <span class="token attr-name">resource</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>People.hbm.xml<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mapping</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mapping</span> <span class="token attr-name">resource</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Customer.hbm.xml<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mapping</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mapping</span> <span class="token attr-name">resource</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Orders.hbm.xml<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mapping</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="5、调用Hubernate-API"><a href="#5、调用Hubernate-API" class="headerlink" title="**5、调用Hubernate API **"></a>**5、调用Hubernate API **</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token class-name">PeopleTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token comment">//Hibernate 加载核心配置文件（有数据库连接信息） 不设置configure()的访问文件也会默认去找hibernate.cfg.xml</span>        <span class="token class-name">Configuration</span> configuration <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Configuration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">configure</span><span class="token punctuation">(</span><span class="token string">"hibernate.cfg.xml"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//获取会话工厂 SessionFactory</span>        <span class="token class-name">SessionFactory</span> sessionFactory <span class="token operator">=</span> configuration<span class="token punctuation">.</span><span class="token function">buildSessionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//在SessionFactory中获取Session会话</span>        <span class="token class-name">Session</span> session <span class="token operator">=</span> sessionFactory<span class="token punctuation">.</span><span class="token function">openSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Serializable</span> id <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">People</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">"某某某11"</span><span class="token punctuation">,</span> <span class="token number">5100.50</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        session<span class="token punctuation">.</span><span class="token function">beginTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="映射文件标签属性："><a href="#映射文件标签属性：" class="headerlink" title="映射文件标签属性："></a>映射文件标签属性：</h4><p><strong>hibernate-mapping标签：</strong></p><p>​    package：给class节点对应的实体类统一设置包名，此处设置包名，class的nname属性就可以省略包名。</p><p>​    schema：数据库schema的名称</p><p>​    catalog：数据库catalog的名称</p><p>​    default-cascade：默认的级联关系，默认为none</p><p>​    default-access：Hibernate用来访问属性的策略</p><p>​    default-lazy：指定了未明确注明lazy属性的Java属性和集合类，Hibernate会采用什么样的加载风格，默认为true</p><p>​    auto-impory：指定我们是否可以在查询语句中使用非全限定类名，默认为true，如果下面中有两个同名的持久化类，最好在这两个类的对应映射文件中设置为</p><p>​                              false</p><p><strong>class标签：</strong></p><p>​    name：实体类名</p><p>​    table：数据库表名</p><p>​    schema：数据库schema的名称，会覆盖hibernate-mapping中的schema</p><p>​    catalog：数据库catalog的名称，会覆盖hibernate-mapping中的catalog</p><p>​    proxy：指定一个接口，在延迟加载时作为代理使用</p><p>​    dynamic-update：动态更新，不会属性没有值sql也要传那么多参数</p><p>​    dynamic-insert：动态添加，不会属性没有值sql也要传那么多参数</p><p>​    where：查询时给Sql添加where条件，在使用HQL的情况下</p><p><strong>id标签：</strong></p><p>​    name：实体类属性名</p><p>​    type：实体类属性数据类型</p><p>​    此处可以设置两种类型的数据：java数据类型或Hibernate映射类型，实体类的属性数据类型必须于数据表对应的字段数据类型一致</p><p>​    column：数据库表的主键</p><p>​    generator：主键生成策略</p><p>​        hilo算法、</p><p>​        increment：Hibernate自增、</p><p>​        identity：数据库自增、</p><p>​        native：本地策略，根据底层数据库自动选择主键的生成策略</p><p>​        uuid.hex：算法</p><p>​        select算法</p><p><strong>property标签：</strong></p><p>​    name：实体类的属性名</p><p>​    column：数据库表字段名</p><p>​    type：数据类型</p><p>​    update：该字段是可以修改，默认为true</p><p>​    insert：该字段是可以添加，默认为true</p><p>​    lazy：延迟加载策略</p><p><strong>实体关系映射文件属性：</strong></p><p>​    inverse：该类型是否放弃维护映射关系，当两个类有映射关系添加时，并且都持有对方时，会出现重复维护，添加多条，这时候就让一方放弃维护即可，一对                     多，或多对多时会出现</p><p><strong>级联删除：</strong></p><p>​    cascade=”delete“：删除为该字段有级联的数据（也就是外键），如果不使用这个属性，那么就只能在代码中自己去编程删除了</p><h2 id="延迟加载："><a href="#延迟加载：" class="headerlink" title="延迟加载："></a>延迟加载：</h2><p>延迟加载也就是当我们要去查询时，如查询一个用户，但用户里面还要订单，如果我们只是查看用户而不查看用户的订单就不去查询订单只查询用户，当访问订单时才加载订单 </p><h3 id="XML配置："><a href="#XML配置：" class="headerlink" title="XML配置："></a>XML配置：</h3><h4 id="一对多：-1"><a href="#一对多：-1" class="headerlink" title="一对多："></a>一对多：</h4><p><strong>多个结果集的lazy（如set，list）</strong></p><p>我们需要去多结果集标签中设置 lazy 属性  它有false 、 true 、 extra 三个属性值</p><p>false：关闭延迟加载</p><p>true：开启延迟加载</p><p>extra：增强延迟加载</p><pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token prolog">&lt;?xml version='1.0' encoding='utf-8'?&gt;</span><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">hibernate-mapping</span> <span class="token name">PUBLIC</span>        <span class="token string">"-//Hibernate/Hibernate Mapping DTD 3.0//EN"</span>        <span class="token string">"http://www.hibernate.org/dtd/hibernate-mapping-3.0.dtd"</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hibernate-mapping</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>class</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.study.hibernate.pojo.Customer<span class="token punctuation">"</span></span> <span class="token attr-name">table</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>customer<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>        <span class="token comment">&lt;!--   设置主键 name 类型属性  column 对应表字段    --&gt;</span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>            <span class="token comment">&lt;!--  设置主键自增      --&gt;</span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>generator</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>identity<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>generator</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">&gt;</span></span>        <span class="token comment">&lt;!--    types数据类型    --&gt;</span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>name<span class="token punctuation">"</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>name<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>java.lang.String<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>        <span class="token comment">&lt;!--  设置set name当前类中的set属性   table 这个属性的值重哪个表中获取   lazy 是否开启延迟加载   --&gt;</span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>set</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>orders<span class="token punctuation">"</span></span> <span class="token attr-name">table</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>orders<span class="token punctuation">"</span></span> <span class="token attr-name">lazy</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>            <span class="token comment">&lt;!--   配置关联的字段 也就是外键 cid 要与当前表的id相同        --&gt;</span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>key</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>cid<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>key</span><span class="token punctuation">&gt;</span></span>            <span class="token comment">&lt;!--  一对多的意思   根据关联的字段查找到对象放入set中       --&gt;</span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>one-to-many</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.study.hibernate.pojo.Orders<span class="token punctuation">"</span></span> <span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>one-to-many</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>set</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>class</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>hibernate-mapping</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>单个结果集设置lazy</strong></p><p>lazy开启懒加载，在many-to-one标签中设置，false、proxy、no-proxy</p><p>默认为开启延迟加载</p><p>false：关闭延迟加载</p><p>proxy：无论调用方法是否需要访问customer的成员变量，都会发送SQL语句查询Customer</p><p>no-proxy：当调用方法需要访问customer的成员变量时，发送SQL语句查询Customer，否则不查询</p><pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token prolog">&lt;?xml version='1.0' encoding='utf-8'?&gt;</span><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">hibernate-mapping</span> <span class="token name">PUBLIC</span>        <span class="token string">"-//Hibernate/Hibernate Mapping DTD 3.0//EN"</span>        <span class="token string">"http://www.hibernate.org/dtd/hibernate-mapping-3.0.dtd"</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hibernate-mapping</span><span class="token punctuation">&gt;</span></span>    <span class="token comment">&lt;!-- name:类的全路径:--&gt;</span>    <span class="token comment">&lt;!-- table:表的名称:(可以省略的.使用类的名称作为表名.)--&gt;</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>class</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.study.hibernate.pojo.Orders<span class="token punctuation">"</span></span> <span class="token attr-name">table</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>oders<span class="token punctuation">"</span></span> <span class="token punctuation">&gt;</span></span>        <span class="token comment">&lt;!-- 主键--&gt;</span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>            <span class="token comment">&lt;!--主键生成策略--&gt;</span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>generator</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>identity<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>generator</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">&gt;</span></span>        <span class="token comment">&lt;!--type:三种写法--&gt;</span>        <span class="token comment">&lt;!--Java类型 :java.lang.String--&gt;</span>        <span class="token comment">&lt;!--Hibernate类型:string--&gt;</span>        <span class="token comment">&lt;!--SQL类型 :不能直接使用type属性,需要子标签&lt;column&gt;--&gt;</span>        <span class="token comment">&lt;!--&lt;column name="name" sql-type="varchar(20)"/&gt;--&gt;</span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>name<span class="token punctuation">"</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>name<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>java.lang.String<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>many-to-one</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>customer<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.study.hibernate.pojo.Customer<span class="token punctuation">"</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>cid<span class="token punctuation">"</span></span> <span class="token attr-name">lazy</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>many-to-one</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>class</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>hibernate-mapping</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="API使用："><a href="#API使用：" class="headerlink" title="API使用："></a>API使用：</h3><h4 id="普通延迟加载："><a href="#普通延迟加载：" class="headerlink" title="普通延迟加载："></a>普通延迟加载：</h4><p>lazy 为 true</p><p><strong>当我们之查看用户时：</strong></p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lazyCustomer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token class-name">Configuration</span> configuration <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Configuration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">configure</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">SessionFactory</span> sessionFactory <span class="token operator">=</span> configuration<span class="token punctuation">.</span><span class="token function">buildSessionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">Session</span> session <span class="token operator">=</span> sessionFactory<span class="token punctuation">.</span><span class="token function">openSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">Customer</span> customer <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Customer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>customer<span class="token punctuation">)</span><span class="token punctuation">;</span>    session<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>结果：</p><p>可以发现只执行了 一条SQL</p><p><a href="https://imgtu.com/i/jdLNzq"><img src="https://s1.ax1x.com/2022/07/07/jdLNzq.jpg" alt="jdLNzq.jpg"></a></p><p><strong>再同时查看订单：</strong></p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lazyCustomer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token class-name">Configuration</span> configuration <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Configuration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">configure</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">SessionFactory</span> sessionFactory <span class="token operator">=</span> configuration<span class="token punctuation">.</span><span class="token function">buildSessionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">Session</span> session <span class="token operator">=</span> sessionFactory<span class="token punctuation">.</span><span class="token function">openSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">Customer</span> customer <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Customer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>customer<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>customer<span class="token punctuation">.</span><span class="token function">getOrders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    session<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>结果：</p><p>可以看到查询了俩条SQL语句</p><p><a href="https://imgtu.com/i/jdLO6P"><img src="https://s1.ax1x.com/2022/07/07/jdLO6P.jpg" alt="jdLO6P.jpg"></a></p><h4 id="增强延迟加载："><a href="#增强延迟加载：" class="headerlink" title="增强延迟加载："></a>增强延迟加载：</h4><p>lazy 为extra</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lazyCustomer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token class-name">Configuration</span> configuration <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Configuration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">configure</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">SessionFactory</span> sessionFactory <span class="token operator">=</span> configuration<span class="token punctuation">.</span><span class="token function">buildSessionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">Session</span> session <span class="token operator">=</span> sessionFactory<span class="token punctuation">.</span><span class="token function">openSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">Customer</span> customer <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Customer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>customer<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>customer<span class="token punctuation">.</span><span class="token function">getOrders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    session<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>结果：</p><p>会更加你的查询来判断要执行的sql语句，如果是普通延迟就会直接将数据也查询出来，而增强延迟就不会，他会直接换为count（）去查询，节省效率</p><p><a href="https://imgtu.com/i/jwbdR1"><img src="https://s1.ax1x.com/2022/07/07/jwbdR1.jpg" alt="jwbdR1.jpg"></a></p><h2 id="HQL："><a href="#HQL：" class="headerlink" title="HQL："></a>HQL：</h2><h3 id="Hibernate-HQL"><a href="#Hibernate-HQL" class="headerlink" title="Hibernate HQL"></a>Hibernate HQL</h3><p>HQL: Hibernate Query Language，是 Hibernate框架提供的一种查询机制，它和SQL类似，不同的是HQL是面向对象的查询语句，让开发者能够以面向对象的思想来编写查询语句，对Java编程是一种好友好的方式。<br>HQL不能直接参与数据库的交互，中间层语言。</p><p>Java —》 HQL —&gt;Hibernate —》SQL —&gt;DB</p><p>HQL只能完成查询、修改、删除，新增是无法操作的。</p><h3 id="HQL使用："><a href="#HQL使用：" class="headerlink" title="HQL使用："></a>HQL使用：</h3><p>Hql中from前面默认为select * from后也不是表名，而是类型，如果只是写别名而不写全类名会有警告，当不妨该使用</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token class-name">Hql</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token class-name">Configuration</span> configuration <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Configuration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">configure</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">SessionFactory</span> sessionFactory <span class="token operator">=</span> configuration<span class="token punctuation">.</span><span class="token function">buildSessionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">Session</span> session <span class="token operator">=</span> sessionFactory<span class="token punctuation">.</span><span class="token function">openSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//Hql 语句</span>    <span class="token class-name">String</span> hql <span class="token operator">=</span> <span class="token string">"from People"</span><span class="token punctuation">;</span>    <span class="token comment">//创建Hql 查询放入hql</span>    <span class="token class-name">Query</span> query <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">createQuery</span><span class="token punctuation">(</span>hql<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//进行查询</span>    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">People</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> query<span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">People</span> people <span class="token operator">:</span> list<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>people<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    session<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>结果：</p><pre class="line-numbers language-none"><code class="language-none">七月 08, 2022 9:40:30 上午 org.hibernate.engine.transaction.jta.platform.internal.JtaPlatformInitiator initiateServiceINFO: HHH000490: Using JtaPlatform implementation: [org.hibernate.engine.transaction.jta.platform.internal.NoJtaPlatform]Hibernate:     select        people0_.id as id1_6_,        people0_.name as name2_6_,        people0_.money as money3_6_     from        people people0_People(id=1, name=某某某, money=5000.5)People(id=2, name=某某某11, money=5100.5)People(id=3, name=某某某22, money=5100.5)Process finished with exit code 0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="分页："><a href="#分页：" class="headerlink" title="分页："></a>分页：</h3><p>HQL分页查询可以通过query的方法完成：</p><p>1、setFirstResult() 设置起始下标</p><p>2、setMaxResults() 设置截取长度</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token class-name">Hql</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token class-name">Configuration</span> configuration <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Configuration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">configure</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">SessionFactory</span> sessionFactory <span class="token operator">=</span> configuration<span class="token punctuation">.</span><span class="token function">buildSessionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">Session</span> session <span class="token operator">=</span> sessionFactory<span class="token punctuation">.</span><span class="token function">openSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//Hql 语句</span>    <span class="token class-name">String</span> hql <span class="token operator">=</span> <span class="token string">"from People"</span><span class="token punctuation">;</span>    <span class="token comment">//创建Hql 查询放入hql</span>    <span class="token class-name">Query</span> query <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">createQuery</span><span class="token punctuation">(</span>hql<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//设置起始下标</span>    query<span class="token punctuation">.</span><span class="token function">setFetchSize</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//设置截取长度</span>    query<span class="token punctuation">.</span><span class="token function">setMaxResults</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//进行查询</span>    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">People</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> query<span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">People</span> people <span class="token operator">:</span> list<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>people<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    session<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>结果：</p><pre class="line-numbers language-basic" data-language="basic"><code class="language-basic">Hibernate<span class="token punctuation">:</span>     <span class="token function">select</span>        people0_.id <span class="token keyword">as</span> id1_6_<span class="token punctuation">,</span>        people0_.<span class="token keyword">name</span> <span class="token keyword">as</span> name2_6_<span class="token punctuation">,</span>        people0_.money <span class="token keyword">as</span> money3_6_     from        people people0_ limit ?People<span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">name</span><span class="token operator">=</span>某某某<span class="token punctuation">,</span> money<span class="token operator">=</span><span class="token number">5000.5</span><span class="token punctuation">)</span>People<span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token keyword">name</span><span class="token operator">=</span>某某某<span class="token number">11</span><span class="token punctuation">,</span> money<span class="token operator">=</span><span class="token number">5100.5</span><span class="token punctuation">)</span>Process finished <span class="token function">with</span> <span class="token keyword">exit</span> code <span class="token number">0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="where条件查询-级联查询："><a href="#where条件查询-级联查询：" class="headerlink" title="where条件查询 级联查询："></a><strong>where条件查询 级联查询：</strong></h3><p>HQL直接追加where关键字作为查询条件，与SQL没有区别，比较的值可以使用java对象</p><p>在HQL中 :xxx 为占位符，使用Query的setParameter(“Customer”,customer); 替换占位符</p><p>级联查询也就是先拿到级联的外键对象，再通过这个对象去获取级联的对象</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token class-name">HqlWhere</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token class-name">Configuration</span> configuration <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Configuration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">configure</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">SessionFactory</span> sessionFactory <span class="token operator">=</span> configuration<span class="token punctuation">.</span><span class="token function">buildSessionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">Session</span> session <span class="token operator">=</span> sessionFactory<span class="token punctuation">.</span><span class="token function">openSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">Customer</span> customer <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Customer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//Hql 语句</span>    <span class="token class-name">String</span> hql <span class="token operator">=</span> <span class="token string">"from Orders where customer = :Customer"</span><span class="token punctuation">;</span>    <span class="token comment">//创建Hql 查询放入hql</span>    <span class="token class-name">Query</span> query <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">createQuery</span><span class="token punctuation">(</span>hql<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//替换占位符</span>    query<span class="token punctuation">.</span><span class="token function">setParameter</span><span class="token punctuation">(</span><span class="token string">"Customer"</span><span class="token punctuation">,</span>customer<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Orders</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> query<span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Orders</span> orders <span class="token operator">:</span> list<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>orders<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    session<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>结果：</p><pre class="line-numbers language-basic" data-language="basic"><code class="language-basic">七月 <span class="token number">08</span><span class="token punctuation">,</span> <span class="token number">2022</span> <span class="token number">9</span><span class="token punctuation">:</span><span class="token number">58</span><span class="token punctuation">:</span><span class="token number">00</span> 上午 org.hibernate.engine.transaction.jta.platform.<span class="token function">internal</span>.JtaPlatformInitiator initiateServiceINFO<span class="token punctuation">:</span> HHH000490<span class="token punctuation">:</span> <span class="token keyword">Using</span> JtaPlatform implementation<span class="token punctuation">:</span> [org.hibernate.engine.transaction.jta.platform.<span class="token function">internal</span>.NoJtaPlatform]Hibernate<span class="token punctuation">:</span>     <span class="token function">select</span>        customer0_.id <span class="token keyword">as</span> id1_4_0_<span class="token punctuation">,</span>        customer0_.<span class="token keyword">name</span> <span class="token keyword">as</span> name2_4_0_     from        customer customer0_     where        customer0_.id<span class="token operator">=</span>?Hibernate<span class="token punctuation">:</span>     <span class="token function">select</span>        orders0_.id <span class="token keyword">as</span> id1_5_<span class="token punctuation">,</span>        orders0_.<span class="token keyword">name</span> <span class="token keyword">as</span> name2_5_<span class="token punctuation">,</span>        orders0_.cid <span class="token keyword">as</span> cid3_5_     from        oders orders0_     where        orders0_.cid<span class="token operator">=</span>?Orders{id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">name</span><span class="token operator">=</span>'订单一'}Orders{id<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token keyword">name</span><span class="token operator">=</span>'订单二'}Process finished <span class="token function">with</span> <span class="token keyword">exit</span> code <span class="token number">0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="uniquerResult方法："><a href="#uniquerResult方法：" class="headerlink" title="uniquerResult方法："></a>uniquerResult方法：</h3><p>这个方法获取结果如果是没有获取到返回为null</p><pre class="line-numbers language-none"><code class="language-none">@Testpublic void HqlUniquerResult(){    Configuration configuration = new Configuration().configure();    SessionFactory sessionFactory = configuration.buildSessionFactory();    Session session = sessionFactory.openSession();    Customer customer = session.get(Customer.class, 1);    //Hql 语句    String hql = "from Orders where id = 10";    //创建Hql 查询放入hql    Query query = session.createQuery(hql);    Orders orders = (Orders)query.uniqueResult();    System.out.println(orders);    session.close();}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>结果：</p><pre class="line-numbers language-none"><code class="language-none">七月 08, 2022 10:04:01 上午 org.hibernate.engine.transaction.jta.platform.internal.JtaPlatformInitiator initiateServiceINFO: HHH000490: Using JtaPlatform implementation: [org.hibernate.engine.transaction.jta.platform.internal.NoJtaPlatform]Hibernate:     select        customer0_.id as id1_4_0_,        customer0_.name as name2_4_0_     from        customer customer0_     where        customer0_.id=?Hibernate:     select        orders0_.id as id1_5_,        orders0_.name as name2_5_,        orders0_.cid as cid3_5_     from        oders orders0_     where        orders0_.id=10nullProcess finished with exit code -1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="模糊查询："><a href="#模糊查询：" class="headerlink" title="模糊查询："></a>模糊查询：</h3><p>模糊查询也就是使用like ‘%三 %’  注意是在字符串里面使用 ’  ‘ 号 </p>]]></content>
      
      
      <categories>
          
          <category> Hibernate </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 框架 </tag>
            
            <tag> ORM </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MyBatis缓存</title>
      <link href="/2022/06/26/MyBatis%E7%BC%93%E5%AD%98/"/>
      <url>/2022/06/26/MyBatis%E7%BC%93%E5%AD%98/</url>
      
        <content type="html"><![CDATA[<h1 id="MyBtais缓存"><a href="#MyBtais缓存" class="headerlink" title="MyBtais缓存"></a>MyBtais缓存</h1><h2 id="介绍："><a href="#介绍：" class="headerlink" title="介绍："></a>介绍：</h2><p>Mybatis的二级缓存其实默认是开启的，但我们需要指定每个mapper的缓存策略二级缓存才会生效，如何不配置缓存策略二级缓存则不生效。</p><h2 id="开启二级缓存与配置缓存策略："><a href="#开启二级缓存与配置缓存策略：" class="headerlink" title="开启二级缓存与配置缓存策略："></a>开启二级缓存与配置缓存策略：</h2><p><strong>开启二级缓存：</strong></p><p>默认是开启的</p><p>首先在全局配置文件 mybatis-configuration.xml 文件中加入如下代码：</p><pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token comment">&lt;!--开启二级缓存  --&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>settings</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>setting</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>cacheEnabled<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>settings</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><strong>配置缓存策略：</strong></p><p>在Mybatis的映射Mapper XML文件中设置</p><pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token comment">&lt;!-- 开启二级缓存 --&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>cache</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>cache</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>我们可以看到 mapper.xml 文件中就这么一个空标签<cache>，其实这里可以配置<cache type="org.apache.ibatis.cache.impl.PerpetualCache">,PerpetualCache这个类是mybatis默认实现缓存功能的类。我们不写type就使用mybatis默认的缓存，也可以去实现 Cache 接口来自定义缓存。</cache></cache></p><pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>cache</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org.apache.ibatis.cache.impl.PerpetualCache<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>cache</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="执行过程讲解："><a href="#执行过程讲解：" class="headerlink" title="执行过程讲解："></a>执行过程讲解：</h2><h3 id="运行环境："><a href="#运行环境：" class="headerlink" title="运行环境："></a>运行环境：</h3><p>这里我们可以证实Mybtis二级缓存是默认开启的，我们只需要配置缓存策略即可使用二级缓存</p><p><strong>启动类：</strong></p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">InputStream</span> resourceAsStream <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            resourceAsStream <span class="token operator">=</span> <span class="token class-name">Resources</span><span class="token punctuation">.</span><span class="token function">getResourceAsStream</span><span class="token punctuation">(</span><span class="token string">"SqlMapperConfig.xml"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token class-name">SqlSessionFactory</span> sqlSessionFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SqlSessionFactoryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>resourceAsStream<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">SqlSession</span> sqlSession <span class="token operator">=</span> sqlSessionFactory<span class="token punctuation">.</span><span class="token function">openSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">UserMapper</span> mapper <span class="token operator">=</span> sqlSession<span class="token punctuation">.</span><span class="token function">getMapper</span><span class="token punctuation">(</span><span class="token class-name">UserMapper</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> byId <span class="token operator">=</span> mapper<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        byId <span class="token operator">=</span> mapper<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>mapper接口：</strong></p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserMapper</span> <span class="token punctuation">{</span>    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> <span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> <span class="token function">findById</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p> <strong>mapper接口映射xml：</strong></p><pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">mapper</span> <span class="token name">PUBLIC</span> <span class="token string">"-//mybatis.org//DTD Mapper 3.0//EN"</span> <span class="token string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mapper</span> <span class="token attr-name">namespace</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.example.Dao.UserMapper<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>    <span class="token comment">&lt;!--    设置二级缓存策略--&gt;</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>cache</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org.apache.ibatis.cache.impl.PerpetualCache<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>cache</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>findById<span class="token punctuation">"</span></span> <span class="token attr-name">resultType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>user<span class="token punctuation">"</span></span> <span class="token attr-name">parameterType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>int<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>        select * from user where id=#{id}    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mapper</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>MyBatis配置文件：</strong></p><p>没有去开启二级缓存</p><pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">configuration</span> <span class="token name">PUBLIC</span> <span class="token string">"-//mybatis.org//DTD Config 3.0//EN"</span> <span class="token string">"http://mybatis.org/dtd/mybatis-3-config.dtd"</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span><span class="token comment">&lt;!--    注意先后顺序--&gt;</span><span class="token comment">&lt;!--    通过properties标签使用properties文件--&gt;</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span> <span class="token attr-name">resource</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>jdbc.properties<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">&gt;</span></span><span class="token comment">&lt;!--    设置UserMapper中的类型别名--&gt;</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>typeAliases</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>typeAlias</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.example.domain.User<span class="token punctuation">"</span></span> <span class="token attr-name">alias</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>user<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>typeAliases</span><span class="token punctuation">&gt;</span></span><span class="token comment">&lt;!--    配置数据源环境--&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>environments</span> <span class="token attr-name">default</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dataSourceJDBC<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>environment</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dataSourceJDBC<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>transactionManager</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>JDBC<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>transactionManager</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dataSource</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>POOLED<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>driver<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>${driverClass}<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>url<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>${url}<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>username<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>${user}<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>${password}<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dataSource</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>environment</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>environments</span><span class="token punctuation">&gt;</span></span><span class="token comment">&lt;!--    配置映射文件--&gt;</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mappers</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mapper</span> <span class="token attr-name">resource</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.mapper/UserMapper.xml<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mappers</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="执行流程："><a href="#执行流程：" class="headerlink" title="执行流程："></a>执行流程：</h3><p>第一次执行mapper.findById(1);</p><p>他会先去获取缓存中的映射方法，如果未获取到则进行创建，并将创建的映射方法存入缓存中</p><p><a href="https://imgtu.com/i/jAHS0K"><img src="https://s1.ax1x.com/2022/06/26/jAHS0K.jpg" alt="jAHS0K.jpg"></a></p><p><strong>执行execute</strong>：</p><p>运行执行器，会先判断当前为什么类型的SQL，如果为SELECT的sql又会分为多结果等等方法，这个为多结果的查询sql所以运行多结果执行方法</p><p><a href="https://imgtu.com/i/jESdqH"><img src="https://s1.ax1x.com/2022/06/26/jESdqH.jpg" alt="jESdqH.jpg"></a></p><p><strong>运行多结果执行器：</strong></p><p>判断当前方法是否有边界索引，没有进行查询</p><p><a href="https://imgtu.com/i/jEpbtI"><img src="https://s1.ax1x.com/2022/06/26/jEpbtI.jpg" alt="jEpbtI.jpg"></a></p><p><strong>SelectList查询方法：</strong></p><p>先获取配置文件中的映射语句，再进行query查询</p><p><a href="https://imgtu.com/i/jEpqht"><img src="https://s1.ax1x.com/2022/06/26/jEpqht.jpg" alt="jEpqht.jpg"></a></p><p><strong>query查询方法（CachingExecutor类）重载方法：</strong></p><p>通过映射语句MappedStatement获取SQL,再进行其他的一些参数生成一个key之后用来获取缓存中的结果值</p><p><a href="https://imgtu.com/i/jEpT7d"><img src="https://s1.ax1x.com/2022/06/26/jEpT7d.jpg" alt="jEpT7d.jpg"></a></p><p><strong>query方法（CachingExecutor类）重载方法：</strong></p><p>判断是否开启了二级缓存，没有二级缓存则进行一级缓存的查询，一级缓存还会进行本地缓存的一个获取，没有才进行数据库查询</p><p>如果开启了二级缓存，则进行二级的一个查询，如果有就进行返回结果，并将结果加入到二级缓存，没有还是进行一个一级缓存的查询</p><p><a href="https://imgtu.com/i/jEpHAA"><img src="https://s1.ax1x.com/2022/06/26/jEpHAA.jpg" alt="jEpHAA.jpg"></a></p><p><strong>一级缓存先是进行一个本地缓存的查询，如果本地缓存没有数据就进行数据库查询，查询后会放入本地缓存</strong></p>]]></content>
      
      
      <categories>
          
          <category> MyBatis </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 缓存 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SpringMVC</title>
      <link href="/2022/04/21/SpringMVC/"/>
      <url>/2022/04/21/SpringMVC/</url>
      
        <content type="html"><![CDATA[<h1 id="SpringMVC"><a href="#SpringMVC" class="headerlink" title="SpringMVC:"></a>SpringMVC:</h1><h2 id="什么是SpringMVC"><a href="#什么是SpringMVC" class="headerlink" title="什么是SpringMVC:"></a>什么是SpringMVC:</h2><p>Spring MVC 是 Spring 提供的一个基于 MVC 设计模式的轻量级 Web 开发框架，本质上相当于 Servlet。</p><p>Spring MVC 是结构最清晰的 Servlet+JSP+JavaBean 的实现，是一个典型的教科书式的 MVC 构架，不像 Struts 等其它框架都是变种或者不是完全基于 MVC 系统的框架。</p><p>Spring MVC 角色划分清晰，分工明细，并且和 Spring 框架无缝结合。Spring MVC 是当今业界最主流的 Web 开发框架，以及最热门的开发技能。</p><p>在 Spring MVC 框架中，Controller 替换 Servlet 来担负控制器的职责，用于接收请求，调用相应的 Model 进行处理，处理器完成业务处理后返回处理结果。Controller 调用相应的 View 并对处理结果进行视图渲染，最终客户端得到响应信息。</p><p>Spring MVC 框架采用松耦合可插拔的组件结构，具有高度可配置性，比起其它 MVC 框架更具有扩展性和灵活性。</p><p>此外，Spring MVC 的注解驱动和对 REST 风格的支持，也是它最具特色的功能。无论是在框架设计，还是扩展性、灵活性等方面都全面超越了 Struts2 等 MVC 框架。并且由于 Spring MVC 本身就是 Spring 框架的一部分，所以可以说与 Spring 框架是无缝集成，性能方面具有先天的优越性，对于开发者来说，开发效率也高于其它的 Web 框架，在企业中的应用越来越广泛，成为主流的 MVC 框架。</p><h2 id="前端控制器（DispatcherServlet）："><a href="#前端控制器（DispatcherServlet）：" class="headerlink" title="前端控制器（DispatcherServlet）："></a>前端控制器（DispatcherServlet）：</h2><h3 id="流程图："><a href="#流程图：" class="headerlink" title="流程图："></a>流程图：</h3><p><img src="C:\Users\hhxx\AppData\Roaming\Typora\typora-user-images\image-20220421120152796.png" alt="image-20220421120152796"></p><p><strong>SpringMVC 的执行流程如下。</strong></p><ol><li>用户点击某个请求路径，发起一个 HTTP request 请求，该请求会被提交到 DispatcherServlet（前端控制器）；</li><li>由 DispatcherServlet 请求一个或多个 HandlerMapping（处理器映射器），并返回一个执行链（HandlerExecutionChain）。</li><li>DispatcherServlet 将执行链返回的 Handler 信息发送给 HandlerAdapter（处理器适配器）；</li><li>HandlerAdapter 根据 Handler 信息找到并执行相应的 Handler（常称为 Controller）；</li><li>Handler 执行完毕后会返回给 HandlerAdapter 一个 ModelAndView 对象（Spring MVC的底层对象，包括 Model 数据模型和 View 视图信息）；</li><li>HandlerAdapter 接收到 ModelAndView 对象后，将其返回给 DispatcherServlet ；</li><li>DispatcherServlet 接收到 ModelAndView 对象后，会请求 ViewResolver（视图解析器）对视图进行解析；</li><li>ViewResolver 根据 View 信息匹配到相应的视图结果，并返回给 DispatcherServlet；</li><li>DispatcherServlet 接收到具体的 View 视图后，进行视图渲染，将 Model 中的模型数据填充到 View 视图中的 request 域，生成最终的 View（视图）；</li><li>视图负责将结果显示到浏览器（客户端）。</li><li></li></ol><h3 id="Spring-MVC接口"><a href="#Spring-MVC接口" class="headerlink" title="Spring MVC接口"></a>Spring MVC接口</h3><p>Spring MVC 涉及到的组件有 DispatcherServlet（前端控制器）、HandlerMapping（处理器映射器）、HandlerAdapter（处理器适配器）、Handler（处理器）、ViewResolver（视图解析器）和 View（视图）。下面对各个组件的功能说明如下。</p><h4 id="1）DispatcherServlet"><a href="#1）DispatcherServlet" class="headerlink" title="1）DispatcherServlet"></a>1）DispatcherServlet</h4><p>DispatcherServlet 是前端控制器，Spring MVC 的所有请求都要经过 DispatcherServlet 来统一分发。DispatcherServlet 相当于一个转发器或中央处理器，控制整个流程的执行，对各个组件进行统一调度，以降低组件之间的耦合性，有利于组件之间的拓展。</p><h4 id="2）HandlerMapping"><a href="#2）HandlerMapping" class="headerlink" title="2）HandlerMapping"></a>2）HandlerMapping</h4><p>HandlerMapping 是处理器映射器，其作用是根据请求的 URL 路径，通过注解或者 XML 配置，寻找匹配的处理器（Handler）信息。</p><p><strong>handler也就是Controller</strong></p><h4 id="3）HandlerAdapter"><a href="#3）HandlerAdapter" class="headerlink" title="3）HandlerAdapter"></a>3）HandlerAdapter</h4><p>HandlerAdapter 是处理器适配器，其作用是根据映射器找到的处理器（Handler）信息，按照特定规则执行相关的处理器（Handler）。</p><p><strong>handler也就是Controller</strong></p><h4 id="4）Handler"><a href="#4）Handler" class="headerlink" title="4）Handler"></a>4）Handler</h4><p>Handler 是处理器，和 Java Servlet 扮演的角色一致。其作用是执行相关的请求处理逻辑，并返回相应的数据和视图信息，将其封装至 ModelAndView 对象中。</p><p><strong>handler也就是Controller</strong></p><h4 id="5）View-Resolver"><a href="#5）View-Resolver" class="headerlink" title="5）View Resolver"></a>5）View Resolver</h4><p>View Resolver 是视图解析器，其作用是进行解析操作，通过 ModelAndView 对象中的 View 信息将逻辑视图名解析成真正的视图 View（如通过一个 JSP 路径返回一个真正的 JSP 页面）。</p><h4 id="6）View"><a href="#6）View" class="headerlink" title="6）View"></a>6）View</h4><p>View 是视图，其本身是一个接口，实现类支持不同的 View 类型（JSP、FreeMarker、Excel 等）。</p><h2 id="演示："><a href="#演示：" class="headerlink" title="演示："></a>演示：</h2><h3 id="简单实现："><a href="#简单实现：" class="headerlink" title="简单实现："></a>简单实现：</h3><p>不使用Controller注解方式：</p><h4 id="导入依赖："><a href="#导入依赖：" class="headerlink" title="导入依赖："></a>导入依赖：</h4><pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>javax.servlet<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>javax.servlet-api<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>4.0.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>provided<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.junit.jupiter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>junit-jupiter-api<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${junit.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.junit.jupiter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>junit-jupiter-engine<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${junit.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>jstl<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>jstl<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-tx<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>5.0.5.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>5.0.5.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-webmvc<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>5.0.5.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>javax.servlet.jsp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>jsp-api<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="web-xml："><a href="#web-xml：" class="headerlink" title="web.xml："></a>web.xml：</h4><p>配置前端控制器映射路径</p><pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>web-app</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://xmlns.jcp.org/xml/ns/javaee<span class="token punctuation">"</span></span>         <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span>         <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd<span class="token punctuation">"</span></span>         <span class="token attr-name">version</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>4.0<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet-name</span><span class="token punctuation">&gt;</span></span>dispatcherServlet<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet-name</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet-class</span><span class="token punctuation">&gt;</span></span>org.springframework.web.servlet.DispatcherServlet<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet-class</span><span class="token punctuation">&gt;</span></span><span class="token comment">&lt;!--        初始化加载参数springmvc.xml --&gt;</span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>init-param</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>param-name</span><span class="token punctuation">&gt;</span></span>contextConfigLocation<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>param-name</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>param-value</span><span class="token punctuation">&gt;</span></span>classpath:spring_mvc.xml<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>param-value</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>init-param</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>load-on-startup</span><span class="token punctuation">&gt;</span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>load-on-startup</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet-mapping</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet-name</span><span class="token punctuation">&gt;</span></span>dispatcherServlet<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet-name</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url-pattern</span><span class="token punctuation">&gt;</span></span>/<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url-pattern</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet-mapping</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>web-app</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="SpringMvc-xml"><a href="#SpringMvc-xml" class="headerlink" title="SpringMvc.xml"></a>SpringMvc.xml</h4><p>映射器与适配器可以用手动配置，有默认的，有其他需求可再配置  、</p><p>适配器源码中表名handler要是controller了，可以看看源码</p><pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>beans</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/beans<span class="token punctuation">"</span></span>       <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span>       <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token comment">&lt;!--        配置处理器适配器 还有其他类型适配器，使用是不同的--&gt;</span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org.springframework.web.servlet.mvc.SimpleControllerHandlerAdapter<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span><span class="token comment">&lt;!--        配置处理器映射器 还有其他类型映射器，使用是不同的--&gt;</span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org.springframework.web.servlet.handler.BeanNameUrlHandlerMapping<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span><span class="token comment">&lt;!--        配置URL映射的controller  映射器会根据URL来找映射并给适配器调用--&gt;</span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/user<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.example.SpringMvc_review.controller.UserController<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>beans</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="UserController："><a href="#UserController：" class="headerlink" title="UserController："></a>UserController：</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 不使用注解，在xml中设置 */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token keyword">implements</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">ModelAndView</span> <span class="token function">handleRequest</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> httpServletRequest<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> httpServletResponse<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>        <span class="token class-name">ModelAndView</span> modelAndView <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ModelAndView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        modelAndView<span class="token punctuation">.</span><span class="token function">addObject</span><span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token string">"joke"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        modelAndView<span class="token punctuation">.</span><span class="token function">setViewName</span><span class="token punctuation">(</span><span class="token string">"/WEB-INF/user.jsp"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> modelAndView<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="User："><a href="#User：" class="headerlink" title="User："></a>User：</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token class-name">Integer</span> age<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> age<span class="token punctuation">,</span> <span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">getAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> age<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setAge</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> age<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> name<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setName</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="user-jsp"><a href="#user-jsp" class="headerlink" title="user.jsp"></a>user.jsp</h4><pre class="line-numbers language-jsp" data-language="jsp"><code class="language-jsp">&lt;%--  Created by IntelliJ IDEA.  User: hhxx  Date: 2022/4/21  Time: 11:43  To change this template use File | Settings | File Templates.--%&gt;&lt;%@ page contentType="text/html;charset=UTF-8" language="java" isELIgnored="false" %&gt;&lt;html&gt;&lt;head&gt;    &lt;title&gt;Title&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;h1&gt;User  JSP&lt;/h1&gt;&lt;ul&gt;    &lt;li&gt;${user.age}&lt;/li&gt;    &lt;li&gt;${user.name}&lt;/li&gt;&lt;/ul&gt;&lt;/body&gt;&lt;/html&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="配置Tomcat运行结果："><a href="#配置Tomcat运行结果：" class="headerlink" title="配置Tomcat运行结果："></a>配置Tomcat运行结果：</h4><p><img src="C:\Users\hhxx\AppData\Roaming\Typora\typora-user-images\image-20220421122128419.png" alt="image-20220421122128419"></p><h2 id="接口参数绑定："><a href="#接口参数绑定：" class="headerlink" title="接口参数绑定："></a>接口参数绑定：</h2>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 框架 </tag>
            
            <tag> SpringMVC </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Vue脚手架</title>
      <link href="/2022/04/13/Vue%E8%84%9A%E6%89%8B%E6%9E%B6/"/>
      <url>/2022/04/13/Vue%E8%84%9A%E6%89%8B%E6%9E%B6/</url>
      
        <content type="html"><![CDATA[<h1 id="VueCLI"><a href="#VueCLI" class="headerlink" title="VueCLI:"></a>VueCLI:</h1><p>Vue-CLI 是 Vue 官方提供的, 用来搭建项目脚手架的工具，它是 Vue.js 开发的标准工具，它已经集成了 webpack , 内置好了很多常用配置, 使得我们在使用 Vue 开发项目时更加的标准化。</p><p>作用： 通过 Vue-CLI 下载模板项目。</p><p>官方文档：<a href="https://cli.vuejs.org/zh/">https://cli.vuejs.org/zh/</a></p><p>github站点：<a href="https://github.com/vuejs/vue-cli">https://github.com/vuejs/vue-cli</a></p><h2 id="Vue-CLI-安装"><a href="#Vue-CLI-安装" class="headerlink" title="Vue CLI 安装"></a>Vue CLI 安装</h2><p>需要先安装Node</p><h3 id="全局安装-Vue-CLI："><a href="#全局安装-Vue-CLI：" class="headerlink" title="全局安装 Vue-CLI："></a>全局安装 Vue-CLI：</h3><p>会直接下载最新版本，也可以指定版本，在安装前我们可以更好下载镜像npm config set registry <a href="https://registry.npm.taobao.org/">https://registry.npm.taobao.org</a></p><pre class="line-numbers language-none"><code class="language-none">npm install -g @vue/cli   <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="查看安装版本："><a href="#查看安装版本：" class="headerlink" title="查看安装版本："></a>查看安装版本：</h3><pre class="line-numbers language-none"><code class="language-none">vue --version# 或者 大写Vvue -V<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><strong>如果执行上面后，命令行提示 ‘vue’ 不是内部或外部命令</strong></p><p>解决方法：配置环境变量</p><ol><li><p>查看全局安装目录 nmp root -g </p></li><li><p>在 我的电脑 进入全局安装目录下，找到 vue.cmd</p></li><li><ol start="3"><li>右键计算机，属性—》高级系统设置—》环境变量，将 vue.cmd 的路径加入环境变量，点击“确定”</li></ol></li></ol><p><img src="C:\Users\hhxx\AppData\Roaming\Typora\typora-user-images\image-20220412173214043.png" alt="image-20220412173214043"></p><h2 id="基于-Vue-CLI-创建项目"><a href="#基于-Vue-CLI-创建项目" class="headerlink" title="基于 Vue-CLI 创建项目"></a>基于 Vue-CLI 创建项目</h2><p>cmd 使用命令 vue create 命令来创建一个新项目</p><pre class="line-numbers language-none"><code class="language-none">vue create 项目名称<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>执行上面命令后：看需要选择版本，</p><p><img src="C:\Users\hhxx\AppData\Roaming\Typora\typora-user-images\image-20220412173755114.png" alt="image-20220412173755114"></p><p>选择完后：</p><p><img src="C:\Users\hhxx\AppData\Roaming\Typora\typora-user-images\image-20220412174036007.png" alt="image-20220412174036007"></p><p>输入完后：</p><p><img src="C:\Users\hhxx\AppData\Roaming\Typora\typora-user-images\image-20220412174125650.png" alt="image-20220412174125650"></p><p>出现链接，有这个页面就运行成功</p><p><img src="C:\Users\hhxx\AppData\Roaming\Typora\typora-user-images\image-20220412174147077.png" alt="image-20220412174147077"></p><h2 id="CLI-服务命令："><a href="#CLI-服务命令：" class="headerlink" title="CLI 服务命令："></a>CLI 服务命令：</h2><p>CLI 服务 ( @vue/cli-service ) 是一个开发环境依赖。针对绝大部分应用优化过的内部的 webpack 配置；</p><p> 在一个 Vue CLI 项目中， @vue/cli-service 模块安装了一个名为 vue-cli-service 的命令。 </p><p>在 package.json 中的 scripts 指定 vue-cli-service 相关命令。</p><pre class="line-numbers language-none"><code class="language-none">"scripts": {"serve": "vue-cli-service serve --open","build": "vue-cli-service build","lint": "vue-cli-service lint"}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>serve 启动一个开发环境服务器(基于 webpack-dev-server)</p><p>​    修改组件代码后，会自动热模块替换</p><p>build 会项目根目录下自动创建一个 dist/ 目录，打包后的文件都在其中</p><p>​    打包后的 js 会自动生成后缀为 .js 和 .map 的文件</p><pre><code> js文件: 是经过压缩加密的，如果运行时报错，输出的错误信息无法准确定位到哪里的代码报 错。 map文件：文件比较大， 代码未加密，可以准确的输出是哪一行哪一列有错。</code></pre><p>lint 使用 Eslint 进行检查并修复代码的规范 </p><p>​    比如: 将 main.js 中的格式多加个空格 ，执行 npm run lint 后它会自动的去除多余空格 。</p><p><strong>执行命令方式：</strong></p><pre class="line-numbers language-none"><code class="language-none">pm run serve  //运行npm run build  //打包npm run lint  //进行检查并修复代码的规范<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="脚手架项目结构"><a href="#脚手架项目结构" class="headerlink" title="脚手架项目结构"></a>脚手架项目结构</h2><pre class="line-numbers language-none"><code class="language-none">|-- node_modules: 存放下载依赖的文件夹|-- public: 存放不会变动静态的文件，它与src/assets的区别在于，public目录中的文件不被webpack打包处理，会原样拷贝到dist目录下|-- index.html: 主页面文件|-- favicon.ico: 在浏览器上显示的图标|-- src: 源码文件夹|-- assets: 存放组件中的静态资源|-- components: 存放一些公共组件|-- views: 存放所有的路由组件|-- App.vue: 应用根主组件|-- main.js: 应用入口 js|-- .browserslistrc: 指定了项目可兼容的目标浏览器范围, 对应是package.json 的 browserslist选项|-- .eslintrc.js: eslint相关配置|-- .gitignore: git 版本管制忽略的配置|-- babel.config.js: babel 的配置,即ES6语法编译配置|-- package-lock.json: 用于记录当前状态下实际安装的各个包的具体来源和版本号等, 保证其他人在 npm install 项目时大家的依赖能保证一致.|-- package.json: 项目基本信息,包依赖配置信息等|-- postcss.config.js: postcss一种对css编译的工具，类似babel对js的处理|-- README.md: 项目描述说明的 readme 文件<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="运行报错："><a href="#运行报错：" class="headerlink" title="运行报错："></a>运行报错：</h2><p><img src="C:\Users\hhxx\AppData\Roaming\Typora\typora-user-images\image-20220412174925934.png" alt="image-20220412174925934"></p><p><strong>解决：</strong></p><p>加入：lintOnSave:false   //关闭语法检查</p><p><img src="C:\Users\hhxx\AppData\Roaming\Typora\typora-user-images\image-20220412175006681.png" alt="image-20220412175006681"></p><h2 id="Vue-use-与Vue-mixin"><a href="#Vue-use-与Vue-mixin" class="headerlink" title="Vue.use()与Vue.mixin()"></a>Vue.use()与Vue.mixin()</h2><h3 id="main-vue"><a href="#main-vue" class="headerlink" title="main.vue:"></a>main.vue:</h3><pre class="line-numbers language-none"><code class="language-none">import Vue from "vue";import App from "./App.vue"import aa from "./event"import plugin from "./plugin"Vue.config.productionTip=falseVue.mixin(aa)  //全局,公用方法Vue.use(plugin)new Vue({    render:h=&gt;h(App)}).$mount("#app")  //el:"#app"/** * render:function(h){ * 这个h是一个函数，使用typeof就就知道了 * 第一个参数：标签元素，第二个参数：标签内容 *  h("h1","h1中的内容") * } */<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="plugin"><a href="#plugin" class="headerlink" title="plugin:"></a>plugin:</h3><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">default</span><span class="token punctuation">{</span>    <span class="token function">install</span><span class="token punctuation">(</span><span class="token parameter">Vue</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">//加载哪个对象原型链,这样只要在这个实例中就能够使用这个方法</span>        <span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">play</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span>z<span class="token punctuation">,</span>y</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>            <span class="token function">alert</span><span class="token punctuation">(</span>x<span class="token operator">+</span>z<span class="token operator">+</span>y<span class="token punctuation">)</span>        <span class="token punctuation">}</span>            <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="event："><a href="#event：" class="headerlink" title="event："></a>event：</h3><p>mixin设置公用方法</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">default</span><span class="token punctuation">{</span>    <span class="token literal-property property">methods</span><span class="token operator">:</span> <span class="token punctuation">{</span>        <span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token function">alert</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>msg<span class="token punctuation">)</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="封装axios"><a href="#封装axios" class="headerlink" title="封装axios"></a>封装axios</h2><p>注意：要访问的如json文件要防止public文件夹下才能访问</p><h3 id="创建axion"><a href="#创建axion" class="headerlink" title="创建axion"></a>创建axion</h3><p>在src下创建一个utils文件夹，里面创建一个requset.js放入一下代码</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">import</span> axios <span class="token keyword">from</span> <span class="token string">"axios"</span><span class="token keyword">const</span> request <span class="token operator">=</span> axios<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token comment">//创建axios</span>    <span class="token literal-property property">baseURL</span><span class="token operator">:</span><span class="token string">"/dev"</span><span class="token punctuation">,</span>  <span class="token comment">//也就是根基会在location:8080后加上</span>    <span class="token literal-property property">timeout</span><span class="token operator">:</span><span class="token number">500</span>  <span class="token comment">//过期时间</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token keyword">export</span> <span class="token keyword">default</span> request<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="使用创建的axion进行配置访问地址与方式"><a href="#使用创建的axion进行配置访问地址与方式" class="headerlink" title="使用创建的axion进行配置访问地址与方式"></a>使用创建的axion进行配置访问地址与方式</h3><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">import</span> request <span class="token keyword">from</span> <span class="token string">"../Utils/request"</span><span class="token punctuation">;</span><span class="token comment">// request({</span><span class="token comment">//     method:"get",//访问方式</span><span class="token comment">//     url:"/tech.json"//访问url</span><span class="token comment">// }).then(response =&gt; {</span><span class="token comment">//     console.log(response.data);</span><span class="token comment">// })</span><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>    <span class="token function">getList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">const</span> axios <span class="token operator">=</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">{</span>            <span class="token literal-property property">method</span><span class="token operator">:</span><span class="token string">"get"</span><span class="token punctuation">,</span>            <span class="token literal-property property">url</span><span class="token operator">:</span><span class="token string">"http://localhost:8081/tech.json"</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> axios<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="调用："><a href="#调用：" class="headerlink" title="调用："></a>调用：</h3><p>在控制台中查看是否拥有</p><pre class="line-numbers language-vue" data-language="vue"><code class="language-vue">&lt;template&gt;  &lt;div id="app"&gt;      !!!!!    &lt;/div&gt;&lt;/template&gt;&lt;script&gt;    import text from "./api/text"    export default {  name: "App",  data () {    return {          }  },created() {        text.getList().then(response=&gt;{      console.log(response.data)    })  } }&lt;/script&gt;&lt;style &gt;&lt;/style&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="vue跨域访问："><a href="#vue跨域访问：" class="headerlink" title="vue跨域访问："></a>vue跨域访问：</h2><p>使用代理 proxy：</p><p>当axios的url开头带有/dev-axios的话就会被拦截下来，并修改前面的http ip port 改为target上的 </p><p>pathRewrite：替换</p><p>“^/dev-axios”:””  url开头为/dev-axios将这端改为“”空</p><p>如：<a href="http://localhost:8080/dev-axios/aa.json">http://localhost:8080/dev-axios/aa.json</a>   –&gt;  <a href="http://localhost:8081/aa.json">http://localhost:8081/aa.json</a></p><pre class="line-numbers language-none"><code class="language-none">proxy:{      'dev-axios':{        target:"http://localhost:8081",        changeOrigin:true,        pathRewrite:{          "^/dev-axios":""        }      }    }<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>完整示例配置：</strong></p><pre class="line-numbers language-none"><code class="language-none">module.exports = {  devServer:{    port:8080 //修改端口号，如果当前端口被占用了，会在原来端口上加1    ,open:true  //自动打开浏览器 ，需要配置协议才能正常使用,下面就是配置协议    ,https:false      ,host:"localhost",   //注意要用双引号包裹，127.0.0.1也行    proxy:{  //配置代理      'dev-axios':{  //url中带有dev-axios就会        target:"http://localhost:8081",        changeOrigin:true,        pathRewrite:{          "^/dev-axios":""        }      }    }  },  transpileDependencies: true,  lintOnSave:false  //关闭语法检查};<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="全局变量："><a href="#全局变量：" class="headerlink" title="全局变量："></a>全局变量：</h2><p><img src="C:\Users\hhxx\AppData\Roaming\Typora\typora-user-images\image-20220422160454062.png" alt="image-20220422160454062"></p><p>使用全局变量可在全局代替</p><p>如：</p><p>属性名称的需要使用[]包裹，值的话就不需要</p><pre class="line-numbers language-none"><code class="language-none">module.exports = {  devServer:{    proxy:{      [process.env.VUE_APP_BASE_API]:{        target:process.env.VUE_APP_SERVER_URL,        changeOrigin:true,        pathRewrite:{          ["^"+process.env.VUE_APP_BASE_API]:""        }      }    }  },  transpileDependencies: true,  lintOnSave:false  //关闭语法检查};<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="Vuex状态管理："><a href="#Vuex状态管理：" class="headerlink" title="Vuex状态管理："></a>Vuex状态管理：</h2><h3 id="安装："><a href="#安装：" class="headerlink" title="安装："></a>安装：</h3><pre class="line-numbers language-none"><code class="language-none">npm install vuex@3<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="创建Vuex"><a href="#创建Vuex" class="headerlink" title="创建Vuex"></a>创建Vuex</h3><pre class="line-numbers language-none"><code class="language-none">import Vue from 'vue'import Vuex, { Store } from 'vuex'Vue.use(Vuex)//对state里面的数据进行加工const getters = {    bigsum(state){        return state.sum*10    }}const actions = {    add(content,value){        console.log("content:"+content,"value:"+value)        content.commit("ADD",value)    },    minus(content,value){        content.commit("MINUS",value)    },    odd(content,value){        if(content.state.sum%2){            content.commit("ODD",value)        }        console.log(content)            },    time(content,value){        setTimeout(()=&gt;{            content.commit("TIME",value)           },1000)    }}const mutations = {    ADD(state,value){        console.log("state:"+state+"value:"+value)        state.sum+=value;    },    MINUS(state,value){        state.sum-=value;    },    ODD(state,value){        state.sum+=value;    } ,    TIME(state,value){        state.sum+=value;    } }//存放共享数据const state = {    sum:0}export default new Store({    actions,    mutations,    state,    getters})<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="main-js引用："><a href="#main-js引用：" class="headerlink" title="main.js引用："></a>main.js引用：</h3><pre class="line-numbers language-none"><code class="language-none">import Vue from "vue";import App from "./App.vue";import router from "./router";import store from './store'Vue.config.productionTip = false;const vm= new Vue({  router,  render: (h) =&gt; h(App),  store}).$mount("#app");console.log(vm)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="组件使用："><a href="#组件使用：" class="headerlink" title="组件使用："></a>组件使用：</h3><pre class="line-numbers language-none"><code class="language-none">&lt;template&gt;  &lt;div class="home"&gt;     &lt;!-- &lt;h2&gt;和为：{{sum}}&lt;/h2&gt; --&gt;    &lt;h2&gt;和为：{{$store.state.sum}}&lt;/h2&gt;    &lt;!-- &lt;h2&gt;放大10倍：{{$store.state.bigsum}}&lt;/h2&gt; --&gt;    &lt;h2&gt;放大10倍：{{bigsum}}&lt;/h2&gt;    &lt;select v-model="n" &gt;      &lt;option :value="1"&gt;1&lt;/option&gt;       &lt;option :value="2"&gt;2&lt;/option&gt;        &lt;option :value="3"&gt;3&lt;/option&gt;    &lt;/select&gt;    &lt;button @click="add(n)"&gt;+&lt;/button&gt;    &lt;button @click="minus(n)"&gt;-&lt;/button&gt;    &lt;button @click="odd(n)"&gt;奇数&lt;/button&gt;    &lt;button @click="time(n)"&gt;延迟&lt;/button&gt;  &lt;/div&gt;&lt;/template&gt;&lt;script&gt;// @ is an alias to /srcimport HelloWorld from "@/components/HelloWorld.vue";import {mapState,mapGetters,mapMutations,mapActions} from 'vuex'  //自动简易vuex引用export default {  name: "HomeView",  components: {    },data() {    return {      n:1    }  },  computed:{    // sum(){    //   return this.$store.state.sum;    // }    // ...mapState({sum:"sum"})     ...mapState(["sum"]), //推荐使用    ...mapGetters(["bigsum"]) //推荐使用  }  ,methods: {    // add(){     //   this.$store.dispatch("add",this.n)          // },    // minus(){    // this.$store.dispatch("minus",this.n)    // },    ...mapMutations({add:"ADD",minus:"MINUS"}),    // ...mapMutations(["ADD"]), //注意生成的方法是大写的 // add(value){  生成的方法，需要传递参数    //   this.$store.dispatch("add",value)          // },    // odd(){          //    this.$store.dispatch("odd",this.n)          // },    ...mapActions({odd:"odd"}),    // time(){         //    this.$store.dispatch("time",this.n)          // }    ...mapActions(["time"])  },};&lt;/script&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Vue </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 前端 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Vue基本使用</title>
      <link href="/2022/03/29/Vue%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/"/>
      <url>/2022/03/29/Vue%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<h1 id="Vue"><a href="#Vue" class="headerlink" title="Vue:"></a>Vue:</h1><h2 id="计算函数："><a href="#计算函数：" class="headerlink" title="计算函数："></a>计算函数：</h2><p>可用于观察数据变化使用就调用</p><p>默认是get</p><p>设置get于set需要这样设置</p><pre class="line-numbers language-none"><code class="language-none">data () {    return {      isALL:false    }  },computed:{    checkedAll:{          get(){            return this.getChecked===this.getlength          },          set(isAll){  //参数为get返回的值，要有行为才会调用             this.List.forEach(element =&gt; {               element.completed=isAll           });          }        }}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>computed中定义的函数，在computed中定义的函数的调用时机是：当页面引用了vue data关键字的属性，并且这些属性发生改变的时候，如果computed中定义的函数也依赖了这些改变的属性，那么computed中定义的函数才会被执行。也就是computed中定义的函数被Vue框架回调的条件是，1.函数内依赖了vue的属性，2.这些属性发生了改变，3.这些属性被页面引用。这三个条件同时满足，才会触发computed中定义的某个函数的回调。而且和methods定义的函数，其调用语法也是不一样的，computed中定义的函数，调用的时候后面不能有小括号，类似属性的调用。</p><p><strong>示例：</strong></p><pre class="line-numbers language-vue" data-language="vue"><code class="language-vue">&lt;script&gt;export default {    name: "UserFooter",  data () {    return {      isALL:true    }  },  props:{    List:Array,    delcheck:Function,  },  components: {},  methods: {     },  computed:{    getChecked(){       let i=0;       this.List.forEach(element =&gt; {         if(element.completed==true){           i++;         }               });        return i;    },    getlength(){      return this.List.length    }，      checkedAll:{      get(){        return this.getChecked===this.getlength      },      set(isAll){         this.List.forEach(element =&gt; {           element.completed=isAll       });      }    }  }  }&lt;/script&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="组件化："><a href="#组件化：" class="headerlink" title="组件化："></a>组件化：</h2><p>组件（component） 是 Vue.js 最强大的功能之一。 Vue 中的组件化开发就是把网页的重复代码抽取出来 ，封装成一个个可复用的视图组件，然后将这些视图组件拼 接到一块就构成了一个完整的系统。</p><p>这种方式非常灵活，可以极大的提高我们开发和维护的效率。</p><p>提高开发效率，增强可维护性，更好的去解决软件上的高耦合、低内聚、无重用的3大代码问题</p><p>通常一套系统会以一棵嵌套的组件树的形式来组织：</p><p><img src="https://s2.loli.net/2022/04/14/s1TcxnEBkKrC6iv.png" alt="image-20220328234834859"></p><h3 id="组件的基本使用"><a href="#组件的基本使用" class="headerlink" title="组件的基本使用"></a>组件的基本使用</h3><p>为了能在模板中使用，这些组件必须先注册以便 Vue 能够识别。</p><p> 有两种组件的注册类型：全局注册和局部注册</p><h4 id="全局注册"><a href="#全局注册" class="headerlink" title="全局注册"></a>全局注册</h4><p>全局注册之后，可以在任何新创建的 Vue 实例 (new Vue) 的模板中使用</p><pre class="line-numbers language-none"><code class="language-none">Vue.component('组件名',{ template: '定义组件模板'， data: function(){ //data 选项在组件中必须是一个函数 return {} } //其他选项：methods})<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="局部注册："><a href="#局部注册：" class="headerlink" title="局部注册："></a>局部注册：</h4><pre class="line-numbers language-none"><code class="language-none">new Vue({    el:"#app",    components:{      App  //这里是导入了js包的    },template:" &lt;app&gt;&lt;/app&gt;"  //表示这个标签将会代替我们上面的入口，但App里面还有个入口,将会使用那个入口，这个页面的就会清除  })<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-none"><code class="language-none">;(function(){    window.App={        template:` &lt;div id="app"&gt;        &lt;!--头部导航区域--&gt;            &lt;app-navber&gt;&lt;/app-navber&gt;                &lt;!--核心区域:分左右两边--&gt;        &lt;div class="container-fluid"&gt;            &lt;div class="row"&gt;                        &lt;!--左边菜单栏区域--&gt;            &lt;app-left&gt;&lt;/app-left&gt;                            &lt;!--右边主页面区域: 分上下两个区域--&gt;            &lt;app-home&gt;            &lt;h1 class="page-header" slot="dashboard"&gt;Dashboard111&lt;/h1&gt;            &lt;h2 class="sub-header" slot="Section"&gt;Section title111&lt;/h2&gt;            &lt;/app-home&gt;            &lt;/div&gt;         &lt;/div&gt;        &lt;/div&gt;`,        components:{            AppNavber,            AppLeft,            AppHome        }    }})()<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="使用案例："><a href="#使用案例：" class="headerlink" title="使用案例："></a>使用案例：</h4><p>链接：<a href="https://pan.baidu.com/s/1uaCpnWoFYabffIoZwE4gGA">https://pan.baidu.com/s/1uaCpnWoFYabffIoZwE4gGA</a><br>提取码：H03Z</p><h3 id="组件之间传递数据："><a href="#组件之间传递数据：" class="headerlink" title="组件之间传递数据："></a>组件之间传递数据：</h3><h4 id="父组件传递给子组件"><a href="#父组件传递给子组件" class="headerlink" title="父组件传递给子组件"></a>父组件传递给子组件</h4><p>使用props  </p><p><strong>props有三种形式：</strong></p><p>数组：</p><pre class="line-numbers language-none"><code class="language-none">props:["hobbies"]<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>对象：</p><pre class="line-numbers language-none"><code class="language-none">props:{         index:{type:Number,         required:true},     }<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>对象：</p><pre class="line-numbers language-none"><code class="language-none">props:{         emp:Object,         deleteEmp:Function,              }<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="使用示例："><a href="#使用示例：" class="headerlink" title="使用示例："></a><strong>使用示例：</strong></h5><h6 id="父组件："><a href="#父组件：" class="headerlink" title="父组件："></a><strong>父组件：</strong></h6><p>在组件标签中使用 :名称=”传递对象“  即可</p><p>&lt;dashboard :hobbies=”hobbies” @delete_hob=”deleteHob”&gt;</p><pre class="line-numbers language-none"><code class="language-none">;(function(){    window.AppHome={        template:`        &lt;div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main"&gt;        &lt;!--右边上半区域  &lt;h1 class="page-header"&gt;Dashboard&lt;/h1&gt;--&gt;       &lt;slot name="dashboard"&gt;&lt;/slot&gt;        &lt;dashboard :hobbies="hobbies" @delete_hob="deleteHob"&gt;&lt;/dashboard&gt;        &lt;!--右边下半区域  &lt;h2 class="sub-header"&gt;Section title&lt;/h2&gt;--&gt;       &lt;slot name="Section"&gt;&lt;/slot&gt;        &lt;home-list :empList="empList" :deleteEmp="deleteEmp" &gt;&lt;/home-list&gt;          &lt;/div&gt;`,    components:{        Dashboard,        HomeList    },data() {        return {            hobbies:["1111","2222","3333","4444"],            empList:[{id:1,name:"某某某1",salary:12535,age:15},            {id:2,name:"某某某2",salary:12535,age:15},            {id:3,name:"某某某3",salary:12535,age:15},            {id:4,name:"某某某4",salary:12535,age:15}]        }    },methods: {        deleteEmp(index){            //删除  从第几个开始，删除几个            this.empList.splice(index,1);        },        deleteHob(index){z            this.hobbies.splice(index,1)            //要传递的PubSub.subscribe方法，参数  1，方法名   2,  数据            PubSub.publish("pub",1)        }    },    }})()<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h6 id="子组件："><a href="#子组件：" class="headerlink" title="子组件："></a>子组件：</h6><p>使用 props： 接收产生，接收有上面说的三种方式，接收后就可以使用了</p><pre class="line-numbers language-none"><code class="language-none">;(function(){    window.Dashboard={        template:`        &lt;div class="row placeholders"&gt;          &lt;div v-for="(item,index) in hobbies"  class="col-xs-6 col-sm-3 placeholder"&gt;            &lt;img src="data:image/gif;base64,R0lGODlhAQABAIAAAHd3dwAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" width="200" height="200" class="img-responsive" alt="Generic placeholder thumbnail"&gt;            &lt;h4 &gt;{{item}}&lt;/h4&gt;            &lt;a href="#" @click="del(index)"&gt; 删除&lt;/a&gt;            &lt;span class="text-muted"&gt;Something else&lt;/span&gt;          &lt;/div&gt;        &lt;/div&gt;`,        props:["hobbies"]  //获取父组件的参数        ,methods: {          del(index){            this.$emit("delete_hob",index)            }        },    }})()<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="Vue-实例生命周期"><a href="#Vue-实例生命周期" class="headerlink" title="Vue 实例生命周期"></a>Vue 实例生命周期</h2><h3 id="介绍："><a href="#介绍：" class="headerlink" title="介绍："></a>介绍：</h3><p><strong>生命周期分为三大阶段：初始化显示、更新显示、销毁Vue实例</strong></p><p><strong>初始化阶段的钩子函数：</strong></p><p> beforeCreate() 实例创建前：数据和模板均未获取到</p><p>created() 实例创建后: 最早可访问到 data 数据，但模板未获取到</p><p>beforeMount() 数据挂载前：模板已获取到，但是数据未挂载到模板上。</p><p>mounted() 数据挂载后： 数据已挂载到模板中</p><p><strong>更新阶段的钩子函数：</strong></p><p>beforeUpdate() 模板更新前：data 改变后，更新数据模板前调用</p><p>updated() 模板更新后：将 data 渲染到数据模板中</p><p><strong>销毁阶段的钩子函数：</strong></p><p>beforeDestroy() 实例销毁前</p><p> destroyed() 实例销毁后</p><h3 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h3><p>修改数据是在控制台修改</p><pre class="line-numbers language-none"><code class="language-none">&lt;script&gt;             const vm=   new Vue({            el:"#app",            data:{                msg:"生命周期"            },            beforeCreate() {// 实例创建前                //模板和数据均为获取到                console.log("beforeCreate",this.$el,this.$data);            },            created() {// 实例创建后                 //数据成功获取到，但模板未获取到 ,ajax一般在created声明周期中                 console.log("created",this.$el,this.$data);            },            beforeMount() {//数据挂载前                //模板与数据都都获取到了，但模板没有挂载数据                console.log("beforeMount",this.$el,this.$data);            },            mounted() {//数据挂载后                //模板与数据都都获取到了，模板也挂载了数据                console.log("mounted",this.$el,this.$data);            },            beforeUpdate() {//数据更新之前                //数据没有进行更新，data 改变后，更新数据模板前调用                console.log("beforeUpdate",this.$el.innerHTML,this.$data);            },            updated() {//数据更新之后                //数据进行更新了，将 data 渲染到数据模板中                console.log("updated",this.$el.innerHTML,this.$data);            },            beforeDestroy() {//实例销毁之前                console.log("beforeDestroy",this.$el.innerHTML,this.$data);            },            destroyed() {//实例销毁之后                console.log("destroyed");            },        })        //销毁实例        vm.$destroy();    &lt;/script&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="axios通讯"><a href="#axios通讯" class="headerlink" title="axios通讯"></a>axios通讯</h2><p>一般放在created() 实例创建后中</p><pre class="line-numbers language-none"><code class="language-none">axios.get("db.json").then(response =&gt;{                    this.arr=response.data                }).catch(error=&gt;{                    console.log(error);                }).finally(()=&gt;{                    console.log("无论有没有异常如何都会走")                })<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="路由"><a href="#路由" class="headerlink" title="路由"></a>路由</h2><h3 id="什么是路由"><a href="#什么是路由" class="headerlink" title="什么是路由"></a>什么是路由</h3><p>Vue Router 是 Vue.js 官方的路由管理器。它和 Vue.js 的核心深度集成，让构建单页面应用变得非常简单。 通过根据不同的请求路径，切换显示不同组件进行渲染页面。</p><h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><p><strong>安装路由</strong></p><pre class="line-numbers language-none"><code class="language-none">npm install vue-router@2.8.1<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>导入vue-router.js</p><pre class="line-numbers language-none"><code class="language-none">&lt;script src="./node_modules/vue/dist/vue.js"&gt;&lt;/script&gt;&lt;script src="./node_modules/vue-router/dist/vue-router.js"&gt;&lt;/script&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h4 id="router-link标签"><a href="#router-link标签" class="headerlink" title="router-link标签"></a>router-link标签</h4><p>tag：转换后的标签，默认a标签</p><p>to：跳转路由的模板加载到 router-view</p><p>exact：精准查询    这样就必须要完整的路径才可以访问</p><pre class="line-numbers language-none"><code class="language-none">&lt;router-link tag="li" to="/" exact&gt;&lt;a&gt;首页&lt;/a&gt;&lt;/router-link&gt;&lt;router-link tag="li" to="/rightHome" exact&gt;&lt;a&gt;新闻&lt;/a&gt;&lt;/router-link&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h4 id="router-view标签"><a href="#router-view标签" class="headerlink" title="router-view标签"></a>router-view标签</h4><p>router-link跳转模板会替换掉router-view，（里面可以放替换标签，也就是插入）</p><pre class="line-numbers language-none"><code class="language-none">&lt;router-view&gt;            &lt;h1 class="page-header" slot="dashboard"&gt;Dashboard111&lt;/h1&gt;            &lt;h2 class="sub-header" slot="Section"&gt;Section title111&lt;/h2&gt;        &lt;/router-view&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h4 id="路由（包含子路由）："><a href="#路由（包含子路由）：" class="headerlink" title="路由（包含子路由）："></a>路由（包含子路由）：</h4><p>linkActiveClass：router-link点击后的会添加的class，当点击别的就会去到并为另一个赋值上</p><p>routes：配置路由</p><p>​    path ：router-link点击的路径</p><p>​    component ： 替换模板</p><p>children ：子路由（在父路由包含的模板内放入<router-view>）</router-view></p><pre class="line-numbers language-none"><code class="language-none">;(function(){    window.router=new VueRouter({      // 点击后添加的class      linkActiveClass:'active',        routes:[              {path:"/",component:AppHome},              {path:"/rightHome",component:RigthHome                ,children:[                   {path:"/rightHome/sports",component:Sports},                   {path:"/rightHome/Tech",component:Tech},                   {path:"",redirect:'/rightHome/sports'} //默认访问模板                ]              }          ]      })        })()<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="缓存："><a href="#缓存：" class="headerlink" title="缓存："></a>缓存：</h4><ol><li><p>默认情况下，当路由组件被切换后组件实例会销毁，当切换回来时实例会重新创建。</p></li><li><p>如果可以缓存路由组件实例，切换后不用重新加载数据，可以提高用户体验。</p></li></ol><p><keep-alive> 可缓存渲染的路由组件实例</keep-alive></p><p>注意就可以缓存模板了，模板内的如input的数据也可以缓存到</p><pre class="line-numbers language-none"><code class="language-none">&lt;keep-alive&gt;             &lt;router-view&gt;             &lt;h1 class="page-header" slot="dashboard"&gt;Dashboard111&lt;/h1&gt;             &lt;h2 class="sub-header" slot="Section"&gt;Section title111&lt;/h2&gt;             &lt;/router-view&gt;         &lt;/keep-alive&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>切换回页面后返回这个页面数据都还在，模板不会被销毁</p><p><img src="https://s2.loli.net/2022/04/14/35uAvRYtq6SfkZ1.png" alt="image-20220401171841177"></p><h4 id="路由获取动态的数据"><a href="#路由获取动态的数据" class="headerlink" title="路由获取动态的数据"></a>路由获取动态的数据</h4><p><strong>这些都是声明式路由</strong></p><h5 id="组件："><a href="#组件：" class="headerlink" title="组件："></a>组件：</h5><pre class="line-numbers language-none"><code class="language-none">;(function(){    const template = `     &lt;!--体育栏目 --&gt;  &lt;div&gt;      &lt;ul&gt;                &lt;li v-for="(item,index) in sports" :keys="item.id" &gt;        &lt;!-- :to="'/sports/sprotsDetail/'+item.id" 要动态获取数据拼接，需要在属性前加上:并且路由中的值也需要动态获取 --&gt;            &lt;router-link  :to="'/sports/sprotsDetail/'+item.id" v-text="item.title"&gt;&lt;/router-link&gt;        &lt;/li&gt;      &lt;/ul&gt;      &lt;router-view&gt;&lt;/router-view&gt;  &lt;/div&gt;  `;  window.Sports = {      template,      data() {          return {              sports:[]          }      },methods: {        getdata(){            axios.get("sport.json").then(response =&gt;{                this.sports=response.data            })        }      },created() {          this.getdata();                },  }})()<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="路由："><a href="#路由：" class="headerlink" title="路由："></a>路由：</h5><pre class="line-numbers language-none"><code class="language-none">;(function(){    window.router=new VueRouter({      // 点击后添加的class      linkActiveClass:'active',        routes:[              {path:"/",component:AppHome},              {path:"/rightHome",component:RigthHome                ,children:[                   {path:"/rightHome/sports",component:Sports,                      children:[                      ///sports/sprotsDetail/:id    :id可获取到我们之前的动态添加的数据，并添加                        {path:"/sports/sprotsDetail/:id",component:SprotsDetail},                      ]                    },                   {path:"/rightHome/Tech",component:Tech,children:[                     {path:"/Tech/Detail/:id",component:TechDetail}                   ]},                   {path:"",redirect:'/rightHome/sports'}                ]              }          ]      })        })()<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="结果："><a href="#结果：" class="headerlink" title="结果："></a>结果：</h5><p><img src="https://s2.loli.net/2022/04/14/4MW8i3lnuwTFeQv.png" alt="image-20220408170910935"></p><h3 id="编程式路由"><a href="#编程式路由" class="headerlink" title="编程式路由"></a>编程式路由</h3><h4 id="声明式与编程式路由"><a href="#声明式与编程式路由" class="headerlink" title="声明式与编程式路由"></a>声明式与编程式路由</h4><p><img src="https://s2.loli.net/2022/04/14/P3O4iaKYlFm2WSp.png" alt="image-20220408171138601"></p><h4 id="编程式路由导航-API"><a href="#编程式路由导航-API" class="headerlink" title="编程式路由导航 API"></a>编程式路由导航 API</h4><pre class="line-numbers language-none"><code class="language-none">this.$router.push(path) 相当于点击路由链接(后退1步,会返回当前路由界面)this.$router.replace(path) 用新路由替换当前路由(后退1步,不可返回到当前路由界面)this.$router.back() 后退回上一个记录路由this.$router.go(n) 参数 n 指定步数this.$router.go(-1) 后退回上一个记录路由this.$router.go(1) 向前进下一个记录路由<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="示例：-1"><a href="#示例：-1" class="headerlink" title="示例："></a>示例：</h4><h5 id="路由：-1"><a href="#路由：-1" class="headerlink" title="路由："></a>路由：</h5><p>路由还是要像原来那么些，不变</p><pre class="line-numbers language-none"><code class="language-none">;(function(){    window.router=new VueRouter({      // 点击后添加的class      linkActiveClass:'active',        routes:[              {path:"/",component:AppHome},              {path:"/rightHome",component:RigthHome                ,children:[                   {path:"/rightHome/sports",component:Sports,                      children:[                        {path:"/sports/sprotsDetail/:id",component:SprotsDetail},2                      ]                    },                   {path:"/rightHome/Tech",component:Tech,children:[                     {path:"/Tech/Detail/:id",component:TechDetail}                   ]},                   {path:"",redirect:'/rightHome/sports'}                ]              }          ]      })        })()<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="显示代码："><a href="#显示代码：" class="headerlink" title="显示代码："></a>显示代码：</h5><pre class="line-numbers language-none"><code class="language-none">;(function(){    const template = `      &lt;!--科技栏目--&gt;  &lt;div&gt;      &lt;ul &gt;          &lt;li v-for="item in array" :keys="item.id"&gt;              &lt;span&gt;{{item.title}} &lt;/span&gt;              &lt;!--不需要使用router-link，直接使用方法--&gt;              &lt;button @click="TechPush(item.id)" class="btn  btn-default btn-xs"&gt;查看(Push)&lt;/button&gt;&amp;nbsp;              &lt;button  @click="TechReplace(item.id)" class="btn btn-default btn-xs"&gt;查看(replace)&lt;/button&gt;          &lt;/li&gt;          &lt;button @click="$router.back()"&gt;返回&lt;/button&gt;          &lt;button @click="$router.go(-1)"&gt;后退1&lt;/button&gt;          &lt;button @click="$router.go(1)"&gt;前进1&lt;/button&gt;                &lt;/ul&gt;      &lt;router-view&gt;&lt;/router-view&gt;        &lt;/div&gt; `;  window.Tech = {      template,      data() {          return {              array:[]          }      },methods: {        getdata(){                    axios.get("tech.json").then(response =&gt;{                this.array=response.data            })        },        TechPush(id){            this.$router.push(`/Tech/Detail/${id}`)        },        TechReplace(id){            this.$router.replace(`/Tech/Detail/${id}`)        }      },created() {          this.getdata();                },  }})()<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="reduce循环"><a href="#reduce循环" class="headerlink" title="reduce循环"></a>reduce循环</h2><p>List是个数组</p><p>数组有几个，（pru,thi)=&gt;{}方法就会循环几次</p><p>reduce参数：</p><p>1，循环方法</p><p>​        参数：</p><p>​                1，返回结果值</p><p>​                2，当前循环到的值</p><p>2，返回结果（这个结果是可变的，参1的方法的返回值就会替换参数2原先的值）</p><pre class="line-numbers language-none"><code class="language-none">let aaa= this.List.reduce((pru,thi)=&gt;{  return pru+1},0)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="深度监听："><a href="#深度监听：" class="headerlink" title="深度监听："></a>深度监听：</h2><p>深度监听的话，集合中的对象属性有改变也能监听到</p><pre class="line-numbers language-vue" data-language="vue"><code class="language-vue">watch:{                 List:{          handler:function(items){          localStore.save(items)          },         deep:true //深度监听，数组里的对象有东西改变也会触发handler       }   }<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Vue </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 前端 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RabiitMQ</title>
      <link href="/2022/03/25/RabiitMQ/"/>
      <url>/2022/03/25/RabiitMQ/</url>
      
        <content type="html"><![CDATA[<h1 id="RabbitMQ"><a href="#RabbitMQ" class="headerlink" title="RabbitMQ"></a>RabbitMQ</h1><h2 id="1-1-1-什么是MQ"><a href="#1-1-1-什么是MQ" class="headerlink" title="1.1.1. 什么是MQ"></a>1.1.1. 什么是MQ</h2><p>MQ(message queue)，从字面意思上看，本质是个队列，FIFO 先入先出，只不过队列中存放的内容是 message 而已，还是一种跨进程的通信机制，用于上下游传递消息。在互联网架构中，MQ 是一种非常常见的上下游“逻辑解耦+物理解耦”的消息通信服务。使用了 MQ 之后，消息发送上游只需要依赖 MQ，不用依赖其他服务。 </p><h2 id="1-1-2-为什么要用MQ"><a href="#1-1-2-为什么要用MQ" class="headerlink" title="1.1.2. 为什么要用MQ"></a>1.1.2. 为什么要用MQ</h2><p>1.流量消峰 </p><p>举个例子，如果订单系统最多能处理一万次订单，这个处理能力应付正常时段的下单时绰绰有余，正常时段我们下单一秒后就能返回结果。但是在高峰期，如果有两万次下单操作系统是处理不了的，只能限制订单超过一万后不允许用户下单。使用消息队列做缓冲，我们可以取消这个限制，把一秒内下的订单分散成一段时间来处理，这时有些用户可能在下单十几秒后才能收到下单成功的操作，但是比不能下单的体验要好。 </p><p>2.应用解耦 </p><p>以电商应用为例，应用中有订单系统、库存系统、物流系统、支付系统。用户创建订单后，如果耦合调用库存系统、物流系统、支付系统，任何一个子系统出了故障，都会造成下单操作异常。当转变成基于消息队列的方式后，系统间调用的问题会减少很多，比如物流系统因为发生故障，需要几分钟来修复。在这几分钟的时间里，物流系统要处理的内存被缓存在消息队列中，用户的下单操作可以正常完成。当物流系统恢复后，继续处理订单信息即可，中单用户感受不到物流系统的故障，提升系统的可用性。</p><p><img src="https://s2.loli.net/2022/04/14/PUA2BNTktKqFE7p.png" alt="image-20220325095640537"></p><p>3.异步处理<br>有些服务间调用是异步的，例如A调用B，B需要花费很长时间执行，但是A需要知道B什么时候可以执行完，以前一般有两种方式，A过一段时间去调用B的查询api查询。或者A提供一个callback api,B执行完之后调用api通知A服务。这两种方式都不是很优雅，使用消息总线，可以很方便解决这个问题,A调用B服务后，只需要监听B处理完成的消息，当B处理完成后，会发送一条消息给MQ，MQ会将此消息转发给A服务。这样A服务既不用循环调用B的查询api，也不用提供callback api。同样B服务也不用做这些操作。A服务还能及时的得到异步处理成功的消息。</p><p><img src="https://s2.loli.net/2022/04/14/LAx2nasguGfTRqK.png" alt="image-20220325095845337"></p><h2 id="RabbitMQ工作原理："><a href="#RabbitMQ工作原理：" class="headerlink" title="RabbitMQ工作原理："></a>RabbitMQ工作原理：</h2><p>这张图就是RabbitMQ的工作原理了，我们的代码都会以这个方式进行编码，</p><p><img src="https://s2.loli.net/2022/04/14/msSCn9D3fjh4QZH.png" alt="image-20220326144223717"></p><p><strong>Broker</strong>:接收和分发消息的应用，RabbitMQ Server 就是 Message Broker<br><strong>Virtual host</strong>:出于多租户和安全因素设计的，把 AMQP的基本组件划分到一个虚拟的分组中，类似于网络中的namespace概念。当多个不同的用户使用同一个RabbitMQ server提供的服务时，可以划分出多个vhost，每个用户在自己的vhost创建exchange / queue 等<br><strong>Connection</strong> : publisher / consumer和broker之间的TCP连接<br><strong>Channel</strong>:如果每一次访问RabbitMQ都建立一个 Connection，在消息量大的时候建立TCP<br>Connection的开销将是巨大的，效率也较低。Channel是在 connection 内部建立的逻辑连接，如果应用程序支持多线程，通常每个thread创建单独的channel进行通讯，AMQP method包含了channel id帮助客户端和message broker识别channel，所以 channel之间是完全隔离的。Channel作为轻量级的<br>Connection极大减少了操作系统建立TCP connection的开销<br><strong>Exchange</strong>: message到达 broker 的第一站，根据分发规则，匹配查询表中的routing key，分发消息到queue中去。常用的类型有: direct (point-to-point), topic(publish-subscribe) and fanout<br>(multicast)<br><strong>Queue</strong>:消息最终被送到这里等待consumer 取走<br><strong>Binding</strong>: exchange和queue之间的虚拟连接，binding 中可以包含routing key，Binding信息被保存到exchange 中的查询表中，用于message 的分发依据</p><h2 id="依赖："><a href="#依赖：" class="headerlink" title="依赖："></a>依赖：</h2><pre class="language-none"><code class="language-none">    &lt;dependencies&gt;&lt;!--        rabbitmq依赖 客户端--&gt;        &lt;!-- https://mvnrepository.com/artifact/com.rabbitmq/amqp-client --&gt;        &lt;dependency&gt;            &lt;groupId&gt;com.rabbitmq&lt;/groupId&gt;            &lt;artifactId&gt;amqp-client&lt;/artifactId&gt;            &lt;version&gt;5.14.2&lt;/version&gt;        &lt;/dependency&gt;&lt;!--        io 文件操作流依赖  --&gt;        &lt;!-- https://mvnrepository.com/artifact/commons-io/commons-io --&gt;        &lt;dependency&gt;            &lt;groupId&gt;commons-io&lt;/groupId&gt;            &lt;artifactId&gt;commons-io&lt;/artifactId&gt;            &lt;version&gt;2.11.0&lt;/version&gt;        &lt;/dependency&gt;    &lt;/dependencies&gt;</code></pre><h2 id="使用的工具类："><a href="#使用的工具类：" class="headerlink" title="使用的工具类："></a>使用的工具类：</h2><pre class="language-none"><code class="language-none">/** * RabbitMQ工具类 */public class RabbitMQUtil {    //创建连接工厂 ，这个Rabbit提供的工厂方法，用于获取RabbitMQ的连接    private static  ConnectionFactory rabbitmqConnFactory = new ConnectionFactory();    static {        //RabbitMQ 连接地址        rabbitmqConnFactory.setHost("124.223.79.104");        //RabbitMQ 用户名        rabbitmqConnFactory.setUsername("admin");        //RabbitMQ 密码        rabbitmqConnFactory.setPassword("Admin123");    }    public static Channel getChannel() throws IOException, TimeoutException {        //获取RabbitMQ的连接        Connection connection = rabbitmqConnFactory.newConnection();        //我们需要使用连接先获取（创建）信道        return connection.createChannel();    }}</code></pre><pre class="language-none"><code class="language-none">/** * 线程睡眠 */public class SleepingUtil {    public static void sleep(int ss){        try {            Thread.sleep(ss*1000);        } catch (InterruptedException e) {            e.printStackTrace();        }    }}</code></pre><h2 id="简单队列使用："><a href="#简单队列使用：" class="headerlink" title="简单队列使用："></a>简单队列使用：</h2><p>简单队列使用如图：</p><p><img src="https://s2.loli.net/2022/04/14/3klpcSaY6gftxCJ.png" alt="image-20220326235714086"></p><h3 id="生产者："><a href="#生产者：" class="headerlink" title="生产者："></a>生产者：</h3><p>生产者需要将消息放入队列，以便消费者消费</p><pre class="language-java" data-language="java"><code class="language-java">/** * 生产者 */public class Producer {    private final static String QUEUE_NAME = "hello";    //记得关闭防火墙或者打开 5672端口，这里测试使用的是5672端口号，否则可能报超时错误    public static void main(String[] args) throws IOException, TimeoutException {        //创建连接工厂 ，这个Rabbit提供的工厂方法，用于获取RabbitMQ的连接        ConnectionFactory rabbitmqConnFactory = new ConnectionFactory();        //RabbitMQ 连接地址        rabbitmqConnFactory.setHost("124.223.79.104");        //RabbitMQ 用户名        rabbitmqConnFactory.setUsername("admin");        //RabbitMQ 密码        rabbitmqConnFactory.setPassword("Admin123");        //获取RabbitMQ的连接        Connection connection = rabbitmqConnFactory.newConnection();        //我们需要使用连接先获取（创建）信道        Channel channel = connection.createChannel();        //使用信道调取一个队列的声明（生成队列），我们可以先不创建交换机，默认就会有一个交换机        //参数：        // 1、队列的名称        // 2,队列里的消息是否需要持久化（存储磁盘），默认存储内存中        // 3,是否需要排它 ， 该队列是否只提供给一个消费者进行消费 是否进行共享 ，true:只能一个消费者消费 false:可以多个消费者消费        // 4、是否自动删除 ， 最后一个消费者断开连接后，该队列是否自动删除        // 5、队列参数        channel.queueDeclare(QUEUE_NAME, false, false, false, null);        //发送信息        String message = "Hello Word";        //使用信道发送消息        //参数： 1、 发送到哪个交换机，我们没有创建交换机，填写空就行        // 2、路由的key值是哪个 本次是队列名称        // 3、其他参数消息        // 4、发送的消息体        channel.basicPublish("",QUEUE_NAME,null,message.getBytes());        System.out.println("消息发送完毕");  channel.close();        connection.close();    }}</code></pre><p><strong>运行后：</strong></p><p>我们可以使用RabbitMQ的网页查看一些基本信息</p><p><img src="https://s2.loli.net/2022/04/14/nEDbfAwR85xXY1I.png" alt="image-20220326144754170"></p><h3 id="消费者："><a href="#消费者：" class="headerlink" title="消费者："></a>消费者：</h3><p>获取队列中的消息</p><pre class="language-none"><code class="language-none">/** * 消费者 */public class Consumer {    private final static String QUEUE_NAME = "hello";    public static void main(String[] args) throws IOException, TimeoutException {        //创建连接工厂 ，这个Rabbit提供的工厂方法，用于获取RabbitMQ的连接        ConnectionFactory rabbitmqConnFactory = new ConnectionFactory();        //RabbitMQ 连接地址        rabbitmqConnFactory.setHost("124.223.79.104");        //RabbitMQ 用户名        rabbitmqConnFactory.setUsername("admin");        //RabbitMQ 密码        rabbitmqConnFactory.setPassword("Admin123");        //创建连接        Connection connection = rabbitmqConnFactory.newConnection();        //创建信道        Channel channel = connection.createChannel();        //成功后回调用的类        DeliverCallback deliverCallback =new DeliverCallback() {            /**             *  回调方法             * @param s  名称             * @param delivery 获取到队列中消息内容，《getBody()方法获取消息体》             * @throws IOException             */            public void handle(String s, Delivery delivery) throws IOException {                System.out.println(s+"--&gt;成功");                System.out.println(new String(delivery.getBody())+"--&gt;成功");            }        };        //取消后回调用的类        CancelCallback cancelCallback =new CancelCallback() {            public void handle(String s) throws IOException {                System.out.println(s+"--&gt;消息被中断，取消");            }        };        //消费者消费（获取对列消息）        //参数:        //1,消费哪个对象        //2,消费成功后是否自动应答  true：自动应答  false：手动应答        //     应答作用：消费者发送一个消息应答，告诉RabbitMQ这个消息已经接收并且处理完毕了。RabbitMQ就可以删除它了。        //3,消费者成功消费的回调方法        //4，消费者取消消费的回调方法        channel.basicConsume(QUEUE_NAME,true,deliverCallback,cancelCallback);                  channel.close();        connection.close();    }}</code></pre><p>运行后：</p><p>我们放入的信息被消费了</p><p><img src="https://s2.loli.net/2022/04/14/3TERzbSVC1QBIvA.png" alt="image-20220326145001090"></p><h2 id="工作队列（Work-Queues）："><a href="#工作队列（Work-Queues）：" class="headerlink" title="工作队列（Work Queues）："></a>工作队列（Work Queues）：</h2><p>一个生产者，一个消息队列，多个消费者，同样也称为点对点模式</p><p>工作队列模式的最大特点就是有多个消费者，这样就不会因为处理耗时的任务导致<code>MQ</code>不可用。</p><p><img src="https://s2.loli.net/2022/04/14/uOFcwaWS6GJNMU8.png" alt="image-20220327000635100"></p><p>默认情况下，<code>rabbitmq</code>将会按顺序派发每个任务给下一个消费者，平均而言，每个消费者将获得相同数量的消息，这种分发消息的方式称为<strong>轮询</strong>。</p><h3 id="生产者：-1"><a href="#生产者：-1" class="headerlink" title="生产者："></a>生产者：</h3><pre class="language-none"><code class="language-none">/** * 生产者 */public class TaskProducer {    private static final String QUEUE_NAME = "hello";    public static void main(String[] args) throws IOException, TimeoutException {        Channel channel = RabbitMQUtil.getChannel();        //使用信道调取一个队列的声明（生成队列），我们可以先不创建交换机，默认就会有一个交换机        //参数：        // 1、队列的名称        // 2,队列里的消息是否需要持久化（存储磁盘），默认存储内存中        // 3,是否需要排它 ， 该队列是否只提供给一个消费者进行消费 是否进行共享 ，true:只能一个消费者消费 false:可以多个消费者消费        // 4、是否自动删除 ， 最后一个消费者断开连接后，该队列是否自动删除        // 5、队列参数        channel.queueDeclare(QUEUE_NAME,false,false,false,null);        //使用控制台输入，我们就可以更换的观察每个信息被谁消费        Scanner scanner = new Scanner(System.in);        while (scanner.hasNext()){            String message = scanner.next();            channel.basicPublish("",QUEUE_NAME,null,message.getBytes());            System.out.println(message +" ---&gt; 发送完成");        }    }}</code></pre><h3 id="消费者：-1"><a href="#消费者：-1" class="headerlink" title="消费者："></a>消费者：</h3><p>由于要有多个消费者，我们这就使用多线程了</p><h4 id="Runnable实现类："><a href="#Runnable实现类：" class="headerlink" title="Runnable实现类："></a>Runnable实现类：</h4><pre class="language-none"><code class="language-none">/** * 工作线程， 也就是消费者 */public class Worker implements Runnable {    //队列名称    private static final String QUEUE_NAME = "hello";    //消费者名称    private String name;    public Worker(String name){        this.name = name;    }    public void run() {        //获取信道        Channel channel = null;        try {            channel = RabbitMQUtil.getChannel();        } catch (IOException e) {            e.printStackTrace();        } catch (TimeoutException e) {            e.printStackTrace();        }        //成功获取生产者信息回调方法        DeliverCallback deliverCallback = new DeliverCallback() {            public void handle(String s, Delivery delivery) throws IOException {                System.out.println(new String(delivery.getBody()));                System.out.println(name+" --&gt;成功");            }        };        // 消费者取消消费的回调方法        CancelCallback cancelCallback = new CancelCallback() {            public void handle(String s) throws IOException {                System.out.println(Thread.currentThread().getName()+"---&gt; " +s + ":消费者取消消费 回调函数  逻辑代码....");            }        };        //消费者消费（获取对列消息）        //参数:        //1,消费哪个对象        //2,消费成功后是否自动应答  true：自动应答  false：手动应答        //     应答作用：消费者发送一个消息应答，告诉RabbitMQ这个消息已经接收并且处理完毕了。RabbitMQ就可以删除它了。        //3,消费者成功消费的回调方法        //4，消费者取消消费的回调方法        try {            channel.basicConsume(QUEUE_NAME,true,deliverCallback,cancelCallback);            System.out.println(name +" 等待消费");        } catch (IOException e) {            e.printStackTrace();        }    }}</code></pre><h4 id="创建消费者线程类："><a href="#创建消费者线程类：" class="headerlink" title="创建消费者线程类："></a>创建消费者线程类：</h4><pre class="language-none"><code class="language-none">/** * 创建多个消费者，看看它们轮询消费 */public class WorkerText {    public static void main(String[] args) {        //继承了Runnable        // 由于我们创建线程，线程结束后信依旧存活，        // 但我们的线程名称在回调方法中不能显示我们设置的，所以我们使用这个方式        Worker worker1 =  new Worker("消费者1");        Worker worker2 =  new Worker("消费者2");        Worker worker3 =  new Worker("消费者3");        //创建多线程        Thread thread1 = new Thread(worker1);        thread1.start();        Thread thread2 = new Thread(worker2);        thread2.start();        Thread thread3 = new Thread(worker3);        thread3.start();    }}</code></pre><h2 id="应答："><a href="#应答：" class="headerlink" title="应答："></a>应答：</h2><h3 id="消息应答机制"><a href="#消息应答机制" class="headerlink" title="消息应答机制"></a>消息应答机制</h3><p>消费者完成一个任务可能需要一段时间，如果其中一个消费者处理一个长的任务并仅只完成了部分突然它挂掉，由于RabbitMQ 一旦向消费者传递了一条消息，便立即将该消息标记为删除。在这种情况下，突然有个消费者挂掉了，我们将丢失正在处理的消息，以及后续发送给该消费者的消息也无法接收到。</p><p>为了保证消息在发送过程中不丢失，rabbitmq 引入消息应答机制。</p><p>消费者在接收到消息并且处理该消息之后，告诉 rabbitmq 它已经处理了，rabbitmq 可以把该消息删除掉了。</p><h3 id="自动应答"><a href="#自动应答" class="headerlink" title="自动应答"></a>自动应答</h3><p>不推荐使用，</p><p><strong>RabbitMQ 只要将消息分发给消费者就被认为消息传递成功</strong>,就会将内存中的消息删除,而不管消费者有没有处理完消息</p><p>消息发送后立即被认为已经传送成功，这种模式需要在高吞吐量和数据传输安全性方面做权衡,因为这种模式如果消息在接收到之前，消费者出现连接或者 channel 关闭，那么消息就丢失了,当然另一方面这种模式消费者可以传递过载的消息，没有对传递的消息数量进行限制，当然这样有可能使得消费者由于接收太多还来不及处理的消息，导致这些消息的积压，最终使得内存耗尽，最终这些消费者线程被操作系统杀死，所以这种模式仅适用在消费者可以高效并以某种速率能够处理这些消息的情况下使用。</p><h3 id="手动消息应答的方法"><a href="#手动消息应答的方法" class="headerlink" title="手动消息应答的方法"></a>手动消息应答的方法</h3><p>推荐使用</p><p><strong>RabbitMQ 将消息分发给了消费者,并且只有当消费者处理完成了整个消息之后才会被认为消息传递成功了</strong>,然后才会将内存中的消息删除</p><p>Channel.basicAck (用于肯定确认)<br>RabbitMQ 已知道该消息并且成功的处理消息，可以将其丢弃了</p><p>Channel.basicNack (用于否定确认)<br>Channel.basicReject (用于否定确认)<br>与 Channel.basicNack 相比少一个参数，不处理该消息，直接拒绝，可以将其丢弃了</p><h3 id="Multiple-的解释"><a href="#Multiple-的解释" class="headerlink" title="Multiple 的解释"></a><strong>Multiple 的解释</strong></h3><p>手动应答的好处是可以批量应答并且减少网络拥堵 </p><p><img src="https://s2.loli.net/2022/04/14/s3yt4HpzagArROm.png" alt="image-20220327182119329"></p><p>multiple 的 true 和 false 代表不同意思<strong>（推荐false，虽然可能会导致网络拥堵，但为了避免其它消息可能发生错误导致消息丢失使用不使用批量应答）</strong></p><p>true 代表批量应答 channel 上未应答的消息 比如说 channel 上有传送 tag 的消息 5,6,7,8 当前 tag 是 8 那么此时 5-8 的这些还未应答的消息都会被确认收到消息应答 </p><p>false 同上面相比 只会应答 tag=8 的消息 5,6,7 这三个消息依然不会被确认收到消息应答</p><p><img src="https://s2.loli.net/2022/04/14/GcFnwr3djRlVKoZ.png" alt="image-20220327182226782"></p><h3 id="消息自动重新入队"><a href="#消息自动重新入队" class="headerlink" title="消息自动重新入队"></a>消息自动重新入队</h3><p>如果消费者由于某些原因失去连接(其通道已关闭，连接已关闭或 TCP 连接丢失)，导致消息 未发送 ACK 确认，RabbitMQ 将了解到消息未完全处理，并将对其重新排队。如果此时其他消费者 可以处理，它将很快将其重新分发给另一个消费者。这样，即使某个消费者偶尔死亡，也可以确 保不会丢失任何消息</p><p><img src="https://s2.loli.net/2022/04/14/dO3AKMXzWDnHlm5.png" alt="image-20220327183127721"></p><h3 id="手动应答测试代码："><a href="#手动应答测试代码：" class="headerlink" title="手动应答测试代码："></a><strong>手动应答测试代码：</strong></h3><h4 id="测试目标："><a href="#测试目标：" class="headerlink" title="测试目标："></a>测试目标：</h4><p>（注意，为确认应答只是RabbitMQ不会删除队列中的消息）</p><p>1，观察消费者在消费失败时，消息是否会重新入队并提供给其他消费者消费 (断开连接消息重新入队)</p><p>2，观察消费手动应答后队列消息的变化</p><h4 id="生产者：-2"><a href="#生产者：-2" class="headerlink" title="生产者："></a><strong>生产者：</strong></h4><p>生产者还是那么回事，主要看消费者</p><pre class="language-none"><code class="language-none">/** * 生产者  本文件测试应答 */public class Producer {    private static final String QUEUE_NAME = "ack_queue";    public static void main(String[] args) throws IOException, TimeoutException {        //获取信道        Channel channel = RabbitMQUtil.getChannel();        //使用信道调取一个队列的声明（生成队列），我们可以先不创建交换机，默认就会有一个交换机        //参数：        // 1、队列的名称        // 2,队列里的消息是否需要持久化（存储磁盘），默认存储内存中        // 3,是否需要排它 ， 该队列是否只提供给一个消费者进行消费 是否进行共享 ，true:只能一个消费者消费 false:可以多个消费者消费        // 4、是否自动删除 ， 最后一个消费者断开连接后，该队列是否自动删除        // 5、队列参数        channel.queueDeclare(QUEUE_NAME,false,false,false,null);        Scanner scanner = new Scanner(System.in);        while (scanner.hasNext()){            String message = scanner.next();            //使用信道发送消息            //参数： 1、 发送到哪个交换机，我们没有创建交换机，填写空就行            // 2、路由的key值是哪个 本次是队列名称            // 3、其他参数消息            // 4、发送的消息体            channel.basicPublish("",QUEUE_NAME,null,message.getBytes());            System.out.println("发生消息成功 --&gt;&gt; "+message);        }    }}</code></pre><h4 id="消费者：-2"><a href="#消费者：-2" class="headerlink" title="消费者："></a>消费者：</h4><p>我们还是使用多线程测试，也可以创建两个消费者main ，我认为比较麻烦，所以使用多线程了</p><p> <strong>Runnable实现类：</strong></p><p>DeliverCallback中，我编写的是10秒后让消费者2异常终止，这样就可以观察到信道连接中断时，消息是否会重新入队</p><pre class="language-none"><code class="language-none">/*** 消费者代码 */public class WorkConsumer implements Runnable{    private static final String QUEUE_NAME = "ack_queue";    //消费者名称    private String name;    //线程沉睡时间    private Integer time;    public WorkConsumer(String name,Integer time){        this.name = name;        this.time = time;    }    public void run() {        Channel channel = null;        try {            //获取信道            channel = RabbitMQUtil.getChannel();        } catch (IOException e) {            e.printStackTrace();        } catch (TimeoutException e) {            e.printStackTrace();        }        System.out.println(name+"等待消息接收时间为 --&gt; "+time +"秒");        //这是为了让匿名实现类内部能够使用channel        final Channel finalChannel = channel;        //消费消息方法        DeliverCallback deliverCallback = new DeliverCallback() {            public void handle(String s, Delivery delivery) throws IOException {                //线程沉睡                SleepingUtil.sleep(time);                //用于测试如果代码出问题，那么消息是否会重新入队并且给另一个消费者消费                if (name.equals("消费者2")){                    Thread.currentThread().stop();                }                System.out.println(name+"消费消息: "+new String(delivery.getBody()));                //手动应答（确认成功）                //参数：                //1、消息的标记 tag，每个消息在信道中都会有标记                // 我们可以获取到消息中的标记，并手动应答表示这个标记的消息以成功接收                //delivery.getEnvelope().getDeliveryTag() 这个方法可回去到我们消息中的标记                //2、是否批量应答 false不批量                finalChannel.basicAck(delivery.getEnvelope().getDeliveryTag(),false);            }        };        //取消回调方法        CancelCallback cancelCallback = new CancelCallback() {            public void handle(String s) throws IOException {                System.out.println("取消消息成功 --&gt;" +s);            }        };        try {            //消费者消费（获取对列消息）            //参数:            //1,消费哪个对象            //2,消费成功后是否自动应答  true：自动应答  false：手动应答            //     应答作用：消费者发送一个消息应答，告诉RabbitMQ这个消息已经接收并且处理完毕了。RabbitMQ就可以删除它了。            //3,消费者成功消费的回调方法            //4，消费者取消消费的回调方法            channel.basicConsume(QUEUE_NAME,false,deliverCallback,cancelCallback);        } catch (IOException e) {            e.printStackTrace();        }    }}</code></pre><p><strong>线程启动类：</strong></p><pre class="language-none"><code class="language-none">public class ConsumerThread {    public static void main(String[] args) {        WorkConsumer workConsumer1 = new WorkConsumer("消费者1",1);        WorkConsumer workConsumer2 = new WorkConsumer("消费者2",10);        Thread thread = new Thread(workConsumer1);        thread.start();        Thread thread1 = new Thread(workConsumer2);        thread1.start();    }}</code></pre><h4 id="目标结果："><a href="#目标结果：" class="headerlink" title="目标结果："></a>目标结果：</h4><p>1，观察消费者在消费失败时，消息是否会重新入队并提供给其他消费者消费</p><p>​        可以得出消费会重新入队并给其他消费者消费</p><p><img src="https://s2.loli.net/2022/04/14/A45CnVRQ1EYm97T.png" alt="image-20220328184117474"></p><p>2，观察消费手动应答后队列消息的变化（基于以上代码在手动应答删除情况下进行）</p><p>​                可看到，队列消息还在其他，并没有删除</p><p><img src="https://s2.loli.net/2022/04/14/SCBcLwit1RIXbWN.png" alt="image-20220328184449413"></p><p><img src="https://s2.loli.net/2022/04/14/CZqWAfh6YQ3To4P.png" alt="image-20220328184452126"></p><h2 id="持久化："><a href="#持久化：" class="headerlink" title="持久化："></a>持久化：</h2><h3 id="队列持久化："><a href="#队列持久化：" class="headerlink" title="队列持久化："></a>队列持久化：</h3><p>持久化队列后，当我们重启RabbitMQ时，队列不会消失（注意：是队列不是消息）</p><p><strong>如何持久化？</strong></p><p>我们只需要在声明（创建）队列时将参数二改为true即可</p><pre class="language-none"><code class="language-none">//获取信道Channel channel = RabbitMQUtil.getChannel();//使用信道调取一个队列的声明（生成队列），我们可以先不创建交换机，默认就会有一个交换机//参数：// 1、队列的名称// 2,队列里的消息是否需要持久化（存储磁盘），默认存储内存中// 3,是否需要排它 ， 该队列是否只提供给一个消费者进行消费 是否进行共享 ，true:只能一个消费者消费 false:可以多个消费者消费// 4、是否自动删除 ， 最后一个消费者断开连接后，该队列是否自动删除// 5、队列参数channel.queueDeclare(QUEUE_NAME,true,false,false,null);</code></pre><h4 id="判断队列是否持久化："><a href="#判断队列是否持久化：" class="headerlink" title="判断队列是否持久化："></a>判断队列是否持久化：</h4><p><img src="https://s2.loli.net/2022/04/14/YLjTF5XOqBQxMw1.png" alt="image-20220328233855919"></p><h4 id="注意点："><a href="#注意点：" class="headerlink" title="注意点："></a><strong>注意点：</strong></h4><p>以及声明（创建）过的队列是不能持久化的，要删除后重新声明时才能设置为持久化</p><p><strong>为以及存在的队列持久化报错异常：</strong></p><pre class="language-none"><code class="language-none">Caused by: com.rabbitmq.client.ShutdownSignalException: channel error; protocol method: #method&lt;channel.close&gt;(reply-code=406, reply-text=PRECONDITION_FAILED - inequivalent arg 'durable' for queue 'ack_queue' in vhost '/': received 'true' but current is 'false', class-id=50, method-id=10)at com.rabbitmq.client.impl.ChannelN.asyncShutdown(ChannelN.java:517)at com.rabbitmq.client.impl.ChannelN.processAsync(ChannelN.java:341)at com.rabbitmq.client.impl.AMQChannel.handleCompleteInboundCommand(AMQChannel.java:182)at com.rabbitmq.client.impl.AMQChannel.handleFrame(AMQChannel.java:114)at com.rabbitmq.client.impl.AMQConnection.readFrame(AMQConnection.java:739)at com.rabbitmq.client.impl.AMQConnection.access$300(AMQConnection.java:47)at com.rabbitmq.client.impl.AMQConnection$MainLoop.run(AMQConnection.java:666)at java.lang.Thread.run(Thread.java:748)</code></pre><p><strong>解决方法：</strong></p><p>删除队列，重新声明</p><p><img src="https://s2.loli.net/2022/04/14/1vrfuRqKHQyjM5B.png" alt="image-20220328233921944"></p><p><img src="https://s2.loli.net/2022/04/14/SysX5Ea4tUGR2vY.png" alt="image-20220328233926734"></p><h4 id="消息持久化："><a href="#消息持久化：" class="headerlink" title="消息持久化："></a>消息持久化：</h4><p>要想让消息实现持久化需要在消息生产者修改代码，MessageProperties.PERSISTENT_TEXT_PLAIN 添 加这个属性。</p><p><img src="https://s2.loli.net/2022/04/14/LmWC2N5HGZEf7X8.png" alt="image-20220328234328144"></p><p>将消息标记为持久化并不能完全保证不会丢失消息。尽管它告诉 RabbitMQ 将消息保存到磁盘，但是 这里依然存在当消息刚准备存储在磁盘的时候 但是还没有存储完，消息还在缓存的一个间隔点。此时并没 有真正写入磁盘。持久性保证并不强，但是对于我们的简单任务队列而言，这已经绰绰有余了。如果需要 更强有力的持久化策略，参考发布确认。</p><h2 id="不公平分发消息："><a href="#不公平分发消息：" class="headerlink" title="不公平分发消息："></a>不公平分发消息：</h2><p>在最开始的时候我们学习到 RabbitMQ 分发消息采用的轮询分发，但是在某种场景下这种策略并不是很好，比方说有两个消费者在处理任务，其中有个消费者 1 处理任务的速度非常快，而另外一个消费者 2 处理速度却很慢，这个时候我们还是采用轮训分发的化就会到这处理速度快的这个消费者很大一部分时间处于空闲状态，而处理慢的那个消费者一直在干活，这种分配方式在这种情况下其实就不太好，但是RabbitMQ 并不知道这种情况它依然很公平的进行分发。</p><p>为了避免上述情况，强烈建议使用不公平分发（能者多劳）,这样速度快的消费者就可以消费多个不会闲置。</p><p>不公平分发消息 消费者需要设置信道参数： <strong>channel.basicQos(1);</strong>   <strong>1是不公平分发   ， 默认是 0 轮询分发</strong>   <strong>而 2-5则是预取值</strong></p><h3 id="生产者：-3"><a href="#生产者：-3" class="headerlink" title="生产者："></a>生产者：</h3><pre class="language-none"><code class="language-none">/** * 生产者  本文件测试应答 */public class Producer {    private static final String QUEUE_NAME = "ack_queue";    public static void main(String[] args) throws IOException, TimeoutException {        //获取信道        Channel channel = RabbitMQUtil.getChannel();        //使用信道调取一个队列的声明（生成队列），我们可以先不创建交换机，默认就会有一个交换机        //参数：        // 1、队列的名称        // 2,队列里的消息是否需要持久化（存储磁盘），默认存储内存中        // 3,是否需要排它 ， 该队列是否只提供给一个消费者进行消费 是否进行共享 ，true:只能一个消费者消费 false:可以多个消费者消费        // 4、是否自动删除 ， 最后一个消费者断开连接后，该队列是否自动删除        // 5、队列参数        channel.queueDeclare(QUEUE_NAME,true,false,false,null);        Scanner scanner = new Scanner(System.in);        while (scanner.hasNext()){            String message = scanner.next();            //使用信道发送消息            //参数： 1、 发送到哪个交换机，我们没有创建交换机，填写空就行            // 2、路由的key值是哪个 本次是队列名称            // 3、其他参数消息            // 4、发送的消息体            channel.basicPublish("",QUEUE_NAME,null,message.getBytes());            System.out.println("发生消息成功 --&gt;&gt; "+message);        }    }}</code></pre><h3 id="消费者：-3"><a href="#消费者：-3" class="headerlink" title="消费者："></a>消费者：</h3><h4 id="Runnable实现类：-1"><a href="#Runnable实现类：-1" class="headerlink" title="Runnable实现类："></a>Runnable实现类：</h4><pre class="language-none"><code class="language-none">/*** 消费者代码 */public class WorkConsumer implements Runnable{    private static final String QUEUE_NAME = "ack_queue";    //消费者名称    private String name;    //线程沉睡时间    private Integer time;    public WorkConsumer(String name,Integer time){        this.name = name;        this.time = time;    }    public void run() {        Channel channel = null;        try {            //获取信道            channel = RabbitMQUtil.getChannel();            //开启不公平分发            channel.basicQos(1);        } catch (IOException e) {            e.printStackTrace();        } catch (TimeoutException e) {            e.printStackTrace();        }        System.out.println(name+"等待消息接收时间为 --&gt; "+time +"秒");        //这是为了让匿名实现类内部能够使用channel        final Channel finalChannel = channel;        //消费消息方法        DeliverCallback deliverCallback = new DeliverCallback() {            public void handle(String s, Delivery delivery) throws IOException {                System.out.println(name+"开始消费");                //线程沉睡                SleepingUtil.sleep(time);                //用于测试如果代码出问题，那么消息是否会重新入队并且给另一个消费者消费//                if (name.equals("消费者2")){//                    System.out.println("消费者2，死亡，连接断开...");//                    Thread.currentThread().stop();//                }                System.out.println(name+"消费消息: "+new String(delivery.getBody()));                //手动应答（确认成功）                //参数：                //1、消息的标记 tag，每个消息在信道中都会有标记                // 我们可以获取到消息中的标记，并手动应答表示这个标记的消息以成功接收                //delivery.getEnvelope().getDeliveryTag() 这个方法可回去到我们消息中的标记                //2、是否批量应答 false不批量                finalChannel.basicAck(delivery.getEnvelope().getDeliveryTag(),false);            }        };        //取消回调方法        CancelCallback cancelCallback = new CancelCallback() {            public void handle(String s) throws IOException {                System.out.println("取消消息成功 --&gt;" +s);            }        };        try {            //消费者消费（获取对列消息）            //参数:            //1,消费哪个对象            //2,消费成功后是否自动应答  true：自动应答  false：手动应答            //     应答作用：消费者发送一个消息应答，告诉RabbitMQ这个消息已经接收并且处理完毕了。RabbitMQ就可以删除它了。            //3,消费者成功消费的回调方法            //4，消费者取消消费的回调方法            channel.basicConsume(QUEUE_NAME,false,deliverCallback,cancelCallback);        } catch (IOException e) {            e.printStackTrace();        }    }}</code></pre><h4 id="消费者线程执行类："><a href="#消费者线程执行类：" class="headerlink" title="消费者线程执行类："></a>消费者线程执行类：</h4><pre class="language-none"><code class="language-none">public class ConsumerThread {    public static void main(String[] args) {        WorkConsumer workConsumer1 = new WorkConsumer("消费者1",1);        WorkConsumer workConsumer2 = new WorkConsumer("消费者2",10);        Thread thread = new Thread(workConsumer1);        thread.start();        Thread thread1 = new Thread(workConsumer2);        thread1.start();    }}</code></pre><h4 id="结果："><a href="#结果：" class="headerlink" title="结果："></a>结果：</h4><p>可观察到，消费者1因为消费快所以消费的多，而消费者2消费慢就消费的少</p><p><img src="https://s2.loli.net/2022/04/14/PoORgnj7HIQTku1.png" alt="image-20220329101724499"></p><h2 id="预取值"><a href="#预取值" class="headerlink" title="预取值"></a>预取值</h2><h3 id="介绍："><a href="#介绍：" class="headerlink" title="介绍："></a>介绍：</h3><p>本身消息的发送就是异步发送的，所以在任何时候，channel 上肯定不止只有一个消息另外来自消费者的手动确认本质上也是异步的。因此这里就存在一个未确认的消息缓冲区，因此希望开发人员能限制此 缓冲区的大小，以避免缓冲区里面无限制的未确认消息问题。这个时候就可以通过使用 basic.qos 方法设 置“预取计数”值来完成的。该值定义通道上允许的未确认消息的最大数量。一旦数量达到配置的数量， RabbitMQ 将停止在通道上传递更多消息，除非至少有一个未处理的消息被确认，例如，假设在通道上有 未确认的消息 5、6、7，8，并且通道的预取计数设置为 4，此时 RabbitMQ 将不会在该通道上再传递任何 消息，除非至少有一个未应答的消息被 ack。比方说 tag=6 这个消息刚刚被确认 ACK，RabbitMQ 将会感知 这个情况到并再发送一条消息。消息应答和 QoS 预取值对用户吞吐量有重大影响。通常，增加预取将提高 向消费者传递消息的速度。虽然自动应答传输消息速率是最佳的，但是，在这种情况下已传递但尚未处理的消息的数量也会增加，从而增加了消费者的 RAM 消耗(随机存取存储器)应该小心使用具有无限预处理 的自动确认模式或手动确认模式，消费者消费了大量的消息如果没有确认的话，会导致消费者连接节点的 内存消耗变大，所以找到合适的预取值是一个反复试验的过程，不同的负载该值取值也不同 100 到 300 范 围内的值通常可提供最佳的吞吐量，并且不会给消费者带来太大的风险。预取值为 1 是最保守的。当然这 将使吞吐量变得很低，特别是消费者连接延迟很严重的情况下，特别是在消费者连接等待时间较长的环境 中。对于大多数应用来说，稍微高一点的值将是最佳的。</p><p>简单说就是在信道中设置一个缓冲区，从队列中获取消息放入信道缓冲区中，信道中的消息是不会被别的消费者获取，<strong>最多预取值存放5条消息在信道中</strong></p><p><strong>设置预取值：channel.basicQos(5);  参数为 2 - 5 ；表示预取值的数量</strong></p><p><strong>它是分配是这样的：</strong></p><p>队列会先将他们的信道中预取值填充完，之后谁空缺给谁补充，如14条消息，消费者1消费时间为1秒预取值为3，消费者2消费时间为10秒，预取值为5，那么会先被消费者1，2分别拿走3,5条，但由于消费者1消费的快，将缓冲区（预取值）中消息消费了，那么队列就会为消费者1补充，最终，消费者1消费者了6条消息后，消费者2才消费1条它缓冲区的一条消息，但由于消费者1已经将消息消费完了，那么就没有消息为消费者2补充了，如果再来了一条消息，也就随机在两个消费者中选一个补充</p><p><img src="https://s2.loli.net/2022/04/14/m57s3d1opthzugq.png" alt="image-20220329104154264"></p><h3 id="生产者：-4"><a href="#生产者：-4" class="headerlink" title="生产者："></a>生产者：</h3><pre class="language-none"><code class="language-none">/** * 生产者  本文件测试应答 */public class Producer {    private static final String QUEUE_NAME = "ack_queue";    public static void main(String[] args) throws IOException, TimeoutException {        //获取信道        Channel channel = RabbitMQUtil.getChannel();        //使用信道调取一个队列的声明（生成队列），我们可以先不创建交换机，默认就会有一个交换机        //参数：        // 1、队列的名称        // 2,队列里的消息是否需要持久化（存储磁盘），默认存储内存中        // 3,是否需要排它 ， 该队列是否只提供给一个消费者进行消费 是否进行共享 ，true:只能一个消费者消费 false:可以多个消费者消费        // 4、是否自动删除 ， 最后一个消费者断开连接后，该队列是否自动删除        // 5、队列参数        channel.queueDeclare(QUEUE_NAME,true,false,false,null);        Scanner scanner = new Scanner(System.in);        while (scanner.hasNext()){            String message = scanner.next();            //使用信道发送消息            //参数： 1、 发送到哪个交换机，我们没有创建交换机，填写空就行            // 2、路由的key值是哪个 本次是队列名称            // 3、其他参数消息            // 4、发送的消息体            channel.basicPublish("",QUEUE_NAME,null,message.getBytes());            System.out.println("发生消息成功 --&gt;&gt; "+message);        }    }}</code></pre><h3 id="消费者"><a href="#消费者" class="headerlink" title="消费者:"></a>消费者:</h3><p>要在队列持久化下进行</p><h4 id="Runnable实现类：-2"><a href="#Runnable实现类：-2" class="headerlink" title="Runnable实现类："></a>Runnable实现类：</h4><pre class="language-none"><code class="language-none">/*** 消费者代码 */public class WorkConsumer implements Runnable{    private static final String QUEUE_NAME = "ack_queue";    //消费者名称    private String name;    //线程沉睡时间    private Integer time;    //预取值    private  Integer forecast;    public WorkConsumer(String name,Integer time,Integer forecast){        this.name = name;        this.time = time;        this.forecast=forecast;    }    public void run() {        Channel channel = null;        try {            //获取信道            channel = RabbitMQUtil.getChannel();            //设置预取值的数量，（1是不公平，0是轮询，2-5才是预取值）            channel.basicQos(forecast);        } catch (IOException e) {            e.printStackTrace();        } catch (TimeoutException e) {            e.printStackTrace();        }        System.out.println(name+"等待消息接收时间为 --&gt; "+time +"秒");        //这是为了让匿名实现类内部能够使用channel        final Channel finalChannel = channel;        //消费消息方法        DeliverCallback deliverCallback = new DeliverCallback() {            public void handle(String s, Delivery delivery) throws IOException {                System.out.println(name+"开始消费");                //线程沉睡                SleepingUtil.sleep(time);                //用于测试如果代码出问题，那么消息是否会重新入队并且给另一个消费者消费//                if (name.equals("消费者2")){//                    System.out.println("消费者2，死亡，连接断开...");//                    Thread.currentThread().stop();//                }                System.out.println(name+"消费消息: "+new String(delivery.getBody()));                //手动应答（确认成功）                //参数：                //1、消息的标记 tag，每个消息在信道中都会有标记                // 我们可以获取到消息中的标记，并手动应答表示这个标记的消息以成功接收                //delivery.getEnvelope().getDeliveryTag() 这个方法可回去到我们消息中的标记                //2、是否批量应答 false不批量                finalChannel.basicAck(delivery.getEnvelope().getDeliveryTag(),false);            }        };        //取消回调方法        CancelCallback cancelCallback = new CancelCallback() {            public void handle(String s) throws IOException {                System.out.println("取消消息成功 --&gt;" +s);            }        };        try {            //消费者消费（获取对列消息）            //参数:            //1,消费哪个对象            //2,消费成功后是否自动应答  true：自动应答  false：手动应答            //     应答作用：消费者发送一个消息应答，告诉RabbitMQ这个消息已经接收并且处理完毕了。RabbitMQ就可以删除它了。            //3,消费者成功消费的回调方法            //4，消费者取消消费的回调方法            channel.basicConsume(QUEUE_NAME,false,deliverCallback,cancelCallback);        } catch (IOException e) {            e.printStackTrace();        }    }}</code></pre><h4 id="消费者线程创建类："><a href="#消费者线程创建类：" class="headerlink" title="消费者线程创建类："></a>消费者线程创建类：</h4><pre class="language-none"><code class="language-none">public class ConsumerThread {    public static void main(String[] args) {        WorkConsumer workConsumer1 = new WorkConsumer("消费者1",1,3);        WorkConsumer workConsumer2 = new WorkConsumer("消费者2",10,5);        Thread thread = new Thread(workConsumer1);        thread.start();        Thread thread1 = new Thread(workConsumer2);        thread1.start();    }}</code></pre><p>这里就可以看到预取值的测试结果了</p><h2 id="发布确认："><a href="#发布确认：" class="headerlink" title="发布确认："></a>发布确认：</h2><h3 id="原理："><a href="#原理：" class="headerlink" title="原理："></a>原理：</h3><p>​    生产者将信道设置成 confirm 模式，一旦信道进入 confirm 模式，所有在该信道上面发布的 消息都将会被指派一个唯一的 ID(从 1 开始)，一旦消息被投递到所有匹配的队列之后，broker 就会发送一个确认给生产者(包含消息的唯一 ID)，这就使得生产者知道消息已经正确到达目的队 列了，如果消息和队列是可持久化的，那么确认消息会在将消息写入磁盘之后发出，broker 回传 给生产者的确认消息中 delivery-tag 域包含了确认消息的序列号，此外 broker 也可以设置 basic.ack 的 multiple 域，表示到这个序列号之前的所有消息都已经得到了处理。</p><p>​    confirm 模式最大的好处在于他是异步的，一旦发布一条消息，生产者应用程序就可以在等信 道返回确认的同时继续发送下一条消息，当消息最终得到确认之后，生产者应用便可以通过回调 方法来处理该确认消息，如果 RabbitMQ 因为自身内部错误导致消息丢失，就会发送一条 nack 消 息，生产者应用程序同样可以在回调方法中处理该 nack 消息</p><p><img src="https://s2.loli.net/2022/04/14/HAK7hyTiM4QUgez.png" alt="image-20220330170450998"></p><h3 id="开启发布确认的方法："><a href="#开启发布确认的方法：" class="headerlink" title="开启发布确认的方法："></a>开启发布确认的方法：</h3><pre class="language-none"><code class="language-none">//开启发布确认channel.confirmSelect();//发布确认等候结果：当服务端（队列）返回false，或超时，生产者可以重新发送消息channel.waitForConfirms();</code></pre><h3 id="单个发布确认："><a href="#单个发布确认：" class="headerlink" title="单个发布确认："></a>单个发布确认：</h3><p>​        这是一种简单的确认方式，它是一种同步确认发布的方式，也就是发布一个消息之后只有它 被确认发布，后续的消息才能继续发布,waitForConfirmsOrDie(long)这个方法只有在消息被确认 的时候才返回，如果在指定时间范围内这个消息没有被确认那么它将抛出异常。</p><p>​        这种确认方式有一个最大的缺点就是:发布速度特别的慢，因为如果没有确认发布的消息就会 阻塞所有后续消息的发布，这种方式最多提供每秒不超过数百条发布消息的吞吐量。当然对于某 些应用程序来说这可能已经足够了。</p><h4 id="生产者：-5"><a href="#生产者：-5" class="headerlink" title="生产者："></a>生产者：</h4><p>发布确认是发生在生产者与队列之间的，所以不需要消费者</p><p>测试结果结果：发布1000个单独确认消息，耗时：21570毫秒  (加上控制台打印时间)</p><pre class="language-none"><code class="language-none">    //单个发布确认（缺点：每发一条消息都需要确认,耗费时间比较长，性能不好）    public static void SingleReleaseConfirmation() throws IOException, TimeoutException, InterruptedException {        Channel channel = RabbitMQUtil.getChannel();        //开启发布确认        channel.confirmSelect();        //随机生成一个uuid为队列名称        String queryName = UUID.randomUUID().toString();        //使用信道调取一个队列的声明（生成队列），我们可以先不创建交换机，默认就会有一个交换机        //参数：        // 1、队列的名称        // 2,队列里的消息是否需要持久化（存储磁盘），默认存储内存中        // 3,是否需要排它 ， 该队列是否只提供给一个消费者进行消费 是否进行共享 ，true:只能一个消费者消费 false:可以多个消费者消费        // 4、是否自动删除 ， 最后一个消费者断开连接后，该队列是否自动删除        // 5、队列参数        channel.queueDeclare(queryName,true,false,false,null);        //开始时间        long l = System.currentTimeMillis();//批量发送消息，单独确认        for (Integer i=0;i&lt;MESSAGE_COUNT;i++){            //使用信道发送消息            //参数： 1、 发送到哪个交换机，我们没有创建交换机，填写空就行            // 2、路由的key值是哪个 本次是队列名称            // 3、其他参数消息            // 4、发送的消息体            channel.basicPublish("",queryName,null,i.toString().getBytes());            //发布确认结果：当服务端（队列）返回false，或超时，生产者可以重新发送消息            boolean b = channel.waitForConfirms();            if (b){                System.out.println("消息发布成功");            }        }        long l1 = System.currentTimeMillis();        System.out.println("发布"+MESSAGE_COUNT+"个单独确认消息，耗时："+ (l1-l) +"毫秒");    }}</code></pre><h3 id="批量发布确认："><a href="#批量发布确认：" class="headerlink" title="批量发布确认："></a>批量发布确认：</h3><p>上面那种方式非常慢，与单个等待确认消息相比，先发布一批消息然后一起确认可以极大地 提高吞吐量，当然这种方式的缺点就是:当发生故障导致发布出现问题时，不知道是哪个消息出现 问题了，我们必须将整个批处理保存在内存中，以记录重要的信息而后重新发布消息。当然这种 方案仍然是同步的，也一样阻塞消息的发布</p><h4 id="生产者：-6"><a href="#生产者：-6" class="headerlink" title="生产者："></a>生产者：</h4><p>结果：批量发布确认,发布1000条消息，批量确认消息大小：100，耗时：355毫秒(加上控制台打印时间)</p><pre class="language-none"><code class="language-none">//批量确认发布,缺点（当发生故障导致发布出现问题时，不知道是哪个消息出现问题了）   public static void  batchReleaseConfirmation() throws IOException, TimeoutException, InterruptedException {       Channel channel = RabbitMQUtil.getChannel();       //开启发布确认       channel.confirmSelect();       String queryName = UUID.randomUUID().toString();       //使用信道调取一个队列的声明（生成队列），我们可以先不创建交换机，默认就会有一个交换机       //参数：       // 1、队列的名称       // 2,队列里的消息是否需要持久化（存储磁盘），默认存储内存中       // 3,是否需要排它 ， 该队列是否只提供给一个消费者进行消费 是否进行共享 ，true:只能一个消费者消费 false:可以多个消费者消费       // 4、是否自动删除 ， 最后一个消费者断开连接后，该队列是否自动删除       // 5、队列参数       channel.queueDeclare(queryName,true,false,false,null);       //批量发布确认的大小       int ConfirmsMax=100;       //开始时间       long l = System.currentTimeMillis();       //批量发送消息，单独确认       for (Integer i=0;i&lt;MESSAGE_COUNT;i++){           //使用信道发送消息           //参数： 1、 发送到哪个交换机，我们没有创建交换机，填写空就行           // 2、路由的key值是哪个 本次是队列名称           // 3、其他参数消息           // 4、发送的消息体           channel.basicPublish("",queryName,null,i.toString().getBytes());           //批量发布确认（没一百条确认一次）           if ((i+1)%ConfirmsMax==0) {               //发布确认结果：当服务端（队列）返回false，或超时，生产者可以重新发送消息               boolean b = channel.waitForConfirms();               if (b) {                   System.out.println("消息发布成功");               }           }       }       long l1 = System.currentTimeMillis();       System.out.println("发布"+MESSAGE_COUNT+"条消息，批量确认消息大小："+ConfirmsMax+"，耗时："+ (l1-l) +"毫秒");   }</code></pre><h3 id="异步发布确认："><a href="#异步发布确认：" class="headerlink" title="异步发布确认："></a>异步发布确认：</h3><p>异步确认虽然编程逻辑比上两个要复杂，但是性价比最高，无论是可靠性还是效率都没得说， 他是利用回调函数来达到消息可靠性传递的，这个中间件也是通过函数回调来保证是否投递成功， 下面就让我们来详细讲解异步确认是怎么实现的</p><p><img src="https://s2.loli.net/2022/04/14/4NcUuKtxSIJR2q3.png" alt="image-20220404144939674"></p><h4 id="生产者：-7"><a href="#生产者：-7" class="headerlink" title="生产者："></a>生产者：</h4><p>使用方法:(具体看代码，有写注释)<br>          addConfirmListener()消息监听器，监听哪些消息成功，哪些消息失败（有重载，一个参数的只监听成功）<br>          这个方法是异步的<br>          参数:<br>          1、成功确认<br>          2、失败确认</p><p>​        参数接口为ConfirmCallback，要我们实例化</p><p>ConcurrentSkipListMap为跳表支持高频发：简单放个图看一下</p><p><img src="https://s2.loli.net/2022/04/14/G7jTrlm5YnJK4Vv.png" alt="image-20220402142557914"></p><p>要了解可以看下这篇文章：<a href="https://www.cnblogs.com/skywang12345/p/3498556.html">Java多线程系列–“JUC集合”05之 ConcurrentSkipListMap - 如果天空不死 - 博客园 (cnblogs.com)</a></p><p>主要就是使用这个集合存放发送的消息，确认后移出</p><p>这个方法，返回此映射的部分视图，其键值严格小于 toKey。<br>                      ConcurrentNavigableMap&lt;K,V&gt; headMap(K toKey)</p><p>结果： //发布1000条消息，异步发布确认消息，耗时：41毫秒(异步确认)</p><pre class="language-none"><code class="language-none">//异步发布确认public static void asyncReleaseConfirmation() throws IOException, TimeoutException {    Channel channel = RabbitMQUtil.getChannel();    //开启发布确认    channel.confirmSelect();    /**     * 线程完全有序的一个哈希表 使用于高并发的情况下     * 1，轻松的将序号于消息进行管理     * 2，轻松批量删除条目 只要给到序号     * 3，支持高并发（多线程）     */    final ConcurrentSkipListMap&lt;Long,String&gt; outstandingConfirms = new ConcurrentSkipListMap&lt;Long, String&gt;();    String queryName = UUID.randomUUID().toString();    //使用信道调取一个队列的声明（生成队列），我们可以先不创建交换机，默认就会有一个交换机    //参数：    // 1、队列的名称    // 2,队列里的消息是否需要持久化（存储磁盘），默认存储内存中    // 3,是否需要排它 ， 该队列是否只提供给一个消费者进行消费 是否进行共享 ，true:只能一个消费者消费 false:可以多个消费者消费    // 4、是否自动删除 ， 最后一个消费者断开连接后，该队列是否自动删除    // 5、队列参数    channel.queueDeclare(queryName,true,false,false,null);    //开始时间    long l = System.currentTimeMillis();    /**     * 消息确认成功回调     */    ConfirmCallback ackCallback = new ConfirmCallback() {        //参数：1、哪个消息    2、是否为批量确认        public void handle(long l, boolean b) throws IOException {            System.out.println("成功发布消息："+l);            System.out.println("是否为批量确认"+b);            if (b){                /**                 *  批量：删除掉已经确认的消息 剩下的就是为确认的消息                 *  返回此映射的部分视图，其键值严格小于 toKey。                 * ConcurrentNavigableMap&lt;K,V&gt; headMap(K toKey)                 *  返回此映射的部分视图，其键小于（或等于，如果 inclusive 为 true）toKey。                 * ConcurrentNavigableMap&lt;K,V&gt; headMap(K toKey, boolean inclusive)                 */                ConcurrentNavigableMap&lt;Long, String&gt; longStringConcurrentNavigableMap = outstandingConfirms.headMap(l);                NavigableSet&lt;Long&gt; longs = longStringConcurrentNavigableMap.keySet();                //循环获取的key将它遍历出来如何进行移出                for (Long aLong : longs) {                    System.out.println(aLong);                    outstandingConfirms.remove(aLong);                }                //清除                longStringConcurrentNavigableMap.clear();            }else {                //不是批量确认就直接移出就可以了                outstandingConfirms.remove(l);            }        }    };    ConfirmCallback nackCallback= new ConfirmCallback() {        //参数：1、哪个消息    2、是否为批量确认        public void handle(long l, boolean b) throws IOException {            System.out.println("失败发布消息："+l);            System.out.println("是否为批量确认"+b);        }    };;    /**     * addConfirmListener()消息监听器，监听哪些消息成功，哪些消息失败（有重载，一个参数的只监听成功）     * 这个方法是异步的     * 参数:     * 1、成功确认     * 2、失败确认    */    channel.addConfirmListener(ackCallback,nackCallback);    //异步发布确认，我们尽管发，由broker将消息的成功失败告诉我们，但我们需要监听器监听    for (Integer i=0;i&lt;MESSAGE_COUNT;i++){        String message="消息"+i;        //使用信道发送消息        //参数： 1、 发送到哪个交换机，我们没有创建交换机，填写空就行        // 2、路由的key值是哪个 本次是队列名称        // 3、其他参数消息        // 4、发送的消息体        channel.basicPublish("",queryName,null,i.toString().getBytes());        //将消息需要于数据放入ConcurrentSkipListMap中，channel.getNextPublishSeqNo()下个发送消息的序号        outstandingConfirms.put(channel.getNextPublishSeqNo(),message);    }    long l1 = System.currentTimeMillis();    System.out.println("发布"+MESSAGE_COUNT+"条消息，异步发布确认消息，耗时："+ (l1-l) +"毫秒");}</code></pre><h2 id="交换机-Exchanges-："><a href="#交换机-Exchanges-：" class="headerlink" title="交换机(Exchanges)："></a>交换机(Exchanges)：</h2><h3 id="交换机的作用："><a href="#交换机的作用：" class="headerlink" title="交换机的作用："></a>交换机的作用：</h3><p>可以用于发布订阅模式，由于我们使用默认交换机时，我们的多个消费者是竞争关系，一个消息只会被消费一次，当我们使用交换机可以实现绑定多个队列实现一个消息消费多次</p><p><img src="https://s2.loli.net/2022/04/14/mGudoX98wLMvcIp.png" alt="image-20220404145939041"></p><h3 id="概念"><a href="#概念" class="headerlink" title="概念:"></a>概念:</h3><p>RabbitMQ 消息传递模型的核心思想是: 生产者生产的消息从不会直接发送到队列。实际上，通常生产 者甚至都不知道这些消息传递传递到了哪些队列中。生产者只能将消息发送到交换机(exchange)，交换机工作的内容非常简单，一方面它接收来 自生产者的消息，另一方面将它们推入队列。交换机必须确切知道如何处理收到的消息。是应该把这些消 息放到特定队列还是说把他们到许多队列中还是说应该丢弃它们。这就的由交换机的类型来决定。</p><h3 id="交换机-Exchanges-类型"><a href="#交换机-Exchanges-类型" class="headerlink" title="交换机(Exchanges)类型:"></a>交换机(Exchanges)类型:</h3><p><strong>总共有以下类型：</strong> </p><p>路由类型：直接(direct),    </p><p>主题类型(topic) ,   </p><p>头类型：标题(headers) ,  </p><p> 发布订阅类型： 扇出(fanout)</p><h3 id="无名交换机（exchange）"><a href="#无名交换机（exchange）" class="headerlink" title="无名交换机（exchange）"></a>无名交换机（exchange）</h3><p>前面部分我们对 exchange 一无所知，但仍然能够将消息发送到队列。之前能实现的 原因是因为我们使用的是默认交换，我们通过空字符串(“”)进行标识。</p><pre class="language-none"><code class="language-none">channel.basicPublish("",QUEUE_NAME,null,message.getBytes());</code></pre><p>第一个参数是交换机的名称。空字符串表示默认或无名称交换机</p><p>消息能发送到队列中其实 是由 routingKey(bindingkey)绑定 key 指定的，如果它存在的话，</p><p>没有可以使用队列名称，使用创建的交换机时要绑定队列的routingKey(bindingkey)，bindingkey是队列的key，可以自己取名的（队列默认binding就是队列名称）</p><h3 id="临时队列："><a href="#临时队列：" class="headerlink" title="临时队列："></a>临时队列：</h3><p>没有持久化的队列就是临时队列</p><p>每当我们连接到 Rabbit 时，我们都需要一个全新的空队列，为此我们可以创建一个具有随机名称 的队列，或者能让服务器为我们选择一个随机队列名称那就更好了。其次一旦我们断开了消费者的连 接，队列将被自动删除。</p><p>创建临时队列的方式如下:</p><p>​    String queueName = channel.queueDeclare().getQueue();</p><p>创建出来之后长成这样:</p><p><img src="https://s2.loli.net/2022/04/14/zYrdGTwJDHSjtb3.png" alt="image-20220404200129888"></p><h3 id="绑定-bindings-："><a href="#绑定-bindings-：" class="headerlink" title="绑定(bindings)："></a>绑定(bindings)：</h3><p>什么是 bingding 呢，binding 其实是 交换机（exchange） 和 队列（queue） 之间的桥梁，它告诉我们 交换机（exchange） 和 哪个队 列进行了绑定关系。比如说下面这张图告诉我们的就是 X 与 Q1 和 Q2 进行了绑</p><p>简单说就是，交换机绑定队列的bindingkey，绑定后交换机就可以把消息放入绑定的队列中</p><p><img src="https://s2.loli.net/2022/04/14/Pwmui8EXOjas67A.png" alt="image-20220404200257614"></p><h3 id="发布订阅（fanout）："><a href="#发布订阅（fanout）：" class="headerlink" title="发布订阅（fanout）："></a>发布订阅（fanout）：</h3><h4 id="Fanout-介绍："><a href="#Fanout-介绍：" class="headerlink" title="Fanout 介绍："></a>Fanout 介绍：</h4><p>Fanout 这种类型非常简单。正如从名称中猜到的那样，它是将接收到的所有消息<strong>广播</strong>到它知道的所有队列中。</p><p>系统中默认有的exchange 类型：</p><p><img src="https://s2.loli.net/2022/04/14/KWIwfl6CJ24es8g.png" alt="image-20220405141041791"></p><h4 id="Fanout-示例："><a href="#Fanout-示例：" class="headerlink" title="Fanout 示例："></a>Fanout 示例：</h4><h5 id="大致实现图："><a href="#大致实现图：" class="headerlink" title="大致实现图："></a><strong>大致实现图：</strong></h5><p><img src="https://s2.loli.net/2022/04/14/GDIdVU5R8litqKL.png" alt="image-20220405141154377"></p><h5 id="交换机与队列关："><a href="#交换机与队列关：" class="headerlink" title="交换机与队列关："></a><strong>交换机与队列关：</strong></h5><p><strong>交换机</strong></p><p><img src="https://s2.loli.net/2022/04/14/4YsXKpdCnWR3gLy.png" alt="image-20220405141620556"></p><p><strong>队列</strong></p><p><img src="https://s2.loli.net/2022/04/14/omujXgWNTdsSEVh.png" alt="image-20220405141844488"></p><h4 id="生产者：-8"><a href="#生产者：-8" class="headerlink" title="生产者："></a>生产者：</h4><p>我们需要在生产者中声明一个交换机： channel.exchangeDeclare(EXCHANGE_NAME,”fanout”);   注意：谁先启动就写谁那（也可以两边都声明交换机）</p><p>队列也不在我们生产者中声明了，交给消费者声明，因为生产者中只需要队列的Routing key即可</p><p> channel.basicPublish(EXCHANGE_NAME, “queue”, null,message.getBytes());</p><pre class="language-none"><code class="language-none">/** * 生产者: * 我们现在使用交换机，bindingKey进行绑定发送消息，所以我们不需要声明队列， * 队列交给消费者声明，消费者再对队列进行设置bindingKey，并与交换机绑定bindingKey * 我们只需要再生产者处声明交换机即可，消费者不以不声明交换机，直接使用交换机名称即可 */public class EmitLog {    public static final String EXCHANGE_NAME = "logs";    public static void main(String[] args) throws IOException, TimeoutException {        Channel channel = RabbitMQUtil.getChannel();        /**         * 声明交换机         * 参数1，交换机名称         * 参数2，交换机类型（Fanout（扇出类型），发布订阅类型）         */        channel.exchangeDeclare(EXCHANGE_NAME,"fanout");        Scanner scanner = new Scanner(System.in);        while (scanner.hasNext()) {            String message = scanner.next();            //使用信道发送消息            //参数：            // 1、 发送到哪个交换机，我们没有创建交换机，填写空就行            // 2、路由的RontingKey值是哪个,（告诉交换机，消息要发送到指定Routingkey的队列中）            // 3、其他参数消息            // 4、发送的消息体            channel.basicPublish(EXCHANGE_NAME, "queue", null,message.getBytes());            System.out.println(message+" ---&gt; 成功发送");        }    }}</code></pre><h4 id="消费者：-4"><a href="#消费者：-4" class="headerlink" title="消费者："></a>消费者：</h4><p>（注意，需要两个生产者，我们只需要在创建一个生产者，并且将ReceiveLogs01改为其他提示即可如：ReceiveLogs02，<strong>Routingkey不可更改，要不然生产者发送的信息交换机就不能将消息都发送到了两个消费者了</strong>，因为生产者中发布消息给交换机需要指定一个Routingkey，如果两个消费者Routingkey不同，交换机只会给指定的那一个Routingkey的队列发送消息）</p><p>我们需要声明队列：  String queue = channel.queueDeclare().getQueue();  这是个临时队列，当消费者断开和该队列的连接时 队列自动删除</p><p>并为队列绑定交换机，并设置Routingkey并与交换机绑定： channel.queueBind(queue,EXCHANGE_NAME,”queue”);</p><pre class="language-none"><code class="language-none">/** * 消费者1，我们的bindingKey要与其他消费者相同这样就能够消费者都接收到相同的消息 * （生产者发送消息给交换机，交换机根据bindingKey发送给队列，因为bindingKey都一样所以就可以发送） */public class ReceiveLogs01 {    public static final String EXCHANGE_NAME = "logs";    public static void main(String[] args) throws IOException, TimeoutException {        Channel channel = RabbitMQUtil.getChannel();        /**         * 声明交换机（交给生产者声明就行）         * 参数1，交换机名称         * 参数2，交换机类型（Fanout（扇出类型），发布订阅类型）         * BuiltinExchangeType.FANOUT == "fanout"         */        //channel.exchangeDeclare(EXCHANGE_NAME,BuiltinExchangeType.FANOUT);        /**         * 声明一个临时队列（并获取临时队列名称）         *  生成一个临时的队列 队列的名称是随机的         *  当消费者断开和该队列的连接时 队列自动删除         */        String queue = channel.queueDeclare().getQueue();        /**         * 队列绑定         * 参数1：队列名称         * 参数2：交换名称         * 参数3：队列bindingKey（也是设置队列bindingKey）；交换机根据queue发送消息，可发送给多个消费者         *      生产者发送消息给交换机，交换机根据bindingKey发送给队列，因为bindingKey都一样所以就可以发送         */        channel.queueBind(queue,EXCHANGE_NAME,"queue");        //成功获取生产者信息回调方法        DeliverCallback deliverCallback = new DeliverCallback() {            public void handle(String s, Delivery delivery) throws IOException {                System.out.println("ReceiveLogs01 消费消息："+new String(delivery.getBody()));            }        };        // 消费者取消消费的回调方法        CancelCallback cancelCallback = new CancelCallback() {            public void handle(String s) throws IOException {                System.out.println(s + ":ReceiveLogs01 消费者取消消费 回调函数  逻辑代码....");            }        };        System.out.println("ReceiveLogs01:等待消费中.................");        /**         *  消费者消费（获取对列消息）         *   参数:         *   1,消费哪个队列         *   2,消费成功后是否自动应答  true：自动应答  false：手动应答         *        应答作用：消费者发送一个消息应答，告诉RabbitMQ这个消息已经接收并且处理完毕了。RabbitMQ就可以删除它了。         *   3,消费者成功消费的回调方法         *   4，消费者取消消费的回调方法         */        channel.basicConsume(queue,true,deliverCallback,cancelCallback);    }}</code></pre><h4 id="结果：-1"><a href="#结果：-1" class="headerlink" title="结果："></a>结果：</h4><p>可以看到，消费者1和消费者2都消费到了相同的信息</p><p><img src="https://s2.loli.net/2022/04/14/capLE1zoGQBnwji.png" alt="image-20220405142844948"></p><h3 id="直接交换机（direct）："><a href="#直接交换机（direct）：" class="headerlink" title="直接交换机（direct）："></a>直接交换机（direct）：</h3><h4 id="介绍：-1"><a href="#介绍：-1" class="headerlink" title="介绍："></a>介绍：</h4><p>我们希望将日志消息写入磁盘的程序仅接收严重错误(errros)，而不存储哪些警告(warning)或信息(info)日志 消息避免浪费磁盘空间。Fanout 这种交换类型并不能给我们带来很大的灵活性-它只能进行无意识的 广播，在这里我们将使用 direct 这种类型来进行替换，这种类型的工作方式是，消息只去到它绑定的 routingKey 队列中去</p><p><img src="https://s2.loli.net/2022/04/14/1JbkAOXp8GgPK3a.png" alt="image-20220405145232744"></p><p>在上面这张图中，我们可以看到 X 绑定了两个队列，绑定类型是 direct。队列 Q1 绑定键为 orange， 队列 Q2 绑定键有两个:一个绑定键为 black，另一个绑定键为 green.</p><p>在这种绑定情况下，生产者发布消息到 exchange 上，绑定键为 orange 的消息会被发布到队列 Q1。绑定键为 blackgreen 和的消息会被发布到队列 Q2，其他消息类型的消息将被丢弃。</p><h4 id="多重绑定"><a href="#多重绑定" class="headerlink" title="多重绑定"></a>多重绑定</h4><p><img src="https://s2.loli.net/2022/04/14/miUPfgowZ4hxy5a.png" alt="image-20220405145459224"></p><p>当然如果 exchange 的绑定类型是 direct，但是它绑定的多个队列的 key 如果都相同，在这种情 况下虽然绑定类型是 direct 但是它表现的就和 fanout 有点类似了，就跟广播差不多，如上图所示</p><h4 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h4><p>直接交换机可以发送给不同的routingkey的队列，只需要改变发布时交换机要发送到达RoutingKey即可，</p><p><img src="https://s2.loli.net/2022/04/14/xV3PYC6qyIWDn4l.png" alt="image-20220405145531537"></p><p><img src="https://s2.loli.net/2022/04/14/xiFW2CnH6hpwe9B.png" alt="image-20220405145636633"></p><h4 id="消费者1"><a href="#消费者1" class="headerlink" title="消费者1:"></a>消费者1:</h4><pre class="language-none"><code class="language-none">public class ReceiveLogsDirect01 { private static final String EXCHANGE_NAME = "direct_logs"; public static void main(String[] argv) throws Exception { Channel channel = RabbitUtils.getChannel(); channel.exchangeDeclare(EXCHANGE_NAME, BuiltinExchangeType.DIRECT); String queueName = "disk";  channel.queueDeclare(queueName, false, false, false, null); channel.queueBind(queueName, EXCHANGE_NAME, "error");  System.out.println("等待接收消息.....");  DeliverCallback deliverCallback = (consumerTag, delivery) -&gt; { String message = new String(delivery.getBody(), "UTF-8"); message="接收绑定键:"+delivery.getEnvelope().getRoutingKey()+",消息:"+message; File file = new File("C:\\work\\rabbitmq_info.txt"); FileUtils.writeStringToFile(file,message,"UTF-8"); System.out.println("错误日志已经接收"); }; //消费者消费（获取对列消息）    //参数:    //1,消费哪个对象    //2,消费成功后是否自动应答  true：自动应答  false：手动应答    //     应答作用：消费者发送一个消息应答，告诉RabbitMQ这个消息已经接收并且处理完毕了。RabbitMQ就可以删除它了。    //3,消费者成功消费的回调方法    //4，消费者取消消费的回调方法 channel.basicConsume(queueName, true, deliverCallback, consumerTag -&gt; { }); }}</code></pre><h4 id="消费者2："><a href="#消费者2：" class="headerlink" title="消费者2："></a>消费者2：</h4><pre class="language-none"><code class="language-none">public class ReceiveLogsDirect02 { private static final String EXCHANGE_NAME = "direct_logs"; public static void main(String[] argv) throws Exception {      Channel channel = RabbitUtils.getChannel();     channel.exchangeDeclare(EXCHANGE_NAME, BuiltinExchangeType.DIRECT);     String queueName = "console";          channel.queueDeclare(queueName, false, false, false, null);          channel.queueBind(queueName, EXCHANGE_NAME, "info");     channel.queueBind(queueName, EXCHANGE_NAME, "warning");     System.out.println("等待接收消息.....");          DeliverCallback deliverCallback = (consumerTag, delivery) -&gt; {    String message = new String(delivery.getBody(), "UTF-8");     System.out.println(" 接收绑定键 :"+delivery.getEnvelope().getRoutingKey()+", 消  息:"+message);     };     //消费者消费（获取对列消息）     //参数:     //1,消费哪个对象     //2,消费成功后是否自动应答  true：自动应答  false：手动应答     //     应答作用：消费者发送一个消息应答，告诉RabbitMQ这个消息已经接收并且处理完毕了。RabbitMQ就可以删除它了。     //3,消费者成功消费的回调方法     //4，消费者取消消费的回调方法     channel.basicConsume(queueName, true, deliverCallback, consumerTag -&gt; {     }); }}</code></pre><h4 id="生产者：-9"><a href="#生产者：-9" class="headerlink" title="生产者："></a>生产者：</h4><pre class="language-none"><code class="language-none">public class EmitLogDirect {        private static final String EXCHANGE_NAME = "direct_logs";        public static void main(String[] argv) throws Exception {            try (Channel channel = RabbitUtils.getChannel()) {                channel.exchangeDeclare(EXCHANGE_NAME, BuiltinExchangeType.DIRECT);                //创建多个 bindingKey                Map&lt;String, String&gt; bindingKeyMap = new HashMap&lt;&gt;();                bindingKeyMap.put("info","普通 info 信息");                bindingKeyMap.put("warning","警告 warning 信息");                bindingKeyMap.put("error","错误 error 信息");                //debug 没有消费这接收这个消息 所有就丢失了                bindingKeyMap.put("debug","调试 debug 信息");                                for (Map.Entry&lt;String, String&gt; bindingKeyEntry: bindingKeyMap.entrySet()){                    String bindingKey = bindingKeyEntry.getKey();                    String message = bindingKeyEntry.getValue();                    channel.basicPublish(EXCHANGE_NAME,bindingKey, null,                            message.getBytes("UTF-8"));                    System.out.println("生产者发出消息:" + message);                }            }        }    }</code></pre><h3 id="主题类型（Topics）"><a href="#主题类型（Topics）" class="headerlink" title="主题类型（Topics）"></a>主题类型（Topics）</h3><p>使用这个类型，我们可以做到Routingkey动态化</p><h4 id="Topic-的要求"><a href="#Topic-的要求" class="headerlink" title="Topic 的要求"></a>Topic 的要求</h4><p>发送到类型是 topic 交换机的消息的 routing_key 不能随意写，必须满足一定的要求，<strong>它必须是一个单 词列表，以点号分隔开</strong>。这些单词可以是任意单词，比如说：”stock.usd.nyse”, “nyse.vmw”,  “quick.orange.rabbit”.这种类型的。当然这个单词列表最多不能超过 255 个字节。（使用这种方法就可以做到Routingkey的动态绑定）</p><p><strong>在这个规则列表中，其中有两个替换符是大家需要注意的</strong></p><p>*** ** (星号)可以代替一个单词</p><p><strong>#</strong>  (井号)可以替代零个或多个单词</p><h4 id="Topic-匹配案例"><a href="#Topic-匹配案例" class="headerlink" title="Topic 匹配案例"></a>Topic 匹配案例</h4><p><strong>下图绑定关系如下</strong></p><p>Q2是多绑定</p><p><img src="https://s2.loli.net/2022/04/14/jnmtpCIc3SvrLib.png" alt="image-20220405222728111"></p><p><strong>上图是一个队列绑定关系图，我们来看看他们之间数据接收情况是怎么样的</strong></p><p>quick.orange.rabbit             被队列 Q1Q2 接收到</p><p>lazy.orange.elephant          被队列 Q1Q2 接收到</p><p>quick.orange.fox                 被队列 Q1 接收到</p><p>lazy.brown.fox                     被队列 Q2 接收到</p><p>lazy.pink.rabbit                    虽然满足两个绑定但只被队列 Q2 接收一次（因为匹配到的都是Q2）</p><p>quick.brown.fox                  不匹配任何绑定不会被任何队列接收到会被丢弃</p><p>quick.orange.male.rabbit         是四个单词不匹配任何绑定会被丢弃</p><p>lazy.orange.male.rabbit         是四个单词但匹配 Q2</p><p><strong>当队列绑定关系是下列这种情况时需要引起注意</strong></p><p>当一个队列绑定键是#,那么这个队列将接收所有数据，就有点像 fanout 了</p><p>如果队列绑定键当中没有#和*出现，那么该队列绑定类型就是 direct 了</p><h4 id="生产者：-10"><a href="#生产者：-10" class="headerlink" title="生产者："></a>生产者：</h4><p>RoutingKey需要规范，看上面的<strong>Topic 的要求</strong></p><pre class="language-none"><code class="language-none">/** * 生产者 */public class EmitLogTopic {    public static final String EXCHANGE_NAME = "topic_logs";    public static void main(String[] args) throws IOException, TimeoutException {        Channel channel = RabbitMQUtil.getChannel();        /**         * 声明交换机         * 参数：         * 1，交换机名称         * 2，交换机类型         */        channel.exchangeDeclare(EXCHANGE_NAME, BuiltinExchangeType.TOPIC);        //这是要发送消息的RoutingKey与消息主体        Map&lt;String, String&gt; bindingKeyMap = new HashMap();        bindingKeyMap.put("quick.orange.rabbit","被队列 Q1Q2 接收到");        bindingKeyMap.put("lazy.orange.elephant","被队列 Q1Q2 接收到");        bindingKeyMap.put("quick.orange.fox","被队列 Q1 接收到");        bindingKeyMap.put("lazy.brown.fox","被队列 Q2 接收到");        bindingKeyMap.put("lazy.pink.rabbit","虽然满足两个绑定但只被队列 Q2 接收一次");        bindingKeyMap.put("quick.brown.fox","不匹配任何绑定不会被任何队列接收到会被丢弃");        bindingKeyMap.put("quick.orange.male.rabbit","是四个单词不匹配任何绑定会被丢弃");        bindingKeyMap.put("lazy.orange.male.rabbit","是四个单词但匹配 Q2");        Set&lt;Map.Entry&lt;String, String&gt;&gt; entries = bindingKeyMap.entrySet();        for (Map.Entry&lt;String, String&gt; entry : entries) {            String RoutingKey = entry.getKey();            String message = entry.getValue();            channel.basicPublish(EXCHANGE_NAME,RoutingKey,null,message.getBytes());            System.out.println(message+" ---&gt; 发送成功");        }    }}</code></pre><h4 id="消费者1："><a href="#消费者1：" class="headerlink" title="消费者1："></a>消费者1：</h4><p>RoutingKey需要规范，看上面的<strong>Topic 的要求</strong></p><p>delivery.getEnvelope().getRoutingKey() 可获取到当前消息发送使用的RoutingKey</p><pre class="language-none"><code class="language-none">/** * 消费者1 */public class ReceiveLogsTopic01 {    public static final String EXCHANGE_NAME = "topic_logs";    public static void main(String[] args) throws IOException, TimeoutException {        Channel channel = RabbitMQUtil.getChannel();        /**         * 声明交换机         * 参数：         * 1，交换机名称         * 2，交换机类型         */        channel.exchangeDeclare(EXCHANGE_NAME, BuiltinExchangeType.TOPIC);        String queueName="Q1";        //使用信道调取一个队列的声明（生成队列），我们可以先不创建交换机，默认就会有一个交换机        //参数：        // 1、队列的名称        // 2,队列里的消息是否需要持久化（存储磁盘），默认存储内存中        // 3,是否需要排它 ， 该队列是否只提供给一个消费者进行消费 是否进行共享 ，true:只能一个消费者消费 false:可以多个消费者消费        // 4、是否自动删除 ， 最后一个消费者断开连接后，该队列是否自动删除        // 5、队列参数        channel.queueDeclare(queueName,false,false,false,null);        channel.queueBind(queueName,EXCHANGE_NAME,"*.orange.*");        System.out.println("ReceiveLogsTopic01 准备消费...............");        //成功获取生产者信息回调方法        DeliverCallback deliverCallback = new DeliverCallback() {            public void handle(String s, Delivery delivery) throws IOException {                //获取RoutingKey                System.out.println("当前队列RoutingKey ： "+delivery.getEnvelope().getRoutingKey());                System.out.println("ReceiveLogsTopic01 消费消息："+new String(delivery.getBody()));            }        };        // 消费者取消消费的回调方法        CancelCallback cancelCallback = new CancelCallback() {            public void handle(String s) throws IOException {                System.out.println(s + ":ReceiveLogsTopic01 消费者取消消费 回调函数  逻辑代码....");            }        };        /**         *  消费者消费（获取对列消息）         *   参数:         *   1,消费哪个队列         *   2,消费成功后是否自动应答  true：自动应答  false：手动应答         *        应答作用：消费者发送一个消息应答，告诉RabbitMQ这个消息已经接收并且处理完毕了。RabbitMQ就可以删除它了。         *   3,消费者成功消费的回调方法         *   4，消费者取消消费的回调方法         */        channel.basicConsume(queueName,true,deliverCallback,cancelCallback);    }}</code></pre><h4 id="消费者2：-1"><a href="#消费者2：-1" class="headerlink" title="消费者2："></a>消费者2：</h4><p>RoutingKey需要规范，看上面的<strong>Topic 的要求</strong></p><p>delivery.getEnvelope().getRoutingKey() 可获取到当前消息发送使用的RoutingKey</p><pre class="language-none"><code class="language-none">/** * 消费者2 */public class ReceiveLogsTopic02 {    public static final String EXCHANGE_NAME = "topic_logs";    public static void main(String[] args) throws IOException, TimeoutException {        Channel channel = RabbitMQUtil.getChannel();        /**         * 声明交换机         * 参数：         * 1，交换机名称         * 2，交换机类型         */        channel.exchangeDeclare(EXCHANGE_NAME, BuiltinExchangeType.TOPIC);        String queueName="Q2";        //使用信道调取一个队列的声明（生成队列），我们可以先不创建交换机，默认就会有一个交换机        //参数：        // 1、队列的名称        // 2,队列里的消息是否需要持久化（存储磁盘），默认存储内存中        // 3,是否需要排它 ， 该队列是否只提供给一个消费者进行消费 是否进行共享 ，true:只能一个消费者消费 false:可以多个消费者消费        // 4、是否自动删除 ， 最后一个消费者断开连接后，该队列是否自动删除        // 5、队列参数        channel.queueDeclare(queueName,false,false,false,null);        channel.queueBind(queueName,EXCHANGE_NAME,"*.*.rabbit");        channel.queueBind(queueName,EXCHANGE_NAME,"lazy.#");        System.out.println("ReceiveLogsTopic02 准备消费...............");        //成功获取生产者信息回调方法        DeliverCallback deliverCallback = new DeliverCallback() {            public void handle(String s, Delivery delivery) throws IOException {                //获取RoutingKey                System.out.println("当前队列RoutingKey ： "+delivery.getEnvelope().getRoutingKey());                System.out.println("ReceiveLogsTopic02 消费消息："+new String(delivery.getBody()));            }        };        // 消费者取消消费的回调方法        CancelCallback cancelCallback = new CancelCallback() {            public void handle(String s) throws IOException {                System.out.println(s + ":ReceiveLogsTopic02 消费者取消消费 回调函数  逻辑代码....");            }        };        /**         *  消费者消费（获取对列消息）         *   参数:         *   1,消费哪个队列         *   2,消费成功后是否自动应答  true：自动应答  false：手动应答         *        应答作用：消费者发送一个消息应答，告诉RabbitMQ这个消息已经接收并且处理完毕了。RabbitMQ就可以删除它了。         *   3,消费者成功消费的回调方法         *   4，消费者取消消费的回调方法         */        channel.basicConsume(queueName,true,deliverCallback,cancelCallback);    }}</code></pre><h4 id="结果：-2"><a href="#结果：-2" class="headerlink" title="结果："></a>结果：</h4><p><img src="https://s2.loli.net/2022/04/14/RiYxFdltvyBXOmH.png" alt="image-20220406140846561"></p><h2 id="死信队列"><a href="#死信队列" class="headerlink" title="死信队列"></a>死信队列</h2><h3 id="概念："><a href="#概念：" class="headerlink" title="概念："></a>概念：</h3><p>先从概念解释上搞清楚这个定义，死信，顾名思义就是无法被消费的消息，字面意思可以这样理 解，一般来说，producer 将消息投递到 broker 或者直接到 queue 里了，consumer 从 queue 取出消息 进行消费，但某些时候由于特定的原因导致 queue 中的某些消息无法被消费，这样的消息如果没有 后续的处理，就变成了死信，有死信自然就有了死信队列。 </p><p>应用场景:为了保证订单业务的消息数据不丢失，需要使用到 RabbitMQ 的死信队列机制，当消息 消费发生异常时，将消息投入死信队列中.还有比如说: 用户在商城下单成功并点击去支付后在指定时 间未支付时自动失效</p><h3 id="死信的来源："><a href="#死信的来源：" class="headerlink" title="死信的来源："></a>死信的来源：</h3><p>消息 TTL 过期 （存活时间过期，消息也是有存活时间的）</p><p>队列达到最大长度(队列满了，无法再添加数据到 mq 中)</p><p>消息被拒绝(basic.reject 或 basic.nack)并且 requeue=false.</p><h3 id="死信队列示例："><a href="#死信队列示例：" class="headerlink" title="死信队列示例："></a>死信队列示例：</h3><h4 id="流程图："><a href="#流程图：" class="headerlink" title="流程图："></a>流程图：</h4><p>注意：是由普通队列发送给死信队列的，所以我们是要为普通队列设置一下参数</p><p><img src="https://s2.loli.net/2022/04/14/QgKhnaw9mrSp5cs.png" alt="image-20220406140004952"></p><h4 id="生产者：-11"><a href="#生产者：-11" class="headerlink" title="生产者："></a>生产者：</h4><p>我们需要为发布的消息进行参数设置：</p><p>AMQP.BasicProperties properties = new AMQP.BasicProperties() .builder().expiration(“10000”).build();<br>这是个链式操作，builder开始  ，build结束，中间则是设置参数的，</p><p>expiration是设置消息过期时间</p><p>生产者其实只需要将消息发送到正常普通的交换机即可，当出现死信时有普通队列将信息发送给死信交换机，然后再放入死信队列</p><pre class="language-none"><code class="language-none">/** * 生产者 */public class Producer {    //普通交换机名称    public static final String NORMAL_EXCHANGE="normal_exchange";    public static void main(String[] args) throws IOException, TimeoutException {        Channel channel = RabbitMQUtil.getChannel();        channel.exchangeDeclare(NORMAL_EXCHANGE,"direct");        /**         * 设置参数（链式）         * builder 开始         * 设置参数  expiration设置消息有效时长  ms         * build  结束         */        AMQP.BasicProperties properties = new AMQP.BasicProperties()                .builder().expiration("10000").build();        for (int i = 0; i &lt; 10; i++) {            String message = "消息"+i;            channel.basicPublish(NORMAL_EXCHANGE,"normal",properties,message.getBytes());        }        System.out.println("发送完成");    }}</code></pre><h4 id="普通队列消费者："><a href="#普通队列消费者：" class="headerlink" title="普通队列消费者："></a>普通队列消费者：</h4><p>我们需要需要什么两个个交换机：</p><p>普通交换机：我们需要进行正常信息的消费</p><p>死信交换机：在这声明死信交换机与队列是应为我们刚好需要使用，如果在使用时我们死信交换机或死信队列不在的话会报错</p><p>使用到了的队列的参数设置：</p><p>我们需要声明一个 Map&lt;String, Object&gt; parameter = new HashMap();</p><p>key为我们的参数名，固定的不会变</p><p>value为设置的参数</p><p>参数名：</p><p>x-dead-letter-exchange   设置死信交换机</p><p>x-dead-letter-routing-key  设置死信对齐</p><p>x-message-tt1   设置消息过期时间 ms（这个我们在生产者中设置更好）</p><p>x-max-length   设置队列消息个数数（当超过队列长度的消息会进入死信队列）</p><p>死信交换机与死信队列其实不用过多的设置，就普通的即可，我们只是将死信放入一个普通的队列而已，由于这个队列是存放死信的所以才叫私信队列，交换机也是同理，所以不用过多设置</p><pre class="language-none"><code class="language-none">/** * 消费者1，（ C1） */public class NormalConsumer01 {    //普通交换机名称    public static final String NORMAL_EXCHANGE="normal_exchange";    //死信交换机名称    public static final String DEAD_EXCHANGE="dead_exchange";    //普通队列名称    public static final String NORMAL_QUEUE="normal_queue";    //死信队列名称    public static final String DEAD_QUEUE="dead_queue";    public static void main(String[] args) throws IOException, TimeoutException {        Channel channel = RabbitMQUtil.getChannel();        /**         * 声明死信交换机，死信交换机机也是普通交换机         */        channel.exchangeDeclare(DEAD_EXCHANGE,"direct");        /**         * 声明死信队列，死信队列我们不需要设置声明参数         */        channel.queueDeclare(DEAD_QUEUE,false,false,false,null);        //让死信队列与死信交换机绑定        channel.queueBind(DEAD_QUEUE,DEAD_EXCHANGE,"dead");        //---------------------------------------------------------------------------        /**         * 声明普通交换机         */        channel.exchangeDeclare(NORMAL_EXCHANGE,"direct");        /**         * 设置参数 参数key都是固定的         * x-dead-letter-exchange   设置死信交换机         * x-dead-letter-routing-key  设置死信对齐         * x-message-tt1   设置过期时间 ms         */        Map&lt;String, Object&gt; parameter = new HashMap();        //告诉普通队列，死信交换机是哪个        parameter.put("x-dead-letter-exchange",DEAD_EXCHANGE);        //告诉普通队列，死信交队列的RoutingKey        parameter.put("x-dead-letter-routing-key","dead");        //设置消息过期时间，这个在生产者也可以设置，并且在生产者中设置也更好        //parameter.put("x-message-tt1",10000);        //设置队列长度（当超过队列长度的消息会进入死信队列）        //parameter.put("x-max-length",6);        /**         * 声明普通队列，由于普通队列需要向向死信队列发送死信，所以我们需要参数         */        channel.queueDeclare(NORMAL_QUEUE,false,false,false,parameter);        //普通队列与普通交换机绑定        channel.queueBind(NORMAL_QUEUE,NORMAL_EXCHANGE,"normal");        System.out.println("C1 准备消费......");        //成功获取生产者信息回调方法        DeliverCallback deliverCallback = new DeliverCallback() {            public void handle(String s, Delivery delivery) throws IOException {                System.out.println("c1 消费消息："+new String(delivery.getBody()));            }        };        // 消费者取消消费的回调方法        CancelCallback cancelCallback = new CancelCallback() {            public void handle(String s) throws IOException {                System.out.println(s + ":c1 消费者取消消费 回调函数  逻辑代码....");            }        };        /**         *  消费者消费（获取对列消息）         *   参数:         *   1,消费哪个队列         *   2,消费成功后是否自动应答  true：自动应答  false：手动应答         *        应答作用：消费者发送一个消息应答，告诉RabbitMQ这个消息已经接收并且处理完毕了。RabbitMQ就可以删除它了。         *   3,消费者成功消费的回调方法         *   4，消费者取消消费的回调方法         */        channel.basicConsume(NORMAL_QUEUE,true,deliverCallback,cancelCallback);    }}</code></pre><h4 id="死信队列消费者："><a href="#死信队列消费者：" class="headerlink" title="死信队列消费者："></a>死信队列消费者：</h4><p>由于在普通消费者中交换机与队列都已声明过，所以我们只需要使用队列名获取消息即可</p><pre class="language-none"><code class="language-none">/** * C2 死信消费者 */public class DeadConsumer02 {    //死信队列名称    public static final String DEAD_QUEUE="dead_queue";    public static void main(String[] args) throws IOException, TimeoutException {        Channel channel = RabbitMQUtil.getChannel();        System.out.println("死信C2 准备消费......");        //成功获取生产者信息回调方法        DeliverCallback deliverCallback = new DeliverCallback() {            public void handle(String s, Delivery delivery) throws IOException {                System.out.println("死信c2 消费消息："+new String(delivery.getBody()));            }        };        // 消费者取消消费的回调方法        CancelCallback cancelCallback = new CancelCallback() {            public void handle(String s) throws IOException {                System.out.println(s + ":死信c2 消费者取消消费 回调函数  逻辑代码....");            }        };        /**         *  消费者消费（获取对列消息）         *   参数:         *   1,消费哪个队列         *   2,消费成功后是否自动应答  true：自动应答  false：手动应答         *        应答作用：消费者发送一个消息应答，告诉RabbitMQ这个消息已经接收并且处理完毕了。RabbitMQ就可以删除它了。         *   3,消费者成功消费的回调方法         *   4，消费者取消消费的回调方法         */        channel.basicConsume(DEAD_QUEUE,true,deliverCallback,cancelCallback);    }}</code></pre><h4 id="结果一（非死信）："><a href="#结果一（非死信）：" class="headerlink" title="结果一（非死信）："></a>结果一（非死信）：</h4><p><strong>没有死信产生</strong></p><p>普通消费者成功消费</p><p><img src="https://s2.loli.net/2022/04/14/owXC2GZ1tAv4qP7.png" alt="image-20220406214300928"></p><h4 id="结果2（死信）："><a href="#结果2（死信）：" class="headerlink" title="结果2（死信）："></a>结果2（死信）：</h4><p><strong>消费者1创建了交换机和队列后关闭了，消息过期后发送到死信队列</strong></p><p><strong>成功发布消息</strong></p><p><img src="https://s2.loli.net/2022/04/14/TMN1x3XUBFzWmpq.png" alt="image-20220406215039743"></p><p><strong>消息过期成为死信</strong>：</p><p><img src="https://s2.loli.net/2022/04/14/TzDGU4tJgrVhxdc.png" alt="image-20220406215108957"></p><p><strong>被死信队列消费</strong>：</p><p><img src="https://s2.loli.net/2022/04/14/lRjX6DM4VfWLI5b.png" alt="image-20220406215304717"></p><p><strong>这是超出普通队列长度后的结果：</strong></p><p>发送了10条消息，普通队列长度为6，<strong>注意：要设置队列的参数</strong></p><p><img src="https://s2.loli.net/2022/04/14/9m7u1CteIa28YE3.png" alt="image-20220406222848617"></p><h4 id="普通队列消费者（消息据收）："><a href="#普通队列消费者（消息据收）：" class="headerlink" title="普通队列消费者（消息据收）："></a>普通队列消费者（消息据收）：</h4><p>死信来源：消费者拒收消息</p><p>前面的普通队列消费者是消息存活超时与长度（长度的参数注释了）的消费者示例</p><p>这个是消息拒收后加入死信队列的演示，其他消费者，生产者（取消消息超时时间）和上面相同</p><p>注意：要改为手动应答，否则手动拒收消息是不可用的，因为自动应答后已经将消息删除了</p><pre class="language-none"><code class="language-none">/** * 消费者1，（ C1） */public class NormalConsumer01 {    //普通交换机名称    public static final String NORMAL_EXCHANGE="normal_exchange";    //死信交换机名称    public static final String DEAD_EXCHANGE="dead_exchange";    //普通队列名称    public static final String NORMAL_QUEUE="normal_queue";    //死信队列名称    public static final String DEAD_QUEUE="dead_queue";    public static void main(String[] args) throws IOException, TimeoutException {        final Channel channel = RabbitMQUtil.getChannel();        /**         * 声明死信交换机，死信交换机机也是普通交换机         */        channel.exchangeDeclare(DEAD_EXCHANGE,"direct");        /**         * 声明死信队列，死信队列我们不需要设置声明参数         */        channel.queueDeclare(DEAD_QUEUE,false,false,false,null);        //让死信队列与死信交换机绑定        channel.queueBind(DEAD_QUEUE,DEAD_EXCHANGE,"dead");        //---------------------------------------------------------------------------        /**         * 声明普通交换机         */        channel.exchangeDeclare(NORMAL_EXCHANGE,"direct");        /**         * 设置参数 参数key都是固定的         * x-dead-letter-exchange   设置死信交换机         * x-dead-letter-routing-key  设置死信对齐         * x-message-tt1   设置过期时间 ms         * x-max-length    设置队列长度（当超过队列长度的消息会进入死信队列）         */        Map&lt;String, Object&gt; parameter = new HashMap();        //告诉普通队列，死信交换机是哪个        parameter.put("x-dead-letter-exchange",DEAD_EXCHANGE);        //告诉普通队列，死信交队列的RoutingKey        parameter.put("x-dead-letter-routing-key","dead");        //设置消息过期时间，这个在生产者也可以设置，并且在生产者中设置也更好//        parameter.put("x-message-tt1",10000);        //设置队列长度（当超过队列长度的消息会进入死信队列）        //parameter.put("x-max-length",6);        /**         * 声明普通队列，由于普通队列需要向向死信队列发送死信，所以我们需要参数         */        channel.queueDeclare(NORMAL_QUEUE,false,false,false,parameter);        //普通队列与普通交换机绑定        channel.queueBind(NORMAL_QUEUE,NORMAL_EXCHANGE,"normal");        System.out.println("C1 准备消费......");        //成功获取生产者信息回调方法        DeliverCallback deliverCallback = new DeliverCallback() {            public void handle(String s, Delivery delivery) throws IOException {                if ("消息5".equals(new String(delivery.getBody()))){                    System.out.println("拒收消息："+new String(delivery.getBody()));                    /**                     * 拒绝接收消息                     * 参数：                     * 1，被拒绝消息的标签（序号）                     * 2，是否从新放回原来的队列， false：不放回，（会被交给死信队列）  true：放回原来的队列，重新进行消费                     */                    channel.basicReject(delivery.getEnvelope().getDeliveryTag(),false);                }else {                    System.out.println("c1 消费消息：" + new String(delivery.getBody()));                    /**                     * 确认应答                     * 参数：                     * 1，确认消息标签（序号），                     * 2，是否为批量确认                     */                    channel.basicAck(delivery.getEnvelope().getDeliveryTag(),false);                }            }        };        // 消费者取消消费的回调方法        CancelCallback cancelCallback = new CancelCallback() {            public void handle(String s) throws IOException {                System.out.println(s + ":c1 消费者取消消费 回调函数  逻辑代码....");            }        };        /**         *  消费者消费（获取对列消息）         *   参数:         *   1,消费哪个队列         *   2,消费成功后是否自动应答  true：自动应答  false：手动应答         *        应答作用：消费者发送一个消息应答，告诉RabbitMQ这个消息已经接收并且处理完毕了。RabbitMQ就可以删除它了。         *   3,消费者成功消费的回调方法         *   4，消费者取消消费的回调方法         */        channel.basicConsume(NORMAL_QUEUE,false,deliverCallback,cancelCallback);    }}</code></pre><h4 id="结果：-3"><a href="#结果：-3" class="headerlink" title="结果："></a>结果：</h4><p><img src="https://s2.loli.net/2022/04/14/8b15sS7PVYnqK9M.png" alt="image-20220406225457710"></p><h2 id="延迟队列"><a href="#延迟队列" class="headerlink" title="延迟队列"></a>延迟队列</h2><h3 id="概念-1"><a href="#概念-1" class="headerlink" title="概念"></a>概念</h3><p>延时队列,队列内部是有序的，最重要的特性就体现在它的延时属性上，延时队列中的元素是希望 在指定时间到了以后或之前取出和处理，简单来说，延时队列就是用来存放需要在指定时间被处理的 元素的队列。</p><p>延迟队列简单点理解就和我们上面死信队列中的普通队列挂机后消息有生命时长 一直等到寿命结果进入死信队列一样，这就可以当作一个延迟队列</p><h3 id="延迟队列使用场景"><a href="#延迟队列使用场景" class="headerlink" title="延迟队列使用场景"></a>延迟队列使用场景</h3><p>1.订单在十分钟之内未支付则自动取消</p><p>2.新创建的店铺，如果在十天内都没有上传过商品，则自动发送消息提醒。</p><p>3.用户注册成功后，如果三天内没有登陆则进行短信提醒。</p><p>4.用户发起退款，如果三天内没有得到处理则通知相关运营人员。 </p><p>5.预定会议后，需要在预定的时间点前十分钟通知各个与会人员参加会</p><p>这些场景都有一个特点，需要在某个事件发生之后或者之前的指定时间点完成某一项任务，如： 发生订单生成事件，在十分钟之后检查该订单支付状态，然后将未支付的订单进行关闭；看起来似乎 使用定时任务，一直轮询数据，每秒查一次，取出需要被处理的数据，然后处理不就完事了吗？如果 数据量比较少，确实可以这样做，比如：对于“如果账单一周内未支付则进行自动结算”这样的需求， 如果对于时间不是严格限制，而是宽松意义上的一周，那么每天晚上跑个定时任务检查一下所有未支 付的账单，确实也是一个可行的方案。但对于数据量比较大，并且时效性较强的场景，如：“订单十 分钟内未支付则关闭“，短期内未支付的订单数据可能会有很多，活动期间甚至会达到百万甚至千万 级别，对这么庞大的数据量仍旧使用轮询的方式显然是不可取的，很可能在一秒内无法完成所有订单 的检查，同时会给数据库带来很大压力，无法满足业务要求而且性能低下。<strong>（总结：这些场景使用定时器，性能低，但使用延迟队列就不会）</strong></p><p><strong>流程图：</strong></p><p><img src="https://s2.loli.net/2022/04/14/ORgAmL1QFPNxjHY.png" alt="image-20220407134116255"></p><h3 id="RabbitMQ-中的-TTL"><a href="#RabbitMQ-中的-TTL" class="headerlink" title="RabbitMQ 中的 TTL"></a>RabbitMQ 中的 TTL</h3><p>TTL 是什么呢？TTL 是 RabbitMQ 中一个消息或者队列的属性，表明一条消息或者该队列中的所有 消息的最大存活时间，</p><p>单位是毫秒。换句话说，如果一条消息设置了 TTL 属性或者进入了设置 TTL 属性的队列，那么这 条消息如果在 TTL 设置的时间内没有被消费，则会成为”死信”。如果同时配置了队列的 TTL 和消息的 TTL，那么较小的那个值将会被使用，有两种方式设置 TTL。</p><p><strong>设置信息TTL</strong></p><pre class="language-none"><code class="language-none">/** * 设置参数（链式） * builder 开始 * 设置参数  expiration设置消息有效时长  ms * build  结束 */AMQP.BasicProperties properties = new AMQP.BasicProperties()        .builder().expiration("100000").build();//或//AMQP.BasicProperties properties = new AMQP.BasicProperties();//properties.setExpiration("60000");    String message = "消息";    channel.basicPublish(NORMAL_EXCHANGE,"normal",properties,message.getBytes());</code></pre><p><strong>设置队列TTL</strong></p><p>x-message-ttl</p><pre class="language-none"><code class="language-none">/**      * 设置参数 参数key都是固定的      * x-dead-letter-exchange   设置死信交换机      * x-dead-letter-routing-key  设置死信对齐      * x-message-tt1   设置过期时间 ms      * x-max-length    设置队列长度（当超过队列长度的消息会进入死信队列）      */     Map&lt;String, Object&gt; parameter = new HashMap();     //告诉普通队列，死信交换机是哪个     parameter.put("x-dead-letter-exchange",DEAD_EXCHANGE);     //告诉普通队列，死信交队列的RoutingKey     parameter.put("x-dead-letter-routing-key","dead");     //设置消息过期时间，这个在生产者也可以设置，并且在生产者中设置也更好     parameter.put("x-message-tt1",10000);     //设置队列长度（当超过队列长度的消息会进入死信队列）     //parameter.put("x-max-length",6);     /**      * 声明普通队列，由于普通队列需要向向死信队列发送死信，所以我们需要参数      */     channel.queueDeclare(NORMAL_QUEUE,false,false,false,parameter);</code></pre><p><strong>两者的区别</strong></p><p>如果设置了队列的 TTL 属性，那么一旦消息过期，就会被队列丢弃(如果配置了死信队列被丢到死信队 列中)，而第二种方式，消息即使过期，也不一定会被马上丢弃，因为消息是否过期是在即将投递到消费者 之前判定的，如果当前队列有严重的消息积压情况，则已过期的消息也许还能存活较长时间；另外，还需 要注意的一点是，如果不设置 TTL，表示消息永远不会过期，如果将 TTL 设置为 0，则表示除非此时可以 直接投递该消息到消费者，否则该消息将会被丢弃。</p><h3 id="测试延迟队列环境"><a href="#测试延迟队列环境" class="headerlink" title="测试延迟队列环境"></a>测试延迟队列环境</h3><h4 id="SpringBoot"><a href="#SpringBoot" class="headerlink" title="SpringBoot"></a><strong>SpringBoot</strong></h4><h4 id="XML"><a href="#XML" class="headerlink" title="XML:"></a><strong>XML:</strong></h4><pre class="language-none"><code class="language-none">&lt;dependencies&gt;    &lt;dependency&gt;        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;        &lt;artifactId&gt;spring-boot-starter&lt;/artifactId&gt;    &lt;/dependency&gt;    &lt;dependency&gt;        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;        &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;        &lt;scope&gt;test&lt;/scope&gt;    &lt;/dependency&gt;    &lt;!--RabbitMQ 依赖--&gt;    &lt;dependency&gt;        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;        &lt;artifactId&gt;spring-boot-starter-amqp&lt;/artifactId&gt;    &lt;/dependency&gt;    &lt;dependency&gt;        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;        &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;    &lt;/dependency&gt;    &lt;dependency&gt;        &lt;groupId&gt;com.alibaba&lt;/groupId&gt;        &lt;artifactId&gt;fastjson&lt;/artifactId&gt;        &lt;version&gt;1.2.47&lt;/version&gt;    &lt;/dependency&gt;    &lt;dependency&gt;        &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;        &lt;artifactId&gt;lombok&lt;/artifactId&gt;    &lt;/dependency&gt;    &lt;!--swagger--&gt;    &lt;dependency&gt;        &lt;groupId&gt;io.springfox&lt;/groupId&gt;        &lt;artifactId&gt;springfox-swagger2&lt;/artifactId&gt;        &lt;version&gt;2.9.2&lt;/version&gt;    &lt;/dependency&gt;    &lt;dependency&gt;        &lt;groupId&gt;io.springfox&lt;/groupId&gt;        &lt;artifactId&gt;springfox-swagger-ui&lt;/artifactId&gt;        &lt;version&gt;2.9.2&lt;/version&gt;    &lt;/dependency&gt;    &lt;!--RabbitMQ 测试依赖--&gt;    &lt;dependency&gt;        &lt;groupId&gt;org.springframework.amqp&lt;/groupId&gt;        &lt;artifactId&gt;spring-rabbit-test&lt;/artifactId&gt;        &lt;scope&gt;test&lt;/scope&gt;    &lt;/dependency&gt;&lt;/dependencies&gt;</code></pre><h4 id="application："><a href="#application：" class="headerlink" title="application："></a><strong>application：</strong></h4><pre class="language-none"><code class="language-none">spring:  rabbitmq:    port: 5672  #15672是客户端，而5672是rabbitmq服务端    host: 124.223.79.104    username: admin    password: Admin123</code></pre><h4 id="SwaggerConfig配置类："><a href="#SwaggerConfig配置类：" class="headerlink" title="SwaggerConfig配置类："></a><strong>SwaggerConfig配置类：</strong></h4><pre class="language-none"><code class="language-none">@Configuration@EnableSwagger2public class SwaggerConfig {    @Bean    public Docket webApiConfig(){        return new Docket(DocumentationType.SWAGGER_2)                .groupName("webApi")                .apiInfo(webApiInfo())                .select()                .build();    }    private ApiInfo webApiInfo(){        return new ApiInfoBuilder()                .title("rabbitmq 接口文档")                .description("本文档描述了 rabbitmq 微服务接口定义")                .version("1.0")                .contact(new Contact("enjoy6288", "http://atguigu.com","1551388580@qq.com"))                .build();    }}</code></pre><h3 id="演示："><a href="#演示：" class="headerlink" title="演示："></a>演示：</h3><h4 id="代码架构图"><a href="#代码架构图" class="headerlink" title="代码架构图"></a>代码架构图</h4><p>创建两个队列 QA 和 QB，两者队列 TTL 分别设置为 10S 和 40S，然后在创建一个交换机 X 和死信交 换机 Y，它们的类型都是 direct，创建一个死信队列 QD，它们的绑定关系如下：（这些都是理论上的其实并没有就叫延迟交换机的）</p><p><img src="https://s2.loli.net/2022/04/14/KMwUW9yFboAuVn6.png" alt="image-20220407143915339"></p><p>接下来，我们使用的是SpringBoot，SpringBoot中交换机与队列就不写在生产者或消费者中了，都进行分开写了生产者是生产者，消费者是消费者交换机是交换机</p><h4 id="声明绑定配置类："><a href="#声明绑定配置类：" class="headerlink" title="声明绑定配置类："></a>声明绑定配置类：</h4><p>SpringBoot中交换机的声明与队列的声明还要交换机与队列的绑定都在配置中完成</p><p>new DirectExchange(EXCHANGE_X);  用于创建交换机，Exchange前面的为交换机类型</p><p>QueueBuilder 用于队列的声明，以及一些参数</p><p>BindingBuilder 用于交换机与队列绑定与设置RoutingKey</p><pre class="language-none"><code class="language-none">@Configuration/** * 声明绑定配置类 * 这里的配置都会提供给RabbitMQ，我们使用RabbitTemplate工具类即可发送消息 */public class QueueConfig {    //普通交换机名称    public static final String EXCHANGE_X="X";    //普通队列名称1（消息存活10s)    public static final String QUEUE_QA="QA";    //普通队列1   RoutingKey    public static final String QUEUE_QA_ROUTING_KEY="XA";    //普通队列名称2（消息存活30s)    public static final String QUEUE_QB="QB";    //普通队列2   RoutingKey    public static final String QUEUE_QB_ROUTING_KEY="XB";    //死信交换机（也就是延迟交换机）名称    public static final String EXCHANGE_DEAD="Y";    //死信队列（延迟队列）名称    public static final String QUEUE_DEAD_QD="QD";    //死信(延迟)队列RoutingKey    public static final String QUEUE_DEAD_QD_ROUTING_KEY="YD";    //************************************************普通队列与交换机**********************************************************    /**     * 将交换机放入IOC容器管理     * @return 返回X（普通）交换机     */    @Bean    public Exchange XExchange(){        // 声明direct（自接）类型交换机，多个构造方法，可查看源码        return new DirectExchange(EXCHANGE_X);    }    /**     * 创建队列 消息延迟（存活）为30秒     * @return 返回创建好的队列交给IOC容器     */    @Bean    public Queue queueQA(){        /**         * 链式         * 使用QueueBuilder构建类进行构建队列         * QueueBuilder构造方法是私有的所以我们没法调用构造函数创建队列         * 我们需要使用durable持久化为我们创建队列，         * durable这个方法中使用了QueueBuilder的构造函数创建队列并为队列设置为持久化         * 其后面就是要设置的参数或使用withArguments(Map&lt;String, Object&gt; arguments) 使用MAP进行填写参数         * build 替我们构造Queue （这一步才是真正的创建了队列），之前就好比是将参数给赋值好         */        return QueueBuilder//队列建立者                .durable(QUEUE_QA)//队列名称并持久化                .ttl(10000) //队列消息存活时间                .deadLetterExchange(EXCHANGE_DEAD) //转发的死信交换机                .deadLetterRoutingKey(QUEUE_DEAD_QD_ROUTING_KEY)//转发的死信队列RoutingKey                .build();//构造队列    }    /**     * 创建队列 消息延迟（存活）为30秒     * @return 返回创建好的队列交给IOC容器     */    @Bean    public Queue queueQB(){        /**         * 链式         * 使用QueueBuilder构建类进行构建队列         * QueueBuilder构造方法是私有的所以我们没法调用构造函数创建队列         * 我们需要使用durable持久化为我们创建队列，         * durable这个方法中使用了QueueBuilder的构造函数创建队列并为队列设置为持久化         * 其后面就是要设置的参数或使用withArguments(Map&lt;String, Object&gt; arguments) 使用MAP进行填写参数         * build 替我们构造Queue （这一步才是真正的创建了队列），之前就好比是将参数给赋值好         */        return QueueBuilder//队列建立者                .durable(QUEUE_QB)//队列名称并持久化                .ttl(30000) //队列消息存活时间                .deadLetterExchange(EXCHANGE_DEAD) //转发的死信交换机                .deadLetterRoutingKey(QUEUE_DEAD_QD_ROUTING_KEY)//转发的死信队列RoutingKey                .build();//构造队列    }    //***************************************死信（延迟）队列与交换机**********************************************************    /**     * 将交换机放入IOC容器管理     * @return 返回DEAD死信（延迟）交换机     */    @Bean    public Exchange DeadExchange(){        // 声明direct（自接）类型交换机，多个构造方法，可查看源码        return new DirectExchange(EXCHANGE_DEAD);    }    /**     * 创建队列(延迟队列，死信队列)     * @return 返回创建好的队列交给IOC容器     */    @Bean    public Queue queueDead(){        /**         * 链式         * 使用QueueBuilder构建类进行构建队列         * QueueBuilder构造方法是私有的所以我们没法调用构造函数创建队列         * 我们需要使用durable持久化为我们创建队列，         * durable这个方法中使用了QueueBuilder的构造函数创建队列并为队列设置为持久化         * 其后面就是要设置的参数或使用withArguments(Map&lt;String, Object&gt; arguments) 使用MAP进行填写参数         * build 替我们构造Queue （这一步才是真正的创建了队列），之前就好比是将参数给赋值好         */        return QueueBuilder.durable(QUEUE_DEAD_QD).build();    }    //************************************************绑定**********************************************************    /**     * 进行交换机与队列绑定     * 形参会先使用Autowired规则寻找，找不到则遵循@Qualifier注解。这里不能使用@Resource     * @param exchange 要绑定的交换机（获取的容器中的）     * @param queue 要绑定的队列 （获取的是容器中的）     * @return 将绑定的类返回给IOC容器，RabbitMQ会获取     */    @Bean    public Binding ExchangeXBindingQueueQA(@Qualifier("XExchange") Exchange exchange,@Qualifier("queueQA") Queue queue){       return BindingBuilder//队列建立者               .bind(queue)//要绑定的队列               .to(exchange)//要绑定的交换机               .with(QUEUE_QA_ROUTING_KEY)//绑定队列的RoutingKey               .noargs();//构造绑定    }    /**     * 进行交换机与队列绑定     * 形参会先使用Autowired规则寻找，找不到则遵循@Qualifier注解。这里不能使用@Resource     * @param exchange 要绑定的交换机（获取的容器中的）     * @param queue 要绑定的队列 （获取的是容器中的）     * @return 将绑定的类返回给IOC容器，RabbitMQ会获取     */    @Bean    public Binding ExchangeXBindingQueueQB(@Qualifier("XExchange") Exchange exchange,@Qualifier("queueQB") Queue queue){        return BindingBuilder//队列建立者                .bind(queue)//要绑定的队列                .to(exchange)//要绑定的交换机                .with(QUEUE_QB_ROUTING_KEY)//绑定队列的RoutingKey                .noargs();//构造绑定    }    /**     * 进行交换机与队列绑定     * 形参会先使用Autowired规则寻找，找不到则遵循@Qualifier注解。这里不能使用@Resource     * @param exchange 要绑定的交换机（获取的容器中的）     * @param queue 要绑定的队列 （获取的是容器中的）     * @return 将绑定的类返回给IOC容器，RabbitMQ会获取     */    @Bean    public Binding DeadExchangeBindingQueueDead(@Qualifier("DeadExchange") Exchange exchange,@Qualifier("queueDead") Queue queue){        return BindingBuilder//队列建立者                .bind(queue)//要绑定的队列                .to(exchange)//要绑定的交换机                .with(QUEUE_DEAD_QD_ROUTING_KEY)//绑定队列的RoutingKey                .noargs();//构造绑定    }}</code></pre><h4 id="生产者：-12"><a href="#生产者：-12" class="headerlink" title="生产者："></a>生产者：</h4><p>我们使用访问请求发送消息</p><p>RabbitTemplate： RabbitTemplate类用于消息发送等等，有许多方法</p><pre class="language-none"><code class="language-none">@Slf4j@Controller@RestControllerpublic class TtlController {    /**     * RabbitTemplate，使用这个进行消息的一些操作     */    @Autowired    private RabbitTemplate rabbitTemplate;    @RequestMapping("/sendMsg/{message}")    public void publicMessage(@PathVariable("message") String message){        log.info("发布消息：时间{} ，发布的消息为{}",new Date().toString(),message);        /**         * 发送消息         * 参数：         * 1，交换机名称         * 2，RoutingKey         * 3，发送的消息         */        rabbitTemplate.convertAndSend(QueueConfig.EXCHANGE_X                , QueueConfig.QUEUE_QA_ROUTING_KEY                ,"发送消息延迟为10秒,消息为："+message);        /**         * 发送消息         * 参数：         * 1，交换机名称         * 2，RoutingKey         * 3，发送的消息         */        rabbitTemplate.convertAndSend(QueueConfig.EXCHANGE_X                , QueueConfig.QUEUE_QB_ROUTING_KEY                ,"发送消息延迟为30秒,消息为："+message);    }}</code></pre><h4 id="消费者：-5"><a href="#消费者：-5" class="headerlink" title="消费者："></a>消费者：</h4><p>我们像延迟队列等等需要使用监听器，当队列中有消息时进行消费</p><pre class="language-none"><code class="language-none">/** * 这是个消费者的监听 */@Slf4j@Componentpublic class DeadLetterQueueConsumer{    /**     * 队列的监听     * RabbitListener :进行RabbitMQ的监听     *      参数：     *      queues：要监听的队列     *     * 方法形参是RabbitMQ给的     * Message  消息     * Channel 信道，可用于手动确认等等     */    @RabbitListener(queues = QueueConfig.QUEUE_DEAD_QD)    public void listener(Message message, Channel channel){        log.info("当前时间为{}，收到死信：{}",new Date().toString(),new String(message.getBody()));    }}</code></pre><h4 id="结果：-4"><a href="#结果：-4" class="headerlink" title="结果："></a>结果：</h4><p><strong>发送消息</strong></p><p><img src="https://s2.loli.net/2022/04/14/Vsp8vjUEewgWImz.png" alt="image-20220407222244900"></p><p><strong>运行结果：</strong></p><p><img src="https://s2.loli.net/2022/04/14/M4YPC1aRVjzLNbd.png" alt="image-20220407222256608"></p><h4 id="代码优化："><a href="#代码优化：" class="headerlink" title="代码优化："></a>代码优化：</h4><p>以上代码都是队列固定死了消息生命时长，如果有别的的时间那么就需要再创建一个队列，为了避免这种缺点，我们可以将消息的寿命时长设置在生产者中，发布消息时同时设置消息寿命</p><p><strong>一下操作都基于上面的代码</strong></p><p>新增一个QC队列，没有时长并于普通交换机绑定，RoutingKey为XC</p><p><img src="https://s2.loli.net/2022/04/14/YZrcA98opdNgUGm.png" alt="image-20220408130437393"></p><h5 id="不使用插件发布时延迟："><a href="#不使用插件发布时延迟：" class="headerlink" title="不使用插件发布时延迟："></a>不使用插件发布时延迟：</h5><p>​    </p><p>缺陷：</p><p>因为是使用的是基于死信队列，当消息在生产者发布时设置了超时时间，队列只会判断队列中第一个消息是否过期进入死信，如果第一个消息时间超时时间比较长而第二个消息比较短，就会导致第二个消息明明已经过期但由于队列只会查看第一个消息，导致第二个消息要等第一个消息进入死信后才会查看第二个消息（也就是消息延迟准确）</p><h6 id="声明绑定配置类（增加代码）："><a href="#声明绑定配置类（增加代码）：" class="headerlink" title="声明绑定配置类（增加代码）："></a>声明绑定配置类（增加代码）：</h6><pre class="language-none"><code class="language-none">//普通队列名称3（消息存活不进行设置)public static final String QUEUE_QC="QC";//普通队列3   RoutingKeypublic static final String QUEUE_QC_ROUTING_KEY="XC"; /**     * 创建队列 消息延迟（存活）这个队列我们不设置消息存活时间，交给给生产者设置，这样就可以摆脱固定你性了     * @return 返回创建好的队列交给IOC容器     */    @Bean    public Queue queueQC(){        /**         * 链式         * 使用QueueBuilder构建类进行构建队列         * QueueBuilder构造方法是私有的所以我们没法调用构造函数创建队列         * 我们需要使用durable持久化为我们创建队列，         * durable这个方法中使用了QueueBuilder的构造函数创建队列并为队列设置为持久化         * 其后面就是要设置的参数或使用withArguments(Map&lt;String, Object&gt; arguments) 使用MAP进行填写参数         * build 替我们构造Queue （这一步才是真正的创建了队列），之前就好比是将参数给赋值好         */        return QueueBuilder//队列建立者                .durable(QUEUE_QC) //队列名称与持久化                .deadLetterExchange(EXCHANGE_DEAD) //绑定的死信交换机                .deadLetterRoutingKey(QUEUE_DEAD_QD_ROUTING_KEY) //死信队列绑定的RoutingKey                .build();//构造队列    }            /**     * 进行交换机与队列绑定     * 形参会先使用Autowired规则寻找，找不到则遵循@Qualifier注解。这里不能使用@Resource     * @param exchange 要绑定的交换机（获取的容器中的）     * @param queue 要绑定的队列 （获取的是容器中的）     * @return 将绑定的类返回给IOC容器，RabbitMQ会获取     */    @Bean    public Binding ExchangeXBindingQueueQC(@Qualifier("XExchange") Exchange exchange,@Qualifier("queueQC") Queue queue){        return BindingBuilder//队列建立者                .bind(queue)//要绑定的队列                .to(exchange)//要绑定的交换机                .with(QUEUE_QC_ROUTING_KEY)//绑定队列的RoutingKey                .noargs();//构造绑定    }</code></pre><h6 id="生产者-Controller）："><a href="#生产者-Controller）：" class="headerlink" title="生产者(Controller）："></a>生产者(Controller）：</h6><p>使用MessagePostProcessor接口实现postProcessMessage()方法中设置参数</p><pre class="language-none"><code class="language-none">/** * 发送消息并为消息设置消息生命时长 * @param message  消息 * @param ttl 生命时长 */@RequestMapping("/sendMsg/{message}/{ttl}")public void PublicMsgTtl(@PathVariable("message") String message,@PathVariable("ttl") Integer ttl){     ttl = ttl*1000;    /**     * 发布消息设置的参数接口     */    Integer finalTtl = ttl;    MessagePostProcessor postProcessor = new MessagePostProcessor() {        /**         * 设置发布消息时设置的参数         * @param message  消息(可设置参数)         * @return  返回message         * @throws AmqpException         */        @Override        public Message postProcessMessage(Message message) throws AmqpException {            //getMessageProperties获取消息参数            //setExpiration设置TTL (还有其他参数)            message.getMessageProperties().setExpiration(finalTtl.toString());            return message;        }    };    log.info("发布消息：时间{} ，发布的消息为{},设置的延迟时长为{}秒",new Date().toString(),message,ttl);    /**     * 发送消息     * 参数：     * 1，交换机名称     * 2，RoutingKey     * 3，发送的消息     */    rabbitTemplate.convertAndSend(QueueConfig.EXCHANGE_X            ,QueueConfig.QUEUE_QC_ROUTING_KEY            ,"发送消息延迟"+ttl+"秒,消息为："+message            ,postProcessor);}</code></pre><h6 id="结果：-5"><a href="#结果：-5" class="headerlink" title="结果："></a>结果：</h6><p>这种方式会有问题：</p><p><strong>看起来似乎没什么问题，但是在最开始的时候，就介绍过如果使用在消息属性上设置 TTL 的方式，消 息可能并不会按时“死亡“，因为 RabbitMQ 只会检查第一个消息是否过期，如果过期则丢到死信队列， 如果第一个消息的延时时长很长，而第二个消息的延时时长很短，第二个消息并不会优先得到执行。</strong></p><p>如图输出结果：</p><p><img src="https://s2.loli.net/2022/04/14/gFvtsM1BHyrLNpu.png" alt="image-20220408130935566"></p><h5 id="使用插件发布时延迟："><a href="#使用插件发布时延迟：" class="headerlink" title="使用插件发布时延迟："></a>使用插件发布时延迟：</h5><p>可以解决消息延迟不准确（不使用插件的缺点）</p><h6 id="我能需要先下载插件："><a href="#我能需要先下载插件：" class="headerlink" title="我能需要先下载插件："></a><strong>我能需要先下载插件：</strong></h6><p>在官网上下载 <a href="https://www.rabbitmq.com/community-plugins.html">https://www.rabbitmq.com/community-plugins.html</a></p><p>下载 rabbitmq_delayed_message_exchange 插件，然后解压放置到 RabbitMQ 的插件目录。</p><p>插件包放置位置：/usr/lib/rabbitmq/lib/rabbitmq_server-3.8.8/plugins</p><p>在插件目录使用该命令使用下载的插件：rabbitmq-plugins enable rabbitmq_delayed_message_exchange</p><p>插件包名称示例：rabbitmq_delayed_message_exchange-3.9.0.ez</p><h6 id="安装："><a href="#安装：" class="headerlink" title="安装："></a><strong>安装：</strong></h6><pre class="language-none"><code class="language-none">[root@VM-4-12-centos plugins]# rabbitmq-plugins enable rabbitmq_delayed_message_exchangeEnabling plugins on node rabbit@VM-4-12-centos:rabbitmq_delayed_message_exchangeThe following plugins have been configured:  rabbitmq_delayed_message_exchange  rabbitmq_management  rabbitmq_management_agent  rabbitmq_web_dispatchApplying plugin configuration to rabbit@VM-4-12-centos...The following plugins have been enabled:  rabbitmq_delayed_message_exchangestarted 1 plugins.[root@VM-4-12-centos plugins]# service rabbitmq-server restart  #重启RabbitMQ服务Redirecting to /bin/systemctl restart rabbitmq-server.service[root@VM-4-12-centos plugins]# </code></pre><p><strong>命令：service rabbitmq-server restart    重启RabbitMQ服务</strong></p><p>x-delayed-message类型交换机是延迟交换机，消息在这个交换机中延迟，延迟时间到了后进入队列让消费者进行消费</p><p><img src="https://s2.loli.net/2022/04/14/hkVGx5TcnMY6I9r.png" alt="image-20220408224420080"></p><h6 id="使用插件后给流程图："><a href="#使用插件后给流程图：" class="headerlink" title="使用插件后给流程图："></a><strong>使用插件后给流程图：</strong></h6><p><img src="https://s2.loli.net/2022/04/14/gpo8Rz9NeGvJAIh.png" alt="image-20220409113518241"></p><p>使用插件后消息延迟就是在交换机中发生的了，延迟完成后再发送给队列</p><h6 id="声明绑定配置类"><a href="#声明绑定配置类" class="headerlink" title="声明绑定配置类"></a><strong>声明绑定配置类</strong></h6><p>我需要声明延迟交换机与队列，并且进行绑定</p><p>由于我们延迟交换机使用的是插件，所以我们需要自定义交换机，这样我们就可以自己指定交换机的类型，</p><p>延迟交换机还需要设置交换机延迟消息的类型，延迟交换机会获得到这个类型的特点，发送消息时就可以使用这个类型发送，如：fanout 类型，我们就可以广播</p><p>参数key：</p><p>x-delayed-type</p><pre class="language-none"><code class="language-none">/** * 延迟交换机配置类 * 这里是使用我们插件的延迟队列（自己安装的） */@Configurationpublic class DelayedQueueConfig {    //延迟交换机名称    public static final String EXCHANGE_DELAYED="delayed.exchange";    //延迟队列名称    public static final String QUEUE_DELAYED="delayed.queue";    //延迟队列RoutingKey    public static final String QUEUE_DELAYED_ROUTING_KEY="delayed.routingKey";    /**     * 创建一个自定义交换机，交换机类型为延迟交换机（x-delayed-message）     * @return 返回一个自定义交换机（延迟交换机）     */    @Bean    public CustomExchange delayedExchange(){        /**         * 这是延迟交换机（x-delayed-message交换机）才有的参数         * x-delayed-type: 延迟类型，延迟消息的类型         *         */        Map&lt;String, Object&gt; arguments = new HashMap&lt;&gt;();        arguments.put("x-delayed-type","direct");        /**         * CustomExchange ： 创建自定义交换机，需要我们自动指定交换机类型         * 参数：（其他交换机也有这是行参数的构造（除交换机类型外，因为这个是自定义交换机才有））         * 1，交换机名称         * 2，交换机类型         * 3，交换机是否持久化         * 4，交换机是否自动删除         * 4，参数         */        return new CustomExchange(EXCHANGE_DELAYED,"x-delayed-message",true,false,arguments);    }    /**     * 创建队列     * @return 返回一个队列     */    @Bean    public Queue queueDelayed(){        //使用队列建立者创建队列，并让队列持久化，我们也可以直接new Queue（name）；创建一个队列        return QueueBuilder.durable(QUEUE_DELAYED).build();    }    /**     * 将队列于交换机进行RoutingKey绑定     * @param customExchange 自定义交换机（延迟交换机）     * @param queue  队列     * @return 返回绑定结果     */    @Bean    public Binding delayedExchangeBindingQueueDelayed(@Qualifier("delayedExchange") CustomExchange customExchange            ,@Qualifier("queueDelayed") Queue queue){        return BindingBuilder//绑定建立者                .bind(queue)//队列                .to(customExchange)//交换机                .with(QUEUE_DELAYED_ROUTING_KEY)//绑定的RoutingKey                .noargs();//构建    }}</code></pre><h6 id="生产者：-13"><a href="#生产者：-13" class="headerlink" title="生产者："></a><strong>生产者：</strong></h6><p>MessagePostProcessor 接口设置参数：</p><p>setDelay：设置消息延迟时间 （使用x-delayed-message类型交换机需要使用这个） ，之前没有插件使用的是setExpiration：设置消息存活时间</p><pre class="language-none"><code class="language-none">/** * 延迟交换机进行延迟（x-delayed-message类型交换机） */@Slf4j@Controller@RestControllerpublic class delayedController {    @Autowired    private RabbitTemplate rabbitTemplate;    /**     * 向延迟交换机发送消息     * @param message     * @param delayedTime     */    @RequestMapping("Send/DelayedMsg/{message}/{delayed}")    public void publicDelayedMessage(@PathVariable("message") String message            ,@PathVariable("delayed") Integer delayedTime){        //设置参数        MessagePostProcessor messagePostProcessor = new MessagePostProcessor() {            @Override            public Message postProcessMessage(Message message) throws AmqpException {                //setDelay：设置消息延迟时间  ，之前没有插件使用的是setExpiration：设置消息存活时间                message.getMessageProperties().setDelay(delayedTime * 1000);                return message;            }        };        log.info("发布消息：时间{} ，发布的延迟（delayed）消息为{},设置的延迟时长为{}秒",new Date().toString(),message,delayedTime);        /**         * 发送消息         * 参数：         * 1，交换机名称         * 2，RoutingKey         * 3，发送的消息         */        rabbitTemplate.convertAndSend(DelayedQueueConfig.EXCHANGE_DELAYED                ,DelayedQueueConfig.QUEUE_DELAYED_ROUTING_KEY                ,"发送(delayed)消息延迟"+delayedTime+"秒,消息为："+message                ,messagePostProcessor);    }}</code></pre><h6 id="消费者：-6"><a href="#消费者：-6" class="headerlink" title="消费者："></a><strong>消费者：</strong></h6><p>@RabbitListener(queues = DelayedQueueConfig.QUEUE_DELAYED)</p><p>使用@RabbitListener监听，并指定监听队列</p><pre class="language-none"><code class="language-none">/** * 延迟队列监听 */@Slf4j@Componentpublic class DelayedQueueConsumer {    /**     * @RabbitListener 监听     *      queues 将的队列名称     * @param message     * @param channel     */    @RabbitListener(queues = DelayedQueueConfig.QUEUE_DELAYED)    public void listenerDelayedQueue(Message message, Channel channel){        log.info("当前时间为{}，收到延迟消息：{}",new Date().toString(),new String(message.getBody()));    }}</code></pre><h6 id="结果：-6"><a href="#结果：-6" class="headerlink" title="结果："></a><strong>结果：</strong></h6><p>成功解决不使用插件延迟消息的缺点，第二个消息被先消费掉了，符合预期</p><p><img src="https://s2.loli.net/2022/04/14/ydbkau7UMh65iJA.png" alt="image-20220409115656161"></p><h2 id="发布确认高级："><a href="#发布确认高级：" class="headerlink" title="发布确认高级："></a>发布确认高级：</h2><p>这里是直接配置当前项目里所以的交换机开启发布确认</p><p>在生产环境中由于一些不明原因，导致 rabbitmq 重启，在 RabbitMQ 重启期间生产者消息投递失败， 导致消息丢失，需要手动处理和恢复。于是，我们开始思考，如何才能进行 RabbitMQ 的消息可靠投递呢？ 特别是在这样比较极端的情况，RabbitMQ 集群不可用的时候，无法投递的消息</p><h3 id="发布确认-springboot-版本："><a href="#发布确认-springboot-版本：" class="headerlink" title="发布确认 springboot 版本："></a>发布确认 springboot 版本：</h3><h4 id="确认机制方案"><a href="#确认机制方案" class="headerlink" title="确认机制方案"></a>确认机制方案</h4><p><img src="https://s2.loli.net/2022/04/14/Qbm6LIcq2iT3gHB.png" alt="image-20220411192330135"></p><h4 id="代码架构图（交换机）"><a href="#代码架构图（交换机）" class="headerlink" title="代码架构图（交换机）:"></a>代码架构图（交换机）:</h4><p>如果交换机接挂机了，如何处理</p><p><img src="https://s2.loli.net/2022/04/14/3UHAoPtONKbikaV.png" alt="image-20220411192416420"></p><h4 id="application配置文件："><a href="#application配置文件：" class="headerlink" title="application配置文件："></a>application配置文件：</h4><p>需要在配置文件中添加spring.rabbitmq.publisher-confirm-type=correlated才能开始发布确认</p><p>NONE </p><p>​    禁用发布确认模式，是默认值 </p><p>CORRELATED </p><p>​    发布消息成功到交换器后会触发回调方法 </p><p> SIMPLE（是同步发布确认，单个发布确认确认效果）</p><p>​     经测试有两种效果，其一效果和 CORRELATED 值一样会触发回调方法， 其二在发布消息成功后使用 rabbitTemplate 调用 waitForConfirms 或 waitForConfirmsOrDie 方法 等待 broker 节点返回发送结果，根据返回结果来判定下一步的逻辑，要注意的点是 waitForConfirmsOrDie 方法如果返回 false 则会关闭 channel，则接下来无法发送消息到 broker</p><pre class="language-none"><code class="language-none">spring:  rabbitmq:    port: 5672  #15672是可视化客户端端口   5672  是rabbitmq服务端口    host: 124.223.79.104    username: admin    password: Admin123    #NONE禁用发布确认模式，是默认值,    #CORRELATED发布消息成功到交换器后会触发回调方法，    #SIMPLE经测试有两种效果    publisher-confirm-type: correlated</code></pre><h4 id="声明绑定配置类：-1"><a href="#声明绑定配置类：-1" class="headerlink" title="声明绑定配置类："></a>声明绑定配置类：</h4><p>正常声明交换机与队列，并绑定</p><pre class="language-none"><code class="language-none">/** * 发布确认声明与绑定配置类 */@Configurationpublic class ConfirmQueueConfig {    //延迟交换机名称    public static final String EXCHANGE_CONFIRM="confirm.exchange";    //延迟队列名称    public static final String QUEUE_CONFIRM="confirm.queue";    //延迟队列RoutingKey    public static final String QUEUE_CONFIRM_ROUTING_KEY="confirm.routingKey";    /**     * 声明交换机     * @return 返回声明的交换机     */    @Bean    public Exchange ConfirmExchange(){        return new DirectExchange(EXCHANGE_CONFIRM);    }    /**     * 声明队列     * @return 返回创建的队列     */    @Bean    public Queue ConfirmQueue(){        return QueueBuilder.durable(QUEUE_CONFIRM).build();    }    /**     * 绑定     * @param exchange 交换机     * @param queue 队列     * @return 返回绑定结构     */    @Bean    public Binding ExchangeConfirmBindingConfirmExchange(@Qualifier("ConfirmExchange") Exchange exchange            ,@Qualifier("ConfirmQueue") Queue queue){        return BindingBuilder.bind(queue).to(exchange).with(QUEUE_CONFIRM_ROUTING_KEY).noargs();    }}</code></pre><h4 id="生产者：-14"><a href="#生产者：-14" class="headerlink" title="生产者："></a>生产者：</h4><p>需要注意下发送消息中的CorrelationData这个参数，这个参数里的信息是要给我们交换机发布确认回调方法的，回调方法中的CorrelationData就是我们在生产者中创建的</p><pre class="language-none"><code class="language-none">/** * 发布确认生产者 */@Slf4j@Controller@RestControllerpublic class ConfirmController {    @Autowired    private RabbitTemplate rabbitTemplate;    /**     * 发布消息     * @param message     */    @RequestMapping("confirm/Msg/{message}")    public void publicMessage(@PathVariable("message") String message){        //回调方法中显示的CorrelationData实例,无参构造 id为UUID        CorrelationData correlationData = new CorrelationData();        correlationData.setReturned(new ReturnedMessage(new Message(message.getBytes())                ,1                ,"replyText"                ,ConfirmQueueConfig.EXCHANGE_CONFIRM                ,ConfirmQueueConfig.QUEUE_CONFIRM_ROUTING_KEY                ));        rabbitTemplate.convertAndSend(ConfirmQueueConfig.EXCHANGE_CONFIRM  //交换机                ,ConfirmQueueConfig.QUEUE_CONFIRM_ROUTING_KEY //RoutingKey                ,message //发送的消息                ,correlationData  //回调方法中CorrelationData的实例        );        log.info("发布确认生产者，发送消息:{}",message);    }}</code></pre><h4 id="消费者：-7"><a href="#消费者：-7" class="headerlink" title="消费者："></a>消费者：</h4><pre class="language-none"><code class="language-none">/** * 发布确认消费者 */@Slf4j@Componentpublic class ConfirmQueueConsumer {    @RabbitListener(queues = ConfirmQueueConfig.QUEUE_CONFIRM)    public void ConfirmListenerQueue(Message message, Channel channel){      log.info("发布确认消费者接收到队列消息，消费消息:{}",new String(message.getBody()));    }}</code></pre><h4 id="回调实现类："><a href="#回调实现类：" class="headerlink" title="回调实现类："></a>回调实现类：</h4><p><strong>生产者与交换机发布确认回调</strong></p><p>我们需要将我们创建的回调实现类注入给RabbitTemplate这样RabbitTemplate才能调用我们的回调方法，要不然RabbitTemplate是没有回调实现类的</p><p> @PostConstruct //被注解的方法，在对象加载完依赖注入后执行,对应的还有@PreDestroy，在对象消亡之前执行</p><p>correlationData 这个实参就是我们生产者创建发送过来的correlationData</p><pre class="language-none"><code class="language-none">/** * 生产者与交换机发布确认回调 * 使用回调方法类接口,要使用需要开始发布确认 */@Slf4j@Componentpublic class ConfirmCallback implements RabbitTemplate.ConfirmCallback {    @Autowired    private RabbitTemplate rabbitTemplate;    /**     * 注入实现类给RabbitTemplate调用     * 由于RabbitTemplate.ConfirmCallback为内部接口     * 而我们实现了他的接口但是他并不知道，所以我们需要将当前实现类给注入进去     */    @PostConstruct //被注解的方法，在对象加载完依赖注入后执行,对应的还有@PreDestroy，在对象消亡之前执行    private void init(){        rabbitTemplate.setConfirmCallback(this);    }    /**     * 实现回调方法，不管成功还是失败都会调用     * @param correlationData  保存回调消息的ID及相关信息     *        这个对象并不是他自动生成的，而是由我们在生产者发送消息时创建发送过来的     *        convertAndSend（）发送消息这个方法有大量的重载，里面有好几个重载方法中就要我们填充correlationData对象实例     *        如果我们不实现发送过来，那么这边correlationData对象也会为空     * @param b  交换机是否成功接收消息  true：成功     false：失败     * @param s  失败原因   成功：null   失败：失败原因信息     */    @Override    public void confirm(CorrelationData correlationData, boolean b, String s) {        //获取信息，为防止信息id为null而报错        String id = correlationData.getId()!=null?correlationData.getId():"null";        if (b){            log.info("交换机成功接收消息：消息ID为：{}",id);        }else {            log.info("交换机接收消息失败：消息ID为：{},失败原因:{}",id,s);        }    }}</code></pre><h4 id="结果：-7"><a href="#结果：-7" class="headerlink" title="结果："></a>结果：</h4><h5 id="正常结果："><a href="#正常结果：" class="headerlink" title="正常结果："></a><strong>正常结果：</strong></h5><p><img src="https://s2.loli.net/2022/04/14/MeLHI1649s2pkhA.png" alt="image-20220411211456808"></p><h5 id="交换机宕机结果："><a href="#交换机宕机结果：" class="headerlink" title="交换机宕机结果："></a>交换机宕机结果：</h5><p>将生产者中发送消息的交换机故意填写错误，这样就可以演示交换机异常宕机效果了</p><p>结果：</p><p><img src="https://s2.loli.net/2022/04/14/iKfho6wMQV8s1Jj.png" alt="image-20220411211802755"></p><h5 id="队列宕机结果："><a href="#队列宕机结果：" class="headerlink" title="队列宕机结果："></a>队列宕机结果：</h5><p>将生产者中发送消息的队列RoutingKey故意填写成错误，这样就可以演示队列异常宕机效果了</p><p>结果：</p><p>可以看到结果是调用的是成功回调，这是因为这个只限于生产者与交换机的回调，交换机并没有成功将信息发送给指定的队列，但依旧调用成功</p><p>队列并没有回调，直接导致信息丢失，并且生产者还不知道，我们需要开始退回publisher-returns: true 下我们就介绍下回退 </p><p><img src="https://s2.loli.net/2022/04/14/NKMEcJ68H4G27PW.png" alt="image-20220411212040403"></p><h3 id="回退消息"><a href="#回退消息" class="headerlink" title="回退消息:"></a>回退消息:</h3><p><strong>在仅开启了生产者确认机制的情况下，交换机接收到消息后，会直接给消息生产者发送确认消息</strong>，如果发现该消息不可路由(发送给消费者)，那么消息会被直接丢弃，此时生产者是不知道消息被丢弃这个事件的。那么如何 让无法被路由的消息帮我想办法处理一下？最起码通知我一声，我好自己处理啊。通过设置 可以在当消息传递过程中不可达目的地时将消息返回给生产者。</p><h4 id="开启回退（mandatory-参数）："><a href="#开启回退（mandatory-参数）：" class="headerlink" title="开启回退（mandatory 参数）："></a>开启回退（mandatory 参数）：</h4><p>publisher-returns: true   //这个参数是用来开始退回的</p><pre class="language-none"><code class="language-none">spring:  rabbitmq:    port: 5672  #15672是可视化客户端端口   5672  是rabbitmq服务端口    host: 124.223.79.104    username: admin    password: Admin123    #NONE禁用发布确认模式，是默认值,    #CORRELATED发布消息成功到交换器后会触发回调方法，    #SIMPLE经测试有两种效果，其一效果和 CORRELATED 值一样会触发回调方法    publisher-confirm-type: correlated    publisher-returns: true  #开启信息回退，这样当交换机路由消息给队列失败就可以退回消息</code></pre><h4 id="回调实现类：-1"><a href="#回调实现类：-1" class="headerlink" title="回调实现类："></a>回调实现类：</h4><p>RabbitTemplate.ReturnsCallback     退回接口，也就是交换机与队列之前的确认</p><p>退回即可的方法中returnedMessage 实参也同样是我们在生产者或交换机回调中创建的</p><p>退回实现同样也需要注入给RabbitTemplate，使它能够调用</p><pre class="language-none"><code class="language-none">/** * 发布确认回调 * 使用回调方法类接口,要使用需要开始发布确认 * RabbitTemplate.ConfirmCallback 交换机发布确认 * RabbitTemplate.ReturnsCallback 交换机退回，也就是交换机与队列之前的确认 */@Slf4j@Componentpublic class ConfirmCallback implements RabbitTemplate.ConfirmCallback,RabbitTemplate.ReturnsCallback {    @Autowired    private RabbitTemplate rabbitTemplate;    /**     * 注入实现类给RabbitTemplate调用     * 由于RabbitTemplate.ConfirmCallback为内部接口，RabbitTemplate.ReturnsCallback同样也需要     * 而我们实现了他的接口但是他并不知道，所以我们需要将当前实现类给注入进去     */    @PostConstruct //被注解的方法，在对象加载完依赖注入后执行,对应的还有@PreDestroy，在对象消亡之前执行    private void init(){        rabbitTemplate.setConfirmCallback(this);        rabbitTemplate.setReturnsCallback(this);    }    /**     * 实现回调方法，不管成功还是失败都会调用     * @param correlationData  保存回调消息的ID及相关信息     *        这个对象并不是他自动生成的，而是由我们在生产者发送消息时创建发送过来的     *        convertAndSend（）发送消息这个方法有大量的重载，里面有好几个重载方法中就要我们填充correlationData对象实例     *        如果我们不实现发送过来，那么这边correlationData对象也会为空     * @param b  交换机是否成功接收消息  true：成功     false：失败     * @param s  失败原因   成功：null   失败：失败原因信息     */    @Override    public void confirm(CorrelationData correlationData, boolean b, String s) {        //获取信息，为防止信息id为null而报错        String id = correlationData.getId()!=null?correlationData.getId():"null";        if (b){            log.info("交换机成功接收消息：消息ID为：{}",id);        }else {            log.info("交换机接收消息失败：消息ID为：{},失败原因:{}",id,s);        }    }    /**     * 路由失败回调     * 退回方法，交换机路由（发送消息）给队列时失败的回调     * @param returnedMessage   消息的一些参数，同意在消费者中设置的，CorrelationData中的参数     */    @Override    public void returnedMessage(ReturnedMessage returnedMessage) {        log.info("路由失败，交换机退回消息：{},交换机是：{},RoutingKey是：{}，退回的原因：{}",                returnedMessage.getMessage(),returnedMessage.getExchange(),returnedMessage.getRoutingKey());    }}</code></pre><h4 id="生产者：-15"><a href="#生产者：-15" class="headerlink" title="生产者："></a>生产者：</h4><p>我们将RoutingKey故意写错，这样就没有这个RoutingKey，那么就可以演示宕机了，使得交换机不能将消息路由（发送）到队列，看下是否会调用退回回调方法</p><pre class="language-none"><code class="language-none">/** * 发布确认生产者 */@Slf4j@Controller@RestControllerpublic class ConfirmController {    @Autowired    private RabbitTemplate rabbitTemplate;    /**     * 发布消息     * @param message     */    @RequestMapping("confirm/Msg/{message}")    public void publicMessage(@PathVariable("message") String message){        //回调方法中显示的CorrelationData实例,无参构造 id为UUID        CorrelationData correlationData = new CorrelationData();        correlationData.setReturned(new ReturnedMessage(new Message(message.getBytes())                ,1                ,"replyText"                ,ConfirmQueueConfig.EXCHANGE_CONFIRM                ,ConfirmQueueConfig.QUEUE_CONFIRM_ROUTING_KEY                ));        rabbitTemplate.convertAndSend(ConfirmQueueConfig.EXCHANGE_CONFIRM  //交换机                ,ConfirmQueueConfig.QUEUE_CONFIRM_ROUTING_KEY+"111" //RoutingKey                ,message //发送的消息                ,correlationData  //回调方法中CorrelationData的实例        );        log.info("发布确认生产者，发送消息:{}",message);    }}</code></pre><h4 id="消费者：-8"><a href="#消费者：-8" class="headerlink" title="消费者："></a>消费者：</h4><p>消费者其实在这没多打用，因为我们都没有发送到消费者就宕机了</p><pre class="language-none"><code class="language-none">/** * 发布确认消费者 */@Slf4j@Componentpublic class ConfirmQueueConsumer {    @RabbitListener(queues = ConfirmQueueConfig.QUEUE_CONFIRM)    public void ConfirmListenerQueue(Message message, Channel channel){      log.info("发布确认消费者接收到队列消息，消费消息:{}",new String(message.getBody()));    }}</code></pre><h4 id="结果：-8"><a href="#结果：-8" class="headerlink" title="结果："></a>结果：</h4><p>调用了退回回调方法，这样我们就不用担心消息不明不白的丢失了</p><p><img src="https://s2.loli.net/2022/04/14/2dNjO1WSxozQgsa.png" alt="image-20220412115323648"></p><h3 id="备份交换机："><a href="#备份交换机：" class="headerlink" title="备份交换机："></a>备份交换机：</h3><p>有了 mandatory 参数和回退消息，我们获得了对无法投递消息的感知能力，有机会在生产者的消息 无法被投递时发现并处理。但有时候，我们并不知道该如何处理这些无法路由的消息，最多打个日志，然 后触发报警，再来手动处理。而通过日志来处理这些无法路由的消息是很不优雅的做法，特别是当生产者 所在的服务有多台机器的时候，手动复制日志会更加麻烦而且容易出错。而且设置 mandatory 参数会增 加生产者的复杂性，需要添加处理这些被退回的消息的逻辑。如果既不想丢失消息，又不想增加生产者的 复杂性，该怎么做呢？前面在设置死信队列的文章中，我们提到，可以为队列设置死信交换机来存储那些 处理失败的消息，可是这些不可路由消息根本没有机会进入到队列，因此无法使用死信队列来保存消息。 在 RabbitMQ 中，有一种备份交换机的机制存在，可以很好的应对这个问题。什么是备份交换机呢？备份 交换机可以理解为 RabbitMQ 中交换机的“备胎”，当我们为某一个交换机声明一个对应的备份交换机时， 就是为它创建一个备胎，当交换机接收到一条不可路由消息时，将会把这条消息转发到备份交换机中，由 备份交换机来进行转发和处理，通常备份交换机的类型为 Fanout ，这样就能把所有消息都投递到与其绑 定的队列中，然后我们在备份交换机下绑定一个队列，这样所有那些原交换机无法被路由的消息，就会都 进入这个队列了。当然，我们还可以建立一个报警队列，用独立的消费者来进行<strong>监测</strong>和<strong>报警</strong>。</p><h4 id="代码架构图："><a href="#代码架构图：" class="headerlink" title="代码架构图："></a>代码架构图：</h4><p><strong>包含发布确认高级篇代码（包含回退消息但代码不会再放出来，代码和上面相同只是多加了一些）</strong></p><p><img src="https://s2.loli.net/2022/04/14/wOc94qreSfyJl5E.png" alt="image-20220413171253890"></p><h4 id="声明绑定配置类：-2"><a href="#声明绑定配置类：-2" class="headerlink" title="声明绑定配置类："></a>声明绑定配置类：</h4><p>普通交换机使用ExchangeBuilder交换机建立者来创建交换机，使用alternate方法进行备份交换机绑定，alternate方法本质还是调用withArgument（）方法填写参数</p><p>备份交换机是发布订阅类型</p><p>其他都是常规声明绑定</p><pre class="language-none"><code class="language-none">/** * 发布确认声明与绑定配置类 */@Configurationpublic class ConfirmQueueConfig {    //___________________________声明名称__________________________________________    //确认交换机名称    public static final String EXCHANGE_CONFIRM="confirm.exchange";    //确认队列名称    public static final String QUEUE_CONFIRM="confirm.queue";    //确认队列RoutingKey    public static final String QUEUE_CONFIRM_ROUTING_KEY="confirm.routingKey";    //备份交换机名称    public static final String EXCHANGE_BACKUP="backup.exchange";    //备份队列名称    public static final String QUEUE_BACKUP="backup.queue";    //备份队列RoutingKey    public static final String QUEUE_BACKUP_WARNING_ROUTING_KEY="backup.warning";    //警告队列名称    public static final String QUEUE_WARNING="warning.queue";    //_______________________________声明交换机_____________________________________________-    /**     * 声明交换机     * @return 返回声明的交换机     */    @Bean    public Exchange ConfirmExchange(){        /**         * 由于我们需要绑定备份交换机，所以我们需要使用交换机建立者，填写参数         */        return ExchangeBuilder//交换机建立者                .directExchange(EXCHANGE_CONFIRM)  //交换机类型与名称                .durable(true)  //是否持久化                .alternate(EXCHANGE_BACKUP)  //绑定备份的交换机名称，这个方法中也是调用这个方法withArgument填写参数                .build(); //构建交换机    }    /**     * 声明备份交换机，扇出类型交换机     * @return 返回声明的交换机     */    @Bean    public Exchange BackupExchange(){        return new FanoutExchange(EXCHANGE_BACKUP);    }    //____________________________________声明队列____________________________________________________    /**     * 声明队列     * @return 返回创建的队列     */    @Bean    public Queue ConfirmQueue(){        return QueueBuilder.durable(QUEUE_CONFIRM).build();    }    /**     * 声明（备份队列）队列，备份交换机路由的队列     * @return 返回创建的队列     */    @Bean    public Queue BackupQueue(){        return QueueBuilder.durable(QUEUE_BACKUP).build();    }    /**     * 声明警告队列(warning)队列,备份交换机路由的队列     * @return 返回创建的队列     */    @Bean    public Queue WarningQueue(){        return QueueBuilder.durable(QUEUE_WARNING).build();    }    //__________________________RoutingKey绑定_________________________________________    /**     * 绑定     * @param exchange 交换机     * @param queue 队列     * @return 返回绑定结构     */    @Bean    public Binding ExchangeConfirmBindingConfirmQueue(@Qualifier("ConfirmExchange") Exchange exchange            ,@Qualifier("ConfirmQueue") Queue queue){        return BindingBuilder.bind(queue).to(exchange).with(QUEUE_CONFIRM_ROUTING_KEY).noargs();    }    /**     * 备份交换机绑定     * @param exchange 交换机     * @param queue 队列 备份消息队列     * @return 返回绑定结构     */    @Bean    public Binding ExchangeConfirmBackupQueue(@Qualifier("BackupExchange") Exchange exchange            ,@Qualifier("BackupQueue") Queue queue){        return BindingBuilder.bind(queue).to(exchange).with(QUEUE_BACKUP_WARNING_ROUTING_KEY).noargs();    }    /**     * 备份交换机绑定     * @param exchange 交换机     * @param queue 队列 警告消息队列     * @return 返回绑定结构     */    @Bean    public Binding ExchangeConfirmBinding(@Qualifier("BackupExchange") Exchange exchange            ,@Qualifier("WarningQueue") Queue queue){        return BindingBuilder.bind(queue).to(exchange).with(QUEUE_BACKUP_WARNING_ROUTING_KEY).noargs();    }}</code></pre><h4 id="生产者：-16"><a href="#生产者：-16" class="headerlink" title="生产者："></a>生产者：</h4><p>我们将RoutingKey故意写错，这样就没有这个RoutingKey，那么就可以演示宕机了，使得交换机不能将消息路由（发送）到队列，看下是否会调用退回回调方法</p><pre class="language-none"><code class="language-none">/** * 发布确认生产者 */@Slf4j@Controller@RestControllerpublic class ConfirmController {    @Autowired    private RabbitTemplate rabbitTemplate;    /**     * 发布消息     * @param message     */    @RequestMapping("confirm/Msg/{message}")    public void publicMessage(@PathVariable("message") String message){        //回调方法中显示的CorrelationData实例,无参构造 id为UUID        CorrelationData correlationData = new CorrelationData();        correlationData.setReturned(new ReturnedMessage(new Message(message.getBytes())                ,1                ,"replyText"                ,ConfirmQueueConfig.EXCHANGE_CONFIRM                ,ConfirmQueueConfig.QUEUE_CONFIRM_ROUTING_KEY                ));        rabbitTemplate.convertAndSend(ConfirmQueueConfig.EXCHANGE_CONFIRM  //交换机                ,ConfirmQueueConfig.QUEUE_CONFIRM_ROUTING_KEY+"111" //RoutingKey                ,message //发送的消息                ,correlationData  //回调方法中CorrelationData的实例        );        log.info("发布确认生产者，发送消息:{}",message);    }}</code></pre><h4 id="消费者：-9"><a href="#消费者：-9" class="headerlink" title="消费者："></a>消费者：</h4><pre class="language-none"><code class="language-none">/** * 备份交换机备份队列消息者与警告队列消费者 */@Slf4j@Componentpublic class BackupConsumer {    /**     * 监听备份队列消息     * @param message 路由失败的一些消息     * @param channel     */    @RabbitListener(queues = ConfirmQueueConfig.QUEUE_BACKUP)    public void BackupQueueListener(Message message, Channel channel){        log.info("备份队列备份消息：{}",new String(message.getBody()));    }    /**     * 监听警告队列消息     * @param message 路由失败的一些消息     * @param channel     */    @RabbitListener(queues = ConfirmQueueConfig.QUEUE_WARNING)    public void WarningQueueListener(Message message, Channel channel){        log.info("警告队列：路由失败，RoutingKey为：{}",message.getMessageProperties().getReceivedRoutingKey());    }}</code></pre><h4 id="结果：-9"><a href="#结果：-9" class="headerlink" title="结果："></a>结果：</h4><p>注意：重新启动项目的时候需要把原来的 confirm.exchange 删除因为我们修改了其绑定属性，不然报以下错:</p><p><img src="https://s2.loli.net/2022/04/14/qoFpAWPzv9BN8y2.png" alt="image-20220413172303951"></p><p><strong>运行结果</strong>：</p><p><img src="https://s2.loli.net/2022/04/14/yeAY9igFENJBKta.png" alt="image-20220413172332796"></p><p>mandatory 参数（回退）与备份交换机可以一起使用的时候，如果两者同时开启，消息究竟何去何从？谁优先 级高，经过上面结果显示答案是备份交换机优先级高。</p><h2 id="RabbitMQ-其他知识点"><a href="#RabbitMQ-其他知识点" class="headerlink" title="RabbitMQ 其他知识点"></a>RabbitMQ 其他知识点</h2><h3 id="幂等性"><a href="#幂等性" class="headerlink" title="幂等性:"></a>幂等性:</h3><h4 id="概念-2"><a href="#概念-2" class="headerlink" title="概念:"></a>概念:</h4><p>用户对于同一操作发起的一次请求或者多次请求的结果是一致的，不会因为多次点击而产生了副作用。 举个最简单的例子，那就是支付，用户购买商品后支付，支付扣款成功，但是返回结果的时候网络异常， 此时钱已经扣了，用户再次点击按钮，此时会进行第二次扣款，返回结果成功，用户查询余额发现多扣钱 了，流水记录也变成了两条。在以前的单应用系统中，我们只需要把数据操作放入事务中即可，发生错误 立即回滚，但是再响应客户端的时候也有可能出现网络中断或者异常等等,(说简单就行消息重复发送)</p><h4 id="消息重复消费"><a href="#消息重复消费" class="headerlink" title="消息重复消费"></a>消息重复消费</h4><p>消费者在消费 MQ 中的消息时，MQ 已把消息发送给消费者，消费者在给 MQ 返回 ack 时网络中断， 故 MQ 未收到确认信息，该条消息会重新发给其他的消费者，或者在网络重连后再次发送给该消费者，但 实际上该消费者已成功消费了该条消息，造成消费者消费了重复的消息。</p><h4 id="解决思路"><a href="#解决思路" class="headerlink" title="解决思路"></a>解决思路</h4><p>MQ 消费者的幂等性的解决一般使用全局 ID 或者写个唯一标识比如时间戳 或者 UUID 或者订单消费 者消费 MQ 中的消息也可利用 MQ 的该 id 来判断，或者可按自己的规则生成一个全局唯一 id，每次消费消 息时用该 id 先判断该消息是否已消费过。</p><h4 id="消费端的幂等性保障"><a href="#消费端的幂等性保障" class="headerlink" title="消费端的幂等性保障"></a>消费端的幂等性保障</h4><p>在海量订单生成的业务高峰期，生产端有可能就会重复发生了消息，这时候消费端就要实现幂等性， 这就意味着我们的消息永远不会被消费多次，即使我们收到了一样的消息。业界主流的幂等性有两种操作:a. 唯一 ID+指纹码机制,利用数据库主键去重, b.利用 redis 的原子性去实现</p><h4 id="唯一-ID-指纹码机制"><a href="#唯一-ID-指纹码机制" class="headerlink" title="唯一 ID+指纹码机制"></a>唯一 ID+指纹码机制</h4><p>指纹码:我们的一些规则或者时间戳加别的服务给到的唯一信息码,它并不一定是我们系统生成的，基 本都是由我们的业务规则拼接而来，但是一定要保证唯一性，然后就利用查询语句进行判断这个 id 是否存 在数据库中,优势就是实现简单就一个拼接，然后查询判断是否重复；劣势就是在高并发时，如果是单个数 据库就会有写入性能瓶颈当然也可以采用分库分表提升性能，但也不是我们最推荐的方式。</p><h4 id="Redis-原子性"><a href="#Redis-原子性" class="headerlink" title="Redis 原子性"></a>Redis 原子性</h4><p>利用 redis 执行 setnx 命令，天然具有幂等性。从而实现不重复消费</p><h2 id="优先级队列"><a href="#优先级队列" class="headerlink" title="优先级队列:"></a>优先级队列:</h2><h3 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景:"></a>使用场景:</h3><p>在我们系统中有一个订单催付的场景，我们的客户在天猫下的订单,淘宝会及时将订单推送给我们，如果在用户设定的时间内未付款那么就会给用户推送一条短信提醒，很简单的一个功能对吧，但是，tmall 商家对我们来说，肯定是要分大客户和小客户的对吧，比如像苹果，小米这样大商家一年起码能给我们创 造很大的利润，所以理应当然，他们的订单必须得到优先处理，而曾经我们的后端系统是使用 redis 来存 放的定时轮询，大家都知道 redis 只能用 List 做一个简简单单的消息队列，并不能实现一个优先级的场景， 所以订单量大了后采用 RabbitMQ 进行改造和优化,如果发现是大客户的订单给一个相对比较高的优先级， 否则就是默认优先级。</p><p><img src="https://s2.loli.net/2022/04/14/s9w4TzgEviFQrB6.png" alt="image-20220413231021607"></p><h3 id="演示：-1"><a href="#演示：-1" class="headerlink" title="演示："></a>演示：</h3><h4 id="SpringBoot使用"><a href="#SpringBoot使用" class="headerlink" title="SpringBoot使用:"></a>SpringBoot使用:</h4><h5 id="声明配置类："><a href="#声明配置类：" class="headerlink" title="声明配置类："></a>声明配置类：</h5><p>队列参数：</p><p>maxPriority（int max）；开启优先级并设置队列最大优先是多少</p><p>其他都是正常声明</p><pre class="language-none"><code class="language-none">/** * 优先级队列声明绑定配置类 */@Configurationpublic class PriorityQueueConfig {    //交换机（普通）名称    public static final String EXCHANGE_PRIORITY="priority.exchange";    //优先级队列名称    public static final String QUEUE_PRIORITY="priority.queue";    //队列RoutingKey    public static final String QUEUE_PRIORITY_ROUTING_KEY="priority.routingKey";    @Bean    public Exchange PriorityExchange(){        return new DirectExchange(EXCHANGE_PRIORITY);    }    /**     * 创建优先级队列     * 其实也就是为这个队列配置优先级权限     * maxPriority（）最大优先级是多少 0 - 255     * @return 返回队列     */    @Bean    public Queue PriorityQueue(){        return QueueBuilder.durable(QUEUE_PRIORITY).maxPriority(10).build();    }    /**     * 绑定RoutingKey     * @param exchange     * @param queue     * @return     */    @Bean    public Binding PriorityExchangeBindingPriorityQueue(@Qualifier("PriorityExchange") Exchange exchange            ,@Qualifier("PriorityQueue") Queue queue){        return BindingBuilder.bind(queue).to(exchange).with(QUEUE_PRIORITY_ROUTING_KEY).noargs();    }}</code></pre><h5 id="生产者：-17"><a href="#生产者：-17" class="headerlink" title="生产者："></a>生产者：</h5><p><strong>注意：我们第一次启动我们要先不使用消费者消费，要不然发一条消息消费者消息一条，这样就没有机会排序了，放消息发送完成后再开启消费者</strong></p><p>设置发送消息参数：</p><p>发送消息设置参数实现：MessagePostProcessor </p><p> /**<br>         * 设置参数<br>                  */<br>        ​        MessagePostProcessor messagePostProcessor = new MessagePostProcessor() {<br>        ​            //设置参数方法，message.getMessageProperties()获取消息参数后设置，链式操作<br>            @Override<br>            public Message postProcessMessage(Message message) throws AmqpException {<br>            ​    message.getMessageProperties().setPriority(5);<br>            ​    return message;<br>            }<br>        ​        };</p><pre class="language-none"><code class="language-none">/** * 生产者 * 优先级队列发消息生产者 */@Slf4j@Controller@RestControllerpublic class PriorityController {    /**     * RabbitTemplate，使用这个进行消息的一些操作     */    @Autowired    private RabbitTemplate rabbitTemplate;    @RequestMapping("priority/Msg/{message}")    private void publicMessage(@PathVariable("message")String message){        /**         * 设置参数         */        MessagePostProcessor messagePostProcessor = new MessagePostProcessor() {        //设置参数方法，message.getMessageProperties()获取消息参数后设置，链式操作            @Override            public Message postProcessMessage(Message message) throws AmqpException {                message.getMessageProperties().setPriority(5);                return message;            }        };        for (int i = 1; i &lt;= 100; i++) {            String msg="消息："+message+i;            /**             * 发布确认回调中的消息详细详细配置             */            CorrelationData correlationData = new CorrelationData();            correlationData.setReturned(new ReturnedMessage(new Message(msg.getBytes()),0,""                    ,PriorityQueueConfig.EXCHANGE_PRIORITY,PriorityQueueConfig.QUEUE_PRIORITY_ROUTING_KEY));            if (i==23){                //发送第23条消息时为它设置优先级为5                rabbitTemplate.convertAndSend(PriorityQueueConfig.EXCHANGE_PRIORITY                        ,PriorityQueueConfig.QUEUE_PRIORITY_ROUTING_KEY                        ,msg                        ,messagePostProcessor                        ,correlationData);            }else {                rabbitTemplate.convertAndSend(PriorityQueueConfig.EXCHANGE_PRIORITY                        , PriorityQueueConfig.QUEUE_PRIORITY_ROUTING_KEY                        , msg                        , correlationData);            }        }        System.out.println("消息发送成功");    }}</code></pre><h5 id="消费者：-10"><a href="#消费者：-10" class="headerlink" title="消费者："></a>消费者：</h5><p>一定要注意导的包，导错包的话是会报错的</p><pre class="language-none"><code class="language-none">@Slf4j@Componentpublic class PriorityConsumer {    @RabbitListener(queues = PriorityQueueConfig.QUEUE_PRIORITY)    public void PriorityListener(Message message, Channel channel){        log.info("优先级队列消费者消费消息:{}",new String(message.getBody()));    }}</code></pre><h5 id="结果：-10"><a href="#结果：-10" class="headerlink" title="结果："></a>结果：</h5><p><strong>第一次启动，发送消息但消费者不启动</strong></p><p>直接注释@RabbitListener（）就可以关闭了</p><p><img src="https://s2.loli.net/2022/04/14/KfZQh4kiJuLWezg.png" alt="image-20220414143225722"></p><p><strong>第二次启动，不发送消息，开启消费者</strong></p><p><img src="https://s2.loli.net/2022/04/14/asrFH5iuNLGUMSd.png" alt="image-20220414143318166"></p><p>可以看到，由于我们第23条信息我们设置的优先级为5，其他信息优先级为默认，在优先级队列排序下，第23条消息先被消费了</p><p><strong>优先级队列标识：</strong></p><p><img src="https://s2.loli.net/2022/04/14/CrJ24mQxncL7hlR.png" alt="image-20220414143544177"></p><h4 id="普通使用"><a href="#普通使用" class="headerlink" title="普通使用:"></a>普通使用:</h4><h5 id="如何添加："><a href="#如何添加：" class="headerlink" title="如何添加："></a>如何添加：</h5><p>1.控制台页面添加</p><p><img src="https://s2.loli.net/2022/04/14/I9BT3g6LEKb4R8y.png" alt="image-20220414143835403"></p><p><strong>2,队列中代码添加优先级</strong></p><pre class="language-none"><code class="language-none">Map&lt;String, Object&gt; params = new HashMap();params.put("x-max-priority", 10);channel.queueDeclare("hello", true, false, false, params);</code></pre><p><img src="https://s2.loli.net/2022/04/14/kfZMNmxbQrPvo5p.png" alt="image-20220414143922270"></p><p><strong>3.消息中代码添加优先级</strong></p><pre class="language-none"><code class="language-none">AMQP.BasicProperties properties = new AMQP.BasicProperties().builder().priority(5).build();</code></pre><h5 id="演示：-2"><a href="#演示：-2" class="headerlink" title="演示："></a>演示：</h5><h6 id="生产者：-18"><a href="#生产者：-18" class="headerlink" title="生产者："></a>生产者：</h6><pre class="language-none"><code class="language-none">public class Producer {    private static final String QUEUE_NAME="hello";    public static void main(String[] args) throws Exception {        try (Channel channel = RabbitMqUtils.getChannel();) {            //给消息赋予一个 priority 属性            AMQP.BasicProperties properties = new                    AMQP.BasicProperties().builder().priority(5).build();            for (int i = 1; i &lt;11; i++) {                String message = "info"+i;                if(i==5){                    channel.basicPublish("", QUEUE_NAME, properties, message.getBytes());                }else{                    channel.basicPublish("", QUEUE_NAME, null, message.getBytes());                }                System.out.println("发送消息完成:" + message);            }        }    }}</code></pre><h6 id="消费者：-11"><a href="#消费者：-11" class="headerlink" title="消费者："></a>消费者：</h6><pre class="language-none"><code class="language-none">public class Consumer {    private static final String QUEUE_NAME="hello";    public static void main(String[] args) throws Exception {        Channel channel = RabbitMqUtils.getChannel();        //设置队列的最大优先级 最大可以设置到 255 官网推荐 1-10 如果设置太高比较吃内存和 CPU        Map&lt;String, Object&gt; params = new HashMap();        params.put("x-max-priority", 10);        channel.queueDeclare(QUEUE_NAME, true, false, false, params);        System.out.println("消费者启动等待消费......");        DeliverCallback deliverCallback=(consumerTag, delivery)-&gt;{            String receivedMessage = new String(delivery.getBody());            System.out.println("接收到消息:"+receivedMessage);        };        channel.basicConsume(QUEUE_NAME,true,deliverCallback,(consumerTag)-&gt;{            System.out.println("消费者无法消费消息时调用，如队列被删除");        });    }}</code></pre><h2 id="惰性队列："><a href="#惰性队列：" class="headerlink" title="惰性队列："></a>惰性队列：</h2><h3 id="使用场景-1"><a href="#使用场景-1" class="headerlink" title="使用场景"></a>使用场景</h3><p>RabbitMQ 从 3.6.0 版本开始引入了惰性队列的概念。惰性队列会尽可能的将消息存入磁盘中，而在消 费者消费到相应的消息时才会被加载到内存中，它的一个重要的设计目标是能够支持更长的队列，即支持 更多的消息存储。当消费者由于各种各样的原因(比如消费者下线、宕机亦或者是由于维护而关闭等)而致 使长时间内不能消费消息造成堆积时，惰性队列就很有必要了。</p><p>默认情况下，当生产者将消息发送到 RabbitMQ 的时候，队列中的消息会尽可能的存储在内存之中， 这样可以更加快速的将消息发送给消费者。即使是持久化的消息，在被写入磁盘的同时也会在内存中驻留 一份备份。当 RabbitMQ 需要释放内存的时候，会将内存中的消息换页至磁盘中，这个操作会耗费较长的 时间，也会阻塞队列的操作，进而无法接收新的消息。虽然 RabbitMQ 的开发者们一直在升级相关的算法， 但是效果始终不太理想，尤其是在消息量特别大的时候</p><h3 id="两种模式："><a href="#两种模式：" class="headerlink" title="两种模式："></a>两种模式：</h3><p>队列具备两种模式：default 和 lazy。默认的为 default 模式，在 3.6.0 之前的版本无需做任何变更。lazy 模式即为惰性队列的模式，可以通过调用 channel.queueDeclare 方法的时候在参数中设置，也可以通过 Policy（网页） 的方式设置，如果一个队列同时使用这两种方式设置的话，那么 Policy（网页） 的方式具备更高的优先级。 如果要通过声明的方式改变已有队列的模式的话，那么只能先删除队列，然后再重新声明一个新的。</p><p>在队列声明的时候可以通过“x-queue-mode”参数来设置队列的模式，取值为“default”和“lazy”。</p><p>下面示 例中演示了一个惰性队列的声明细节：</p><pre class="language-none"><code class="language-none">Map&lt;String, Object&gt; args = new HashMap&lt;String, Object&gt;();args.put("x-queue-mode", "lazy");channel.queueDeclare("myqueue", false, false, false, args);</code></pre><h3 id="内存开销对比"><a href="#内存开销对比" class="headerlink" title="内存开销对比"></a>内存开销对比</h3><p><img src="https://s2.loli.net/2022/04/14/r2WuKcC86kV7Rb3.png" alt="image-20220414175443632"></p><p>在发送 1 百万条消息，每条消息大概占 1KB 的情况下，普通队列占用内存是 1.2GB，而惰性队列仅仅 占用 1.5MB（这是因为存储的时持平上的索引而不是真正的消息）</p>]]></content>
      
      
      <categories>
          
          <category> 消息队列 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SpringBootSecurity</title>
      <link href="/2022/03/03/SpringBootSecurity/"/>
      <url>/2022/03/03/SpringBootSecurity/</url>
      
        <content type="html"><![CDATA[<h1 id="SpringBoot安全框架："><a href="#SpringBoot安全框架：" class="headerlink" title="SpringBoot安全框架："></a>SpringBoot安全框架：</h1><h2 id="HttpBasic认证模式："><a href="#HttpBasic认证模式：" class="headerlink" title="HttpBasic认证模式："></a>HttpBasic认证模式：</h2><p>这是种防君子不防小人的认证，也是最简单的一个认证模式</p><p>编写配置类：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecurityConfig</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token punctuation">{</span>    <span class="token comment">//进行重写</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>        <span class="token comment">//开启httpBasic认证</span>        http<span class="token punctuation">.</span><span class="token function">httpBasic</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token comment">//所有的请求</span>                <span class="token punctuation">.</span><span class="token function">authorizeHttpRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token comment">//匹配规则</span>                <span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token comment">//所有请求都需要登录认证才可以访问</span>                <span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>编写好配置文件后，启动会给出一个密码：</strong></p><p>我们使用该密码进行登录</p><p>Using generated security password: 8e0f5586-f414-454b-bd96-ffc82e919a6a</p><p><strong>我们自己指定用户名，密码修改配置文件application：</strong></p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">server</span><span class="token punctuation">:</span>  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span><span class="token key atrule">spring</span><span class="token punctuation">:</span>  <span class="token key atrule">security</span><span class="token punctuation">:</span>    <span class="token comment">#配置httpBasic认证的用户名，密码</span>    <span class="token key atrule">user</span><span class="token punctuation">:</span>      <span class="token key atrule">name</span><span class="token punctuation">:</span> admin      <span class="token key atrule">password</span><span class="token punctuation">:</span> admin123<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>启动后就不好给我们密码了，但这个密码是可以获取到的，如图：</p><p><img src="https://s2.loli.net/2022/03/09/Zvx8aDjWt9eLOY1.png" alt="image-20220302192907115"></p><p><strong>我们可以使用工具Postman获取到账户密码：</strong></p><p>​                                登录：</p><p><img src="https://s2.loli.net/2022/03/09/Peuw2ZW7bDNgGcx.png" alt="image-20220303084206675"></p><p><strong>可以看到有给Authorization  这个是我们的账号密码使用ase64加密后的结果我们可以复制加密后的密码去解码就可以获取到账号密码了：</strong></p><p><img src="https://s2.loli.net/2022/03/09/zHSoTNCL1tjQf4U.png" alt="image-20220303084235403"></p><p><strong>解码结果：</strong></p><p><img src="https://s2.loli.net/2022/03/09/STXbo9kga8Ri5FH.png" alt="image-20220303091317694"></p><h2 id="passwrodEncoder加密"><a href="#passwrodEncoder加密" class="headerlink" title="passwrodEncoder加密"></a>passwrodEncoder加密</h2><p>passwrodEncoder加密是不可逆的</p><p><strong>passwrodEncoder接口：</strong></p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">PasswordEncoder</span> <span class="token punctuation">{</span>    <span class="token class-name">String</span> <span class="token function">encode</span><span class="token punctuation">(</span><span class="token class-name">CharSequence</span> rawPassword<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//用于加密密码</span>    <span class="token keyword">boolean</span> <span class="token function">matches</span><span class="token punctuation">(</span><span class="token class-name">CharSequence</span> rawPassword<span class="token punctuation">,</span> <span class="token class-name">String</span> encodedPassword<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//验证输入的密码是否与加密的密码一致</span>    <span class="token keyword">default</span> <span class="token keyword">boolean</span> <span class="token function">upgradeEncoding</span><span class="token punctuation">(</span><span class="token class-name">String</span> encodedPassword<span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token comment">//密码是否需要被更新，有需要可以重新该方法</span>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>推荐使用的实现类BCryptPasswordEncoder：</strong></p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span><span class="token keyword">void</span> <span class="token function">contextLoads</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token class-name">BCryptPasswordEncoder</span> bCryptPasswordEncoder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//密码加密</span>    <span class="token class-name">String</span> encode <span class="token operator">=</span> bCryptPasswordEncoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token string">"123hzr"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"一次加密:"</span><span class="token operator">+</span>encode<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//密码校验对比</span>    <span class="token keyword">boolean</span> matches <span class="token operator">=</span> bCryptPasswordEncoder<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span><span class="token string">"123"</span><span class="token punctuation">,</span> encode<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"密码是否正确"</span><span class="token operator">+</span>matches<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//密码校验对比</span>    <span class="token keyword">boolean</span> matches1 <span class="token operator">=</span> bCryptPasswordEncoder<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span><span class="token string">"123hzr"</span><span class="token punctuation">,</span> encode<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"密码是否正确"</span><span class="token operator">+</span>matches1<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//同样密码加密，结果和第一加密码不一样，所以说passwrodEncoder加密是不可逆的</span>    <span class="token class-name">String</span> encode2 <span class="token operator">=</span> bCryptPasswordEncoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token string">"123hzr"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"二次加密:"</span><span class="token operator">+</span>encode2<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>结果</strong>：</p><pre class="line-numbers language-none"><code class="language-none">一次加密:$2a$10$6zuzvMqFVq89TerHtThXder6n2VqOMyJF6hpAn8ZBYjA7FaGOPzOy密码是否正确false密码是否正确true二次加密:$2a$10$rAznej1Fv0VGqXkXo7tKiu4c0nBwEYzVykbPfhGE9YSi25xpmTL7G<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><strong>加密值解释：</strong></p><p>$2a  //表示 BCrypt 算法版本</p><p>$10    //表示算法强度</p><p>$rAznej1Fv0VGqXkXo7tK   //随机生成的盐值</p><p>iu4c0nBwEYzVykbPfhGE9YSi25xpmTL7G  //hash值</p><h2 id="formLogin登录认证"><a href="#formLogin登录认证" class="headerlink" title="formLogin登录认证"></a>formLogin登录认证</h2><h3 id="同样先编写配置类："><a href="#同样先编写配置类：" class="headerlink" title="同样先编写配置类："></a>同样先编写配置类：</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecurityConfig</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token punctuation">{</span>    <span class="token comment">/**     * 登录认证方法     * @param http     * @throws Exception     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>            <span class="token comment">//开启formLogin登录认证</span>        <span class="token comment">//关闭防御csrf攻击</span>        http<span class="token punctuation">.</span><span class="token function">csrf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">formLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">loginPage</span><span class="token punctuation">(</span><span class="token string">"/logins"</span><span class="token punctuation">)</span>    <span class="token comment">//用于选择登录页面，没认证时跳转的页面</span>                <span class="token punctuation">.</span><span class="token function">loginProcessingUrl</span><span class="token punctuation">(</span><span class="token string">"/login"</span><span class="token punctuation">)</span>   <span class="token comment">//选择需要认证的请求，也就是登录表单的提交地址</span>                <span class="token punctuation">.</span><span class="token function">usernameParameter</span><span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">)</span>   <span class="token comment">//选择登录请求的哪个参数是用户名</span>                <span class="token punctuation">.</span><span class="token function">passwordParameter</span><span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">)</span>   <span class="token comment">//选择登录请求的哪个参数是密码</span>                <span class="token punctuation">.</span><span class="token function">defaultSuccessUrl</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span>   <span class="token comment">//登录成功跳转的路径</span>                <span class="token punctuation">.</span><span class="token function">failureForwardUrl</span><span class="token punctuation">(</span><span class="token string">"/logins"</span><span class="token punctuation">)</span>  <span class="token comment">//登录失败跳转的路径</span>             <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//自定义过滤拦截请求</span>                <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/logins"</span><span class="token punctuation">,</span><span class="token string">"/login"</span><span class="token punctuation">)</span> <span class="token comment">//资源路径</span>                <span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">//当前资源路径不需要认证就可以访问</span>                <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/business1"</span><span class="token punctuation">,</span><span class="token string">"/business2"</span><span class="token punctuation">,</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token comment">//资源路径</span>                <span class="token punctuation">.</span><span class="token function">hasAnyAuthority</span><span class="token punctuation">(</span><span class="token string">"ROLE_user"</span><span class="token punctuation">,</span><span class="token string">"ROLE_admin"</span><span class="token punctuation">)</span><span class="token comment">//设置可以访问的角色,user角色和admin角色都可以访问</span>                    <span class="token comment">//访问角色控制方式1  与授权方法1一起使用</span>                <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/log"</span><span class="token punctuation">,</span><span class="token string">"/user"</span><span class="token punctuation">)</span><span class="token comment">//资源路径</span>                <span class="token punctuation">.</span><span class="token function">hasRole</span><span class="token punctuation">(</span><span class="token string">"admin"</span><span class="token punctuation">)</span><span class="token comment">//设置可以访问的角色，和hasAnyAuthority作用相同，但hasAnyAuthority可以设置多个，并且需要加前缀ROLE_</span>                    <span class="token comment">//访问角色控制方式2  与授权方法2一起使用  这里由于它不是admin角色了，所有访问业务1业务2访问不了但可以修改一下</span><span class="token comment">//                .antMatchers("/user").hasAnyAuthority("sys:user")  // /user资源路径 必须拥有sys:user角色才可访问</span><span class="token comment">//                .antMatchers("/log").hasAnyAuthority("sys:log") // /log资源路径 必须拥有sys:log角色才可访问</span>                <span class="token comment">//选择的匹配规则</span>                <span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token comment">//所有请求都需要登录认证才可以访问</span>                <span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//.authorizeHttpRequests()   这样方法表示选中的请求</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 授权方法     * @param auth     * @throws Exception     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationManagerBuilder</span> auth<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>                auth  <span class="token comment">//授权</span>                <span class="token punctuation">.</span><span class="token function">inMemoryAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">//将这种用户添加到内存中登录认证，   还有其他类型的授权登录认证方法，比如数据库的登录认证</span>                <span class="token punctuation">.</span><span class="token function">withUser</span><span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">)</span>  <span class="token comment">//用户名</span>                <span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token string">"123456"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">//密码</span>                <span class="token punctuation">.</span><span class="token function">roles</span><span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">)</span>  <span class="token comment">//设置使用该用户名登录赋予的角色，</span>            <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                 <span class="token punctuation">.</span><span class="token function">withUser</span><span class="token punctuation">(</span><span class="token string">"admin"</span><span class="token punctuation">)</span> <span class="token comment">//用户名</span>                 <span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token string">"123456"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                   <span class="token comment">//第一种授权方式</span>                 <span class="token punctuation">.</span><span class="token function">roles</span><span class="token punctuation">(</span><span class="token string">"admin"</span><span class="token punctuation">)</span>  <span class="token comment">//设置使用该账号登录赋予的角色</span>                   <span class="token comment">//第二种授权方式</span>                 <span class="token comment">//.authorities("sys:log","sys:user") //为当前用户赋予角色</span>            <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                  <span class="token punctuation">.</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//配置BCrypt加密，这个会自动调用matches（）这个方法来为我们输入的密码进行对比</span>    <span class="token punctuation">}</span><span class="token comment">/***加密方式*/</span>    <span class="token annotation punctuation">@Bean</span>    <span class="token keyword">public</span> <span class="token class-name">PasswordEncoder</span> <span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 静态资源路径开放     * @param web     * @throws Exception     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">WebSecurity</span> web<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>        <span class="token comment">//将项目中的静态资源路径开放出来，在这开放是不需要经过过滤器拦截的</span>        web<span class="token punctuation">.</span><span class="token function">ignoring</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/css/**"</span><span class="token punctuation">,</span><span class="token string">"/fonts/**"</span><span class="token punctuation">,</span><span class="token string">"/img/**"</span><span class="token punctuation">,</span><span class="token string">"/js/**"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="controller类："><a href="#controller类：" class="headerlink" title="controller类："></a>controller类：</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Controller</span><span class="token keyword">public</span> <span class="token keyword">class</span> indexController <span class="token punctuation">{</span>    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"/"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token string">"index"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token comment">//</span><span class="token comment">//</span>    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/logins"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token string">"login"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/user"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">user</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token string">"user"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/log"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token string">"log"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/business1"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">business1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token string">"business1"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/business2"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">business2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token string">"business2"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="自定义登录验证处理："><a href="#自定义登录验证处理：" class="headerlink" title="自定义登录验证处理："></a><strong>自定义登录验证处理：</strong></h2><p>这里我们需要了解一下</p><p><img src="https://s2.loli.net/2022/03/09/DqCRLYV6WyMAa9Q.png" alt="image-20220304105306887"></p><p>这两类，第一个是登录成功后的处理方式，第二给是登录失败的处理方式，我们需要重新它</p><p><strong>AuthenticationFailureHandler  登录失败重写：</strong></p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 登录失败后进行的操作 */</span><span class="token annotation punctuation">@Component</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyAuthenticationFailureHandler</span><span class="token comment">//SimpleUrlAuthenticationFailureHandle 是AuthenticationFailureHandler的一个实现类</span>    <span class="token keyword">extends</span> <span class="token class-name">SimpleUrlAuthenticationFailureHandler</span> <span class="token punctuation">{</span>    <span class="token comment">//注意这个一定要使用el表达式，否则这个方法都不会进  ；这个是配置文件中自定义的参数，值为JSON</span>    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${spring.security.loginType}"</span><span class="token punctuation">)</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> loginType<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ObjectMapper</span> objectMapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">/**     * 登录失败后进行操作     * @param request 请求     * @param response 响应     * @param exception  异常     * @throws IOException     * @throws ServletException     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onAuthenticationFailure</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">AuthenticationException</span> exception<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>        <span class="token comment">//判断要返回的类型</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>loginType<span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span><span class="token string">"JSON"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token comment">//告诉浏览器，以json返回</span>            response<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token string">"application/json;charset=UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//要返回的数据  这里的JsonResult只是单纯的一个返回json信息格式的类</span>            response<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>objectMapper<span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">JsonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">InputError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token comment">//登录失败后进行的页面跳转，父类已经为我们实现了</span>            response<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token string">"application/html;charset=UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onAuthenticationFailure</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> exception<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p> <strong>AuthenticationSuccessHandler 登录成功重新:</strong></p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 配置登录成功后需要的操作 * 实现AuthenticationSuccessHandler登录成功进行的操作 */</span><span class="token annotation punctuation">@Component</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyAuthenticationSuccessHandler</span>    <span class="token comment">//SavedRequestAwareAuthenticationSuccessHandler 继承该类，该类实现了AuthenticationSuccessHandler登录成功进行的操作</span>    <span class="token comment">//这个类中有帮我们实现一些有用的方法，比如说记住用户上一次的操作，登录后跳转的页面就是用户上一次未能进入的页面，而不是首页</span>    <span class="token keyword">extends</span> <span class="token class-name">SavedRequestAwareAuthenticationSuccessHandler</span> <span class="token punctuation">{</span>    <span class="token comment">//注意这个一定要使用el表达式，否则这个方法都不会进  ；这个是配置文件中自定义的参数，值为JSON</span>    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${spring.security.loginType}"</span><span class="token punctuation">)</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> loginType<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ObjectMapper</span> objectMapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">/**     * 这个方法是登录成功后执行的     * @param request  请求     * @param response  响应     * @param authentication     * @throws ServletException     * @throws IOException     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onAuthenticationSuccess</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Authentication</span> authentication<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>        <span class="token comment">//判断要返回的类型</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>loginType<span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span><span class="token string">"JSON"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token comment">//告诉浏览器，以json返回</span>            response<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token string">"application/json;charset=UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//要返回的数据</span>            response<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>objectMapper<span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">JsonResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token comment">//会帮助我们跳转到上一次请求的页面 ,这个方法也就是我们重新的这个方法</span>            response<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token string">"application/html;charset=UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onAuthenticationSuccess</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span>response<span class="token punctuation">,</span>authentication<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>Security配置类：</strong></p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecurityConfig</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token punctuation">{</span>    <span class="token comment">//将我们自定义的这两个类使用IOC容器装配</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">private</span> <span class="token class-name">MyAuthenticationSuccessHandler</span> myAuthenticationSuccessHandler<span class="token punctuation">;</span>  <span class="token comment">//登录成功处理</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">private</span> <span class="token class-name">MyAuthenticationFailureHandler</span> myAuthenticationFailureHandler<span class="token punctuation">;</span>  <span class="token comment">//登录失败处理</span>    <span class="token comment">/**     * 登录认证方法     * @param http     * @throws Exception     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>        <span class="token comment">//开启formLogin登录认证</span>        <span class="token comment">//关闭防御csrf攻击</span>        http<span class="token punctuation">.</span><span class="token function">csrf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">formLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//开启formLogin登录认证</span>                <span class="token punctuation">.</span><span class="token function">loginPage</span><span class="token punctuation">(</span><span class="token string">"/logins"</span><span class="token punctuation">)</span>    <span class="token comment">//用于选择登录页面，没认证时跳转的页面</span>                <span class="token punctuation">.</span><span class="token function">loginProcessingUrl</span><span class="token punctuation">(</span><span class="token string">"/login"</span><span class="token punctuation">)</span>   <span class="token comment">//选择需要认证的请求，也就是登录表单的提交地址</span>                <span class="token punctuation">.</span><span class="token function">usernameParameter</span><span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">)</span>   <span class="token comment">//选择登录请求的哪个参数是用户名</span>                <span class="token punctuation">.</span><span class="token function">passwordParameter</span><span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">)</span>   <span class="token comment">//选择登录请求的哪个参数是密码</span>                <span class="token comment">//使用自定义的登录失败成功处理方法</span>                <span class="token punctuation">.</span><span class="token function">successHandler</span><span class="token punctuation">(</span>myAuthenticationSuccessHandler<span class="token punctuation">)</span>  <span class="token comment">//登录成功</span>                <span class="token punctuation">.</span><span class="token function">failureHandler</span><span class="token punctuation">(</span>myAuthenticationFailureHandler<span class="token punctuation">)</span>  <span class="token comment">//登录失败</span>                <span class="token comment">//这两会与我们自定义的冲突想要使用自定义的就不能使用这个</span><span class="token comment">//                .defaultSuccessUrl("/")   //登录成功跳转的路径</span><span class="token comment">//                .failureForwardUrl("/logins")  //登录失败跳转的路径</span>             <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//自定义过滤拦截请求</span>                <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/logins"</span><span class="token punctuation">,</span><span class="token string">"/login"</span><span class="token punctuation">)</span> <span class="token comment">//资源路径</span>                <span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">//当前资源路径不需要认证就可以访问</span>                <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/business1"</span><span class="token punctuation">,</span><span class="token string">"/business2"</span><span class="token punctuation">,</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token comment">//资源路径</span>                <span class="token punctuation">.</span><span class="token function">hasAnyAuthority</span><span class="token punctuation">(</span><span class="token string">"ROLE_user"</span><span class="token punctuation">,</span><span class="token string">"ROLE_admin"</span><span class="token punctuation">)</span><span class="token comment">//设置可以访问的角色,user角色和admin角色都可以访问</span>                    <span class="token comment">//访问角色控制方式1  与授权方法1一起使用</span>                <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/log"</span><span class="token punctuation">,</span><span class="token string">"/user"</span><span class="token punctuation">)</span><span class="token comment">//资源路径</span>                <span class="token punctuation">.</span><span class="token function">hasRole</span><span class="token punctuation">(</span><span class="token string">"admin"</span><span class="token punctuation">)</span><span class="token comment">//设置可以访问的角色，和hasAnyAuthority作用相同，但hasAnyAuthority可以设置多个，并且需要加前缀ROLE_</span>                    <span class="token comment">//访问角色控制方式2  与授权方法2一起使用  这里由于它不是admin角色了，所有访问业务1业务2访问不了但可以修改一下</span><span class="token comment">//                .antMatchers("/user").hasAnyAuthority("sys:user")  // /user资源路径 必须拥有sys:user角色才可访问</span><span class="token comment">//                .antMatchers("/log").hasAnyAuthority("sys:log") // /log资源路径 必须拥有sys:log角色才可访问</span>                <span class="token comment">//选择的匹配规则</span>                <span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token comment">//所有请求都需要登录认证才可以访问</span>                <span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//.authorizeHttpRequests()   这样方法表示选中的请求</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 授权方法     * @param auth     * @throws Exception     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationManagerBuilder</span> auth<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>                auth  <span class="token comment">//授权</span>                <span class="token punctuation">.</span><span class="token function">inMemoryAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">//将这种用户添加到内存中登录认证，   还有其他类型的授权登录认证方法，比如数据库的登录认证</span>                <span class="token punctuation">.</span><span class="token function">withUser</span><span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">)</span>  <span class="token comment">//用户名</span>                <span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token string">"123456"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">//密码</span>                <span class="token punctuation">.</span><span class="token function">roles</span><span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">)</span>  <span class="token comment">//设置使用该用户名登录赋予的角色，</span>            <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                 <span class="token punctuation">.</span><span class="token function">withUser</span><span class="token punctuation">(</span><span class="token string">"admin"</span><span class="token punctuation">)</span> <span class="token comment">//用户名</span>                 <span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token string">"123456"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                   <span class="token comment">//第一种授权方式</span>                 <span class="token punctuation">.</span><span class="token function">roles</span><span class="token punctuation">(</span><span class="token string">"admin"</span><span class="token punctuation">)</span>  <span class="token comment">//设置使用该账号登录赋予的角色</span>                   <span class="token comment">//第二种授权方式</span>                 <span class="token comment">//.authorities("sys:log","sys:user") //为当前用户赋予角色</span>            <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                  <span class="token punctuation">.</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//配置BCrypt加密，这个会自动调用matches（）这个方法来为我们输入的密码进行对比</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Bean</span>    <span class="token keyword">public</span> <span class="token class-name">PasswordEncoder</span> <span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 静态资源路径开放     * @param web     * @throws Exception     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">WebSecurity</span> web<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>        <span class="token comment">//将项目中的静态资源路径开放出来，在这开放是不需要经过过滤器拦截的</span>        web<span class="token punctuation">.</span><span class="token function">ignoring</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/css/**"</span><span class="token punctuation">,</span><span class="token string">"/fonts/**"</span><span class="token punctuation">,</span><span class="token string">"/img/**"</span><span class="token punctuation">,</span><span class="token string">"/js/**"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>由于这里返回的是Json数据，注意，那么login就需要使用Ajax的方式请求数据：</strong></p><pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://code.jquery.com/jquery-3.0.0.min.js<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>登录<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/login<span class="token punctuation">"</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>post<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>    账号：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>username<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>user<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">&gt;</span></span>    密码：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>button<span class="token punctuation">"</span></span> <span class="token special-attr"><span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value javascript language-javascript"><span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">"</span></span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>登录<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">    <span class="token keyword">function</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">let</span> username<span class="token operator">=</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"#username"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">let</span> password<span class="token operator">=</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"#password"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        $<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span><span class="token punctuation">{</span>            <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">"POST"</span><span class="token punctuation">,</span>            <span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token string">"/login"</span><span class="token punctuation">,</span>            <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span>                <span class="token string-property property">"user"</span><span class="token operator">:</span> username<span class="token punctuation">,</span>                <span class="token string-property property">"password"</span><span class="token operator">:</span> password            <span class="token punctuation">}</span><span class="token punctuation">,</span>            <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">json</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>              <span class="token keyword">if</span> <span class="token punctuation">(</span>json<span class="token punctuation">.</span>state <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span>                  location<span class="token punctuation">.</span>href<span class="token operator">=</span><span class="token string">"/"</span><span class="token punctuation">;</span>              <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>                  <span class="token function">alert</span><span class="token punctuation">(</span>json<span class="token punctuation">.</span>message<span class="token punctuation">)</span>                  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span>                  location<span class="token punctuation">.</span>href<span class="token operator">=</span><span class="token string">"/logins"</span><span class="token punctuation">;</span>              <span class="token punctuation">}</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span>            <span class="token function-variable function">error</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="session会话的安全管理："><a href="#session会话的安全管理：" class="headerlink" title="session会话的安全管理："></a>session会话的安全管理：</h2><p><img src="https://s2.loli.net/2022/03/09/yDC5PVItQqJhvg2.png" alt="image-20220304121119473"></p><p><img src="https://s2.loli.net/2022/03/09/HZw4NyRuXetcvqo.png" alt="image-20220304121220680"></p><p>添加以上配置示例：</p><p><img src="https://s2.loli.net/2022/03/09/VdxHK6JY45FvpBl.png" alt="image-20220304121253830"></p><p><strong>session的安全保护：</strong></p><p><img src="https://s2.loli.net/2022/03/09/MEb92jfIm6XRuiA.png" alt="image-20220304121414386"></p><p><strong>cookie的安全：</strong></p><p><img src="https://s2.loli.net/2022/03/09/c874Wyzg2Rf93JD.png" alt="image-20220304121440993"></p><h2 id="同账号多登录踢下线："><a href="#同账号多登录踢下线：" class="headerlink" title="同账号多登录踢下线："></a>同账号多登录踢下线：</h2><p><strong>踢下线处理类：</strong></p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 配置当session被踢下线之后的操作，如：跳转页面 */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomExpiredSessionStrategy</span>    <span class="token comment">//需要实现该接口</span>    <span class="token keyword">implements</span> <span class="token class-name">SessionInformationExpiredStrategy</span> <span class="token punctuation">{</span>    <span class="token comment">//页面跳转的处理类</span>    <span class="token keyword">private</span> <span class="token class-name">RedirectStrategy</span> redirectStrategy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultRedirectStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//用于将对象转换为json格式</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ObjectMapper</span> objectMapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">/**     * 当发现session踢下线就会调用该方法处理，前提需要再配置类中使用该类处理     * @param event  这个类中可以获取到requesty 与 respoense     * @throws IOException     * @throws ServletException     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onExpiredSessionDetected</span><span class="token punctuation">(</span><span class="token class-name">SessionInformationExpiredEvent</span> event<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>        <span class="token comment">//两种方式，前后端分离，JSON格式，与直接跳转页面的的方式</span>            <span class="token comment">//方式二，json格式</span>            <span class="token comment">//这里使用map也行，对象也行，就是返回的信息</span>            <span class="token class-name">Map</span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"stat"</span><span class="token punctuation">,</span><span class="token string">"200"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"message"</span><span class="token punctuation">,</span><span class="token string">"请重新进行登录"</span><span class="token operator">+</span>event<span class="token punctuation">.</span><span class="token function">getSessionInformation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLastRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//后面的登录时间</span>            <span class="token class-name">String</span> s <span class="token operator">=</span> objectMapper<span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>            event<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token string">"application/json;charset=UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            event<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//            //方式一，直接跳转  这个方法是重定向到指定的页面</span><span class="token comment">//            redirectStrategy.sendRedirect(event.getRequest(),event.getResponse(),"/logins");</span><span class="token comment">//</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>在securty配置类中配置：</strong></p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecurityConfig</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token punctuation">{</span>    <span class="token comment">//将我们自定义的这两个类使用IOC容器装配</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">private</span> <span class="token class-name">MyAuthenticationSuccessHandler</span> myAuthenticationSuccessHandler<span class="token punctuation">;</span>  <span class="token comment">//登录成功处理</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">private</span> <span class="token class-name">MyAuthenticationFailureHandler</span> myAuthenticationFailureHandler<span class="token punctuation">;</span>  <span class="token comment">//登录失败处理</span>        <span class="token comment">//开启formLogin登录认证</span>        <span class="token comment">//关闭防御csrf攻击</span>        http<span class="token punctuation">.</span><span class="token function">csrf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">formLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//开启formLogin登录认证</span>                <span class="token punctuation">.</span><span class="token function">loginPage</span><span class="token punctuation">(</span><span class="token string">"/logins"</span><span class="token punctuation">)</span>    <span class="token comment">//用于选择登录页面，没认证时跳转的页面</span>                <span class="token punctuation">.</span><span class="token function">loginProcessingUrl</span><span class="token punctuation">(</span><span class="token string">"/login"</span><span class="token punctuation">)</span>   <span class="token comment">//选择需要认证的请求，也就是登录表单的提交地址</span>                <span class="token punctuation">.</span><span class="token function">usernameParameter</span><span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">)</span>   <span class="token comment">//选择登录请求的哪个参数是用户名</span>                <span class="token punctuation">.</span><span class="token function">passwordParameter</span><span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">)</span>   <span class="token comment">//选择登录请求的哪个参数是密码</span>                <span class="token comment">//使用自定义的登录失败成功处理方法</span>                <span class="token punctuation">.</span><span class="token function">successHandler</span><span class="token punctuation">(</span>myAuthenticationSuccessHandler<span class="token punctuation">)</span>  <span class="token comment">//登录成功</span>                <span class="token punctuation">.</span><span class="token function">failureHandler</span><span class="token punctuation">(</span>myAuthenticationFailureHandler<span class="token punctuation">)</span>  <span class="token comment">//登录失败</span>                <span class="token comment">//这两会与我们自定义的冲突想要使用自定义的就不能使用这个</span><span class="token comment">//                .defaultSuccessUrl("/")   //登录成功跳转的路径</span><span class="token comment">//                .failureForwardUrl("/logins")  //登录失败跳转的路径</span>             <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//自定义过滤拦截请求</span>                <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/logins"</span><span class="token punctuation">,</span><span class="token string">"/login"</span><span class="token punctuation">)</span> <span class="token comment">//资源路径</span>                <span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">//当前资源路径不需要认证就可以访问</span>                <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/business1"</span><span class="token punctuation">,</span><span class="token string">"/business2"</span><span class="token punctuation">,</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token comment">//资源路径</span>                <span class="token punctuation">.</span><span class="token function">hasAnyAuthority</span><span class="token punctuation">(</span><span class="token string">"ROLE_user"</span><span class="token punctuation">,</span><span class="token string">"ROLE_admin"</span><span class="token punctuation">)</span><span class="token comment">//设置可以访问的角色,user角色和admin角色都可以访问</span>                    <span class="token comment">//访问角色控制方式1  与授权方法1一起使用</span>                <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/log"</span><span class="token punctuation">,</span><span class="token string">"/user"</span><span class="token punctuation">)</span><span class="token comment">//资源路径</span>                <span class="token punctuation">.</span><span class="token function">hasRole</span><span class="token punctuation">(</span><span class="token string">"admin"</span><span class="token punctuation">)</span><span class="token comment">//设置可以访问的角色，和hasAnyAuthority作用相同，但hasAnyAuthority可以设置多个，并且需要加前缀ROLE_</span>                    <span class="token comment">//访问角色控制方式2  与授权方法2一起使用  这里由于它不是admin角色了，所有访问业务1业务2访问不了但可以修改一下</span><span class="token comment">//                .antMatchers("/user").hasAnyAuthority("sys:user")  // /user资源路径 必须拥有sys:user角色才可访问</span><span class="token comment">//                .antMatchers("/log").hasAnyAuthority("sys:log") // /log资源路径 必须拥有sys:log角色才可访问</span>                <span class="token comment">//选择的匹配规则</span>                <span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token comment">//所有请求都需要登录认证才可以访问</span>                <span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                                <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">sessionManagement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//启用session管理</span>                <span class="token punctuation">.</span><span class="token function">maximumSessions</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token comment">//允许一个账号你个人同时登录，也就是一个session可以几个人同时使用</span>                <span class="token punctuation">.</span><span class="token function">maxSessionsPreventsLogin</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token comment">//false：当登录时，其它登录的登录的地方会被踢下线;true ：当有用户在登录时不允许登录</span>                <span class="token punctuation">.</span><span class="token function">expiredSessionStrategy</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CustomExpiredSessionStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//session超时，被踢下线的自定义操作</span>        <span class="token comment">//.authorizeHttpRequests()   这样方法表示选中的请求</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 授权方法     * @param auth     * @throws Exception     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationManagerBuilder</span> auth<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>                auth  <span class="token comment">//授权</span>                <span class="token punctuation">.</span><span class="token function">inMemoryAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">//将这种用户添加到内存中登录认证，   还有其他类型的授权登录认证方法，比如数据库的登录认证</span>                <span class="token punctuation">.</span><span class="token function">withUser</span><span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">)</span>  <span class="token comment">//用户名</span>                <span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token string">"123456"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">//密码</span>                <span class="token punctuation">.</span><span class="token function">roles</span><span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">)</span>  <span class="token comment">//设置使用该用户名登录赋予的角色，</span>            <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                 <span class="token punctuation">.</span><span class="token function">withUser</span><span class="token punctuation">(</span><span class="token string">"admin"</span><span class="token punctuation">)</span> <span class="token comment">//用户名</span>                 <span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token string">"123456"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                   <span class="token comment">//第一种授权方式</span>                 <span class="token punctuation">.</span><span class="token function">roles</span><span class="token punctuation">(</span><span class="token string">"admin"</span><span class="token punctuation">)</span>  <span class="token comment">//设置使用该账号登录赋予的角色</span>                   <span class="token comment">//第二种授权方式</span>                 <span class="token comment">//.authorities("sys:log","sys:user") //为当前用户赋予角色</span>            <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                  <span class="token punctuation">.</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//配置BCrypt加密，这个会自动调用matches（）这个方法来为我们输入的密码进行对比</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Bean</span>    <span class="token keyword">public</span> <span class="token class-name">PasswordEncoder</span> <span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 静态资源路径开放     * @param web     * @throws Exception     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">WebSecurity</span> web<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>        <span class="token comment">//将项目中的静态资源路径开放出来，在这开放是不需要经过过滤器拦截的</span>        web<span class="token punctuation">.</span><span class="token function">ignoring</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/css/**"</span><span class="token punctuation">,</span><span class="token string">"/fonts/**"</span><span class="token punctuation">,</span><span class="token string">"/img/**"</span><span class="token punctuation">,</span><span class="token string">"/js/**"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="RBAC权限管理控制模型"><a href="#RBAC权限管理控制模型" class="headerlink" title="RBAC权限管理控制模型"></a><strong>RBAC权限管理控制模型</strong></h2><p><img src="https://s2.loli.net/2022/03/09/tsqKGbhigTXQwOS.png" alt="image-20220307195430369"></p><p><img src="https://s2.loli.net/2022/03/09/eFplaSkOnAr2TCc.png" alt="image-20220307195418619"></p><h2 id="动态加载用户角色权限数据："><a href="#动态加载用户角色权限数据：" class="headerlink" title="动态加载用户角色权限数据："></a>动态加载用户角色权限数据：</h2><p>首先我们需要实现两个类，一个是UserDetails，还有个是UserDetailsService</p><p>UserDetails ：这个接口为的是存放用户详细信息，</p><p>UserDetailsService：为加载用户的信息填写到UserDetails 中并返回给Security使用</p><h3 id="UserDetails："><a href="#UserDetails：" class="headerlink" title="UserDetails："></a><strong>UserDetails：</strong></h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 用于获取用户详细信息， * 需要使用UserDetailsService为当前类绑定信息； * 还需要手动创建set方法赋值，已经创建对应的属性存值 */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyUserDetails</span> <span class="token keyword">implements</span> <span class="token class-name">UserDetails</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">GrantedAuthority</span><span class="token punctuation">&gt;</span></span> authorities<span class="token punctuation">;</span>  <span class="token comment">//用户的权限集合</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> password<span class="token punctuation">;</span> <span class="token comment">//密码</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> username<span class="token punctuation">;</span> <span class="token comment">//用户名</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setAuthorities</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">GrantedAuthority</span><span class="token punctuation">&gt;</span></span> authorities<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>authorities <span class="token operator">=</span> authorities<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token class-name">String</span> password<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>password <span class="token operator">=</span> password<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setUsername</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>username <span class="token operator">=</span> username<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setAccountNonExpired</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> accountNonExpired<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>accountNonExpired <span class="token operator">=</span> accountNonExpired<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setAccountNonLocked</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> accountNonLocked<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>accountNonLocked <span class="token operator">=</span> accountNonLocked<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setCredentialsNonExpired</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> credentialsNonExpired<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>credentialsNonExpired <span class="token operator">=</span> credentialsNonExpired<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setEnabled</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> enabled<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>enabled <span class="token operator">=</span> enabled<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">boolean</span> accountNonExpired<span class="token punctuation">;</span> <span class="token comment">//账号是否没过期</span>    <span class="token keyword">private</span> <span class="token keyword">boolean</span> accountNonLocked<span class="token punctuation">;</span> <span class="token comment">//账号是否没被锁定</span>    <span class="token keyword">private</span> <span class="token keyword">boolean</span> credentialsNonExpired<span class="token punctuation">;</span>  <span class="token comment">//用户凭证是否没过期    or 密码是否过期</span>    <span class="token keyword">private</span> <span class="token keyword">boolean</span> enabled<span class="token punctuation">;</span>  <span class="token comment">//账户是否可用</span>    <span class="token comment">/**     * 获取用户的权限集合     * @return     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">GrantedAuthority</span><span class="token punctuation">&gt;</span></span> <span class="token function">getAuthorities</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> authorities<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 获取密码     * @return     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> password<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 获取用户名     * @return     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> username<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 账号是否没过期     *     * @return  这里由于我数据库没加这个字段就默认为true了     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isAccountNonExpired</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 账号是否没被锁定     *     * @return  这里由于我数据库没加这个字段就默认为true了     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isAccountNonLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 密码是否没过期     *     * @return  这里由于我数据库没加这个字段就默认为true了     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isCredentialsNonExpired</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 账户是否可用     * @return     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> enabled<span class="token punctuation">;</span>    <span class="token punctuation">}</span>         <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">Object</span> o<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">==</span> o<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>o <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> o<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token class-name">MyUserDetails</span> that <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">MyUserDetails</span><span class="token punctuation">)</span> o<span class="token punctuation">;</span>        <span class="token keyword">return</span> accountNonExpired <span class="token operator">==</span> that<span class="token punctuation">.</span>accountNonExpired <span class="token operator">&amp;&amp;</span> accountNonLocked <span class="token operator">==</span> that<span class="token punctuation">.</span>accountNonLocked <span class="token operator">&amp;&amp;</span> credentialsNonExpired <span class="token operator">==</span> that<span class="token punctuation">.</span>credentialsNonExpired <span class="token operator">&amp;&amp;</span> enabled <span class="token operator">==</span> that<span class="token punctuation">.</span>enabled <span class="token operator">&amp;&amp;</span> <span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>authorities<span class="token punctuation">,</span> that<span class="token punctuation">.</span>authorities<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>    <span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> that<span class="token punctuation">.</span>password<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> that<span class="token punctuation">.</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span>authorities<span class="token punctuation">,</span> password<span class="token punctuation">,</span> username<span class="token punctuation">,</span> accountNonExpired<span class="token punctuation">,</span> accountNonLocked<span class="token punctuation">,</span> credentialsNonExpired<span class="token punctuation">,</span> enabled<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="UserDetailsService："><a href="#UserDetailsService：" class="headerlink" title="UserDetailsService："></a>UserDetailsService：</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 用于加载UserDetails中的详细信息 * 为替换掉security配置类中的静态授权 */</span><span class="token annotation punctuation">@Component</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyUserDetailsService</span> <span class="token keyword">implements</span> <span class="token class-name">UserDetailsService</span> <span class="token punctuation">{</span>    <span class="token comment">//这里三个查询其实可以放一起的，毕竟都是查询用户权限的</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">private</span> <span class="token class-name">UserMapper</span> userMapper<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">private</span> <span class="token class-name">RoleMapper</span> roleMapper<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">private</span> <span class="token class-name">MenuMapper</span> menuMapper<span class="token punctuation">;</span>    <span class="token comment">/**     *  使用传入的唯一标识（username） 查询用户信息，并组装成为UserDetails类返回，返回后security就会拿到哪些数据并进行验证     *     *  动态添加security认证，鉴权，授权相关的基础信息     *     * @param username  用户输入的账户，也就是security配置类中的 .usernameParameter("user")     * @return     * @throws UsernameNotFoundException     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">UserDetails</span> <span class="token function">loadUserByUsername</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">UsernameNotFoundException</span> <span class="token punctuation">{</span>        <span class="token class-name">MyUserDetails</span> myUserDetails <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyUserDetails</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">//获取用户基本信息</span>        <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token class-name"><span class="token namespace">userMapper<span class="token punctuation">.</span></span>UserFiend</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UsernameNotFoundException</span><span class="token punctuation">(</span><span class="token string">"用户不存在"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        myUserDetails<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        myUserDetails<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        myUserDetails<span class="token punctuation">.</span><span class="token function">setEnabled</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">isEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">//查询用户角色,赋予用户角色，我们需要在角色前加上 ROLE_</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> roleMapper<span class="token punctuation">.</span><span class="token function">listByUserId</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Role</span> role <span class="token operator">=</span> roleMapper<span class="token punctuation">.</span><span class="token function">fiendByUserId</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//在每个元素前加上ROLE_，获取角色</span>        list<span class="token operator">=</span>list<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>rc<span class="token operator">-&gt;</span> <span class="token string">"ROLE_"</span> <span class="token operator">+</span>rc<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//根据角色获取解释对应的权限，这个是只获取要权限的页面</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> list1 <span class="token operator">=</span> menuMapper<span class="token punctuation">.</span><span class="token function">listByRoleId</span><span class="token punctuation">(</span>role<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//将角色与要权限的页面绑定</span>        list1<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">//这一步就如同为角色赋予权限</span>        myUserDetails<span class="token punctuation">.</span><span class="token function">setAuthorities</span><span class="token punctuation">(</span>                <span class="token comment">//由于List不能直接赋值给Authorities 所有使用AuthorityUtils.commaSeparatedStringToAuthorityList()来解决</span>                <span class="token class-name">AuthorityUtils</span><span class="token punctuation">.</span><span class="token function">commaSeparatedStringToAuthorityList</span><span class="token punctuation">(</span>                        <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">,</span>list1<span class="token punctuation">)</span>  <span class="token comment">//将授权页面与角色用逗号分开</span>                <span class="token punctuation">)</span>        <span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//返回当前用户的登录授权信息，交给iSecurity</span>        <span class="token keyword">return</span> myUserDetails<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="修改Security配置类："><a href="#修改Security配置类：" class="headerlink" title="修改Security配置类："></a>修改Security配置类：</h3><p>注意：这里由于一些我也不知道的问题，这里的同账户登录多人不会被踢下线</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecurityConfig</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token punctuation">{</span>    <span class="token comment">//将我们自定义的这两个类使用IOC容器装配</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">private</span> <span class="token class-name">MyAuthenticationSuccessHandler</span> myAuthenticationSuccessHandler<span class="token punctuation">;</span>  <span class="token comment">//登录成功处理</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">private</span> <span class="token class-name">MyAuthenticationFailureHandler</span> myAuthenticationFailureHandler<span class="token punctuation">;</span>  <span class="token comment">//登录失败处理</span>    <span class="token comment">//导入自定义动态授权</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">private</span> <span class="token class-name">MyUserDetailsService</span> myUserDetailsService<span class="token punctuation">;</span>    <span class="token comment">/**     * 登录认证方法     * @param http     * @throws Exception     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>        <span class="token comment">//开启httpBasic认证</span><span class="token comment">//        http.httpBasic()</span><span class="token comment">//                .and()</span><span class="token comment">//                //所有的请求</span><span class="token comment">//                .authorizeHttpRequests()</span><span class="token comment">//                //匹配规则</span><span class="token comment">//                .anyRequest()</span><span class="token comment">//                //所有请求都需要登录认证才可以访问</span><span class="token comment">//                .authenticated();</span><span class="token comment">//_______________________________________________________________________________________________________-</span>        <span class="token comment">//开启formLogin登录认证</span>        <span class="token comment">//关闭防御csrf攻击</span>        http<span class="token punctuation">.</span><span class="token function">csrf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">formLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//开启formLogin登录认证</span>                <span class="token punctuation">.</span><span class="token function">loginPage</span><span class="token punctuation">(</span><span class="token string">"/logins"</span><span class="token punctuation">)</span>    <span class="token comment">//用于选择登录页面，没认证时跳转的页面</span>                <span class="token punctuation">.</span><span class="token function">loginProcessingUrl</span><span class="token punctuation">(</span><span class="token string">"/login"</span><span class="token punctuation">)</span>   <span class="token comment">//选择需要认证的请求，也就是登录表单的提交地址</span>                <span class="token punctuation">.</span><span class="token function">usernameParameter</span><span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">)</span>   <span class="token comment">//选择登录请求的哪个参数是用户名</span>                <span class="token punctuation">.</span><span class="token function">passwordParameter</span><span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">)</span>   <span class="token comment">//选择登录请求的哪个参数是密码</span>                <span class="token comment">//使用自定义的登录失败成功处理方法</span>                <span class="token punctuation">.</span><span class="token function">successHandler</span><span class="token punctuation">(</span>myAuthenticationSuccessHandler<span class="token punctuation">)</span>  <span class="token comment">//登录成功</span>                <span class="token punctuation">.</span><span class="token function">failureHandler</span><span class="token punctuation">(</span>myAuthenticationFailureHandler<span class="token punctuation">)</span>  <span class="token comment">//登录失败</span>                <span class="token comment">//这两会与我们自定义的冲突想要使用自定义的就不能使用这个</span><span class="token comment">//                .defaultSuccessUrl("/")   //登录成功跳转的路径</span><span class="token comment">//                .failureForwardUrl("/logins")  //登录失败跳转的路径</span>             <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//自定义过滤拦截请求</span>                <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/logins"</span><span class="token punctuation">,</span><span class="token string">"/login"</span><span class="token punctuation">,</span><span class="token string">"/"</span><span class="token punctuation">)</span> <span class="token comment">//资源路径</span>                <span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">//当前资源路径不需要认证就可以访问</span>                <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/business1"</span><span class="token punctuation">,</span><span class="token string">"/business2"</span><span class="token punctuation">)</span><span class="token comment">//资源路径</span>                <span class="token punctuation">.</span><span class="token function">hasAnyAuthority</span><span class="token punctuation">(</span><span class="token string">"ROLE_user"</span><span class="token punctuation">,</span><span class="token string">"ROLE_admin"</span><span class="token punctuation">)</span><span class="token comment">//设置可以访问的角色,user角色和admin角色都可以访问</span>                    <span class="token comment">//访问角色控制方式1  与授权方法1一起使用</span>                <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/log"</span><span class="token punctuation">,</span><span class="token string">"/user"</span><span class="token punctuation">)</span><span class="token comment">//资源路径</span>                <span class="token punctuation">.</span><span class="token function">hasRole</span><span class="token punctuation">(</span><span class="token string">"admin"</span><span class="token punctuation">)</span><span class="token comment">//设置可以访问的角色，和hasAnyAuthority作用相同，但hasAnyAuthority可以设置多个，并且需要加前缀ROLE_</span>                                <span class="token comment">//选择的匹配规则</span>                <span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token comment">//所有请求都需要登录认证才可以访问</span>                <span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">sessionManagement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//启用session管理</span>                <span class="token punctuation">.</span><span class="token function">maximumSessions</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token comment">//允许一个账号你个人同时登录，也就是一个session可以几个人同时使用</span>                <span class="token punctuation">.</span><span class="token function">maxSessionsPreventsLogin</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token comment">//false：当登录时，其它登录的登录的地方会被踢下线;true ：当有用户在登录时不允许登录</span>                <span class="token punctuation">.</span><span class="token function">expiredSessionStrategy</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CustomExpiredSessionStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//session超时，被踢下线的自定义操作</span>        <span class="token comment">//.authorizeHttpRequests()   这样方法表示选中的请求</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 授权方法     * @param auth     * @throws Exception     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationManagerBuilder</span> auth<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>        <span class="token comment">//____________________静态授权________________________</span><span class="token comment">//                auth  //授权</span><span class="token comment">//                .inMemoryAuthentication()  //将这种用户添加到内存中登录认证，   还有其他类型的授权登录认证方法，比如数据库的登录认证</span><span class="token comment">//                .withUser("user")  //用户名</span><span class="token comment">//                .password(passwordEncoder().encode("123456"))  //密码</span><span class="token comment">//                .roles("user")  //设置使用该用户名登录赋予的角色，</span><span class="token comment">//            .and()</span><span class="token comment">//                 .withUser("admin") //用户名</span><span class="token comment">//                 .password(passwordEncoder().encode("123456"))</span><span class="token comment">//                   //第一种授权方式</span><span class="token comment">//                 .roles("admin")  //设置使用该账号登录赋予的角色</span><span class="token comment">//                   //第二种授权方式</span><span class="token comment">//                 //.authorities("sys:log","sys:user") //</span>        <span class="token comment">//________________ 动态授权，需要实现UserDetailsService____________________________</span>            auth<span class="token punctuation">.</span><span class="token function">userDetailsService</span><span class="token punctuation">(</span>myUserDetailsService<span class="token punctuation">)</span>                  <span class="token punctuation">.</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//配置BCrypt加密，这个会自动调用matches（）这个方法来为我们输入的密码进行对比</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Bean</span>    <span class="token keyword">public</span> <span class="token class-name">PasswordEncoder</span> <span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 静态资源路径开放     * @param web     * @throws Exception     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">WebSecurity</span> web<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>        <span class="token comment">//将项目中的静态资源路径开放出来，在这开放是不需要经过过滤器拦截的</span>        web<span class="token punctuation">.</span><span class="token function">ignoring</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/css/**"</span><span class="token punctuation">,</span><span class="token string">"/fonts/**"</span><span class="token punctuation">,</span><span class="token string">"/img/**"</span><span class="token punctuation">,</span><span class="token string">"/js/**"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="动态鉴权规则："><a href="#动态鉴权规则：" class="headerlink" title="动态鉴权规则："></a><strong>动态鉴权规则：</strong></h2><p>用于代替静态的鉴权规则</p><h5 id="自定义鉴权规则："><a href="#自定义鉴权规则：" class="headerlink" title="自定义鉴权规则："></a>自定义鉴权规则：</h5><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 动态判断用户是否用于访问页面的权限，类名可以随便取 */</span><span class="token annotation punctuation">@Component</span><span class="token punctuation">(</span><span class="token string">"MyRBACService"</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyRBACService</span> <span class="token punctuation">{</span>    <span class="token comment">/**     * 用于验证当前用户，是否能访问当前请求的资格与权限     * @param request 请求     * @param authentication  通过认证的用户主体详细信息     * @return 有权限返回true ，没权限返回false     */</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">hasPermission</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">Authentication</span> authentication<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token comment">//获取主体信息UserDetails</span>        <span class="token class-name">Object</span> principal <span class="token operator">=</span> authentication<span class="token punctuation">.</span><span class="token function">getPrincipal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//判断principal是否是UserDetails</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>principal <span class="token keyword">instanceof</span> <span class="token class-name">UserDetails</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token class-name">UserDetails</span> userDetails <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">UserDetails</span><span class="token punctuation">)</span> principal<span class="token punctuation">;</span>            <span class="token comment">//将获取到的这一次请求的资源路径转换为SimpleGrantedAuthority类型，</span>            <span class="token comment">// 因为UserDetails中Authorities存放用户权限的类型是SimpleGrantedAuthority类型</span>            <span class="token class-name">SimpleGrantedAuthority</span> simpleGrantedAuthority <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleGrantedAuthority</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getRequestURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//判断当前用户的权限中是发拥有可以访问这个资源路径的权限</span>            <span class="token comment">// contains这个方法是用于判断当前集合是否有相同的</span>            <span class="token keyword">return</span> userDetails<span class="token punctuation">.</span><span class="token function">getAuthorities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>simpleGrantedAuthority<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="Security配置类："><a href="#Security配置类：" class="headerlink" title="Security配置类："></a>Security配置类：</h5><p>这里使用动态鉴权规则后就不能使用静态授权，因为静态授权只是当前授权了角色，但角色的权限是没有配置的，我们可以看到动态鉴权是直接对当前当前用户角色可以访问的权限进行对比的，静态的只有单纯的角色，但角色是什么权限都没有的</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecurityConfig</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token punctuation">{</span>    <span class="token comment">//将我们自定义的这两个类使用IOC容器装配</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">private</span> <span class="token class-name">MyAuthenticationSuccessHandler</span> myAuthenticationSuccessHandler<span class="token punctuation">;</span>  <span class="token comment">//登录成功处理</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">private</span> <span class="token class-name">MyAuthenticationFailureHandler</span> myAuthenticationFailureHandler<span class="token punctuation">;</span>  <span class="token comment">//登录失败处理</span>    <span class="token comment">//导入自定义动态授权</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">private</span> <span class="token class-name">MyUserDetailsService</span> myUserDetailsService<span class="token punctuation">;</span>    <span class="token comment">/**     * 登录认证方法     * @param http     * @throws Exception     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>        <span class="token comment">//开启httpBasic认证</span><span class="token comment">//        http.httpBasic()</span><span class="token comment">//                .and()</span><span class="token comment">//                //所有的请求</span><span class="token comment">//                .authorizeHttpRequests()</span><span class="token comment">//                //匹配规则</span><span class="token comment">//                .anyRequest()</span><span class="token comment">//                //所有请求都需要登录认证才可以访问</span><span class="token comment">//                .authenticated();</span><span class="token comment">//_______________________________________________________________________________________________________-</span>        <span class="token comment">//开启formLogin登录认证</span>        <span class="token comment">//关闭防御csrf攻击</span>        http<span class="token punctuation">.</span><span class="token function">csrf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">formLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//开启formLogin登录认证</span>                <span class="token punctuation">.</span><span class="token function">loginPage</span><span class="token punctuation">(</span><span class="token string">"/logins"</span><span class="token punctuation">)</span>    <span class="token comment">//用于选择登录页面，没认证时跳转的页面</span>                <span class="token punctuation">.</span><span class="token function">loginProcessingUrl</span><span class="token punctuation">(</span><span class="token string">"/login"</span><span class="token punctuation">)</span>   <span class="token comment">//选择需要认证的请求，也就是登录表单的提交地址</span>                <span class="token punctuation">.</span><span class="token function">usernameParameter</span><span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">)</span>   <span class="token comment">//选择登录请求的哪个参数是用户名</span>                <span class="token punctuation">.</span><span class="token function">passwordParameter</span><span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">)</span>   <span class="token comment">//选择登录请求的哪个参数是密码</span>                <span class="token comment">//使用自定义的登录失败成功处理方法</span>                <span class="token punctuation">.</span><span class="token function">successHandler</span><span class="token punctuation">(</span>myAuthenticationSuccessHandler<span class="token punctuation">)</span>  <span class="token comment">//登录成功</span>                <span class="token punctuation">.</span><span class="token function">failureHandler</span><span class="token punctuation">(</span>myAuthenticationFailureHandler<span class="token punctuation">)</span>  <span class="token comment">//登录失败</span>                <span class="token comment">//这两会与我们自定义的冲突想要使用自定义的就不能使用这个</span><span class="token comment">//                .defaultSuccessUrl("/")   //登录成功跳转的路径</span><span class="token comment">//                .failureForwardUrl("/logins")  //登录失败跳转的路径</span>             <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//自定义过滤拦截请求</span>                <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/logins"</span><span class="token punctuation">,</span><span class="token string">"/login"</span><span class="token punctuation">,</span><span class="token string">"/"</span><span class="token punctuation">)</span> <span class="token comment">//资源路径</span>                <span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">//当前资源路径不需要认证就可以访问</span>                <span class="token comment">//____________________静态鉴权____________________________________</span><span class="token comment">//                .antMatchers("/business1","/business2")//资源路径</span><span class="token comment">//                .hasAnyAuthority("ROLE_user","ROLE_admin")//设置可以访问的角色,user角色和admin角色都可以访问</span><span class="token comment">//</span><span class="token comment">//                    //访问角色控制方式1  与授权方法1一起使用</span><span class="token comment">//                .antMatchers("/log","/user")//资源路径</span><span class="token comment">//                .hasRole("admin")//设置可以访问的角色，和hasAnyAuthority作用相同，但hasAnyAuthority可以设置多个，并且需要加前缀ROLE_</span><span class="token comment">//</span><span class="token comment">//                    //访问角色控制方式2  与授权方法2一起使用  这里由于它不是admin角色了，所有访问业务1业务2访问不了但可以修改一下</span><span class="token comment">////                .antMatchers("/user").hasAnyAuthority("sys:user")  // /user资源路径 必须拥有sys:user角色才可访问</span><span class="token comment">////                .antMatchers("/log").hasAnyAuthority("sys:log") // /log资源路径 必须拥有sys:log角色才可访问</span><span class="token comment">//                //选择的匹配规则</span><span class="token comment">//                .anyRequest()</span><span class="token comment">//                //所有请求都需要登录认证才可以访问</span><span class="token comment">//                .authenticated()</span>                <span class="token comment">//______________________________动态图鉴权_____________________________________________</span>                    <span class="token comment">//所有的请求都有经过MyRBACService的hasPermission方法进行鉴权 返回true可以访问，返回false不允许访问</span>                    <span class="token comment">//anyRequest  所有的请求</span>                    <span class="token comment">//access   访问权限</span>                    <span class="token operator">/</span>里面使用<span class="token class-name">SpEL</span>权限表达式                <span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">access</span><span class="token punctuation">(</span><span class="token string">"@MyRBACService.hasPermission(request,authentication)"</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">sessionManagement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//启用session管理</span>                <span class="token punctuation">.</span><span class="token function">maximumSessions</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token comment">//允许一个账号你个人同时登录，也就是一个session可以几个人同时使用</span>                <span class="token punctuation">.</span><span class="token function">maxSessionsPreventsLogin</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token comment">//false：当登录时，其它登录的登录的地方会被踢下线;true ：当有用户在登录时不允许登录</span>                <span class="token punctuation">.</span><span class="token function">expiredSessionStrategy</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CustomExpiredSessionStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//session超时，被踢下线的自定义操作</span>        <span class="token comment">//.authorizeHttpRequests()   这样方法表示选中的请求</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 授权方法     * @param auth     * @throws Exception     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationManagerBuilder</span> auth<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>        <span class="token comment">//____________________静态授权________________________</span><span class="token comment">//                auth  //授权</span><span class="token comment">//                .inMemoryAuthentication()  //将这种用户添加到内存中登录认证，   还有其他类型的授权登录认证方法，比如数据库的登录认证</span><span class="token comment">//                .withUser("user")  //用户名</span><span class="token comment">//                .password(passwordEncoder().encode("123456"))  //密码</span><span class="token comment">//                .roles("user")  //设置使用该用户名登录赋予的角色，</span><span class="token comment">//            .and()</span><span class="token comment">//                 .withUser("admin") //用户名</span><span class="token comment">//                 .password(passwordEncoder().encode("123456"))</span><span class="token comment">//                   //第一种授权方式</span><span class="token comment">//                 .roles("admin")  //设置使用该账号登录赋予的角色</span><span class="token comment">//                   //第二种授权方式</span><span class="token comment">//                 //.authorities("sys:log","sys:user") //</span><span class="token comment">//                    .and().passwordEncoder(passwordEncoder()); //配置BCrypt加密，这个会自动调用matches（）这个方法来为我们输入的密码进行对比</span>        <span class="token comment">//________________ 动态授权，需要实现UserDetailsService____________________________</span>            auth<span class="token punctuation">.</span><span class="token function">userDetailsService</span><span class="token punctuation">(</span>myUserDetailsService<span class="token punctuation">)</span>                  <span class="token punctuation">.</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//配置BCrypt加密，这个会自动调用matches（）这个方法来为我们输入的密码进行对比</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Bean</span>    <span class="token keyword">public</span> <span class="token class-name">PasswordEncoder</span> <span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 静态资源路径开放     * @param web     * @throws Exception     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">WebSecurity</span> web<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>        <span class="token comment">//将项目中的静态资源路径开放出来，在这开放是不需要经过过滤器拦截的</span>        web<span class="token punctuation">.</span><span class="token function">ignoring</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/css/**"</span><span class="token punctuation">,</span><span class="token string">"/fonts/**"</span><span class="token punctuation">,</span><span class="token string">"/img/**"</span><span class="token punctuation">,</span><span class="token string">"/js/**"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="方法增强注解："><a href="#方法增强注解：" class="headerlink" title="方法增强注解："></a>方法增强注解：</h5><p><img src="https://s2.loli.net/2022/03/09/wSlBCNefJyq2sxP.png" alt="image-20220308200231990"></p><p><strong>@PreAuthorize(“SPEL”):  方法执行前判断用户调用权限</strong></p><p><img src="https://s2.loli.net/2022/03/09/37T2DwRsaM96zSh.png" alt="image-20220308200604674"></p><p><strong>@PreFilter(“SPEL”):方法执行前过滤参数</strong></p><p><img src="https://s2.loli.net/2022/03/09/QNLUZrw7TIMDj5P.png" alt="image-20220308200655277"></p><p><strong>@PostAuthorize(“SPEL”):方法执行后判断</strong></p><p><img src="https://s2.loli.net/2022/03/09/IYaygrwcXiAqV7v.png" alt="image-20220308200824019"></p><p><strong>@PostFilter（”SPEL“） ： 方法执行完后过滤返回值</strong></p><p><img src="https://s2.loli.net/2022/03/09/Hw7KEVztY8FCk52.png" alt="image-20220308200910568"></p><p><strong>在Security配置类中开启这个是个注解的使用：</strong></p><p><img src="https://s2.loli.net/2022/03/09/iwQUNd5Rg3phnHk.png" alt="image-20220308200954913"></p><h2 id="记住我功能："><a href="#记住我功能：" class="headerlink" title="记住我功能："></a>记住我功能：</h2><p>这个配置使用十分的简单</p><p><img src="https://s2.loli.net/2022/03/21/I4d1MPALWe8Qumq.png" alt="image-20220309223842857"></p><h5 id="Security配置类"><a href="#Security配置类" class="headerlink" title="Security配置类:"></a>Security配置类:</h5><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecurityConfig</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token punctuation">{</span>    <span class="token comment">//将我们自定义的这两个类使用IOC容器装配</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">private</span> <span class="token class-name">MyAuthenticationSuccessHandler</span> myAuthenticationSuccessHandler<span class="token punctuation">;</span>  <span class="token comment">//登录成功处理</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">private</span> <span class="token class-name">MyAuthenticationFailureHandler</span> myAuthenticationFailureHandler<span class="token punctuation">;</span>  <span class="token comment">//登录失败处理</span>    <span class="token comment">//导入自定义动态授权</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">private</span> <span class="token class-name">MyUserDetailsService</span> myUserDetailsService<span class="token punctuation">;</span>    <span class="token comment">/**     * 登录认证方法     * @param http     * @throws Exception     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>        <span class="token comment">//开启httpBasic认证</span><span class="token comment">//        http.httpBasic()</span><span class="token comment">//                .and()</span><span class="token comment">//                //所有的请求</span><span class="token comment">//                .authorizeHttpRequests()</span><span class="token comment">//                //匹配规则</span><span class="token comment">//                .anyRequest()</span><span class="token comment">//                //所有请求都需要登录认证才可以访问</span><span class="token comment">//                .authenticated();</span><span class="token comment">//_______________________________________________________________________________________________________-</span>        <span class="token comment">//开启formLogin登录认证</span>        http<span class="token punctuation">.</span><span class="token function">rememberMe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//开启记住我功能  ，前端也需要有记住我字段</span>                <span class="token punctuation">.</span><span class="token function">rememberMeCookieName</span><span class="token punctuation">(</span><span class="token string">"rememberMe-Cookie"</span><span class="token punctuation">)</span>  <span class="token comment">//存在浏览器中cookie的名称</span>                <span class="token punctuation">.</span><span class="token function">rememberMeParameter</span><span class="token punctuation">(</span><span class="token string">"remember-me"</span><span class="token punctuation">)</span>  <span class="token comment">//表单中 自动登录 勾选框的参数名</span>                <span class="token punctuation">.</span><span class="token function">tokenValiditySeconds</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">*</span><span class="token number">24</span><span class="token operator">*</span><span class="token number">60</span><span class="token operator">*</span><span class="token number">60</span><span class="token punctuation">)</span> <span class="token comment">//保存Cookie的有效期，默认2周</span>                <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">csrf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">//关闭防御csrf攻击</span>                <span class="token punctuation">.</span><span class="token function">formLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//开启formLogin登录认证</span>                <span class="token punctuation">.</span><span class="token function">loginPage</span><span class="token punctuation">(</span><span class="token string">"/logins"</span><span class="token punctuation">)</span>    <span class="token comment">//用于选择登录页面，没认证时跳转的页面</span>                <span class="token punctuation">.</span><span class="token function">loginProcessingUrl</span><span class="token punctuation">(</span><span class="token string">"/login"</span><span class="token punctuation">)</span>   <span class="token comment">//选择需要认证的请求，也就是登录表单的提交地址</span>                <span class="token punctuation">.</span><span class="token function">usernameParameter</span><span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">)</span>   <span class="token comment">//选择登录请求的哪个参数是用户名</span>                <span class="token punctuation">.</span><span class="token function">passwordParameter</span><span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">)</span>   <span class="token comment">//选择登录请求的哪个参数是密码</span>                <span class="token comment">//使用自定义的登录失败成功处理方法</span>                <span class="token punctuation">.</span><span class="token function">successHandler</span><span class="token punctuation">(</span>myAuthenticationSuccessHandler<span class="token punctuation">)</span>  <span class="token comment">//登录成功</span>                <span class="token punctuation">.</span><span class="token function">failureHandler</span><span class="token punctuation">(</span>myAuthenticationFailureHandler<span class="token punctuation">)</span>  <span class="token comment">//登录失败</span>                <span class="token comment">//这两会与我们自定义的冲突想要使用自定义的就不能使用这个</span><span class="token comment">//                .defaultSuccessUrl("/")   //登录成功跳转的路径</span><span class="token comment">//                .failureForwardUrl("/logins")  //登录失败跳转的路径</span>             <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//自定义过滤拦截请求</span>                <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/logins"</span><span class="token punctuation">,</span><span class="token string">"/login"</span><span class="token punctuation">,</span><span class="token string">"/"</span><span class="token punctuation">)</span> <span class="token comment">//资源路径</span>                <span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">//当前资源路径不需要认证就可以访问</span>                <span class="token comment">//______________________________动态图鉴权_____________________________________________</span>                    <span class="token comment">//所有的请求都有经过MyRBACService的hasPermission方法进行鉴权 返回true可以访问，返回false不允许访问</span>                <span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">access</span><span class="token punctuation">(</span><span class="token string">"@MyRBACService.hasPermission(request,authentication)"</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">sessionManagement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//启用session管理</span>                <span class="token punctuation">.</span><span class="token function">maximumSessions</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token comment">//允许一个账号你个人同时登录，也就是一个session可以几个人同时使用</span>                <span class="token punctuation">.</span><span class="token function">maxSessionsPreventsLogin</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token comment">//false：当登录时，其它登录的登录的地方会被踢下线;true ：当有用户在登录时不允许登录</span>                <span class="token punctuation">.</span><span class="token function">expiredSessionStrategy</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CustomExpiredSessionStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//session超时，被踢下线的自定义操作</span>        <span class="token comment">//.authorizeHttpRequests()   这样方法表示选中的请求</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 授权方法     * @param auth     * @throws Exception     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationManagerBuilder</span> auth<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>        <span class="token comment">//________________ 动态授权，需要实现UserDetailsService____________________________</span>            auth<span class="token punctuation">.</span><span class="token function">userDetailsService</span><span class="token punctuation">(</span>myUserDetailsService<span class="token punctuation">)</span>                  <span class="token punctuation">.</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//配置BCrypt加密，这个会自动调用matches（）这个方法来为我们输入的密码进行对比</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Bean</span>    <span class="token keyword">public</span> <span class="token class-name">PasswordEncoder</span> <span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 静态资源路径开放     * @param web     * @throws Exception     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">WebSecurity</span> web<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>        <span class="token comment">//将项目中的静态资源路径开放出来，在这开放是不需要经过过滤器拦截的</span>        web<span class="token punctuation">.</span><span class="token function">ignoring</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/css/**"</span><span class="token punctuation">,</span><span class="token string">"/fonts/**"</span><span class="token punctuation">,</span><span class="token string">"/img/**"</span><span class="token punctuation">,</span><span class="token string">"/js/**"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="前端："><a href="#前端：" class="headerlink" title="前端："></a>前端：</h5><pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://code.jquery.com/jquery-3.0.0.min.js<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>登录<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/login<span class="token punctuation">"</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>post<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>    账号：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>username<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>user<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">&gt;</span></span>    密码：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>button<span class="token punctuation">"</span></span> <span class="token special-attr"><span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value javascript language-javascript"><span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">"</span></span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>登录<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>     记住我<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>checkbox<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>remember-me<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>remember-me<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">    <span class="token keyword">function</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">let</span> username<span class="token operator">=</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"#username"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">let</span> password<span class="token operator">=</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"#password"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">let</span> remember<span class="token operator">=</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"#remember-me"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">prop</span><span class="token punctuation">(</span><span class="token string">"checked"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">alert</span><span class="token punctuation">(</span>remember<span class="token punctuation">)</span>        $<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span><span class="token punctuation">{</span>            <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">"POST"</span><span class="token punctuation">,</span>            <span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token string">"/login"</span><span class="token punctuation">,</span>            <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span>                <span class="token string-property property">"user"</span><span class="token operator">:</span> username<span class="token punctuation">,</span>                <span class="token string-property property">"password"</span><span class="token operator">:</span> password<span class="token punctuation">,</span>                <span class="token string-property property">"remember-me"</span><span class="token operator">:</span>remember            <span class="token punctuation">}</span><span class="token punctuation">,</span>            <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">json</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>              <span class="token keyword">if</span> <span class="token punctuation">(</span>json<span class="token punctuation">.</span>state <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span>                  location<span class="token punctuation">.</span>href<span class="token operator">=</span><span class="token string">"/"</span><span class="token punctuation">;</span>              <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>                  <span class="token function">alert</span><span class="token punctuation">(</span>json<span class="token punctuation">.</span>message<span class="token punctuation">)</span>                  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span>                  location<span class="token punctuation">.</span>href<span class="token operator">=</span><span class="token string">"/logins"</span><span class="token punctuation">;</span>              <span class="token punctuation">}</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span>            <span class="token function-variable function">error</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>勾选记住我登录后会出现remember -me这个cookie</p><p><img src="https://s2.loli.net/2022/03/21/TPBXH6aGkDcMyuN.png" alt="image-20220309224317467"></p><p>其实它是有两层加密，最外层它是使用Base64加密的：</p><p>​                        解码</p><p><img src="https://s2.loli.net/2022/03/21/tgj25RVxHfU8cXq.png" alt="image-20220309224554252"></p><p>密码还使用MD5加密:</p><p>TokenBasedRememberMeServices类源码：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token class-name">String</span> <span class="token function">makeTokenSignature</span><span class="token punctuation">(</span><span class="token keyword">long</span> tokenExpiryTime<span class="token punctuation">,</span> <span class="token class-name">String</span> username<span class="token punctuation">,</span> <span class="token class-name">String</span> password<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token class-name">String</span> data <span class="token operator">=</span> username <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> tokenExpiryTime <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> password <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">try</span> <span class="token punctuation">{</span>        <span class="token class-name">MessageDigest</span> digest <span class="token operator">=</span> <span class="token class-name">MessageDigest</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token string">"MD5"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token class-name">Hex</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>digest<span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchAlgorithmException</span> var7<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"No MD5 algorithm available!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这图进行解释</p><p><img src="https://s2.loli.net/2022/03/21/P15bc6jrSX9aMuU.png" alt="image-20220309224722249"></p><h5 id="个性化配置"><a href="#个性化配置" class="headerlink" title="个性化配置"></a>个性化配置</h5><p><img src="https://s2.loli.net/2022/03/21/GaHOPL49KkQlRyg.png" alt="image-20220309224647471"></p><h2 id="记住我功能将验证数据保存到数据库："><a href="#记住我功能将验证数据保存到数据库：" class="headerlink" title="记住我功能将验证数据保存到数据库："></a>记住我功能将验证数据保存到数据库：</h2><p>我们没使用数据库存储令牌校验，当我们关闭程序时，记住我功能则会失效，客户端有session也没有用，在内存中令牌校验的数据被清空了，</p><p>为了防止重启程序而导致记住我失效，我们将信息存储到数据库中，</p><p>注意：这个存储的不是你的session，你在浏览器删除session那么同样需要重新输入密码，存储到数据库中的是类似令牌校验的信息</p><p><strong>先创建数据库：</strong></p><p>这个表是固定的，不能修改，在提供的类中，有个方法也可以创建，我们这就手动创建了</p><pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">CREATE TABLE `persistent_logins`(`username` varchar (64) NOT NULL,`series` varchar (64) NOT NULL,`token` varchar(64) NOT NULL,`last_used` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,PRIMARY KEY (series))ENGINE=InnoDB DEFAULT CHARSET=utf8;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在Security配置类中注入一个数据源：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Autowired</span><span class="token keyword">private</span> <span class="token class-name">DataSource</span> dataSource<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>再编辑一个bean 指定存储到数据库的操作</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * JdbcTokenRepositoryImpl 这个类是将数据保存到数据操作的类，里面有很多sql语句的，可以自己去看看 * 这个类中已经固定要存到数据库中的哪个表，我们只需要指定数据源即可 * initDao() 这个方法有在数据库中创建需要的表，我还没尝试过，我的表是自己手动创建的 * 设置记住我存储到的数据源是哪个 * @return */</span><span class="token annotation punctuation">@Bean</span><span class="token keyword">public</span> <span class="token class-name">PersistentTokenRepository</span> <span class="token function">tokenRepository</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token class-name">JdbcTokenRepositoryImpl</span> jdbcTokenRepository <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JdbcTokenRepositoryImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    jdbcTokenRepository<span class="token punctuation">.</span><span class="token function">setDataSource</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> jdbcTokenRepository<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>然在告诉security指定使用这个bean</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token punctuation">.</span><span class="token function">rememberMeCookieName</span><span class="token punctuation">(</span><span class="token string">"rememberMe-Cookie"</span><span class="token punctuation">)</span>  <span class="token comment">//存在浏览器中cookie的名称</span><span class="token punctuation">.</span><span class="token function">rememberMeParameter</span><span class="token punctuation">(</span><span class="token string">"remember-me"</span><span class="token punctuation">)</span>  <span class="token comment">//表单中 自动登录 勾选框的参数名</span><span class="token punctuation">.</span><span class="token function">tokenValiditySeconds</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">*</span><span class="token number">24</span><span class="token operator">*</span><span class="token number">60</span><span class="token operator">*</span><span class="token number">60</span><span class="token punctuation">)</span> <span class="token comment">//保存Cookie的有效期，默认2周</span><span class="token punctuation">.</span><span class="token function">tokenRepository</span><span class="token punctuation">(</span><span class="token function">tokenRepository</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">//指定rememberMe存储到数据库规则方法</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>完整配置：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecurityConfig</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token punctuation">{</span>    <span class="token comment">//将我们自定义的这两个类使用IOC容器装配</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">private</span> <span class="token class-name">MyAuthenticationSuccessHandler</span> myAuthenticationSuccessHandler<span class="token punctuation">;</span>  <span class="token comment">//登录成功处理</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">private</span> <span class="token class-name">MyAuthenticationFailureHandler</span> myAuthenticationFailureHandler<span class="token punctuation">;</span>  <span class="token comment">//登录失败处理</span>    <span class="token comment">//导入自定义动态授权</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">private</span> <span class="token class-name">MyUserDetailsService</span> myUserDetailsService<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">private</span> <span class="token class-name">DataSource</span> dataSource<span class="token punctuation">;</span>    <span class="token comment">/**     * 登录认证方法     * @param http     * @throws Exception     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>        <span class="token comment">//开启formLogin登录认证</span>        http<span class="token punctuation">.</span><span class="token function">rememberMe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//开启记住我功能  ，前端也需要有记住我字段</span>                <span class="token punctuation">.</span><span class="token function">rememberMeCookieName</span><span class="token punctuation">(</span><span class="token string">"rememberMe-Cookie"</span><span class="token punctuation">)</span>  <span class="token comment">//存在浏览器中cookie的名称</span>                <span class="token punctuation">.</span><span class="token function">rememberMeParameter</span><span class="token punctuation">(</span><span class="token string">"remember-me"</span><span class="token punctuation">)</span>  <span class="token comment">//表单中 自动登录 勾选框的参数名</span>                <span class="token punctuation">.</span><span class="token function">tokenValiditySeconds</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">*</span><span class="token number">24</span><span class="token operator">*</span><span class="token number">60</span><span class="token operator">*</span><span class="token number">60</span><span class="token punctuation">)</span> <span class="token comment">//保存Cookie的有效期，默认2周</span>                <span class="token punctuation">.</span><span class="token function">tokenRepository</span><span class="token punctuation">(</span><span class="token function">tokenRepository</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">//指定rememberMe存储到数据库规则方法</span>                <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">csrf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">//关闭防御csrf攻击</span>                <span class="token punctuation">.</span><span class="token function">formLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//开启formLogin登录认证</span>                <span class="token punctuation">.</span><span class="token function">loginPage</span><span class="token punctuation">(</span><span class="token string">"/logins"</span><span class="token punctuation">)</span>    <span class="token comment">//用于选择登录页面，没认证时跳转的页面</span>                <span class="token punctuation">.</span><span class="token function">loginProcessingUrl</span><span class="token punctuation">(</span><span class="token string">"/login"</span><span class="token punctuation">)</span>   <span class="token comment">//选择需要认证的请求，也就是登录表单的提交地址</span>                <span class="token punctuation">.</span><span class="token function">usernameParameter</span><span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">)</span>   <span class="token comment">//选择登录请求的哪个参数是用户名</span>                <span class="token punctuation">.</span><span class="token function">passwordParameter</span><span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">)</span>   <span class="token comment">//选择登录请求的哪个参数是密码</span>                <span class="token comment">//使用自定义的登录失败成功处理方法</span>                <span class="token punctuation">.</span><span class="token function">successHandler</span><span class="token punctuation">(</span>myAuthenticationSuccessHandler<span class="token punctuation">)</span>  <span class="token comment">//登录成功</span>                <span class="token punctuation">.</span><span class="token function">failureHandler</span><span class="token punctuation">(</span>myAuthenticationFailureHandler<span class="token punctuation">)</span>  <span class="token comment">//登录失败</span>                <span class="token comment">//这两会与我们自定义的冲突想要使用自定义的就不能使用这个</span><span class="token comment">//                .defaultSuccessUrl("/")   //登录成功跳转的路径</span><span class="token comment">//                .failureForwardUrl("/logins")  //登录失败跳转的路径</span>             <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//自定义过滤拦截请求</span>                <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/logins"</span><span class="token punctuation">,</span><span class="token string">"/login"</span><span class="token punctuation">,</span><span class="token string">"/"</span><span class="token punctuation">)</span> <span class="token comment">//资源路径</span>                <span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">//当前资源路径不需要认证就可以访问</span>                <span class="token comment">//______________________________动态图鉴权_____________________________________________</span>                    <span class="token comment">//所有的请求都有经过MyRBACService的hasPermission方法进行鉴权 返回true可以访问，返回false不允许访问</span>                <span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">access</span><span class="token punctuation">(</span><span class="token string">"@MyRBACService.hasPermission(request,authentication)"</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">sessionManagement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//启用session管理</span>                <span class="token punctuation">.</span><span class="token function">maximumSessions</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token comment">//允许一个账号你个人同时登录，也就是一个session可以几个人同时使用</span>                <span class="token punctuation">.</span><span class="token function">maxSessionsPreventsLogin</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token comment">//false：当登录时，其它登录的登录的地方会被踢下线;true ：当有用户在登录时不允许登录</span>                <span class="token punctuation">.</span><span class="token function">expiredSessionStrategy</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CustomExpiredSessionStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//session超时，被踢下线的自定义操作</span>        <span class="token comment">//.authorizeHttpRequests()   这样方法表示选中的请求</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 授权方法     * @param auth     * @throws Exception     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationManagerBuilder</span> auth<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>        <span class="token comment">//________________ 动态授权，需要实现UserDetailsService____________________________</span>            auth<span class="token punctuation">.</span><span class="token function">userDetailsService</span><span class="token punctuation">(</span>myUserDetailsService<span class="token punctuation">)</span>                  <span class="token punctuation">.</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//配置BCrypt加密，这个会自动调用matches（）这个方法来为我们输入的密码进行对比</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Bean</span>    <span class="token keyword">public</span> <span class="token class-name">PasswordEncoder</span> <span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 静态资源路径开放     * @param web     * @throws Exception     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">WebSecurity</span> web<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>        <span class="token comment">//将项目中的静态资源路径开放出来，在这开放是不需要经过过滤器拦截的</span>        web<span class="token punctuation">.</span><span class="token function">ignoring</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/css/**"</span><span class="token punctuation">,</span><span class="token string">"/fonts/**"</span><span class="token punctuation">,</span><span class="token string">"/img/**"</span><span class="token punctuation">,</span><span class="token string">"/js/**"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * JdbcTokenRepositoryImpl 这个类中已经固定要存到数据库中的哪个表，我们只需要指定数据源即可     * initDao() 这个方法有在数据库中创建需要的表，我还没尝试过，我的表是自己手动创建的     * 设置记住我存储到的数据源是哪个     * @return     */</span>    <span class="token annotation punctuation">@Bean</span>    <span class="token keyword">public</span> <span class="token class-name">PersistentTokenRepository</span> <span class="token function">tokenRepository</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token class-name">JdbcTokenRepositoryImpl</span> jdbcTokenRepository <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JdbcTokenRepositoryImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        jdbcTokenRepository<span class="token punctuation">.</span><span class="token function">setDataSource</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> jdbcTokenRepository<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>SPEL表达式：</p><p><img src="https://s2.loli.net/2022/03/21/nBC3wzYPX4Gocq9.png" alt="image-20220317231517131"></p><h2 id="退出登录："><a href="#退出登录：" class="headerlink" title="退出登录："></a>退出登录：</h2><h5 id="最简单的实现"><a href="#最简单的实现" class="headerlink" title="最简单的实现"></a><strong>最简单的实现</strong></h5><p>后端配置：</p><pre class="line-numbers language-none"><code class="language-none">.logout()//开启退出登录<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>前端代码：</p><pre class="line-numbers language-none"><code class="language-none">&lt;a href="/logout"&gt;退出登录&lt;/a&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h5 id="Logout的默认行为"><a href="#Logout的默认行为" class="headerlink" title="Logout的默认行为"></a>Logout的默认行为</h5><p>1，当前session失效，即: logout的核心需求，session失效就是访问权限的回收</p><p>2，删除当前用户的remember-me“记住我”功能信息，数据库中的也会删除</p><p>3，clear清除当前的SecurityContext ，可以看做清除了也会的主体信息等</p><p>4，重定向到登录页面，loginPage配置项指定的页面</p><h5 id="个性化配置-1"><a href="#个性化配置-1" class="headerlink" title="个性化配置"></a>个性化配置</h5><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token punctuation">.</span><span class="token function">logoutSuccessUrl</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span> <span class="token comment">//退出后跳转的页面  默认退出到login页面</span><span class="token punctuation">.</span><span class="token function">deleteCookies</span><span class="token punctuation">(</span><span class="token string">"JSESSIONID"</span><span class="token punctuation">)</span> <span class="token comment">//退出后要删除的cookie 参数是cookie名称</span><span class="token punctuation">.</span><span class="token function">logoutUrl</span><span class="token punctuation">(</span><span class="token string">"/logout"</span><span class="token punctuation">)</span>  <span class="token comment">//退出请求路径，也就是页面上退出登录的路径，别忘了前端页面也要改  默认logout</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h5 id="LogoutSuccessHandler-实现个性化规程功能"><a href="#LogoutSuccessHandler-实现个性化规程功能" class="headerlink" title="LogoutSuccessHandler:实现个性化规程功能"></a>LogoutSuccessHandler:实现个性化规程功能</h5><p>注意，不要与logoutSuccessUrl以前使用，否则会失效</p><p><strong>自定义类：</strong></p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 自定义退出后需要进行的操作 */</span><span class="token annotation punctuation">@Component</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyLogoutSuccessHandler</span> <span class="token keyword">implements</span> <span class="token class-name">LogoutSuccessHandler</span> <span class="token punctuation">{</span>    <span class="token comment">/**     * 进行重新方法失效个性化退出     * @param request  请求     * @param response  响应     * @param authentication  主体信息     * @throws IOException     * @throws ServletException     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onLogoutSuccess</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Authentication</span> authentication<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"附加逻辑代码.........."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        response<span class="token punctuation">.</span><span class="token function">sendRedirect</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>Security配置类:</strong>    </p><pre class="line-numbers language-none"><code class="language-none">//退出登录自定义策略@Autowiredprivate MyLogoutSuccessHandler myLogoutSuccessHandler;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-none"><code class="language-none">        //开启formLogin登录认证        http.                logout()//开启退出登录//                .logoutSuccessUrl("/") //退出后跳转的页面  默认退出到login页面                .deleteCookies("JSESSIONID") //指定退出后要删除的cookie                .logoutUrl("/logout")  //退出请求路径，也就是页面上退出登录访问的地址  默认logout                .logoutSuccessHandler(myLogoutSuccessHandler) //使用自定义退出策略 ，不能与logoutSuccessUrl共存，否则失效<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>完整Security配置类：</strong></p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecurityConfig</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token punctuation">{</span>    <span class="token comment">//将我们自定义的这两个类使用IOC容器装配</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">private</span> <span class="token class-name">MyAuthenticationSuccessHandler</span> myAuthenticationSuccessHandler<span class="token punctuation">;</span>  <span class="token comment">//登录成功处理</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">private</span> <span class="token class-name">MyAuthenticationFailureHandler</span> myAuthenticationFailureHandler<span class="token punctuation">;</span>  <span class="token comment">//登录失败处理</span>    <span class="token comment">//导入自定义动态授权</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">private</span> <span class="token class-name">MyUserDetailsService</span> myUserDetailsService<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">private</span> <span class="token class-name">DataSource</span> dataSource<span class="token punctuation">;</span>    <span class="token comment">//退出登录自定义策略</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">private</span> <span class="token class-name">MyLogoutSuccessHandler</span> myLogoutSuccessHandler<span class="token punctuation">;</span>    <span class="token comment">/**     * 登录认证方法     * @param http     * @throws Exception     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>        <span class="token comment">//开启httpBasic认证</span><span class="token comment">//        http.httpBasic()</span><span class="token comment">//                .and()</span><span class="token comment">//                //所有的请求</span><span class="token comment">//                .authorizeHttpRequests()</span><span class="token comment">//                //匹配规则</span><span class="token comment">//                .anyRequest()</span><span class="token comment">//                //所有请求都需要登录认证才可以访问</span><span class="token comment">//                .authenticated();</span><span class="token comment">//_______________________________________________________________________________________________________-</span>        <span class="token comment">//开启formLogin登录认证</span>        http<span class="token punctuation">.</span>                <span class="token function">logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//开启退出登录</span><span class="token comment">//                .logoutSuccessUrl("/") //退出后跳转的页面  默认退出到login页面</span>                <span class="token punctuation">.</span><span class="token function">deleteCookies</span><span class="token punctuation">(</span><span class="token string">"JSESSIONID"</span><span class="token punctuation">)</span> <span class="token comment">//指定退出后要删除的cookie</span>                <span class="token punctuation">.</span><span class="token function">logoutUrl</span><span class="token punctuation">(</span><span class="token string">"/logout"</span><span class="token punctuation">)</span>  <span class="token comment">//退出请求路径，也就是页面上退出登录访问的地址  默认logout</span>                <span class="token punctuation">.</span><span class="token function">logoutSuccessHandler</span><span class="token punctuation">(</span>myLogoutSuccessHandler<span class="token punctuation">)</span> <span class="token comment">//使用自定义退出策略 ，不能与logoutSuccessUrl共存，否则失效</span>                <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">rememberMe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//开启记住我功能  ，前端也需要有记住我字段</span>                <span class="token punctuation">.</span><span class="token function">rememberMeCookieName</span><span class="token punctuation">(</span><span class="token string">"rememberMe-Cookie"</span><span class="token punctuation">)</span>  <span class="token comment">//存在浏览器中cookie的名称</span>                <span class="token punctuation">.</span><span class="token function">rememberMeParameter</span><span class="token punctuation">(</span><span class="token string">"remember-me"</span><span class="token punctuation">)</span>  <span class="token comment">//表单中 自动登录 勾选框的参数名</span>                <span class="token punctuation">.</span><span class="token function">tokenValiditySeconds</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">*</span><span class="token number">24</span><span class="token operator">*</span><span class="token number">60</span><span class="token operator">*</span><span class="token number">60</span><span class="token punctuation">)</span> <span class="token comment">//保存Cookie的有效期，默认2周</span>                <span class="token punctuation">.</span><span class="token function">tokenRepository</span><span class="token punctuation">(</span><span class="token function">tokenRepository</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">//指定rememberMe存储到数据库规则方法</span>                <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">csrf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">//关闭防御csrf攻击</span>                <span class="token punctuation">.</span><span class="token function">formLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//开启formLogin登录认证</span>                <span class="token punctuation">.</span><span class="token function">loginPage</span><span class="token punctuation">(</span><span class="token string">"/logins"</span><span class="token punctuation">)</span>    <span class="token comment">//用于选择登录页面，没认证时跳转的页面</span>                <span class="token punctuation">.</span><span class="token function">loginProcessingUrl</span><span class="token punctuation">(</span><span class="token string">"/login"</span><span class="token punctuation">)</span>   <span class="token comment">//选择需要认证的请求，也就是登录表单的提交地址</span>                <span class="token punctuation">.</span><span class="token function">usernameParameter</span><span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">)</span>   <span class="token comment">//选择登录请求的哪个参数是用户名</span>                <span class="token punctuation">.</span><span class="token function">passwordParameter</span><span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">)</span>   <span class="token comment">//选择登录请求的哪个参数是密码</span>                <span class="token comment">//使用自定义的登录失败成功处理方法</span>                <span class="token punctuation">.</span><span class="token function">successHandler</span><span class="token punctuation">(</span>myAuthenticationSuccessHandler<span class="token punctuation">)</span>  <span class="token comment">//登录成功</span>                <span class="token punctuation">.</span><span class="token function">failureHandler</span><span class="token punctuation">(</span>myAuthenticationFailureHandler<span class="token punctuation">)</span>  <span class="token comment">//登录失败</span>                <span class="token comment">//这两会与我们自定义的冲突想要使用自定义的就不能使用这个</span><span class="token comment">//                .defaultSuccessUrl("/")   //登录成功跳转的路径</span><span class="token comment">//                .failureForwardUrl("/logins")  //登录失败跳转的路径</span>             <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//自定义过滤拦截请求</span>                <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/logins"</span><span class="token punctuation">,</span><span class="token string">"/login"</span><span class="token punctuation">,</span><span class="token string">"/"</span><span class="token punctuation">)</span> <span class="token comment">//资源路径</span>                <span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">//当前资源路径不需要认证就可以访问</span>                <span class="token comment">//____________________静态鉴权____________________________________</span><span class="token comment">//                .antMatchers("/business1","/business2")//资源路径</span><span class="token comment">//                .hasAnyAuthority("ROLE_user","ROLE_admin")//设置可以访问的角色,user角色和admin角色都可以访问</span><span class="token comment">//</span><span class="token comment">//                    //访问角色控制方式1  与授权方法1一起使用</span><span class="token comment">//                .antMatchers("/log","/user")//资源路径</span><span class="token comment">//                .hasRole("admin")//设置可以访问的角色，和hasAnyAuthority作用相同，但hasAnyAuthority可以设置多个，并且需要加前缀ROLE_</span><span class="token comment">//</span><span class="token comment">//                    //访问角色控制方式2  与授权方法2一起使用  这里由于它不是admin角色了，所有访问业务1业务2访问不了但可以修改一下</span><span class="token comment">////                .antMatchers("/user").hasAnyAuthority("sys:user")  // /user资源路径 必须拥有sys:user角色才可访问</span><span class="token comment">////                .antMatchers("/log").hasAnyAuthority("sys:log") // /log资源路径 必须拥有sys:log角色才可访问</span><span class="token comment">//                //选择的匹配规则</span><span class="token comment">//                .anyRequest()</span><span class="token comment">//                //所有请求都需要登录认证才可以访问</span><span class="token comment">//                .authenticated()</span>                <span class="token comment">//______________________________动态图鉴权_____________________________________________</span>                    <span class="token comment">//所有的请求都有经过MyRBACService的hasPermission方法进行鉴权 返回true可以访问，返回false不允许访问</span>                <span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">access</span><span class="token punctuation">(</span><span class="token string">"@MyRBACService.hasPermission(request,authentication)"</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">sessionManagement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//启用session管理</span>                <span class="token punctuation">.</span><span class="token function">maximumSessions</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token comment">//允许一个账号你个人同时登录，也就是一个session可以几个人同时使用</span>                <span class="token punctuation">.</span><span class="token function">maxSessionsPreventsLogin</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token comment">//false：当登录时，其它登录的登录的地方会被踢下线;true ：当有用户在登录时不允许登录</span>                <span class="token punctuation">.</span><span class="token function">expiredSessionStrategy</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CustomExpiredSessionStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//session超时，被踢下线的自定义操作</span>        <span class="token comment">//.authorizeHttpRequests()   这样方法表示选中的请求</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 授权方法     * @param auth     * @throws Exception     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationManagerBuilder</span> auth<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>        <span class="token comment">//____________________静态授权________________________</span><span class="token comment">//                auth  //授权</span><span class="token comment">//                .inMemoryAuthentication()  //将这种用户添加到内存中登录认证，   还有其他类型的授权登录认证方法，比如数据库的登录认证</span><span class="token comment">//                .withUser("user")  //用户名</span><span class="token comment">//                .password(passwordEncoder().encode("123456"))  //密码</span><span class="token comment">//                .roles("user")  //设置使用该用户名登录赋予的角色，</span><span class="token comment">//            .and()</span><span class="token comment">//                 .withUser("admin") //用户名</span><span class="token comment">//                 .password(passwordEncoder().encode("123456"))</span><span class="token comment">//                   //第一种授权方式</span><span class="token comment">//                 .roles("admin")  //设置使用该账号登录赋予的角色</span><span class="token comment">//                   //第二种授权方式</span><span class="token comment">//                 //.authorities("sys:log","sys:user") //</span><span class="token comment">//                    .and().passwordEncoder(passwordEncoder()); //配置BCrypt加密，这个会自动调用matches（）这个方法来为我们输入的密码进行对比</span>        <span class="token comment">//________________ 动态授权，需要实现UserDetailsService____________________________</span>            auth<span class="token punctuation">.</span><span class="token function">userDetailsService</span><span class="token punctuation">(</span>myUserDetailsService<span class="token punctuation">)</span>                  <span class="token punctuation">.</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//配置BCrypt加密，这个会自动调用matches（）这个方法来为我们输入的密码进行对比</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Bean</span>    <span class="token keyword">public</span> <span class="token class-name">PasswordEncoder</span> <span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 静态资源路径开放     * @param web     * @throws Exception     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">WebSecurity</span> web<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>        <span class="token comment">//将项目中的静态资源路径开放出来，在这开放是不需要经过过滤器拦截的</span>        web<span class="token punctuation">.</span><span class="token function">ignoring</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/css/**"</span><span class="token punctuation">,</span><span class="token string">"/fonts/**"</span><span class="token punctuation">,</span><span class="token string">"/img/**"</span><span class="token punctuation">,</span><span class="token string">"/js/**"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * JdbcTokenRepositoryImpl 这个类中已经固定要存到数据库中的哪个表，我们只需要指定数据源即可     * initDao() 这个方法有在数据库中创建需要的表，我还没尝试过，我的表是自己手动创建的     * 设置记住我存储到的数据源是哪个     * @return     */</span>    <span class="token annotation punctuation">@Bean</span>    <span class="token keyword">public</span> <span class="token class-name">PersistentTokenRepository</span> <span class="token function">tokenRepository</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token class-name">JdbcTokenRepositoryImpl</span> jdbcTokenRepository <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JdbcTokenRepositoryImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        jdbcTokenRepository<span class="token punctuation">.</span><span class="token function">setDataSource</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> jdbcTokenRepository<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="Session方式实现图片验证码"><a href="#Session方式实现图片验证码" class="headerlink" title="Session方式实现图片验证码:"></a>Session方式实现图片验证码:</h2><h3 id="配置："><a href="#配置：" class="headerlink" title="配置："></a>配置：</h3><p>我们需要先导入工具类库</p><pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token comment">&lt;!--   验证码工具类库  这是Google提供的一个类库   --&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.github.penggle<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>kaptcha<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.3.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusions</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusion</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>javax.servlet-api<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>javax.servlet<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusion</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusions</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://s2.loli.net/2022/03/21/UtEnrpe3u1wLfqc.png" alt="image-20220312105200767"></p><p>如何我们需要这个类库配置一下参数，</p><p>有两种方式，第一种是使用application.properties 这种方式直接配置，第二种就是自己直接手动配置</p><h5 id="第一种方式："><a href="#第一种方式：" class="headerlink" title="第一种方式："></a><strong>第一种方式：</strong></h5><p>直接将配置文件写入</p><pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token attr-name">kaptcha.border</span><span class="token punctuation">=</span><span class="token attr-value">no</span><span class="token attr-name">kaptcha.border.color</span><span class="token punctuation">=</span><span class="token attr-value">105,179,90</span><span class="token attr-name">kaptcha.image.width</span><span class="token punctuation">=</span><span class="token attr-value">100</span><span class="token attr-name">kaptcha.image.height</span><span class="token punctuation">=</span><span class="token attr-value">45</span><span class="token attr-name">kaptcha.session.key</span><span class="token punctuation">=</span><span class="token attr-value">code</span><span class="token attr-name">kaptcha.textproducer.font.color</span><span class="token punctuation">=</span><span class="token attr-value">blue</span><span class="token attr-name">kaptcha.textproducer.font.size</span><span class="token punctuation">=</span><span class="token attr-value">35</span><span class="token attr-name">kaptcha.textproducer.font.names</span><span class="token punctuation">=</span><span class="token attr-value">宋体,楷体,微软雅黑</span><span class="token attr-name">kaptcha.textproducer.char.length</span><span class="token punctuation">=</span><span class="token attr-value">4</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="第二种方式："><a href="#第二种方式：" class="headerlink" title="第二种方式："></a><strong>第二种方式：</strong></h5><p>先创建一个properties的普通文件再将这些导入：</p><pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token attr-name">kaptcha.border</span><span class="token punctuation">=</span><span class="token attr-value">no</span><span class="token attr-name">kaptcha.border.color</span><span class="token punctuation">=</span><span class="token attr-value">105,179,90</span><span class="token attr-name">kaptcha.image.width</span><span class="token punctuation">=</span><span class="token attr-value">100</span><span class="token attr-name">kaptcha.image.height</span><span class="token punctuation">=</span><span class="token attr-value">45</span><span class="token attr-name">kaptcha.session.key</span><span class="token punctuation">=</span><span class="token attr-value">code</span><span class="token attr-name">kaptcha.textproducer.font.color</span><span class="token punctuation">=</span><span class="token attr-value">blue</span><span class="token attr-name">kaptcha.textproducer.font.size</span><span class="token punctuation">=</span><span class="token attr-value">35</span><span class="token attr-name">kaptcha.textproducer.font.names</span><span class="token punctuation">=</span><span class="token attr-value">宋体,楷体,微软雅黑</span><span class="token attr-name">kaptcha.textproducer.char.length</span><span class="token punctuation">=</span><span class="token attr-value">4</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="再创建一个配置类："><a href="#再创建一个配置类：" class="headerlink" title="再创建一个配置类："></a><strong>再创建一个配置类：</strong></h5><p>这个是使用的第二种方式，所以我们这个需要使用@PropertySource()去导入一下我们的properties文件，如何使用2Value注入下 </p><p>其实两种方式都一样，只是一个需要使用@PropertySource() 去导入，一个可以直接使用@Value注入</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span><span class="token annotation punctuation">@PropertySource</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"classpath:kaptcha.properties"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">KaptChaConf</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${kaptcha.border}"</span><span class="token punctuation">)</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> border<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${kaptcha.border.color}"</span><span class="token punctuation">)</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> borderColor<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${kaptcha.textproducer.font.color}"</span><span class="token punctuation">)</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> fontColor<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${kaptcha.image.width}"</span><span class="token punctuation">)</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> imageWidth<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${kaptcha.image.height}"</span><span class="token punctuation">)</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> imageHeight<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${kaptcha.session.key}"</span><span class="token punctuation">)</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> sessionKey<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${kaptcha.textproducer.char.length}"</span><span class="token punctuation">)</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> charLength<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${kaptcha.textproducer.font.names}"</span><span class="token punctuation">)</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> fontNames<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${kaptcha.textproducer.font.size}"</span><span class="token punctuation">)</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> fontSize<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span><span class="token string">"captchaProducer"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token class-name">DefaultKaptcha</span> <span class="token function">getKaptCha</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token comment">//拥有创建谜底和谜面的方法, createImage(String text)创建谜面图片，createText()创建谜底文字</span>        <span class="token class-name">DefaultKaptcha</span> defaultKaptcha <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultKaptcha</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Properties</span> properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"kaptcha.border"</span><span class="token punctuation">,</span>border<span class="token punctuation">)</span><span class="token punctuation">;</span>        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"kaptcha.border.color"</span><span class="token punctuation">,</span>borderColor<span class="token punctuation">)</span><span class="token punctuation">;</span>        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"kaptcha.image.width"</span><span class="token punctuation">,</span>imageWidth<span class="token punctuation">)</span><span class="token punctuation">;</span>        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"kaptcha.image.height"</span><span class="token punctuation">,</span>imageHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"kaptcha.session.key"</span><span class="token punctuation">,</span>sessionKey<span class="token punctuation">)</span><span class="token punctuation">;</span>        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"kaptcha.textproducer.font.color"</span><span class="token punctuation">,</span>fontColor<span class="token punctuation">)</span><span class="token punctuation">;</span>        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"kaptcha.textproducer.font.size"</span><span class="token punctuation">,</span>fontSize<span class="token punctuation">)</span><span class="token punctuation">;</span>        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"kaptcha.textproducer.font.names"</span><span class="token punctuation">,</span>fontNames<span class="token punctuation">)</span><span class="token punctuation">;</span>        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"kaptcha.textproducer.char.length"</span><span class="token punctuation">,</span>charLength<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//设置Kaptcha的配置 ,</span>        defaultKaptcha<span class="token punctuation">.</span><span class="token function">setConfig</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Config</span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> defaultKaptcha<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="实现图片验证码加载："><a href="#实现图片验证码加载：" class="headerlink" title="实现图片验证码加载："></a>实现图片验证码加载：</h3><h5 id="存储谜底与验证码过期时间类"><a href="#存储谜底与验证码过期时间类" class="headerlink" title="存储谜底与验证码过期时间类"></a>存储谜底与验证码过期时间类</h5><p>由于图片验证码有过期时间，我们需要先创建一个类了存储我们图片验证码的谜底与过期数据</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 存储谜底与验证码过期时间 * 用于实现验证码过期，所有创建此类 */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CaptchaImageVo</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> captchaCode<span class="token punctuation">;</span> <span class="token comment">//验证码谜底</span>    <span class="token keyword">private</span> <span class="token class-name">LocalDateTime</span> expireTime<span class="token punctuation">;</span>  <span class="token comment">//验证码过期时间</span>    <span class="token comment">/**     * 用于初始化     * @param captchaCode  谜底     * @param expireAfterSeconds  过期秒数     */</span>    <span class="token keyword">public</span> <span class="token class-name">CaptchaImageVo</span><span class="token punctuation">(</span><span class="token class-name">String</span> captchaCode<span class="token punctuation">,</span><span class="token keyword">int</span> expireAfterSeconds<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>captchaCode<span class="token operator">=</span>captchaCode<span class="token punctuation">;</span>        <span class="token comment">//当前时间加上指定的秒数</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>expireTime <span class="token operator">=</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">plusSeconds</span><span class="token punctuation">(</span>expireAfterSeconds<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 判断验证码是否过期     * @return     */</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isExpired</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token comment">//判断当前时间是否大于过期时间，大于则失效</span>        <span class="token keyword">return</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isAfter</span><span class="token punctuation">(</span>expireTime<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 获取captchaCode     * @return     */</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getCoed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">return</span> captchaCode<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="验证码图片Controller："><a href="#验证码图片Controller：" class="headerlink" title="验证码图片Controller："></a>验证码图片Controller：</h5><p>我们需要将验证码图片输出到页面，所以我们需要一个controller用来输出，图片我们需要使用流来输出：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@RestController</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CaptchaController</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">private</span> <span class="token class-name">DefaultKaptcha</span> defaultKaptcha<span class="token punctuation">;</span>    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/kaptcha"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">kaptcha</span><span class="token punctuation">(</span><span class="token class-name">HttpSession</span> session<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>        response<span class="token punctuation">.</span><span class="token function">setDateHeader</span><span class="token punctuation">(</span><span class="token string">"Expires"</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        response<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">"Cache-Control"</span><span class="token punctuation">,</span><span class="token string">"no-store, no-cache, must-revalidate"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        response<span class="token punctuation">.</span><span class="token function">addHeader</span><span class="token punctuation">(</span><span class="token string">"Cache-Control"</span><span class="token punctuation">,</span><span class="token string">"post-check=0, pre-check=0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        response<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">"Pragma"</span><span class="token punctuation">,</span><span class="token string">"no-cache"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        response<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token string">"image/jpeg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//获取谜底</span>        <span class="token class-name">String</span> text <span class="token operator">=</span> defaultKaptcha<span class="token punctuation">.</span><span class="token function">createText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//将谜底与过期时间放到session中</span>        session<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">"captcha_key"</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">CaptchaImageVo</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span><span class="token number">2</span><span class="token operator">*</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//这个方式使用我们不用自己去关闭流，它自动关闭，这是jdk7的语法</span>        <span class="token keyword">try</span><span class="token punctuation">(</span><span class="token class-name">ServletOutputStream</span> out<span class="token operator">=</span>response<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token class-name">BufferedImage</span> image <span class="token operator">=</span> defaultKaptcha<span class="token punctuation">.</span><span class="token function">createImage</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//将图片以Io输出， 参数： 图片的字节 ， 图片格式 ，输入流</span>            <span class="token class-name">ImageIO</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>image<span class="token punctuation">,</span><span class="token string">"jpg"</span><span class="token punctuation">,</span>out<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//每当缓冲区数据进入满载状态时，会对数据进行一次写出。</span>            <span class="token comment">// 假如最后一次的数据量没有达到让缓冲区进入满载状态，这时候不主动调用flush()方法缓冲区数据将会丢失</span>            out<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="前端接收："><a href="#前端接收：" class="headerlink" title="前端接收："></a>前端接收：</h5><p>千万记着鉴权那开放访问权限</p><pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://code.jquery.com/jquery-3.0.0.min.js<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>登录<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/login<span class="token punctuation">"</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>post<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>    账号：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>username<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>user<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">&gt;</span></span>    密码：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">&gt;</span></span>    验证码:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>captchaCoed<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>captchaCoed<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/kaptcha<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>kaptcha<span class="token punctuation">"</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>110px<span class="token punctuation">"</span></span> <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>40px<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>button<span class="token punctuation">"</span></span> <span class="token special-attr"><span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value javascript language-javascript"><span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">"</span></span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>登录<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>     记住我<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>checkbox<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>remember-me<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>remember-me<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">    <span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment">//用于点击刷新验证码图片</span>        <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"#kaptcha"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"#kaptcha"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">"src"</span><span class="token punctuation">,</span><span class="token string">"/kaptcha?"</span><span class="token operator">+</span>Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token keyword">function</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">let</span> username<span class="token operator">=</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"#username"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">let</span> password<span class="token operator">=</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"#password"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">let</span> remember<span class="token operator">=</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"#remember-me"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">prop</span><span class="token punctuation">(</span><span class="token string">"checked"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">alert</span><span class="token punctuation">(</span>remember<span class="token punctuation">)</span>        $<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span><span class="token punctuation">{</span>            <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">"POST"</span><span class="token punctuation">,</span>            <span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token string">"/login"</span><span class="token punctuation">,</span>            <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span>                <span class="token string-property property">"user"</span><span class="token operator">:</span> username<span class="token punctuation">,</span>                <span class="token string-property property">"password"</span><span class="token operator">:</span> password<span class="token punctuation">,</span>                <span class="token string-property property">"remember-me"</span><span class="token operator">:</span>remember            <span class="token punctuation">}</span><span class="token punctuation">,</span>            <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">json</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>              <span class="token keyword">if</span> <span class="token punctuation">(</span>json<span class="token punctuation">.</span>state <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span>                  location<span class="token punctuation">.</span>href<span class="token operator">=</span><span class="token string">"/"</span><span class="token punctuation">;</span>              <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>                  <span class="token function">alert</span><span class="token punctuation">(</span>json<span class="token punctuation">.</span>message<span class="token punctuation">)</span>                  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span>                  location<span class="token punctuation">.</span>href<span class="token operator">=</span><span class="token string">"/logins"</span><span class="token punctuation">;</span>              <span class="token punctuation">}</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span>            <span class="token function-variable function">error</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="图片验证码验证："><a href="#图片验证码验证：" class="headerlink" title="图片验证码验证："></a>图片验证码验证：</h3><p><img src="https://s2.loli.net/2022/03/21/v839L1PAlIVgajO.png" alt="image-20220313101138743"></p><p>如图所示，我们需要创建一个验证码过滤器，并且在usernamepasswordAuthentionFilter之前执行</p><h5 id="在这其中要我们需要修改下原来的登录错误处理类："><a href="#在这其中要我们需要修改下原来的登录错误处理类：" class="headerlink" title="在这其中要我们需要修改下原来的登录错误处理类："></a><strong>在这其中要我们需要修改下原来的登录错误处理类：</strong></h5><pre class="line-numbers language-none"><code class="language-none">/** * 登录失败后进行的操作 */@Componentpublic class MyAuthenticationFailureHandler    extends SimpleUrlAuthenticationFailureHandler {    //注意这个一定要使用el表达式，否则这个方法都不会进    @Value("${spring.security.loginType}")    private String loginType;    //用于将对象转换为json格式    private static ObjectMapper objectMapper = new ObjectMapper();    /**     * 登录失败后进行操作     * @param request 请求     * @param response 响应     * @param exception  异常     * @throws IOException     * @throws ServletException     */    @Override    public void onAuthenticationFailure(HttpServletRequest request, HttpServletResponse response, AuthenticationException exception) throws IOException, ServletException {        //错误信息        String errorMsg="登录失败,用户名或密码错误";        //判断异常是否是SessionAuthenticationException类型，这个类型是验证码校验那抛出的异常        if (exception instanceof SessionAuthenticationException){            //将错误信息赋给错误信息返回出去            errorMsg=exception.getMessage();        }        //判断要返回的类型        if (loginType.equalsIgnoreCase("JSON")){            //告诉浏览器，以json返回            response.setContentType("application/json;charset=UTF-8");            //要返回的数据            response.getWriter().write(objectMapper.writeValueAsString(new JsonResult&lt;&gt;().InputError(errorMsg)));        }else {            //登录失败后进行的页面跳转，父类已经为我们实现了            response.setContentType("application/html;charset=UTF-8");            super.onAuthenticationFailure(request, response, exception);        }    }}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="并且我们定义一个常量类，为了跟方便记住重复参数信息："><a href="#并且我们定义一个常量类，为了跟方便记住重复参数信息：" class="headerlink" title="并且我们定义一个常量类，为了跟方便记住重复参数信息："></a><strong>并且我们定义一个常量类，为了跟方便记住重复参数信息：</strong></h5><pre class="line-numbers language-none"><code class="language-none">public class CaptchaConstant {    public static final String CAPTCHA_SESSION_KEY="captcha_key";}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h5 id="创建过滤器："><a href="#创建过滤器：" class="headerlink" title="创建过滤器："></a>创建过滤器：</h5><pre class="line-numbers language-none"><code class="language-none">/** * 自定义过滤器 ，在登录身份校验前先进行检查，验证码是否正确 * 也可以使用Filter * OncePerRequestFilter是Filter的实现类 * OncePerRequestFilter 每次登录都拦截一次， */@Componentpublic class CaptchaCodeFilter extends OncePerRequestFilter {    /**     * 这是我们自定义登录失败的处理方式     */    @Autowired    private MyAuthenticationFailureHandler myAuthenticationFailureHandler;    @Override    protected void doFilterInternal(HttpServletRequest request,                                    HttpServletResponse response,                                    FilterChain filterChain)            throws ServletException, IOException {        //判断当前请求是否是向/login发送请求，并且是以post请求提交的        if ("/login".equals(request.getRequestURI())                &amp;&amp; "post".equalsIgnoreCase(request.getMethod())){            try {                //验证码校验操作                captchaVerify(request);            }catch (AuthenticationException e){                //SessionAuthenticationException这个异常是继承了AuthenticationException的                //我们自定义异常时同样也需继承AuthenticationException                //我们将错误处理交给登录实现处理类进行操作                myAuthenticationFailureHandler.onAuthenticationFailure(request,response,e);                //由于这里已经是发生了异常的，我们就不能让程序再进行往下走了                return;            }        }        //如果验证成功后不是登录操作就进行放行        filterChain.doFilter(request,response);    }    /**     * 验证码验证操作     * 里面的异常是可以自定义的，不一定就要用系统提供的     */    private void captchaVerify(HttpServletRequest request){        //获取session，session中有用户的谜底与验证码过期时间        HttpSession session = request.getSession();        //获取用户输入的验证码        String captchaCoed = request.getParameter("captchaCoed");        System.out.println(captchaCoed);        //判断用户输入的验证码是否为空        if (captchaCoed.trim().isEmpty()){            throw new SessionAuthenticationException("验证码不能为空");        }        //获取我们存入session中的CaptchaImageVo，也就是谜底与过期时间类        CaptchaImageVo captchaImageVo = (CaptchaImageVo)session.getAttribute(CaptchaConstant.CAPTCHA_SESSION_KEY);        System.out.println(captchaImageVo.getCoed());        //判断session中使用有谜底        if (Objects.isNull(captchaImageVo)){            throw new SessionAuthenticationException("验证码不存在");        }        //判断验证码是否过期        if (captchaImageVo.isExpired()){            //移出以前的CaptchaImageVo            session.removeAttribute(CaptchaConstant.CAPTCHA_SESSION_KEY);            throw new SessionAuthenticationException("验证码已过期");        }        //判断用户输入的验证码是否与谜底一致，getCoed()这个方法就是单纯的获取captchaImageVo中的coed        if (!captchaCoed.trim().equalsIgnoreCase(captchaImageVo.getCoed())){            throw new SessionAuthenticationException("验证码不匹配");        }    }}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="Security配置类：-1"><a href="#Security配置类：-1" class="headerlink" title="Security配置类："></a>Security配置类：</h5><p>在配置中配置在UsernamePasswordAuthenticationFilter之前插入我们创建的过滤器</p><pre class="line-numbers language-none"><code class="language-none">@Configurationpublic class SecurityConfig extends WebSecurityConfigurerAdapter {    //将我们自定义的这两个类使用IOC容器装配    @Autowired    private MyAuthenticationSuccessHandler myAuthenticationSuccessHandler;  //登录成功处理    @Autowired    private MyAuthenticationFailureHandler myAuthenticationFailureHandler;  //登录失败处理    //导入自定义动态授权    @Autowired    private MyUserDetailsService myUserDetailsService;    @Autowired    private DataSource dataSource;    //退出登录自定义策略    @Autowired    private MyLogoutSuccessHandler myLogoutSuccessHandler;    //验证码过滤器    @Autowired    private CaptchaCodeFilter captchaCodeFilter;    /**     * 登录认证方法     * @param http     * @throws Exception     */    @Override    protected void configure(HttpSecurity http) throws Exception {        //开启formLogin登录认证        http.                //将验证码过滤器放置在UsernamePasswordAuthenticationFilter过滤器之前执行，AOP思想                addFilterBefore(captchaCodeFilter, UsernamePasswordAuthenticationFilter.class)                .logout()//开启退出登录//                .logoutSuccessUrl("/") //退出后跳转的页面  默认退出到login页面                .deleteCookies("JSESSIONID") //指定退出后要删除的cookie                .logoutUrl("/logout")  //退出请求路径，也就是页面上退出登录访问的地址  默认logout                .logoutSuccessHandler(myLogoutSuccessHandler) //使用自定义退出策略 ，不能与logoutSuccessUrl共存，否则失效                .and()                .rememberMe()//开启记住我功能  ，前端也需要有记住我字段                .rememberMeCookieName("rememberMe-Cookie")  //存在浏览器中cookie的名称                .rememberMeParameter("remember-me")  //表单中 自动登录 勾选框的参数名                .tokenValiditySeconds(2*24*60*60) //保存Cookie的有效期，默认2周                .tokenRepository(tokenRepository())  //指定rememberMe存储到数据库规则方法                .and()                .csrf().disable()  //关闭防御csrf攻击                .formLogin()//开启formLogin登录认证                .loginPage("/logins")    //用于选择登录页面，没认证时跳转的页面                .loginProcessingUrl("/login")   //选择需要认证的请求，也就是登录表单的提交地址                .usernameParameter("user")   //选择登录请求的哪个参数是用户名                .passwordParameter("password")   //选择登录请求的哪个参数是密码                //使用自定义的登录失败成功处理方法                .successHandler(myAuthenticationSuccessHandler)  //登录成功                .failureHandler(myAuthenticationFailureHandler)  //登录失败                //这两会与我们自定义的冲突想要使用自定义的就不能使用这个//                .defaultSuccessUrl("/")   //登录成功跳转的路径//                .failureForwardUrl("/logins")  //登录失败跳转的路径             .and()                .authorizeRequests() //自定义过滤拦截请求                .antMatchers("/logins","/login","/","/kaptcha") //资源路径                .permitAll()  //当前资源路径不需要认证就可以访问                //______________________________动态图鉴权_____________________________________________                    //所有的请求都有经过MyRBACService的hasPermission方法进行鉴权 返回true可以访问，返回false不允许访问                .anyRequest().access("@MyRBACService.hasPermission(request,authentication)")                .and()                .sessionManagement()//启用session管理                .maximumSessions(1)//允许一个账号你个人同时登录，也就是一个session可以几个人同时使用                .maxSessionsPreventsLogin(false)//false：当登录时，其它登录的登录的地方会被踢下线;true ：当有用户在登录时不允许登录                .expiredSessionStrategy(new CustomExpiredSessionStrategy());  //session超时，被踢下线的自定义操作        //.authorizeHttpRequests()   这样方法表示选中的请求    }    /**     * 授权方法     * @param auth     * @throws Exception     */    @Override    protected void configure(AuthenticationManagerBuilder auth) throws Exception {        //________________ 动态授权，需要实现UserDetailsService____________________________            auth.userDetailsService(myUserDetailsService)                  .passwordEncoder(passwordEncoder());  //配置BCrypt加密，这个会自动调用matches（）这个方法来为我们输入的密码进行对比    }    @Bean    public PasswordEncoder passwordEncoder(){        return new BCryptPasswordEncoder();    }    /**     * 静态资源路径开放     * @param web     * @throws Exception     */    @Override    public void configure(WebSecurity web) throws Exception {        //将项目中的静态资源路径开放出来，在这开放是不需要经过过滤器拦截的        web.ignoring().antMatchers("/css/**","/fonts/**","/img/**","/js/**");    }    /**     * JdbcTokenRepositoryImpl 这个类中已经固定要存到数据库中的哪个表，我们只需要指定数据源即可     * initDao() 这个方法有在数据库中创建需要的表，我还没尝试过，我的表是自己手动创建的     * 设置记住我存储到的数据源是哪个     * @return     */    @Bean    public PersistentTokenRepository tokenRepository(){        JdbcTokenRepositoryImpl jdbcTokenRepository = new JdbcTokenRepositoryImpl();        jdbcTokenRepository.setDataSource(dataSource);        return jdbcTokenRepository;    }}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="手机号验证码登录："><a href="#手机号验证码登录：" class="headerlink" title="手机号验证码登录："></a>手机号验证码登录：</h2><h3 id="分析："><a href="#分析：" class="headerlink" title="分析："></a>分析：</h3><p><img src="https://s2.loli.net/2022/03/21/7jINUlQWAoY1edS.png" alt="image-20220316233213777"></p><p><strong>使用到的常量：</strong>public static final String PHONE_SESSION_KEY = “phoneCaptcha”;</p><p>这是我们实现短信验证码登录需要实现发：SMS 在我这用Phone代替</p><p>我们需要先创建一个为我们提供发送的验证码的Controller，这个很好理解吧，点击获取验证码，如何发送短信验证码至手机号短信</p><h3 id="controller："><a href="#controller：" class="headerlink" title="controller："></a>controller：</h3><p>创建验证码并发送给用户手机号，还有放入session以便登录验证</p><pre class="line-numbers language-none"><code class="language-none">@Slf4j@RestControllerpublic class phoneController {    @Autowired    private MyUserDetailsService myUserDetailsService;    //创建手机验证码    @GetMapping("/smscode")    public JsonResult sms(String phone , HttpSession session){        //判断当前号码用户是否存在        try {            UserDetails userDetails = myUserDetailsService.loadUserByUsername(phone);        }catch (Exception e){            return new JsonResult().InputError("当前号码还未注册");        }        //创建一个验证码信息类，存放验证码（验证码使用随机生成），过期时间，电话号码，        int captcha = new Random().nextInt(9999);  //随机生成验证码        PhoneCaptchaVo phoneCaptchaVo = new PhoneCaptchaVo(String.valueOf(captcha),60,phone);        ///TODO 调用短信服务提供商的接口发送短信        log.info(phoneCaptchaVo.getCode()+"  &gt;&gt; 验证码已发送至 "  +phone );        session.setAttribute("phoneCaptcha",phoneCaptchaVo);        return new JsonResult().success("验证码已发送");    }}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这里我们可以看到有给PhoneCaptchaVo 其实就和图片验证码一样，需要的类封装我们的验证基本信息，再放入session</p><h3 id="PhoneCaptchaVo"><a href="#PhoneCaptchaVo" class="headerlink" title="PhoneCaptchaVo :"></a>PhoneCaptchaVo :</h3><pre class="line-numbers language-none"><code class="language-none">public class PhoneCaptchaVo {    private String captchaCode; //验证码谜底    private LocalDateTime expireTime;  //验证码过期时间    private String phone;  //电话号码    /**     * 用于初始化     * @param captchaCode  谜底     * @param expireAfterSeconds  过期秒数     */    public PhoneCaptchaVo(String captchaCode,int expireAfterSeconds,String phone){        this.captchaCode=captchaCode;        //当前时间加上指定的秒数        this.expireTime = LocalDateTime.now().plusSeconds(expireAfterSeconds);        this.phone=phone;    }    /**     * 判断验证码是否过期     * @return     */    public boolean isExpired(){        //判断当前时间是否大于过期时间，大于则失效        return LocalDateTime.now().isAfter(expireTime);    }    /**     * 获取captchaCode     * @return     */    public String getCode(){        return captchaCode;    }    //返回电话号码    public String getPhone(){        return phone;    }}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这样我们的第一步就完成了，以创建并发送验证码，</p><h3 id="使用过滤器进行谜底验证："><a href="#使用过滤器进行谜底验证：" class="headerlink" title="使用过滤器进行谜底验证："></a>使用过滤器进行谜底验证：</h3><p>当我们登录时我们需要进行登录信息的确认，还有谜底对比</p><p>这样我们就完成了基本的验证，但这样我们是无法使用的，因为的短信登录请求/PhoneLogin是无法向/login一样被识别的</p><p>我们还需要创建PhoneAuthenticationFilter ，就像UsernamePasswordAuthenticationFilter一样，如果给login请求就进行登录的一系列操作</p><pre class="line-numbers language-none"><code class="language-none">/** * 短信验证码登录验证的过滤器，与我们图片验证码的过滤器可以说是一模一样 */@Componentpublic class PhoneCodeValidateFilter  extends OncePerRequestFilter {    /**     * 这是我们自定义登录失败的处理方式     */    @Autowired    private MyAuthenticationFailureHandler myAuthenticationFailureHandler;    @Override    protected void doFilterInternal(HttpServletRequest request,                                    HttpServletResponse response,                                    FilterChain filterChain)            throws ServletException, IOException {        //判断当前请求是否是向/login发送请求，并且是以post请求提交的        if ("/PhoneLogin".equals(request.getRequestURI())                &amp;&amp; "post".equalsIgnoreCase(request.getMethod())){            try {                //验证码校验操作                captchaVerify(request);            }catch (AuthenticationException e){                //SessionAuthenticationException这个异常是继承了AuthenticationException的                //我们自定义异常时同样也需继承AuthenticationException                //我们将错误处理交给登录实现处理类进行操作                myAuthenticationFailureHandler.onAuthenticationFailure(request,response,e);                //由于这里已经是发生了异常的，我们就不能让程序再进行往下走了                return;            }        }        //如果验证成功后不是登录操作就进行放行        filterChain.doFilter(request,response);    }    /**     * 验证码验证操作     * 里面的异常是可以自定义的，不一定就要用系统提供的     */    private void captchaVerify(HttpServletRequest request){        //获取session，session中有用户的谜底与验证码过期时间        HttpSession session = request.getSession();        //获取用户输入的验证码            String phone = request.getParameter("phone"); //输入的手机号码            String phoneCode = request.getParameter("phoneCode"); //输入的验证码        //判断用户输入的手机号是否为空        if (phone.trim().isEmpty()){            throw new SessionAuthenticationException("手机号不能为空");        }        //判断用户输入的验证码是否为空        if (phoneCode.trim().isEmpty()){            throw new SessionAuthenticationException("验证码不能为空");        }        //获取我们存入session中的CaptchaImageVo，也就是谜底与过期时间类        PhoneCaptchaVo phoneCaptchaVo = (PhoneCaptchaVo) session.getAttribute(CaptchaConstant.PHONE_SESSION_KEY);        //判断session中使用有谜底        if (Objects.isNull(phoneCaptchaVo)){            throw new SessionAuthenticationException("验证码不存在");        }        //判断验证码是否过期        if (phoneCaptchaVo.isExpired()){            //移出以前的CaptchaImageVo            session.removeAttribute(CaptchaConstant.PHONE_SESSION_KEY);            throw new SessionAuthenticationException("验证码已过期");        }        //判断用户输入的验证码是否与谜底一致        if (!phoneCode.trim().equalsIgnoreCase(phoneCaptchaVo.getCode())){            throw new SessionAuthenticationException("验证码不匹配");        }        //判断用户输入的验证码是否与谜底一致        if (!phone.trim().equalsIgnoreCase(phoneCaptchaVo.getPhone())){            throw new SessionAuthenticationException("手机号不匹配");        }        //验证完后删除验证码，不管成功还是失败        session.removeAttribute(CaptchaConstant.PHONE_SESSION_KEY);    }}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="短信鉴定登录过滤器："><a href="#短信鉴定登录过滤器：" class="headerlink" title="短信鉴定登录过滤器："></a>短信鉴定登录过滤器：</h3><p><img src="https://s2.loli.net/2022/03/21/XhP7JmLgucOi5sI.png" alt="image-20220316234227700"></p><p>如果所示，我们需要自定义我们的短信登录日志过滤器，当我们短信登录进来时绕过用户名密码登录过滤器。而是走我们自定义的过滤器</p><h4 id="实现图中第一个步骤"><a href="#实现图中第一个步骤" class="headerlink" title="实现图中第一个步骤:"></a>实现图中第一个步骤:</h4><p>创建自定义鉴定过滤器</p><h5 id="PhoneAuthenticationFilter："><a href="#PhoneAuthenticationFilter：" class="headerlink" title="PhoneAuthenticationFilter："></a>PhoneAuthenticationFilter：</h5><p>这个类就是图中的SmsCodeAuthenticationFilter</p><p>这个我们可以模仿UsernamePasswordAuthenticationFilter</p><pre class="line-numbers language-none"><code class="language-none">/** * 由于我们需要为手机号登录， * 我们可以仿照UsernamePasswordAuthenticationFilter用户名密码登录创建一个手机号登录过滤器交给Security * * */public class PhoneAuthenticationFilter extends AbstractAuthenticationProcessingFilter {    public static final String SPRING_SECURITY_FORM_PHONE_KEY = "phone";    private static final AntPathRequestMatcher DEFAULT_ANT_PATH_REQUEST_MATCHER = new AntPathRequestMatcher("/PhoneLogin", "POST");    private String phoneParameter = "phone";    private boolean postOnly = true;    public PhoneAuthenticationFilter() {        super(DEFAULT_ANT_PATH_REQUEST_MATCHER);    }    public PhoneAuthenticationFilter(AuthenticationManager authenticationManager) {        super(DEFAULT_ANT_PATH_REQUEST_MATCHER, authenticationManager);    }    public Authentication attemptAuthentication(HttpServletRequest request, HttpServletResponse response) throws AuthenticationException {        if (this.postOnly &amp;&amp; !request.getMethod().equals("POST")) {            throw new AuthenticationServiceException("Authentication method not supported: " + request.getMethod());        } else {            String phone = this.obtainPhone(request);            phone = phone != null ? phone : "";            //我们需要自己创建一个PhoneAuthenticationToken，可以模仿UserNameAuthenticationToken            PhoneAuthenticationToken authRequest = new PhoneAuthenticationToken(phone);            this.setDetails(request, authRequest);            return this.getAuthenticationManager().authenticate(authRequest);        }    }    @Nullable    protected String obtainPhone(HttpServletRequest request) {        return request.getParameter(this.phoneParameter);    }    protected void setDetails(HttpServletRequest request, PhoneAuthenticationToken authRequest) {        authRequest.setDetails(this.authenticationDetailsSource.buildDetails(request));    }    public void setPhoneParameter(String usernameParameter) {        Assert.hasText(usernameParameter, "Phone parameter must not be empty or null");        this.phoneParameter = usernameParameter;    }    public void setPostOnly(boolean postOnly) {        this.postOnly = postOnly;    }    public final String getUsernameParameter() {        return this.phoneParameter;    }}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>再改写这个PhoneAuthenticationFilter类时我们发现UsernamePasswordAuthenticationToken令牌不是我们需要的，所以我们同样要改写，去自定义一个</p><p><strong>解下UsernamePasswordAuthenticationToken：</strong></p><p>通过类名可以的看出来，用户名密码方式进行认证。就是我们见的最多的认证方式通过用户名密码进行登录。咱们话不多说看看具体实现：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UsernamePasswordAuthenticationToken</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractAuthenticationToken</span> <span class="token punctuation">{</span>    <span class="token comment">// 序列化id</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">530L</span><span class="token punctuation">;</span>    <span class="token comment">// 一般指的是用户名</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Object</span> principal<span class="token punctuation">;</span>    <span class="token comment">// 一般指的是密码</span>    <span class="token keyword">private</span> <span class="token class-name">Object</span> credentials<span class="token punctuation">;</span>        <span class="token comment">// 构造器</span>    <span class="token comment">// principal  一般指的是用户名</span>    <span class="token comment">// credentials  一般指的是密码</span>    <span class="token keyword">public</span> <span class="token class-name">UsernamePasswordAuthenticationToken</span><span class="token punctuation">(</span><span class="token class-name">Object</span> principal<span class="token punctuation">,</span> <span class="token class-name">Object</span> credentials<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment">// 初始化父类构造 权限集合为空</span>        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token punctuation">)</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>principal <span class="token operator">=</span> principal<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>credentials <span class="token operator">=</span> credentials<span class="token punctuation">;</span>        <span class="token comment">// 设置是否已认证 默认为false</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setAuthenticated</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 构造器</span>     <span class="token comment">// principal  一般指的是用户名</span>    <span class="token comment">// credentials  一般指的是密码</span>    <span class="token comment">// authorities 权限</span>    <span class="token keyword">public</span> <span class="token class-name">UsernamePasswordAuthenticationToken</span><span class="token punctuation">(</span><span class="token class-name">Object</span> principal<span class="token punctuation">,</span> <span class="token class-name">Object</span> credentials<span class="token punctuation">,</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">GrantedAuthority</span><span class="token punctuation">&gt;</span></span> authorities<span class="token punctuation">)</span> <span class="token punctuation">{</span>       <span class="token comment">// // 初始化父类构造 权限集合</span>        <span class="token keyword">super</span><span class="token punctuation">(</span>authorities<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>principal <span class="token operator">=</span> principal<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>credentials <span class="token operator">=</span> credentials<span class="token punctuation">;</span>        <span class="token comment">// 设置父类方法表示已经认证</span>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">setAuthenticated</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 获取密码</span>    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getCredentials</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>credentials<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 获取用户名</span>    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getPrincipal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>principal<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 设置是否已认证 默认为false</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setAuthenticated</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> isAuthenticated<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IllegalArgumentException</span> <span class="token punctuation">{</span>        <span class="token comment">// 如果为true</span>        <span class="token comment">// 抛出非法参数异常</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>isAuthenticated<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"Cannot set this token to trusted - use constructor which takes a GrantedAuthority list instead"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token comment">// 设置父类是否已认证</span>            <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">setAuthenticated</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment">// 擦除凭证</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">eraseCredentials</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token comment">// 调用父类方法</span>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">eraseCredentials</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 将密码设置为空</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>credentials <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="PhoneAuthenticationToken："><a href="#PhoneAuthenticationToken：" class="headerlink" title="PhoneAuthenticationToken："></a>PhoneAuthenticationToken：</h5><pre class="line-numbers language-none"><code class="language-none">public class PhoneAuthenticationToken  extends AbstractAuthenticationToken {    private static final long serialVersionUID = 560L;    //存放认证信息，认证之前放的是手机号码，认证之后存放UserDetails    private final Object principal;    public PhoneAuthenticationToken(Object principal) {        super((Collection)null);        this.principal = principal;        this.setAuthenticated(false);    }    public PhoneAuthenticationToken(Object principal, Collection&lt;? extends GrantedAuthority&gt; authorities) {        super(authorities);        this.principal = principal;        super.setAuthenticated(true);    }    //由于我们手机号登录不需要密码，这个是获取密码的，我们没有密码就返回null，    //接口中要求实现    public Object getCredentials() {        return null;    }    public Object getPrincipal() {        return this.principal;    }    public void setAuthenticated(boolean isAuthenticated) throws IllegalArgumentException {        Assert.isTrue(!isAuthenticated, "Cannot set this token to trusted - use constructor which takes a GrantedAuthority list instead");        super.setAuthenticated(false);    }    public void eraseCredentials() {        super.eraseCredentials();    }}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="然后再实现图中第二个步骤："><a href="#然后再实现图中第二个步骤：" class="headerlink" title="然后再实现图中第二个步骤："></a>然后再实现图中第二个步骤：</h4><h5 id="实现鉴定提供者"><a href="#实现鉴定提供者" class="headerlink" title="实现鉴定提供者"></a>实现鉴定提供者</h5><pre class="line-numbers language-none"><code class="language-none">/** *创建一个电话号码的鉴定提供者， */public class PhoneAuthenticationProvider implements AuthenticationProvider {//这个其实我认为是多余的可以去掉，因为这个我们再使用过滤器进行谜底验证时就已经验证过电话号码的正确性    private UserDetailsService userDetailsService;    public void setUserDetailsService(UserDetailsService userDetailsService){        this.userDetailsService = userDetailsService;    }    protected  UserDetailsService getUserDetailsService(){        return userDetailsService;    }    // 具体认证流程    @Override    public Authentication authenticate(Authentication authentication) throws AuthenticationException {        //获取存放的Token        PhoneAuthenticationToken phoneAuthenticationToken = (PhoneAuthenticationToken) authentication;        //phoneAuthenticationToken中的Principal，初始存储的电话号码        UserDetails userDetails = userDetailsService.loadUserByUsername((String) phoneAuthenticationToken.getPrincipal());        //判断使用当前号码是否能获取到用户信息，一般都不会出问题，以为我们在获取验证码时就验证了        // 也就是PhoneCodeValidateFilter过滤器中验证码了        if (userDetails == null){            throw new InternalAuthenticationServiceException("无法根据手机号获取用户信息");        }        //我们在这创建一个Token这次他的Principal就变成了userDetails,        PhoneAuthenticationToken authenticationToken = new PhoneAuthenticationToken(userDetails,userDetails.getAuthorities());        //由于我们直接创建的details是没有值的，所以我们要将原来的details赋为我们的details        authenticationToken.setDetails(phoneAuthenticationToken.getDetails());        return authenticationToken;    }    /**     *    supports函数用来指明该Provider是否适用于该类型的认证，如果不合适，则寻找另一个Provider进行验证处理。     *    就好比，判断当前Provider是否适用于电话号码的认证，不适合，则寻找另一个Provider进行验证处理。     */    @Override    public boolean supports(Class&lt;?&gt; authentication) {        //判断当前Provider是否适用于authentication认证        return PhoneAuthenticationToken.class.isAssignableFrom(authentication);    }}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>把这个都完成后，再把他们配置到Security配置类中，但是，这个如果配置的话会显得很多，所以我们可以先创建一个电话号码验证单独的配置类，然后再将它放入到核心Security配置类中，</p><h5 id="单独配置类"><a href="#单独配置类" class="headerlink" title="单独配置类"></a>单独配置类</h5><pre class="line-numbers language-none"><code class="language-none">/** * 由于要配置电话号码登录配置的话，需要配置很多， * 所以我们交配置整合好后在去Security配置类中配置 */@Componentpublic class PhoneSecurityConfig extends SecurityConfigurerAdapter&lt;DefaultSecurityFilterChain, HttpSecurity&gt; {    @Autowired    private MyAuthenticationFailureHandler myAuthenticationFailureHandler;    @Autowired    private MyAuthenticationSuccessHandler myAuthenticationSuccessHandler;    @Autowired    private MyUserDetailsService myUserDetailsService;    //登录信息校验过滤器，也就是过滤登录信息是否正常    @Autowired    private PhoneCodeValidateFilter phoneCodeValidateFilter;    @Override    public void configure(HttpSecurity http) throws Exception {        //创建一个电话号码登录过滤器，也就是如UsernamePasswordAuthenticationFilter一样的        PhoneAuthenticationFilter phoneAuthenticationFilter = new PhoneAuthenticationFilter();        phoneAuthenticationFilter.setAuthenticationManager(http.getSharedObject(AuthenticationManager.class));        phoneAuthenticationFilter.setAuthenticationSuccessHandler(myAuthenticationSuccessHandler);//登录成功处理方式        phoneAuthenticationFilter.setAuthenticationFailureHandler(myAuthenticationFailureHandler);//登录失败处理方式        //创建一个我们自定义鉴定提供者，他会自己去匹配当前信息能使用鉴定提供者        PhoneAuthenticationProvider phoneAuthenticationProvider = new PhoneAuthenticationProvider();        //其实这个都可以不用，如果不要也就删除PhoneAuthenticationProvider中他对应的操作        phoneAuthenticationProvider.setUserDetailsService(myUserDetailsService);        http.addFilterBefore(phoneCodeValidateFilter, UsernamePasswordAuthenticationFilter.class);        http.authenticationProvider(phoneAuthenticationProvider)                .addFilterAfter(phoneAuthenticationFilter,UsernamePasswordAuthenticationFilter.class);    }}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="Securty配置类："><a href="#Securty配置类：" class="headerlink" title="Securty配置类："></a>Securty配置类：</h5><p>在配置类中加入.apply(phoneSecurityConfig)//添加我们的手机号码登录配置类</p><pre class="line-numbers language-none"><code class="language-none">@Configurationpublic class SecurityConfig extends WebSecurityConfigurerAdapter {    //将我们自定义的这两个类使用IOC容器装配    @Autowired    private MyAuthenticationSuccessHandler myAuthenticationSuccessHandler;  //登录成功处理    @Autowired    private MyAuthenticationFailureHandler myAuthenticationFailureHandler;  //登录失败处理    //导入自定义动态授权    @Autowired    private MyUserDetailsService myUserDetailsService;    @Autowired    private DataSource dataSource;    //退出登录自定义策略    @Autowired    private MyLogoutSuccessHandler myLogoutSuccessHandler;    //验证码过滤器    @Autowired    private CaptchaCodeFilter captchaCodeFilter;    @Autowired    private PhoneSecurityConfig phoneSecurityConfig;    /**     * 登录认证方法     * @param http     * @throws Exception     */    @Override    protected void configure(HttpSecurity http) throws Exception {        //开启formLogin登录认证        http                //将验证码过滤器放置在UsernamePasswordAuthenticationFilter过滤器之前执行，AOP思想                .addFilterBefore(captchaCodeFilter, UsernamePasswordAuthenticationFilter.class)                .logout()//开启退出登录//                .logoutSuccessUrl("/") //退出后跳转的页面  默认退出到login页面                .deleteCookies("JSESSIONID") //指定退出后要删除的cookie                .logoutUrl("/logout")  //退出请求路径，也就是页面上退出登录访问的地址  默认logout                .logoutSuccessHandler(myLogoutSuccessHandler) //使用自定义退出策略 ，不能与logoutSuccessUrl共存，否则失效                .and()                .rememberMe()//开启记住我功能  ，前端也需要有记住我字段                .rememberMeCookieName("rememberMe-Cookie")  //存在浏览器中cookie的名称                .rememberMeParameter("remember-me")  //表单中 自动登录 勾选框的参数名                .tokenValiditySeconds(2*24*60*60) //保存Cookie的有效期，默认2周                .tokenRepository(tokenRepository())  //指定rememberMe存储到数据库规则方法                .and()                .csrf().disable()  //关闭防御csrf攻击                .formLogin()//开启formLogin登录认证                .loginPage("/logins")    //用于选择登录页面，没认证时跳转的页面                .loginProcessingUrl("/login")   //选择需要认证的请求，也就是登录表单的提交地址                .usernameParameter("user")   //选择登录请求的哪个参数是用户名                .passwordParameter("password")   //选择登录请求的哪个参数是密码                //使用自定义的登录失败成功处理方法                .successHandler(myAuthenticationSuccessHandler)  //登录成功                .failureHandler(myAuthenticationFailureHandler)  //登录失败                //这两会与我们自定义的冲突想要使用自定义的就不能使用这个//                .defaultSuccessUrl("/")   //登录成功跳转的路径//                .failureForwardUrl("/logins")  //登录失败跳转的路径             .and()                .apply(phoneSecurityConfig)//添加我们的手机号码登录配置类                .and()                .authorizeRequests() //自定义过滤拦截请求                .antMatchers("/logins","/login","/","/kaptcha","/smscode","/PhoneLogin") //资源路径                .permitAll()  //当前资源路径不需要认证就可以访问                //______________________________动态图鉴权_____________________________________________                    //所有的请求都有经过MyRBACService的hasPermission方法进行鉴权 返回true可以访问，返回false不允许访问，                    // 也就是验证用户能访问哪些页面                .anyRequest().access("@MyRBACService.hasPermission(request,authentication)")                .and()                .sessionManagement()//启用session管理                .maximumSessions(1)//允许一个账号你个人同时登录，也就是一个session可以几个人同时使用                .maxSessionsPreventsLogin(false)//false：当登录时，其它登录的登录的地方会被踢下线;true ：当有用户在登录时不允许登录                .expiredSessionStrategy(new CustomExpiredSessionStrategy());  //session超时，被踢下线的自定义操作        //.authorizeHttpRequests()   这样方法表示选中的请求    }    /**     * 授权方法     * @param auth     * @throws Exception     */    @Override    protected void configure(AuthenticationManagerBuilder auth) throws Exception {        //________________ 动态授权，需要实现UserDetailsService____________________________            //这里才是验证登录信息的            auth.userDetailsService(myUserDetailsService)                  .passwordEncoder(passwordEncoder());  //配置BCrypt加密，这个会自动调用matches（）这个方法来为我们输入的密码进行对比    }    @Bean    public PasswordEncoder passwordEncoder(){        return new BCryptPasswordEncoder();    }    /**     * 静态资源路径开放     * @param web     * @throws Exception     */    @Override    public void configure(WebSecurity web) throws Exception {        //将项目中的静态资源路径开放出来，在这开放是不需要经过过滤器拦截的        web.ignoring().antMatchers("/css/**","/fonts/**","/img/**","/js/**");    }    /**     * 向数据库操作关于记住我的验证信息     * JdbcTokenRepositoryImpl 这个类中已经固定要存到数据库中的哪个表，我们只需要指定数据源即可     * initDao() 这个方法有在数据库中创建需要的表，我还没尝试过，我的表是自己手动创建的     * 设置记住我存储到的数据源是哪个     * @return     */    @Bean    public PersistentTokenRepository tokenRepository(){        JdbcTokenRepositoryImpl jdbcTokenRepository = new JdbcTokenRepositoryImpl();        jdbcTokenRepository.setDataSource(dataSource);        return jdbcTokenRepository;    }}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://s2.loli.net/2022/03/21/4zJVputoWcDh5P3.png" alt="image-20220317000050986"></p><h3 id="前端代码"><a href="#前端代码" class="headerlink" title="前端代码"></a>前端代码</h3><pre class="line-numbers language-none"><code class="language-none">&lt;body&gt;&lt;script src="https://code.jquery.com/jquery-3.0.0.min.js"&gt;&lt;/script&gt;&lt;h1&gt;登录&lt;/h1&gt;&lt;form action="/login" method="post"&gt;    账号：&lt;input type="text" id="username" name="user"&gt;&lt;br&gt;    密码：&lt;input type="password" id="password" name="password"&gt;&lt;br&gt;    验证码:&lt;input type="text" id="captchaCoed" name="captchaCoed"&gt;&lt;img src="/kaptcha" id="kaptcha" width="110px" height="40px"&gt;&lt;br&gt;    &lt;input type="button" onclick="login()" value="登录"&gt;     记住我&lt;input type="checkbox" name="remember-me" id="remember-me"&gt;&lt;/form&gt;&lt;h1&gt;手机验证码&lt;/h1&gt;&lt;form action="/" method="post"&gt;    手机号：&lt;input type="text" id="phone" name="phone"&gt;&lt;br&gt;    验证码:&lt;input type="text" id="phoneCode" name="phoneCode"&gt;&lt;input type="button" id="submitPhone"  onclick="getPhone()" value="获取验证码"  &gt;&lt;br&gt;    &lt;input type="button" onclick="PhoneLogin()" value="登录"&gt;&lt;/form&gt;&lt;script&gt;    $(function () {        //用于点击刷新验证码图片        $("#kaptcha").click(function () {            $("#kaptcha").attr("src","/kaptcha?"+Math.floor(Math.random()*100))        })    })    function login() {        let username=$("#username").val();        let password=$("#password").val();        let remember=$("#remember-me").prop("checked");        let captchaCoed=$("#captchaCoed").val();        $.ajax({            type: "POST",            url: "/login",            data: {                "user": username,                "password": password,                "remember-me":remember,                "captchaCoed":captchaCoed            },            success: function (json) {              if (json.state == 200){                  console.log(json)                  location.href="/";              }else {                  alert(json.message)                  console.log(json)                  location.href="/logins";              }            },            error: function (e) {                            }        })    }    function getPhone() {        let phone = $("#phone").val();        $.ajax({            type: "GET",            url: "/smscode",            data: {                "phone": phone,            },            success: function (json) {                if (json.state == 200) {                    console.log(json)                    alert("验证码已发送")                } else {                    alert(json.message)                    console.log(json)                }            },            error: function (e) {            }        })    }    function PhoneLogin() {        let phone = $("#phone").val();        let phoneCode = $("#phoneCode").val();        $.ajax({            type: "POST",            url: "/PhoneLogin",            data: {                "phone": phone,                "phoneCode":phoneCode            },            success: function (json) {                if (json.state == 200) {                    console.log(json)                    location.href="/";                } else {                    alert(json.message)                    console.log(json)                }            },            error: function (e) {            }        })    }&lt;/script&gt;&lt;/body&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="JWT"><a href="#JWT" class="headerlink" title="JWT"></a>JWT</h2><h3 id="jwt介绍："><a href="#jwt介绍：" class="headerlink" title="jwt介绍："></a>jwt介绍：</h3><p><img src="https://s2.loli.net/2022/03/21/kKPDMLRAVIpHrvX.png" alt="image-20220317231621407"></p><p><img src="https://s2.loli.net/2022/03/21/W1stHFYOvjKd6Uk.png" alt="image-20220317231629433"></p><p><img src="https://s2.loli.net/2022/03/21/P2Ik1z493SyCuFO.png" alt="image-20220317231635981"></p><p><img src="https://s2.loli.net/2022/03/21/X3od2kYmL4vnl7B.png" alt="image-20220317231642172"></p><h3 id="创建JWT工具类："><a href="#创建JWT工具类：" class="headerlink" title="创建JWT工具类："></a>创建JWT工具类：</h3><p>我需要先创建一jwt工具类，这样可以在我们需要给地方使用更方便</p><p>注意：获取用户名之类的方法都会去判断jwt令牌是否过期，过期后是获取不到用户名的</p><pre class="line-numbers language-none"><code class="language-none">/** * JWT的工具类 * 三个属性需要在配置文件中定义 */@Data@ConfigurationProperties(prefix = "jwt") //设置application中配置的开头节点@Componentpublic class JwtTokenUtil {//  这三个属性需要在application配置文件中定义    //JWT的密钥    @Value("${jwt.secret}")    private String secret;    //JWT的过期时间    @Value("${jwt.expiration}")    private Long expiration;    //在http对象头中携带jwt的key的名称    @Value("${jwt.header}")    private String header;    /**     * 生成JWT token令牌     *     * @param userDetails 用户信息     * @return JWT token令牌     */    public String generateToken(UserDetails userDetails){        //存放用户不敏感信息，等要放入jwt令牌中        Map&lt;String,Object&gt; claims = new HashMap&lt;&gt;(2);        claims.put("sub",userDetails.getUsername()); //将用户名放入claims        claims.put("created",new Date()); //将令牌创建时间放入claims        return generateToken(claims);    }    /**     * 从claims中获取用户不敏感信息生成令牌     *     * @param claims 用户不敏感信息     * @return 令牌     */    public String generateToken(Map&lt;String,Object&gt; claims){           Date expirationDate = new Date(System.currentTimeMillis() + expiration); //获取当前数据，加上过期是长，生成过期时间        //返回生成的jwt令牌        return Jwts.builder()//                .setClaims(claims)  //加入用户名，与用户创建时间                .setExpiration(System.currentTimeMillis()+expirationDate*1000)//令牌过期时间                //进行jwt令牌的签约 参数1：设置使用声明方式签名（加密方式）,参数2：使用的密钥（等解签也需要这个密钥）                .signWith(SignatureAlgorithm.HS512,secret)                .compact();    }    /**     * 从令牌中获取用户名     * @param token 令牌     * @return 该令牌用户名     */    public String getUsernameFromToken(String token){        String username;        try {            //Claims jwt信息类（数据声明），获取jwt信息类            Claims claims = getClaimsFromToken(token);            username = claims.getSubject(); //在jwt信息类中获取用户名，这个方法是获取用户名的        }catch (Exception e){            username = null;        }        return username;    }    /**     * 从令牌中获取jwt令牌信息     * @param token 令牌     * @return jwt令牌信息类（数据声明）     */    public Claims getClaimsFromToken(String token){        //jwt令牌信息类        Claims claims;        try {            //将jwt进行解析，获取jwt信息类            claims = Jwts.parser()                    .setSigningKey(secret)//解签的密钥                    .parseClaimsJws(token)//解签的令牌                    .getBody();        }catch (Exception e){            claims = null;        }        return claims;    }    /**     * 判断令牌是否过期     * @param token 令牌     * @return 是否过期     */    public Boolean isTokenExpired(String token){        try {            Claims claims = getClaimsFromToken(token);            //获取jwt令牌过期时间，过期使用使用这个方法获取            Date expiration = claims.getExpiration();            //判断当前时间是否在过期时间之前，也就是判断是否过期            return expiration.before(new Date());        }catch (Exception e){            return false;        }    }    /**     * 刷新令牌（令牌过期就表示登录过期，为了保证用户体验，在用户使用中要刷新令牌）     * @param token 原令牌     * @return 新令牌     */    public String refreshToken(String token){        String refreshToken;        try {            //获取jwt信息类            Claims claims = getClaimsFromToken(token);            //修改jwt中的新的创建时间            claims.put("created",new Date());            //生成一个新的令牌，更新它的过期时间            refreshToken = generateToken(claims);        }catch (Exception e){            refreshToken = null;        }        return refreshToken;    }    /**     * 验证令牌     * @param token 令牌     * @param userDetails 用户详细信息     * @return 是否有效     */    public Boolean validateToken(String token,UserDetails userDetails){        //获取用户名        String username = getUsernameFromToken(token);        //判断当前jwt令牌用户名是否与登录用户的用户名相同，并且jwt令牌是否过期        return (username.equals(userDetails.getUsername()) &amp;&amp; !isTokenExpired(token));    }}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>yml配置：</p><pre class="line-numbers language-none"><code class="language-none">jwt:  secret: ahjkvhajkhkss2ajdfaj #密钥，签名（加密），解签（解密）都需要该密钥  expiration: 3600000  #过期时长   header: JWTHeaderName  #jwt在http头部信息中的key<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="JWT实现登录："><a href="#JWT实现登录：" class="headerlink" title="JWT实现登录："></a>JWT实现登录：</h3><p>我们需要配置Controller实现请求，与Service业务层</p><p>这些做完我们就可以获取基本的jwt令牌了</p><h4 id="Controller："><a href="#Controller：" class="headerlink" title="Controller："></a>Controller：</h4><p>两个请求，一个获取令牌：也就是登录我们需要创建一个jwt令牌返回给客户端，一个刷新：刷新我们的jwt令牌返回回去</p><pre class="line-numbers language-none"><code class="language-none">@RestControllerpublic class JwtAuthController {    @Autowired    private JwtAuthService jwtAuthService;    /**     * 创建jwt令牌     * 记得在SecurityConfig中开放访问权限     * @param map     * @return     */    @RequestMapping("/authentication")    public JsonResult login(@RequestBody Map&lt;String,String&gt; map){        //获取用户名和密码        String username = map.get("username");        String password = map.get("password");        //判断用户名与密码是否为空        if (username.isEmpty() || password.isEmpty()){            return  new JsonResult().InputError("用户名或密码不能为空");        }        try {            //返回获取到的jwt令牌            return new JsonResult().success(jwtAuthService.login(username,password));        }catch (UsernameNotFoundException e){            //如果没有获取到jwt令牌，返回错误信息            return new JsonResult().InputError(e.getMessage());        }    }    /**     * 刷新jwt令牌     * @param token  获取http对象头中的jwt令牌，我们以及设置jwt令牌的key为jwt.header     * @return     */    @RequestMapping("/refreshToken")    public JsonResult refresh(@RequestHeader("${jwt.header}") String token){        return new JsonResult().success(jwtAuthService.refreshToken(token));    }}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="Service："><a href="#Service：" class="headerlink" title="Service："></a>Service：</h4><p>业务操作，实际上还是业务层实现真实的操作，访问层只是做一些校验</p><p>注意：AuthenticationManager  这个bean在Security配置类中配置了，可以去看看，下面有完整的Security配置类</p><pre class="line-numbers language-none"><code class="language-none">@Servicepublic class JwtAuthService {    //鉴定管理员     @Autowired    private AuthenticationManager authenticationManager;    @Autowired    private MyUserDetailsService userDetailsService;    @Autowired    private JwtTokenUtil jwtTokenUtil;    /**     * 登录认证换取JWT令牌     * @param username     * @param password     * @return     */    public String login(String username,String password){        try{            //创建一个用户名密码鉴定令牌            UsernamePasswordAuthenticationToken authenticationToken = new UsernamePasswordAuthenticationToken(username,password);            //进行认证，如果认证成功返回一个认证信息，如果没有成功就会抛出AuthenticationException异常            //这个方法中会去数据库中查询认证信息，具体还得网查询            Authentication authenticate = authenticationManager.authenticate(authenticationToken);            //将认证信息给Security            SecurityContextHolder.getContext().setAuthentication(authenticationToken);        }catch (AuthenticationException e){            throw new UsernameNotFoundException("用户名或密码不正确");        }        //进行用户查询        UserDetails userDetails = userDetailsService.loadUserByUsername(username);        //创建jwt令牌并返回        return jwtTokenUtil.generateToken(userDetails);    }    /**     * 刷新jwt令牌     * @param oldToken 旧令牌     * @return     */    public String refreshToken(String oldToken){        //判断当前令牌是否过期        if (!jwtTokenUtil.isTokenExpired(oldToken)){            return jwtTokenUtil.refreshToken(oldToken);        }        return null;    }}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>注意，要把当前两个请求路径开放，并将session关闭</strong></p><h4 id="实现效果："><a href="#实现效果：" class="headerlink" title="实现效果："></a>实现效果：</h4><p>获取到的令牌是可以使用Base64解码的，但密钥是解码不了的</p><p><strong>获取令牌：</strong></p><p><img src="https://s2.loli.net/2022/03/21/kWeJDHTntcVMBfh.png" alt="image-20220320190553251"></p><p><strong>刷新令牌：</strong></p><p><img src="https://s2.loli.net/2022/03/21/etnRIfD1aZVPjTy.png" alt="image-20220320190242450"></p><p><strong>解码演示</strong>：</p><p>这个图就和介绍中jwt结构分析一样</p><p><img src="https://s2.loli.net/2022/03/21/lbj2MnBNmJ87Qoc.png" alt="image-20220320190758729"></p><h3 id="jwt用户授权"><a href="#jwt用户授权" class="headerlink" title="jwt用户授权"></a>jwt用户授权</h3><p>我们单纯的只有jwt令牌也没有用，我们需要为当前用户进行授权，那么我们就需要自己去创建一个过滤器放置在UsernamePasswordAuthenticationFilter之前进行授权</p><p>介绍下， UsernamePasswordAuthenticationToken authenticationToken<br>        = new UsernamePasswordAuthenticationToken(userDetails,null,userDetails.getAuthorities());</p><p>这是个特殊的令牌，这个令牌是Security是可以获取到用户认证信息的，而这个令牌里的认证信息是我们放入的，然后将认证信息交给</p><p>SecurityContextHolder.getContext().setAuthentication(authenticationToken); </p><p>这个方法是将我们有角色认证信息的令牌交给Security这样就完成了角色的认证，就可以判断用户拥有哪些权限了，但每次访问时都会去重写查询（下面代码里可以看到）所以我们可以使用缓存将它存起来，这样就可以提高效率</p><h4 id="jwt身份授权鉴权过滤器"><a href="#jwt身份授权鉴权过滤器" class="headerlink" title="jwt身份授权鉴权过滤器"></a><strong>jwt身份授权鉴权过滤器</strong></h4><pre class="line-numbers language-none"><code class="language-none">/** * 添加jwt过滤器，用于身份授权鉴权 */@Componentpublic class JwtAuthenticationTokenFilter extends OncePerRequestFilter {    @Autowired    private JwtTokenUtil jwtTokenUtil;    @Autowired    private MyUserDetailsService myUserDetailsService;    @Override    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) throws ServletException, IOException {        //获取http头部信息中的jwtToken        String jwtToken = request.getHeader(jwtTokenUtil.getHeader());        //判断是否有jwtToken        if (!StringUtils.isEmpty(jwtToken)){            //获取jwt中的用户名,这里已经是判断jwt令牌的有效性，如果无效就获取不到username            String username = jwtTokenUtil.getUsernameFromToken(jwtToken);            //判断jwtToken中用户名不为空并且Security中还没有认证信息            if (!username.isEmpty()                    &amp;&amp; SecurityContextHolder.getContext().getAuthentication() == null){                UserDetails userDetails = myUserDetailsService.loadUserByUsername(username);                //验证令牌正确性，                if (jwtTokenUtil.validateToken(jwtToken,userDetails)){                    // 将jwt令牌转换为Security认识的令牌 参数1：用户信息 参数2：密码 参数3：用户的权限信息                    UsernamePasswordAuthenticationToken authenticationToken                            = new UsernamePasswordAuthenticationToken(userDetails,null,userDetails.getAuthorities());                    //把认证权限信息交给Security，如当UsernamePasswordAuthenticationFilter拦截时，发现已经认证过了就不会再次认证                    SecurityContextHolder.getContext().setAuthentication(authenticationToken);                }            }        }        filterChain.doFilter(request,response);    }}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>使用aop的思想将它放在UsernamePasswordAuthenticationFilter之前，所以我们需要去配置</p><h4 id="Security配置类-1"><a href="#Security配置类-1" class="headerlink" title="Security配置类"></a>Security配置类</h4><pre class="line-numbers language-none"><code class="language-none">@Configurationpublic class SecurityConfig extends WebSecurityConfigurerAdapter {    //导入自定义动态授权    @Autowired    private MyUserDetailsService myUserDetailsService;    @Autowired    private DataSource dataSource;    //退出登录自定义策略    @Autowired    private MyLogoutSuccessHandler myLogoutSuccessHandler;    @Autowired    private JwtAuthenticationTokenFilter jwtAuthenticationTokenFilter;    /**     * 登录认证方法     * @param http     * @throws Exception     */    @Override    protected void configure(HttpSecurity http) throws Exception {        http    //将jwtAuthenticationTokenFilter放置在UsernamePasswordAuthenticationFilter之前                .addFilterBefore(jwtAuthenticationTokenFilter, UsernamePasswordAuthenticationFilter.class)                .logout()//开启退出登录//                .logoutSuccessUrl("/") //退出后跳转的页面  默认退出到login页面                .deleteCookies("JSESSIONID") //指定退出后要删除的cookie                .logoutUrl("/logout")  //退出请求路径，也就是页面上退出登录访问的地址  默认logout                .logoutSuccessHandler(myLogoutSuccessHandler) //使用自定义退出策略 ，不能与logoutSuccessUrl共存，否则失效                .and()                .rememberMe()//开启记住我功能  ，前端也需要有记住我字段                .rememberMeCookieName("rememberMe-Cookie")  //存在浏览器中cookie的名称                .rememberMeParameter("remember-me")  //表单中 自动登录 勾选框的参数名                .tokenValiditySeconds(2*24*60*60) //保存Cookie的有效期，默认2周                .tokenRepository(tokenRepository())  //令牌仓库默认是在内存中,我们指定rememberMe存储到数据库规则方法                .and()                .csrf().disable()  //关闭防御csrf攻击                .authorizeRequests() //自定义过滤拦截请求                .antMatchers("/login","/authentication","/refreshToken") //资源路径                .permitAll()  //当前资源路径不需要认证就可以访问                .anyRequest().access("@MyRBACService.hasPermission(request,authentication)")                .and()                .sessionManagement()//启用session管理                .sessionCreationPolicy(SessionCreationPolicy.STATELESS);//不使用session，关闭session        //.authorizeHttpRequests()   这样方法表示选中的请求    }    /**     * 授权方法     * @param auth     * @throws Exception     */    @Override    protected void configure(AuthenticationManagerBuilder auth) throws Exception {            //这里才是验证登录信息的            auth.userDetailsService(myUserDetailsService)                  .passwordEncoder(passwordEncoder());  //配置BCrypt加密，这个会自动调用matches（）这个方法来为我们输入的密码进行对比    }    @Bean    public PasswordEncoder passwordEncoder(){        return new BCryptPasswordEncoder();    }    /**     * 静态资源路径开放     * @param web     * @throws Exception     */    @Override    public void configure(WebSecurity web) throws Exception {        //将项目中的静态资源路径开放出来，在这开放是不需要经过过滤器拦截的        web.ignoring().antMatchers("/css/**","/fonts/**","/img/**","/js/**");    }    /**     * 向数据库操作关于记住我的验证信息     * JdbcTokenRepositoryImpl 这个类中已经固定要存到数据库中的哪个表，我们只需要指定数据源即可     * initDao() 这个方法有在数据库中创建需要的表，我还没尝试过，我的表是自己手动创建的     * 设置记住我存储到的数据源是哪个     * @return     */    @Bean    public PersistentTokenRepository tokenRepository(){        JdbcTokenRepositoryImpl jdbcTokenRepository = new JdbcTokenRepositoryImpl();        jdbcTokenRepository.setDataSource(dataSource);        return jdbcTokenRepository;    }    @Bean(name = BeanIds.AUTHENTICATION_MANAGER)    @Override    public AuthenticationManager authenticationManagerBean() throws Exception{        return super.authenticationManagerBean();    }}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>由于我们要使用到别的页面查询是否成功授权鉴权，我们需要一个额外的请求资源</p><pre class="line-numbers language-none"><code class="language-none">@RestControllerpublic class HelloController {    @RequestMapping("/hello")    public String hello(){        return "world";    }}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>注意我们数据库中记得给当前角色这个资源路径的访问资格</p><p><strong>现在开始测试：</strong></p><p><strong>这是有权限清空访问</strong></p><p><img src="https://s2.loli.net/2022/03/21/vzRBIdb9X6WGD5m.png" alt="image-20220320193906937"></p><p><img src="https://s2.loli.net/2022/03/21/mjcJ6BY5k3OQ2Rn.png" alt="image-20220320193505218"></p><p><strong>无权限清空下访问：</strong></p><p><img src="https://s2.loli.net/2022/03/21/RBq4fEZdC6J9FIl.png" alt="image-20220320193746967"></p><p><img src="https://s2.loli.net/2022/03/21/uVZkJzhapcOG6rF.png" alt="image-20220320193640084"></p><h2 id="跨域访问："><a href="#跨域访问：" class="headerlink" title="跨域访问："></a>跨域访问：</h2><h3 id="介绍："><a href="#介绍：" class="headerlink" title="介绍："></a>介绍：</h3><p>为什么要跨域访问？跨域访问是什么？</p><p>跨域访问也就是A网站直接去访问B网站资源路径，这样的行为是不允许的</p><p><strong>如图：</strong></p><p><img src="https://s2.loli.net/2022/03/21/4arOfdijuIq8bQv.png" alt="image-20220321151443656"></p><h3 id="解决方法："><a href="#解决方法：" class="headerlink" title="解决方法："></a><strong>解决方法：</strong></h3><p><img src="https://s2.loli.net/2022/03/21/XlDL1EcG8rdZ5eb.png" alt="image-20220321152423979"></p><h4 id="其他解决方法："><a href="#其他解决方法：" class="headerlink" title="其他解决方法："></a>其他解决方法：</h4><p><img src="https://s2.loli.net/2022/03/21/KRpjq6LcIYf8ZGB.png" alt="image-20220321151622759"></p><p><img src="https://s2.loli.net/2022/03/21/aQwmgfGkiMPAVl7.png" alt="image-20220321151629992"></p><p><img src="https://s2.loli.net/2022/03/21/fWt3wZsPr1Tupka.png" alt="image-20220321151636299"></p><h4 id="SpringBoot解决方法："><a href="#SpringBoot解决方法：" class="headerlink" title="SpringBoot解决方法："></a>SpringBoot解决方法：</h4><p><img src="https://s2.loli.net/2022/03/21/Bnjf38uIDyarETp.png" alt="image-20220321151734457"></p><p><img src="https://s2.loli.net/2022/03/21/i6q8xQsg7tDBlIm.png" alt="image-20220321151753953"></p><p><img src="https://s2.loli.net/2022/03/21/hMqaYJnE4xoyX7Q.png" alt="image-20220321151800818"></p><p><img src="https://s2.loli.net/2022/03/21/GtvJUDmACzo1lrn.png" alt="image-20220321151806595"></p><h4 id="SpringBoot-Security解决方法："><a href="#SpringBoot-Security解决方法：" class="headerlink" title="SpringBoot-Security解决方法："></a>SpringBoot-Security解决方法：</h4><p>以上四种其实都可以使用在Security中解决，但是Security有它推荐的方法</p><p><strong>其实很简单：</strong></p><p>A网站中配置跨域访问权限：http .cors()//开启跨域访问</p><p>实现bean：</p><p>​    注意是这个包下的import org.springframework.web.cors.CorsConfigurationSource;</p><pre><code>/** * 配置跨域请求CORS源 * @return */@Beanpublic CorsConfigurationSource corsConfigurationSource(){    CorsConfiguration corsConfiguration = new CorsConfiguration();    //允许哪些域访问    corsConfiguration.setAllowedOrigins(Arrays.asList("http://loaclhost:8080"));    //访问方式    corsConfiguration.setAllowedMethods(Arrays.asList("GET","POST"));    //设置默认参数    corsConfiguration.applyPermitDefaultValues();    UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();    //允许跨域访问哪些资源    source.registerCorsConfiguration("/**",corsConfiguration);    return source;}</code></pre><p><strong>配置实例：</strong></p><pre class="line-numbers language-none"><code class="language-none">    /**     * 登录认证方法     * @param http     * @throws Exception     */    @Override    protected void configure(HttpSecurity http) throws Exception {        http .cors()//开启跨域访问                .and()                //将jwtAuthenticationTokenFilter放置在UsernamePasswordAuthenticationFilter之前                .addFilterBefore(jwtAuthenticationTokenFilter, UsernamePasswordAuthenticationFilter.class)                .logout()//开启退出登录//                .logoutSuccessUrl("/") //退出后跳转的页面  默认退出到login页面                .deleteCookies("JSESSIONID") //指定退出后要删除的cookie                .logoutUrl("/logout")  //退出请求路径，也就是页面上退出登录访问的地址  默认logout                .logoutSuccessHandler(myLogoutSuccessHandler) //使用自定义退出策略 ，不能与logoutSuccessUrl共存，否则失效                .and()                .rememberMe()//开启记住我功能  ，前端也需要有记住我字段                .rememberMeCookieName("rememberMe-Cookie")  //存在浏览器中cookie的名称                .rememberMeParameter("remember-me")  //表单中 自动登录 勾选框的参数名                .tokenValiditySeconds(2*24*60*60) //保存Cookie的有效期，默认2周                .tokenRepository(tokenRepository())  //令牌仓库默认是在内存中,我们指定rememberMe存储到数据库规则方法                .and()                .csrf().disable()  //关闭防御csrf攻击                .authorizeRequests() //自定义过滤拦截请求                .antMatchers("/login","/authentication","/refreshToken") //资源路径                .permitAll()  //当前资源路径不需要认证就可以访问                .anyRequest().access("@MyRBACService.hasPermission(request,authentication)")                .and()                .sessionManagement()//启用session管理                .sessionCreationPolicy(SessionCreationPolicy.STATELESS);//不使用session，关闭session        //.authorizeHttpRequests()   这样方法表示选中的请求    }    /**     * 授权方法     * @param auth     * @throws Exception     */    @Override    protected void configure(AuthenticationManagerBuilder auth) throws Exception {            //这里才是验证登录信息的            auth.userDetailsService(myUserDetailsService)                  .passwordEncoder(passwordEncoder());  //配置BCrypt加密，这个会自动调用matches（）这个方法来为我们输入的密码进行对比    }    @Bean    public PasswordEncoder passwordEncoder(){        return new BCryptPasswordEncoder();    }    /**     * 静态资源路径开放     * @param web     * @throws Exception     */    @Override    public void configure(WebSecurity web) throws Exception {        //将项目中的静态资源路径开放出来，在这开放是不需要经过过滤器拦截的        web.ignoring().antMatchers("/css/**","/fonts/**","/img/**","/js/**");    }    /**     * 向数据库操作关于记住我的验证信息     * JdbcTokenRepositoryImpl 这个类中已经固定要存到数据库中的哪个表，我们只需要指定数据源即可     * initDao() 这个方法有在数据库中创建需要的表，我还没尝试过，我的表是自己手动创建的     * 设置记住我存储到的数据源是哪个     * @return     */    @Bean    public PersistentTokenRepository tokenRepository(){        JdbcTokenRepositoryImpl jdbcTokenRepository = new JdbcTokenRepositoryImpl();        jdbcTokenRepository.setDataSource(dataSource);        return jdbcTokenRepository;    }    /**     * 识别jwt令牌需要的     * @return     * @throws Exception     */    @Bean(name = BeanIds.AUTHENTICATION_MANAGER)    @Override    public AuthenticationManager authenticationManagerBean() throws Exception{        return super.authenticationManagerBean();    }    /**     * 配置跨域请求CORS源     * @return     */    @Bean    public CorsConfigurationSource corsConfigurationSource(){        CorsConfiguration corsConfiguration = new CorsConfiguration();        //允许哪些域访问  一定要注意最后以/结尾 不让B网站访问就没有用        corsConfiguration.setAllowedOrigins(Arrays.asList("http://loaclhost:8080/"));        //访问方式        corsConfiguration.setAllowedMethods(Arrays.asList("GET","POST"));        //设置默认参数        corsConfiguration.applyPermitDefaultValues();        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();        //允许跨域访问哪些资源        source.registerCorsConfiguration("/**",corsConfiguration);        return source;    }}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="测试："><a href="#测试：" class="headerlink" title="测试："></a>测试：</h4><p>这里是使用的Security推荐解决方法</p><p><strong>B网站向A网站跨域访问前端代码：</strong></p><pre class="line-numbers language-none"><code class="language-none">$.ajax({    type: "POST",    url: "http://localhost:8081/hello",    headers: {        'JWTHeaderName':'eyJhbGciOiJIUzUxMiJ9.eyJleHAiOjE2NDc4NTMzNTEsInN1YiI6InVzZXIiLCJjcmVhdGVkIjoxNjQ3ODQ5NzUxODY3fQ.5EC4IhutkrR0er-TkLLHSLXaAZQ1gR48tTi3YOyjJzV-eE9Y0wziMoCRfUb0I4S9eeOr4mG3JloT7HQUTlwF_w'    },    success: function (json) {        alert("跨域请求配置成功"+json);    },    error: function (e) {        alert("跨域请求配置失败");    }})<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>A网站未配置B网站跨域访问权限下访问结果：</strong></p><p><img src="https://s2.loli.net/2022/03/21/TD8ZIjuQ7gvC94s.png" alt="image-20220321161337254"></p><p><strong>A网站配置B网站跨域访问权限下访问结果：</strong></p><p>​    配置了后就没有那个提示了</p><p><img src="https://s2.loli.net/2022/03/21/B15f4qExDU2nNFo.png" alt="image-20220321161205428"></p><h2 id="开启CSRF防御："><a href="#开启CSRF防御：" class="headerlink" title="开启CSRF防御："></a>开启CSRF防御：</h2><h3 id="介绍：-1"><a href="#介绍：-1" class="headerlink" title="介绍："></a>介绍：</h3><p>什么是CSRF防御，那我们先得了解下CSRF攻击</p><p><a href="https://zhuanlan.zhihu.com/p/114750961">什么是CSRF攻击？如何防御CRSF攻击？ - 知乎 (zhihu.com)</a></p><h3 id="在Security中配置："><a href="#在Security中配置：" class="headerlink" title="在Security中配置："></a><strong>在Security中配置：</strong></h3><p>配置后访问资源http请求头中需要携带CSRF令牌才能访问，（GET请求除外，GET请求不需要携带CSRF就可以访问）</p><p>没访问资源一次就会发生一次新的CSRF令牌，一个令牌只能使用一次</p><p><img src="https://s2.loli.net/2022/03/21/kZmP971nS8AXgTJ.png" alt="image-20220321174052920"></p><pre class="line-numbers language-none"><code class="language-none">http        .csrf()//开启CSRF防御（GET请求是不会被防御的）        //使用cookie存储CSRF令牌（每次防御页面都需要携带该令牌），里面的参数表示这个cookie是可以被js脚本获取到的，        .csrfTokenRepository(CookieCsrfTokenRepository.withHttpOnlyFalse()) //        .ignoringAntMatchers("/authentication") //排除哪些请求不需要携带CSRF令牌就可以进行访问<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>完整配置：</strong></p><pre class="line-numbers language-none"><code class="language-none">@Configurationpublic class SecurityConfig extends WebSecurityConfigurerAdapter {    //导入自定义动态授权    @Autowired    private MyUserDetailsService myUserDetailsService;    @Autowired    private DataSource dataSource;    //退出登录自定义策略    @Autowired    private MyLogoutSuccessHandler myLogoutSuccessHandler;    @Autowired    private JwtAuthenticationTokenFilter jwtAuthenticationTokenFilter;    /**     * 登录认证方法     * @param http     * @throws Exception     */    @Override    protected void configure(HttpSecurity http) throws Exception {        http                .csrf()//开启CSRF防御（GET请求是不会被防御的）                //使用cookie存储CSRF令牌（每次防御页面都需要携带该令牌），里面的参数表示这个cookie是可以被js脚本获取到的，                .csrfTokenRepository(CookieCsrfTokenRepository.withHttpOnlyFalse()) //                .ignoringAntMatchers("/authentication") //排除哪些请求不需要携带CSRF令牌就可以进行访问                .and()                .cors()//开启跨域访问                .and()                //将jwtAuthenticationTokenFilter放置在UsernamePasswordAuthenticationFilter之前                .addFilterBefore(jwtAuthenticationTokenFilter, UsernamePasswordAuthenticationFilter.class)                .logout()//开启退出登录//                .logoutSuccessUrl("/") //退出后跳转的页面  默认退出到login页面                .deleteCookies("JSESSIONID") //指定退出后要删除的cookie                .logoutUrl("/logout")  //退出请求路径，也就是页面上退出登录访问的地址  默认logout                .logoutSuccessHandler(myLogoutSuccessHandler) //使用自定义退出策略 ，不能与logoutSuccessUrl共存，否则失效                .and()                .rememberMe()//开启记住我功能  ，前端也需要有记住我字段                .rememberMeCookieName("rememberMe-Cookie")  //存在浏览器中cookie的名称                .rememberMeParameter("remember-me")  //表单中 自动登录 勾选框的参数名                .tokenValiditySeconds(2*24*60*60) //保存Cookie的有效期，默认2周                .tokenRepository(tokenRepository())  //令牌仓库默认是在内存中,我们指定rememberMe存储到数据库规则方法                .and()                .authorizeRequests() //自定义过滤拦截请求                .antMatchers("/login","/authentication","/refreshToken") //资源路径                .permitAll()  //当前资源路径不需要认证就可以访问                .anyRequest().access("@MyRBACService.hasPermission(request,authentication)")                .and()                .sessionManagement()//启用session管理                .sessionCreationPolicy(SessionCreationPolicy.STATELESS);//不使用session，关闭session        //.authorizeHttpRequests()   这样方法表示选中的请求    }    /**     * 授权方法     * @param auth     * @throws Exception     */    @Override    protected void configure(AuthenticationManagerBuilder auth) throws Exception {            //这里才是验证登录信息的            auth.userDetailsService(myUserDetailsService)                  .passwordEncoder(passwordEncoder());  //配置BCrypt加密，这个会自动调用matches（）这个方法来为我们输入的密码进行对比    }    @Bean    public PasswordEncoder passwordEncoder(){        return new BCryptPasswordEncoder();    }    /**     * 静态资源路径开放     * @param web     * @throws Exception     */    @Override    public void configure(WebSecurity web) throws Exception {        //将项目中的静态资源路径开放出来，在这开放是不需要经过过滤器拦截的        web.ignoring().antMatchers("/css/**","/fonts/**","/img/**","/js/**");    }    /**     * 向数据库操作关于记住我的验证信息     * JdbcTokenRepositoryImpl 这个类中已经固定要存到数据库中的哪个表，我们只需要指定数据源即可     * initDao() 这个方法有在数据库中创建需要的表，我还没尝试过，我的表是自己手动创建的     * 设置记住我存储到的数据源是哪个     * @return     */    @Bean    public PersistentTokenRepository tokenRepository(){        JdbcTokenRepositoryImpl jdbcTokenRepository = new JdbcTokenRepositoryImpl();        jdbcTokenRepository.setDataSource(dataSource);        return jdbcTokenRepository;    }    /**     * 识别jwt令牌需要的     * @return     * @throws Exception     */    @Bean(name = BeanIds.AUTHENTICATION_MANAGER)    @Override    public AuthenticationManager authenticationManagerBean() throws Exception{        return super.authenticationManagerBean();    }    /**     * 配置跨域请求CORS源     * @return     */    @Bean    public CorsConfigurationSource corsConfigurationSource(){        CorsConfiguration corsConfiguration = new CorsConfiguration();        //允许哪些域访问        corsConfiguration.setAllowedOrigins(Arrays.asList("http://localhost:8080"));        //访问方式        corsConfiguration.setAllowedMethods(Arrays.asList("GET","POST"));        //设置默认参数        corsConfiguration.applyPermitDefaultValues();        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();        //允许跨域访问哪些资源        source.registerCorsConfiguration("/**",corsConfiguration);        return source;    }}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://s2.loli.net/2022/03/21/2QsiSmgb1pR6c8k.png" alt="image-20220321172831555"></p><h3 id="使用测试"><a href="#使用测试" class="headerlink" title="使用测试"></a>使用测试</h3><p><strong>先使用我们登录的请求获取jwt令牌与CSRF令牌</strong></p><p><img src="https://s2.loli.net/2022/03/21/zJYNqRbAeBVXd7G.png" alt="image-20220321171847532"></p><p><strong>进行访问/hello：</strong></p><p>不携带CSRF令牌进行访问：</p><p><img src="https://s2.loli.net/2022/03/21/FqsVLNpkCJTfZd7.png" alt="image-20220321171956312"></p><p>携带CSRF令牌进行访问：</p><p><img src="https://s2.loli.net/2022/03/21/AFh2SfxW9YQv3gH.png" alt="image-20220321172017322"></p>]]></content>
      
      
      <categories>
          
          <category> SpringBoot-Security </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 安全框架 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Docker的使用</title>
      <link href="/2022/02/25/Docker%E7%9A%84%E4%BD%BF%E7%94%A8/"/>
      <url>/2022/02/25/Docker%E7%9A%84%E4%BD%BF%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<h1 id="帮助命令："><a href="#帮助命令：" class="headerlink" title="帮助命令："></a>帮助命令：</h1><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker version      #显示docker的版本信息。</span><br><span class="line">docker info         #显示docker的系统信息，包括镜像和容器的数量</span><br><span class="line">docker 命令 --help   #帮助命令  </span><br></pre></td></tr></tbody></table></figure><h3 id="不带命令会输出所有命令帮助："><a href="#不带命令会输出所有命令帮助：" class="headerlink" title="不带命令会输出所有命令帮助："></a><strong>不带命令会输出所有命令帮助：</strong></h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-4-12-centos ~]# docker --help</span><br><span class="line"></span><br><span class="line">Usage:  docker [OPTIONS] COMMAND</span><br><span class="line"></span><br><span class="line">A self-sufficient runtime for containers</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">      --config string      Location of client config files (default "/root/.docker")</span><br><span class="line">  -c, --context string     Name of the context to use to connect to the daemon (overrides</span><br><span class="line">                           DOCKER_HOST env var and default context set with "docker context use")</span><br><span class="line">  -D, --debug              Enable debug mode</span><br><span class="line">  -H, --host list          Daemon socket(s) to connect to</span><br><span class="line">  -l, --log-level string   Set the logging level ("debug"|"info"|"warn"|"error"|"fatal")</span><br><span class="line">                           (default "info")</span><br><span class="line">      --tls                Use TLS; implied by --tlsverify</span><br><span class="line">      --tlscacert string   Trust certs signed only by this CA (default "/root/.docker/ca.pem")</span><br><span class="line">      --tlscert string     Path to TLS certificate file (default "/root/.docker/cert.pem")</span><br><span class="line">      --tlskey string      Path to TLS key file (default "/root/.docker/key.pem")</span><br><span class="line">      --tlsverify          Use TLS and verify the remote</span><br><span class="line">  -v, --version            Print version information and quit</span><br><span class="line"></span><br><span class="line">Management Commands:</span><br><span class="line">  app*        Docker App (Docker Inc., v0.9.1-beta3)</span><br><span class="line">  builder     Manage builds</span><br><span class="line">  buildx*     Docker Buildx (Docker Inc., v0.7.1-docker)</span><br><span class="line">  config      Manage Docker configs</span><br><span class="line">  container   Manage containers</span><br><span class="line">  context     Manage contexts</span><br><span class="line">  image       Manage images</span><br><span class="line">  manifest    Manage Docker image manifests and manifest lists</span><br><span class="line">  network     Manage networks</span><br><span class="line">  node        Manage Swarm nodes</span><br><span class="line">  plugin      Manage plugins</span><br><span class="line">  scan*       Docker Scan (Docker Inc., v0.12.0)</span><br><span class="line">  secret      Manage Docker secrets</span><br><span class="line">  service     Manage services</span><br><span class="line">  stack       Manage Docker stacks</span><br><span class="line">  swarm       Manage Swarm</span><br><span class="line">  system      Manage Docker</span><br><span class="line">  trust       Manage trust on Docker images</span><br><span class="line">  volume      Manage volumes</span><br><span class="line"></span><br><span class="line">Commands:</span><br><span class="line">  attach      Attach local standard input, output, and error streams to a running container</span><br><span class="line">  build       Build an image from a Dockerfile</span><br><span class="line">  commit      Create a new image from a container's changes</span><br><span class="line">  cp          Copy files/folders between a container and the local filesystem</span><br><span class="line">  create      Create a new container</span><br><span class="line">  diff        Inspect changes to files or directories on a container's filesystem</span><br><span class="line">  events      Get real time events from the server</span><br><span class="line">  exec        Run a command in a running container</span><br><span class="line">  export      Export a container's filesystem as a tar archive</span><br><span class="line">  history     Show the history of an image</span><br><span class="line">  images      List images</span><br><span class="line">  import      Import the contents from a tarball to create a filesystem image</span><br><span class="line">  info        Display system-wide information</span><br><span class="line">  inspect     Return low-level information on Docker objects</span><br><span class="line">  kill        Kill one or more running containers</span><br><span class="line">  load        Load an image from a tar archive or STDIN</span><br><span class="line">  login       Log in to a Docker registry</span><br><span class="line">  logout      Log out from a Docker registry</span><br><span class="line">  logs        Fetch the logs of a container</span><br><span class="line">  pause       Pause all processes within one or more containers</span><br><span class="line">  port        List port mappings or a specific mapping for the container</span><br><span class="line">  ps          List containers</span><br><span class="line">  pull        Pull an image or a repository from a registry</span><br><span class="line">  push        Push an image or a repository to a registry</span><br><span class="line">  rename      Rename a container</span><br><span class="line">  restart     Restart one or more containers</span><br><span class="line">  rm          Remove one or more containers</span><br><span class="line">  rmi         Remove one or more images</span><br><span class="line">  run         Run a command in a new container</span><br><span class="line">  save        Save one or more images to a tar archive (streamed to STDOUT by default)</span><br><span class="line">  search      Search the Docker Hub for images</span><br><span class="line">  start       Start one or more stopped containers</span><br><span class="line">  stats       Display a live stream of container(s) resource usage statistics</span><br><span class="line">  stop        Stop one or more running containers</span><br><span class="line">  tag         Create a tag TARGET_IMAGE that refers to SOURCE_IMAGE</span><br><span class="line">  top         Display the running processes of a container</span><br><span class="line">  unpause     Unpause all processes within one or more containers</span><br><span class="line">  update      Update configuration of one or more containers</span><br><span class="line">  version     Show the Docker version information</span><br><span class="line">  wait        Block until one or more containers stop, then print their exit codes</span><br><span class="line"></span><br><span class="line">Run 'docker COMMAND --help' for more information on a command.</span><br><span class="line"></span><br><span class="line">To get more help with docker, check out our guides at https://docs.docker.com/go/guides/</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h3 id="指定命令会显示对应的："><a href="#指定命令会显示对应的：" class="headerlink" title="指定命令会显示对应的："></a><strong>指定命令会显示对应的：</strong></h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-4-12-centos ~]# docker images --help</span><br><span class="line"></span><br><span class="line">Usage:  docker images [OPTIONS] [REPOSITORY[:TAG]]</span><br><span class="line"></span><br><span class="line">List images</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">  -a, --all             Show all images (default hides intermediate images)</span><br><span class="line">      --digests         Show digests</span><br><span class="line">  -f, --filter filter   Filter output based on conditions provided</span><br><span class="line">      --format string   Pretty-print images using a Go template</span><br><span class="line">      --no-trunc        Don't truncate output</span><br><span class="line">  -q, --quiet           Only show image IDs</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h1 id="镜像命令："><a href="#镜像命令：" class="headerlink" title="镜像命令："></a>镜像命令：</h1><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">docker images #查看所有本地主机上的镜像 </span><br><span class="line"></span><br><span class="line">docker search 搜索镜像    #用于搜索镜像</span><br><span class="line"> </span><br><span class="line">docker pull 下载镜像名[:tag]   #下载指定的镜像，可以指定版本</span><br><span class="line"></span><br><span class="line">docker rmi 删除镜像     #删除镜像   </span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h3 id="docker-images-查看所有本地主机上的镜像"><a href="#docker-images-查看所有本地主机上的镜像" class="headerlink" title="docker images #查看所有本地主机上的镜像"></a><strong>docker images #查看所有本地主机上的镜像</strong></h3><p>解释</p><ol><li><em>REPOSITORY            # 镜像的仓库源</em></li><li><em>TAG                # 镜像的标签</em></li><li><em>IMAGE ID            # 镜像的id</em></li><li><em>CREATED            # 镜像的创建时间</em></li><li><em>SIZE                # 镜像的大小</em></li></ol><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Options:</span><br><span class="line">  -a, --all             Show all images (default hides intermediate images) #列出所有镜像</span><br><span class="line">  -q, --quiet           Only show numeric IDs # 只显示镜像的id</span><br><span class="line">————————————————————————————————————————————————————————————————————————————————————————————————————————————————</span><br><span class="line"></span><br><span class="line">[root@VM-4-12-centos ~]# docker images -a    #查看所有的镜像  -a  表示全部的意思 可以可以不带因为默认就显示全部</span><br><span class="line">REPOSITORY   TAG       IMAGE ID   CREATED   SIZE</span><br><span class="line">[root@VM-4-12-centos ~]# docker images -aq   # -q 表示显示ID  -aq 就表示输出全部的ID  应为没有镜像所有无输出</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h3 id="docker-search-搜索镜像-用于搜索镜像"><a href="#docker-search-搜索镜像-用于搜索镜像" class="headerlink" title="docker search 搜索镜像    #用于搜索镜像"></a><strong>docker search 搜索镜像    #用于搜索镜像</strong></h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Options:</span><br><span class="line">  -f, --filter filter   根据所提供的条件过滤输出</span><br><span class="line">      --format string   使用Go模板的漂亮打印搜索</span><br><span class="line">      --limit int       搜索结果的最大数目(默认25个)</span><br><span class="line">      --no-trunc        不截断输出</span><br><span class="line">----------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@VM-4-12-centos ~]# docker search mysql       #查找指定的镜像</span><br><span class="line">NAME                             DESCRIPTION                                     STARS     OFFICIAL   AUTOMATED</span><br><span class="line">mysql/mysql-server               Optimized MySQL Server Docker images. Create…   907                  [OK]</span><br><span class="line">centos/mysql-57-centos7          MySQL 5.7 SQL database server                   92                   </span><br><span class="line">mysql/mysql-cluster              Experimental MySQL Cluster Docker images. Cr…   92                   </span><br><span class="line">bitnami/mysql                    Bitnami MySQL Docker Image                      64                   [OK]</span><br><span class="line">databack/mysql-backup            Back up mysql databases to... anywhere!         55                   </span><br><span class="line">circleci/mysql                   MySQL is a widely used, open-source relation…   25   </span><br></pre></td></tr></tbody></table></figure><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-4-12-centos ~]# docker search mysql --filter=STARS=900   #查找指定收藏数量以上的mysql  也就是过滤查询</span><br><span class="line">NAME                 DESCRIPTION                                     STARS     OFFICIAL   AUTOMATED</span><br><span class="line">mysql/mysql-server   Optimized MySQL Server Docker images. Create…   907                  [OK]</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h3 id="docker-pull-下载镜像名-tag-下载指定的镜像，可以指定版本"><a href="#docker-pull-下载镜像名-tag-下载指定的镜像，可以指定版本" class="headerlink" title="docker pull 下载镜像名[:tag]   #下载指定的镜像，可以指定版本"></a>docker pull 下载镜像名[:tag]   #下载指定的镜像，可以指定版本</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-4-12-centos ~]# docker pull mysql</span><br><span class="line">Using default tag: latest</span><br><span class="line">latest: Pulling from library/mysql</span><br><span class="line">72a69066d2fe: Pull complete </span><br><span class="line">93619dbc5b36: Pull complete </span><br><span class="line">99da31dd6142: Pull complete </span><br><span class="line">626033c43d70: Pull complete </span><br><span class="line">37d5d7efb64e: Pull complete </span><br><span class="line">ac563158d721: Pull complete </span><br><span class="line">d2ba16033dad: Pull complete </span><br><span class="line">688ba7d5c01a: Pull complete </span><br><span class="line">00e060b6d11d: Pull complete </span><br><span class="line">1c04857f594f: Pull complete </span><br><span class="line">4d7cfa90e6ea: Pull complete </span><br><span class="line">e0431212d27d: Pull complete </span><br><span class="line">Digest: sha256:e9027fe4d91c0153429607251656806cc784e914937271037f7738bd5b8e7709</span><br><span class="line">Status: Downloaded newer image for mysql:latest</span><br><span class="line">docker.io/library/mysql:latest</span><br></pre></td></tr></tbody></table></figure><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-4-12-centos ~]# docker pull mysql:5.7    #下载指定版本</span><br><span class="line">5.7: Pulling from library/mysql</span><br><span class="line">72a69066d2fe: Already exists </span><br><span class="line">93619dbc5b36: Already exists </span><br><span class="line">99da31dd6142: Already exists </span><br><span class="line">626033c43d70: Already exists </span><br><span class="line">37d5d7efb64e: Already exists </span><br><span class="line">ac563158d721: Already exists </span><br><span class="line">d2ba16033dad: Already exists </span><br><span class="line">0ceb82207cd7: Pull complete </span><br><span class="line">37f2405cae96: Pull complete </span><br><span class="line">e2482e017e53: Pull complete </span><br><span class="line">70deed891d42: Pull complete </span><br><span class="line">Digest: sha256:f2ad209efe9c67104167fc609cca6973c8422939491c9345270175a300419f94</span><br><span class="line">Status: Downloaded newer image for mysql:5.7</span><br><span class="line">docker.io/library/mysql:5.7</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-4-12-centos ~]# docker images</span><br><span class="line">REPOSITORY   TAG       IMAGE ID       CREATED        SIZE</span><br><span class="line">mysql        5.7       c20987f18b13   2 months ago   448MB</span><br><span class="line">mysql        latest    3218b38490ce   2 months ago   516MB</span><br></pre></td></tr></tbody></table></figure><h3 id="docker-rmi-删除镜像-删除镜像"><a href="#docker-rmi-删除镜像-删除镜像" class="headerlink" title="docker rmi 删除镜像     #删除镜像"></a><strong>docker rmi 删除镜像     #删除镜像</strong></h3><p>docker rmi -f 镜像id #删除指定的镜像</p><p>docker rmi -f 镜像id 镜像id 镜像id 镜像id#删除指定的镜像 </p><p>docker rmi -f $(docker images -aq) #删除全部的镜像</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-4-12-centos ~]# docker rmi c20987f18b13</span><br><span class="line">Untagged: mysql:5.7</span><br><span class="line">Untagged: mysql@sha256:f2ad209efe9c67104167fc609cca6973c8422939491c9345270175a300419f94</span><br><span class="line">Deleted: sha256:c20987f18b130f9d144c9828df630417e2a9523148930dc3963e9d0dab302a76</span><br><span class="line">Deleted: sha256:6567396b065ee734fb2dbb80c8923324a778426dfd01969f091f1ab2d52c7989</span><br><span class="line">Deleted: sha256:0910f12649d514b471f1583a16f672ab67e3d29d9833a15dc2df50dd5536e40f</span><br><span class="line">Deleted: sha256:6682af2fb40555c448b84711c7302d0f86fc716bbe9c7dc7dbd739ef9d757150</span><br><span class="line">Deleted: sha256:5c062c3ac20f576d24454e74781511a5f96739f289edaadf2de934d06e910b92</span><br><span class="line">[root@VM-4-12-centos ~]# docker images</span><br><span class="line">REPOSITORY   TAG       IMAGE ID       CREATED        SIZE</span><br><span class="line">mysql        latest    3218b38490ce   2 months ago   516MB</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Untagged: mysql@sha256:e9027fe4d91c0153429607251656806cc784e914937271037f7738bd5b8e7709</span><br><span class="line">Deleted: sha256:3218b38490cec8d31976a40b92e09d61377359eab878db49f025e5d464367f3b</span><br><span class="line">Deleted: sha256:aa81ca46575069829fe1b3c654d9e8feb43b4373932159fe2cad1ac13524a2f5</span><br><span class="line">Deleted: sha256:0558823b9fbe967ea6d7174999be3cc9250b3423036370dc1a6888168cbd224d</span><br><span class="line">Deleted: sha256:a46013db1d31231a0e1bac7eeda5ad4786dea0b1773927b45f92ea352a6d7ff9</span><br><span class="line">Deleted: sha256:af161a47bb22852e9e3caf39f1dcd590b64bb8fae54315f9c2e7dc35b025e4e3</span><br><span class="line">Deleted: sha256:feff1495e6982a7e91edc59b96ea74fd80e03674d92c7ec8a502b417268822ff</span><br><span class="line">Deleted: sha256:8805862fcb6ef9deb32d4218e9e6377f35fb351a8be7abafdf1da358b2b287ba</span><br><span class="line">Deleted: sha256:872d2f24c4c64a6795e86958fde075a273c35c82815f0a5025cce41edfef50c7</span><br><span class="line">Deleted: sha256:6fdb3143b79e1be7181d32748dd9d4a845056dfe16ee4c827410e0edef5ad3da</span><br><span class="line">Deleted: sha256:b0527c827c82a8f8f37f706fcb86c420819bb7d707a8de7b664b9ca491c96838</span><br><span class="line">Deleted: sha256:75147f61f29796d6528486d8b1f9fb5d122709ea35620f8ffcea0e0ad2ab0cd0</span><br><span class="line">Deleted: sha256:2938c71ddf01643685879bf182b626f0a53b1356138ef73c40496182e84548aa</span><br><span class="line">Deleted: sha256:ad6b69b549193f81b039a1d478bc896f6e460c77c1849a4374ab95f9a3d2cea2</span><br><span class="line">[root@VM-4-12-centos ~]# docker images</span><br><span class="line">REPOSITORY   TAG       IMAGE ID   CREATED   SIZE</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h1 id="容器命令："><a href="#容器命令：" class="headerlink" title="容器命令："></a>容器命令：</h1><p>docker run 镜像id 新建容器并启动</p><p>docker ps 列出所有运行的容器 或 docker container list</p><p>docker rm 容器id 删除指定容器</p><p>docker start 容器id        #启动容器</p><p>docker restart 容器id      #重启容器</p><p>docker stop 容器id  #停止当前正在运行的容器</p><p>docker kill 容器id  #强制停止当前容器</p><p>docker run   [可选参数]   image </p><h3 id="docker-run-镜像id-新建容器并启动"><a href="#docker-run-镜像id-新建容器并启动" class="headerlink" title="docker run 镜像id 新建容器并启动"></a><strong>docker run 镜像id 新建容器并启动</strong></h3><p>#参书说明<br>–name=”Name”        容器名字 tomcat01 tomcat02 用来区分容器<br>-d                    后台方式运行<br>-it                 使用交互方式运行，进入容器查看内容<br>-p                    指定容器的端口 -p 8080(宿主机):8080(容器)<br>        -p ip:主机端口:容器端口<br>        -p 主机端口:容器端口(常用)<br>        -p 容器端口<br>        容器端口<br>-P(大写)                 随机指定端口</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-4-12-centos ~]# docker run -it centos</span><br><span class="line">Unable to find image 'centos:latest' locally</span><br><span class="line">latest: Pulling from library/centos</span><br><span class="line">a1d0c7532777: Pull complete </span><br><span class="line">Digest: sha256:a27fd8080b517143cbbbab9dfb7c8571c40d67d534bbdee55bd6c473f432b177</span><br><span class="line">Status: Downloaded newer image for centos:latest</span><br><span class="line">[root@c00aaaeab391 /]# ls   #查看容器内的centos，基础版本，很多命令都是不完善的！ 可以看到这里的目录信息是变了的</span><br><span class="line">bin  etc   lib  lost+found  mnt  proc  run   srv  tmp  var</span><br><span class="line">dev  home  lib64  media       opt  root  sbin  sys  usr</span><br><span class="line">[root@c00aaaeab391 /]# exit    #退出  会关闭容器，不处于后台运行  并返回主机</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h3 id="退出容器"><a href="#退出容器" class="headerlink" title="退出容器"></a><strong>退出容器</strong></h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">exit            # 直接容器停止并退出</span><br><span class="line">Ctrl + P + Q    # 容器不停止退出</span><br></pre></td></tr></tbody></table></figure><h3 id="docker-ps-参数"><a href="#docker-ps-参数" class="headerlink" title="docker ps [参数]"></a><strong>docker ps [参数]</strong></h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  空  # 列出当前正在运行的容器</span><br><span class="line">  -a   # 列出当前正在运行的容器+带出历史运行过的容器</span><br><span class="line">  -n=? # 显示最近创建的容器</span><br><span class="line">  -q   # 只显示容器的编号</span><br><span class="line"> </span><br><span class="line">[root@VM-4-12-centos ~]# docker ps -a</span><br><span class="line">CONTAINER ID   IMAGE     COMMAND       CREATED       STATUS                   PORTS     NAMES</span><br><span class="line">032fec6ca383   centos    "/bin/bash"   6 hours ago   Exited (0) 6 hours ago             recursing_almeida</span><br><span class="line">[root@VM-4-12-centos ~]# </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h3 id="删除容器"><a href="#删除容器" class="headerlink" title="删除容器"></a><strong>删除容器</strong></h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker rm 容器id                  # 删除指定容器，不能删除正在运行的容器，如果要强制删除 rm -f</span><br><span class="line">docker rm -f $(docker ps -aq)    # 删除所有的容器</span><br><span class="line">docker ps -aq|xargs docker rm    # 删除所有的容器</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h3 id="启动和停止容器的操作"><a href="#启动和停止容器的操作" class="headerlink" title="启动和停止容器的操作"></a><strong>启动和停止容器的操作</strong></h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker start 容器id        # 启动容器  也就是创建好了但又退出关闭了的容器</span><br><span class="line">docker restart 容器id      # 重启容器  </span><br><span class="line">docker stop 容器id         # 停止当前正在运行的容器  </span><br><span class="line">docker kill 容器id         # 强制停止当前容器  </span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h1 id="常用其他命令"><a href="#常用其他命令" class="headerlink" title="常用其他命令"></a>常用其他命令</h1><h3 id="后台启动容器"><a href="#后台启动容器" class="headerlink" title="后台启动容器"></a><strong>后台启动容器</strong></h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 命令 docker run -d 镜像名</span><br><span class="line">[root@AlibabaECS /]# docker run -d centos </span><br><span class="line"></span><br><span class="line"># 问题docker ps, 发现 centos 停止了</span><br><span class="line"></span><br><span class="line"># 常见的坑, docker容器使用后台运行，就必须要有一个前台进程，docker发现没有应用，就会自动停止</span><br><span class="line"># nginx,容器启动后，发现自己没有提供服务，就会立刻停止，就是没有程序了</span><br></pre></td></tr></tbody></table></figure><h3 id="查看日志"><a href="#查看日志" class="headerlink" title="查看日志"></a><strong>查看日志</strong></h3><p>docker logs -ft  [–tail 显示条数]  容器</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># 自己编写一段shell脚本  这样是为了不让容器发现自己没有提供服务而自动停止</span><br><span class="line">[root@VM-4-12-centos ~]# docker run -d centos /bin/sh -c "while true;do echo studyhard;sleep 1;done"</span><br><span class="line"></span><br><span class="line"># 显示日志</span><br><span class="line">-tf                # 显示日志</span><br><span class="line">--tail number      # 要显示的日志条数</span><br><span class="line"></span><br><span class="line">[root@VM-4-12-centos ~]# docker logs -ft --tail 20 922d4c5d125d</span><br><span class="line">2022-02-28T09:28:23.225242813Z kuangshen</span><br><span class="line">2022-02-28T09:28:24.226314111Z kuangshen</span><br><span class="line">2022-02-28T09:28:25.228315422Z kuangshen</span><br><span class="line">2022-02-28T09:28:26.229459113Z kuangshen</span><br><span class="line">2022-02-28T09:28:27.230996681Z kuangshen</span><br><span class="line">2022-02-28T09:28:28.233063721Z kuangshen</span><br><span class="line">2022-02-28T09:28:29.234546880Z kuangshen</span><br><span class="line">2022-02-28T09:28:30.235713638Z kuangshen</span><br><span class="line">2022-02-28T09:28:31.237349645Z kuangshen</span><br><span class="line">2022-02-28T09:28:32.238944999Z kuangshen</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h3 id="查看容器中的进程信息（如：ps）"><a href="#查看容器中的进程信息（如：ps）" class="headerlink" title="查看容器中的进程信息（如：ps）"></a>查看容器中的进程信息（如：ps）</h3><p>docker top 容器id</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-4-12-centos ~]# docker top 922d4c5d125d   </span><br><span class="line">UID                 PID                 PPID                C                   STIME               TTY                 TIME                CMD</span><br><span class="line">root                2563608             2563590             0                   17:23               ?                   00:00:00            /bin/sh -c while true;do echo kuangshen;sleep 1;done</span><br><span class="line">root                2564073             2563608             0                   17:24               ?                   00:00:00            /usr/bin/coreutils --coreutils-prog-shebang=sleep /usr/bin/sleep 1</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h3 id="查看镜像元数据"><a href="#查看镜像元数据" class="headerlink" title="查看镜像元数据"></a>查看镜像元数据</h3><p>docker inspect 容器id    </p><p>这里就只展示部分</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-4-12-centos ~]# docker inspect 922d4c5d125d</span><br><span class="line">[</span><br><span class="line">    {</span><br><span class="line">        "Id": "922d4c5d125ddb94dd3e5b3f0847fb33fc9b6e7a1878d25191572d939c43c559",</span><br><span class="line">        "Created": "2022-02-28T09:23:28.431643819Z",</span><br><span class="line">        "Path": "/bin/sh",</span><br><span class="line">        "Args": [</span><br><span class="line">            "-c",</span><br><span class="line">            "while true;do echo kuangshen;sleep 1;done"</span><br><span class="line">        ],</span><br><span class="line">        "State": {</span><br><span class="line">            "Status": "running",</span><br><span class="line">            "Running": true,</span><br><span class="line">            "Paused": false,</span><br><span class="line">            "Restarting": false,</span><br><span class="line">            "OOMKilled": false,</span><br><span class="line">            "Dead": false,</span><br><span class="line">            "Pid": 2563608,</span><br><span class="line">            "ExitCode": 0,</span><br><span class="line">            "Error": "",</span><br><span class="line">            "StartedAt": "2022-02-28T09:23:28.734054299Z",</span><br><span class="line">            "FinishedAt": "0001-01-01T00:00:00Z"</span><br><span class="line">        },</span><br><span class="line">        "Image": "sha256:5d0da3dc976460b72c77d94c8a1ad043720b0416bfc16c52c45d4847e53fadb6",</span><br><span class="line">        "ResolvConfPath": "/var/lib/docker/containers/922d4c5d125ddb94dd3e5b3f0847fb33fc9b6e7a1878d25191572d939c43c559/resolv.conf",</span><br><span class="line">        "HostnamePath": "/var/lib/docker/containers/922d4c5d125ddb94dd3e5b3f0847fb33fc9b6e7a1878d25191572d939c43c559/hostname",</span><br><span class="line">        "HostsPath": "/var/lib/docker/containers/922d4c5d125ddb94dd3e5b3f0847fb33fc9b6e7a1878d25191572d939c43c559/hosts",</span><br><span class="line">        "LogPath": "/var/lib/docker/containers/922d4c5d125ddb94dd3e5b3f0847fb33fc9b6e7a1878d25191572d939c43c559/922d4c5d125ddb94dd3e5b3f0847fb33fc9b6e7a1878d25191572d939c43c559-json.log",</span><br><span class="line">        "Name": "/cool_ardinghelli",</span><br><span class="line">        "RestartCount": 0,</span><br><span class="line">        "Driver": "overlay2",</span><br><span class="line">        "Platform": "linux",</span><br><span class="line">        "MountLabel": "",</span><br><span class="line">        "ProcessLabel": "",</span><br><span class="line">        "AppArmorProfile": "",</span><br><span class="line">        "ExecIDs": null,</span><br><span class="line">        "HostConfig": {</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h3 id="进入当前正在运行的容器"><a href="#进入当前正在运行的容器" class="headerlink" title="进入当前正在运行的容器"></a><strong>进入当前正在运行的容器</strong></h3><p>命令docker exec -it 容器id baseShell</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-4-12-centos ~]# docker exec -it 922d4c5d125d /bin/bash</span><br><span class="line">[root@922d4c5d125d /]# ls</span><br><span class="line">bin  etc   lib  lost+found  mnt  proc  run   srv  tmp  var</span><br><span class="line">dev  home  lib64  media       opt  root  sbin  sys  usr</span><br><span class="line">[root@922d4c5d125d /]# ps -ef</span><br><span class="line">UID          PID    PPID  C STIME TTY          TIME CMD</span><br><span class="line">root           1       0  0 09:23 ?        00:00:01 /bin/sh -c while true;do echo kuangshen;sleep 1</span><br><span class="line">root        5795       0  0 11:00 pts/0    00:00:00 /bin/bash</span><br><span class="line">root        5844       1  0 11:00 ?        00:00:00 /usr/bin/coreutils --coreutils-prog-shebang=sle</span><br><span class="line">root        5845    5795  0 11:00 pts/0    00:00:00 ps -ef</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 方式二</span><br><span class="line">docker attach 容器id</span><br><span class="line"></span><br><span class="line"># 测试</span><br><span class="line">[root@AlibabaECS ~]# docker attach f1178d5b0bd8</span><br><span class="line">正在执行当前的代码...</span><br><span class="line"></span><br><span class="line"># docker exec        # 进入容器后开启一个新的终端，可以在里面操作(常用)</span><br><span class="line"># docker attach      # 进入容器正在执行的终端，不会启动新的进程</span><br></pre></td></tr></tbody></table></figure><h3 id="从容器内拷贝到主机上"><a href="#从容器内拷贝到主机上" class="headerlink" title="从容器内拷贝到主机上"></a><strong>从容器内拷贝到主机上</strong></h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 命令</span><br><span class="line">docker cp [r] 容器id :容器内路径 目的地主机路径</span><br><span class="line"># 参数r : 递归拷贝</span><br><span class="line"># 测试</span><br><span class="line">[root@AlibabaECS home]# docker cp a485a9d900b4:/home/test.java /home</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>]]></content>
      
      
      <categories>
          
          <category> Docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 使用 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Docker安装</title>
      <link href="/2022/02/25/Docker%E5%AE%89%E8%A3%85/"/>
      <url>/2022/02/25/Docker%E5%AE%89%E8%A3%85/</url>
      
        <content type="html"><![CDATA[<h1 id="Docker安装："><a href="#Docker安装：" class="headerlink" title="Docker安装："></a>Docker安装：</h1><p><strong>1.卸载旧版本</strong></p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">yum remove docker \</span><br><span class="line">                  docker-client \</span><br><span class="line">                  docker-client-latest \</span><br><span class="line">                  docker-common \</span><br><span class="line">                  docker-latest \</span><br><span class="line">                  docker-latest-logrotate \</span><br><span class="line">                  docker-logrotate \</span><br><span class="line">                  docker-engine</span><br></pre></td></tr></tbody></table></figure><p><strong>2.需要的安装包</strong><br>yum install -y yum-utils</p><p><strong>3.设置镜像的仓库</strong><br>yum-config-manager <br>    –add-repo <br>    <a href="https://download.docker.com/linux/centos/docker-ce.repo">https://download.docker.com/linux/centos/docker-ce.repo</a><br>上述方法默认是从国外的，不推荐</p><p>#推荐使用国内的<br>yum-config-manager <br>    –add-repo <br>    <a href="https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo">https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</a></p><p>更新yum软件包索引<br>yum makecache fast</p><p><strong>4.安装docker相关的 docker-ce 社区版 而ee是企业版</strong><br>yum install docker-ce docker-ce-cli containerd.io # 这里我们使用社区版即可</p><p><strong>5.启动docker</strong><br>systemctl start docker</p><p><strong>6.使用docker version查看是否按照成功</strong><br>docker version</p><p><em><strong>7.运行 测试</strong></em> </p><p>docker run hello-world</p><p><img src="https://s2.loli.net/2022/02/24/Cs1Z2FX7DowY8TW.png" alt="image-20220224193452378"></p><p><strong>8.查看已经下载的镜像</strong>*</p><p> docker images</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">REPOSITORY    TAG       IMAGE ID       CREATED        SIZE</span><br><span class="line">hello-world   latest    feb5d9fea6a5   5 months ago   13.3kB</span><br></pre></td></tr></tbody></table></figure><h2 id="卸载-Docker-引擎"><a href="#卸载-Docker-引擎" class="headerlink" title="卸载 Docker 引擎"></a>卸载 Docker 引擎</h2><ol><li><p>卸载 Docker 引擎、CLI 和容器包：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo yum remove docker-ce docker-ce-cli containerd.io</span><br></pre></td></tr></tbody></table></figure></li><li><p>主机上的映像、容器、卷或自定义配置文件不会自动删除。删除所有映像、容器和卷：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo rm -rf /var/lib/docker</span><br><span class="line">$ sudo rm -rf /var/lib/containerd</span><br></pre></td></tr></tbody></table></figure></li></ol><p><strong>详细操作可前往官方文档</strong>：<a href="https://docs.docker.com/engine/install/centos/">在 CentOS | 上安装 Docker 引擎Docker 文档</a></p><h2 id="阿里云镜像加速"><a href="#阿里云镜像加速" class="headerlink" title="阿里云镜像加速"></a>阿里云镜像加速</h2><h4 id="1、登录阿里云找到容器服务"><a href="#1、登录阿里云找到容器服务" class="headerlink" title="1、登录阿里云找到容器服务"></a>1、登录阿里云找到容器服务</h4><p><img src="https://s2.loli.net/2022/02/25/AytG5wq8QXdF1s2.png" alt="image-20220225111541959"></p><h4 id="2、找到镜像加速器"><a href="#2、找到镜像加速器" class="headerlink" title="2、找到镜像加速器"></a>2、找到镜像加速器</h4><p><img src="https://s2.loli.net/2022/02/25/5azQ9w3N1bxfJH7.png" alt="image-20220225111602878"></p><h4 id="3、服务器输入命令"><a href="#3、服务器输入命令" class="headerlink" title="3、服务器输入命令"></a>3、服务器输入命令</h4><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-4-12-centos ~]# sudo mkdir -p /etc/docker</span><br><span class="line">[root@VM-4-12-centos ~]# sudo tee /etc/docker/daemon.json &lt;&lt;-'EOF'</span><br><span class="line">&gt; {</span><br><span class="line">&gt;   "registry-mirrors": ["https://g2lzbeju.mirror.aliyuncs.com"]</span><br><span class="line">&gt; }</span><br><span class="line">&gt; EOF</span><br><span class="line">{</span><br><span class="line">  "registry-mirrors": ["https://g2lzbeju.mirror.aliyuncs.com"]</span><br><span class="line">}</span><br><span class="line">[root@VM-4-12-centos ~]# sudo systemctl daemon-reload</span><br><span class="line">[root@VM-4-12-centos ~]# sudo systemctl restart docker</span><br><span class="line">[root@VM-4-12-centos ~]# </span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h2 id="回顾HelloWorld流程"><a href="#回顾HelloWorld流程" class="headerlink" title="回顾HelloWorld流程"></a>回顾HelloWorld流程</h2><p><img src="https://s2.loli.net/2022/02/24/Cs1Z2FX7DowY8TW.png" alt="image-20220224193452378"></p><p><strong>docker run 流程图</strong></p><p><img src="https://s2.loli.net/2022/02/25/cPxDYVWa1H7SM52.png" alt="image-20220225113537120"></p><h4 id="底层原理"><a href="#底层原理" class="headerlink" title="底层原理"></a>底层原理</h4><p>Docker<strong>是怎么工作的</strong>？</p><p>Docker是一个Client-Server结构的系统，Docker的守护进程运行在主机上。通过Socket从客户端访问！</p><p>Docker-Server接收到Docker-Client的指令，就会执行这个命令！</p><p><img src="https://s2.loli.net/2022/02/25/ro6lQCM2tay8Jn3.png" alt="image-20220225113632854"></p><p><strong>为什么Docker比Vm快</strong><br>1、docker有着比虚拟机更少的抽象层。由于docker不需要Hypervisor实现硬件资源虚拟化,运行在docker容器上的程序直接使用的都是实际物理机的硬件资源。因此在CPU、内存利用率上docker将会在效率上有明显优势。<br>2、docker利用的是宿主机的内核,而不需要Guest OS。</p><p><img src="https://s2.loli.net/2022/02/25/3RvSfCZEbDNpPX5.png" alt="image-20220225113728352"></p><p>因此,当新建一个 容器时,docker不需要和虚拟机一样重新加载一个操作系统内核。仍而避免引导、加载操作系统内核返个比较费时费资源的过程,当新建一个虚拟机时,虚拟机软件需要加载GuestOS,返个新建过程是分钟级别的。而docker由于直接利用宿主机的操作系统,则省略了这个复杂的过程,因此新建一个docker容器只需要几秒钟。</p>]]></content>
      
      
      <categories>
          
          <category> Docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 安装 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Docker是什么？</title>
      <link href="/2022/02/24/Docker%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F/"/>
      <url>/2022/02/24/Docker%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F/</url>
      
        <content type="html"><![CDATA[<p>注意：本片文章内容来自于狂神说，可以观看下这个up的视频，非常好！</p><p>链接：<a href="https://www.bilibili.com/video/BV1og4y1q7M4">https://www.bilibili.com/video/BV1og4y1q7M4</a></p><h1 id="Docker概述"><a href="#Docker概述" class="headerlink" title="Docker概述"></a>Docker概述</h1><h3 id="Docker为什么出现？"><a href="#Docker为什么出现？" class="headerlink" title="Docker为什么出现？"></a>Docker为什么出现？</h3><p>一款产品： 开发–上线 两套环境！应用环境，应用配置！</p><p>开发 — 运维。 问题：我在我的电脑上可以允许！版本更新，导致服务不可用！对于运维来说考验十分大？</p><p>环境配置是十分的麻烦，每一个及其都要部署环境(集群Redis、ES、Hadoop…) !费事费力。</p><p>发布一个项目( jar + (Redis MySQL JDK ES) ),项目能不能带上环境安装打包！</p><p>之前在服务器配置一个应用的环境 Redis MySQL JDK ES Hadoop 配置超麻烦了，不能够跨平台。</p><p>开发环境Windows，最后发布到Linux！</p><p>传统：开发jar，运维来做！</p><p>现在：开发打包部署上线，一套流程做完！</p><p>安卓流程：java — apk —发布（应用商店）一 张三使用apk一安装即可用！</p><p>docker流程： java-jar（环境） — 打包项目帯上环境（镜像） — ( Docker仓库：商店）—–</p><p>Docker给以上的问题，提出了解决方案！</p><p>Docker的思想就来自于集装箱！</p><p>JRE – 多个应用(端口冲突) – 原来都是交叉的！<br>隔离：Docker核心思想！打包装箱！每个箱子是互相隔离的。</p><p>Docker通过隔离机制，可以将服务器利用到极致！</p><p>本质：所有的技术都是因为出现了一些问题，我们需要去解决，才去学习！</p><h3 id="Docker历史"><a href="#Docker历史" class="headerlink" title="Docker历史"></a>Docker历史</h3><p>2010年，几个的年轻人，就在美国成立了一家公司 dotcloud</p><p>做一些pass的云计算服务！LXC（Linux Container容器）有关的容器技术！</p><p>Linux Container容器是一种内核虚拟化技术，可以提供轻量级的虚拟化，以便隔离进程和资源。</p><p>他们将自己的技术（容器化技术）命名就是 Docker<br>Docker刚刚延生的时候，没有引起行业的注意！dotCloud，就活不下去！</p><p>开源</p><p>2013年，Docker开源！</p><p>越来越多的人发现docker的优点！火了。Docker每个月都会更新一个版本！</p><p>2014年4月9日，Docker1.0发布！</p><p>docker为什么这么火？十分的轻巧！</p><p>在容器技术出来之前，我们都是使用虚拟机技术！</p><p>虚拟机：在window中装一个VMware，通过这个软件我们可以虚拟出来一台或者多台电脑！笨重！</p><p>虚拟机也属于虚拟化技术，Docker容器技术，也是一种虚拟化技术！</p><p>VMware : linux centos 原生镜像（一个电脑！） 隔离、需要开启多个虚拟机！ 几个G 几分钟<br>docker: 隔离，镜像（最核心的环境 4m + jdk + mysql）十分的小巧，运行镜像就可以了！小巧！ 几个M 秒级启动！</p><h3 id="聊聊Docker"><a href="#聊聊Docker" class="headerlink" title="聊聊Docker"></a>聊聊Docker</h3><p>Docker基于Go语言开发的！开源项目！</p><p>docker官网：<a href="https://www.docker.com/">https://www.docker.com/</a></p><p> Docker的文档是超级详细的！文档在docker官网的最下方：</p><p><img src="https://s2.loli.net/2022/02/24/iYNvP4oGl1ZSj5V.png" alt="image-20220224154846196"></p><p>仓库地址：<a href="https://hub.docker.com/">https://hub.docker.com/</a></p><h3 id="docker能干嘛"><a href="#docker能干嘛" class="headerlink" title="docker能干嘛"></a>docker能干嘛</h3><p>之前的虚拟机技术</p><p><img src="https://s2.loli.net/2022/02/24/3Via6qcNOtXrAwC.png" alt="image-20220224185404382"></p><p><strong>虚拟机技术缺点</strong>：</p><p>1、 资源占用十分多</p><p>2、 冗余步骤多</p><p>3、 启动很慢！</p><p><strong>容器化技术:</strong></p><p>容器化技术不是模拟一个完整的操作系统</p><p><img src="https://s2.loli.net/2022/02/24/g74EPewcJ2AdUI5.png" alt="image-20220224185514616"></p><p>比较Docker和虚拟机技术的不同：</p><p>传统虚拟机，虚拟出一条硬件，运行一个完整的操作系统，然后在这个系统上安装和运行软件<br>容器内的应用直接运行在宿主机的内容，容器是没有自己的内核的，也没有虚拟我们的硬件，所以就轻便了<br>每个容器间是互相隔离，每个容器内都有一个属于自己的文件系统，互不影响</p><p><strong>DevOps（开发、运维）</strong></p><p>应用更快速的交付和部署</p><p>传统：一对帮助文档，安装程序。</p><p>Docker：打包镜像发布测试一键运行。</p><p>更便捷的升级和扩缩容</p><p>使用了 Docker之后，我们部署应用就和搭积木一样<br>项目打包为一个镜像，扩展服务器A！服务器B</p><p>更简单的系统运维<br>在容器化之后，我们的开发，测试环境都是高度一致的</p><p>更高效的计算资源利用</p><h3 id="Docker的基本组成"><a href="#Docker的基本组成" class="headerlink" title="Docker的基本组成"></a>Docker的基本组成</h3><p><img src="https://s2.loli.net/2022/02/24/ZtYGvPUMqJED5mH.png" alt="image-20220224190512639"></p><p><strong>镜像（image)：</strong></p><p>docker镜像就好比是一个目标，可以通过这个目标来创建容器服务，tomcat镜像==&gt;run==&gt;容器（提供服务器），通过这个镜像可以创建多个容器（最终服务运行或者项目运行就是在容器中的）。</p><p><strong>容器(container)：</strong></p><p>Docker利用容器技术，独立运行一个或者一组应用，通过镜像来创建的.<br>启动，停止，删除，基本命令<br>目前就可以把这个容器理解为就是一个简易的 Linux系统。</p><p><strong>仓库(repository)：</strong></p><p>仓库就是存放镜像的地方！<br>仓库分为公有仓库和私有仓库。(很类似git)<br>Docker Hub是国外的。<br>阿里云…都有容器服务器(配置镜像加速!)</p>]]></content>
      
      
      <categories>
          
          <category> Docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 介绍 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Redis哨兵模式</title>
      <link href="/2022/02/24/Redis%E5%93%A8%E5%85%B5%E6%A8%A1%E5%BC%8F/"/>
      <url>/2022/02/24/Redis%E5%93%A8%E5%85%B5%E6%A8%A1%E5%BC%8F/</url>
      
        <content type="html"><![CDATA[<h1 id="Redis哨兵模式"><a href="#Redis哨兵模式" class="headerlink" title="Redis哨兵模式"></a>Redis哨兵模式</h1><p><strong>介绍：</strong></p><p>主从切换技术的方法是:当主服务器宕机后，需要手动把一台从服务器切换为主服务器，这就需要人工干预，费事费力，还会造成一段时间内服务不可用。这不是一种推荐的方式，更多时候，我们优先考虑哨兵模式。Redis从2.8开始正式提供了Sentinel (哨兵）架构来解决这个问题。</p><p>谋朝篡位的自动版，能够后台监控主机是否故障，如果故障了根据投票数<strong>自动将从库转换为主库</strong>。</p><p>哨兵模式是一种特殊的模式，首先Redis提供了哨兵的命令，哨兵是一个独立的进程，作为进程，它会独立运行。其原理是<strong>哨兵通过发送命令,等待Redis服务器响应，从而监控运行的多个Redis实例。</strong></p><p><img src="https://s2.loli.net/2022/02/23/SJBvaebKFPW6Lxs.png" alt="image-20220223160951455"></p><p>这里的哨兵有两个作用<br>·通过发送命令，让Redis服务器返回监控其运行状态，包括主服务器和从服务器。<br>·当哨兵监测到master宕机，会自动将slave切换成master，然后通过发布订阅模式通知其他的从服务器，修改配置文件，让它<br>们切换主机。<br>然而一个哨兵进程对Redis服务器进行监控，可能会出现问题，为此，我们可以使用多个哨兵进行监控。各个哨兵之间还会进行监控，这样就形成了多哨兵模式。</p><p><img src="https://s2.loli.net/2022/02/23/cSP9LAlOKHjoTfX.png" alt="image-20220223161321009"></p><p>假设主服务器宕机，哨兵1先检测到这个结果，系统并不会马上进行failover过程，仅仅是哨兵1主观的认为主服务器不可用，这个现象成为<strong>主观下线</strong>。当后面的哨兵也检测到主服务器不可用，并且数量达到一定值时，那么哨兵之间就会进行一次投票，投票的结果由一个哨兵发起，进行failover[故障转移]操作。切换成功后，就会通过发布订阅模式，让各个哨兵把自己监控的从服务器实现切换主机,这个过程称为<strong>客观下线</strong>。</p><h2 id="测试："><a href="#测试：" class="headerlink" title="测试："></a>测试：</h2><p>创建一个哨兵的一个配置文件，文件名随意：sentinel.conf </p><p>配置文件：这里我就配置简单点</p><pre class="line-numbers language-none"><code class="language-none">sentinel monitor mymaster 127.0.0.1 6379 1<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><strong>正常的一主二从:</strong></p><pre class="line-numbers language-none"><code class="language-none"># Replicationrole:masterconnected_slaves:2slave0:ip=127.0.0.1,port=6362,state=online,offset=141888,lag=1slave1:ip=127.0.0.1,port=6361,state=online,offset=141888,lag=1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>启动哨兵模式：</strong></p><p><img src="https://s2.loli.net/2022/02/23/7OSxgQsbL6nyFRi.png" alt="image-20220223165032216"></p><p>命令：redis-sentinel  选用的配置文件，如果是哨兵集群就需要多个配置文件</p><pre class="line-numbers language-none"><code class="language-none">[root@VM-4-12-centos StudyHardConfig]# redis-sentinel sentinel.conf 742116:X 23 Feb 2022 16:29:48.399 # oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo742116:X 23 Feb 2022 16:29:48.399 # Redis version=6.0.6, bits=64, commit=00000000, modified=0, pid=742116, just started742116:X 23 Feb 2022 16:29:48.399 # Configuration loaded                _._                                                             _.-``__ ''-._                                                   _.-``    `.  `_.  ''-._           Redis 6.0.6 (00000000/0) 64 bit  .-`` .-```.  ```\/    _.,_ ''-._                                    (    '      ,       .-`  | `,    )     Running in sentinel mode |`-._`-...-` __...-.``-._|'` _.-'|     Port: 26379   #哨兵端口 |    `-._   `._    /     _.-'    |     PID: 742116    `-._    `-._  `-./  _.-'    _.-'                                    |`-._`-._    `-.__.-'    _.-'_.-'|                                   |    `-._`-._        _.-'_.-'    |           http://redis.io          `-._    `-._`-.__.-'_.-'    _.-'                                    |`-._`-._    `-.__.-'    _.-'_.-'|                                   |    `-._`-._        _.-'_.-'    |                                    `-._    `-._`-.__.-'_.-'    _.-'                                         `-._    `-.__.-'    _.-'                                                 `-._        _.-'                                                         `-.__.-'                                               742116:X 23 Feb 2022 16:29:48.404 # Sentinel ID is d0592a16972e6c88a456c5c2969cf4141a0e2f07742116:X 23 Feb 2022 16:29:48.404 # +monitor master mymaster 127.0.0.1 6360 quorum 1#侦测到两个从节点，并表明主节点是谁，现在主节点表明的6360这个端口的redis742116:X 23 Feb 2022 16:29:48.404 * +slave slave 127.0.0.1:6362 127.0.0.1 6362 @ mymaster 127.0.0.1 6360742116:X 23 Feb 2022 16:29:48.408 * +slave slave 127.0.0.1:6361 127.0.0.1 6361 @ mymaster 127.0.0.1 6360<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>断供主节点，让哨兵自动选择一个从节点当主节点：</strong> </p><p>如果master节点断开了，这个时候就会从 从机中随机选择一个服务器（根据一个投票算法）</p><p>哨兵打印的新信息：</p><p>这里投票，选择6362当主节点</p><pre class="line-numbers language-none"><code class="language-none">Feb 2022 16:37:29.007 # +sdown master mymaster 127.0.0.1 6360742116:X 23 Feb 2022 16:37:29.007 # +odown master mymaster 127.0.0.1 6360 #quorum 1/1742116:X 23 Feb 2022 16:37:29.007 # +new-epoch 1742116:X 23 Feb 2022 16:37:29.007 # +try-failover master mymaster 127.0.0.1 6360742116:X 23 Feb 2022 16:37:29.011 # +vote-for-leader d0592a16972e6c88a456c5c2969cf4141a0e2f07 1742116:X 23 Feb 2022 16:37:29.011 # +elected-leader master mymaster 127.0.0.1 6360742116:X 23 Feb 2022 16:37:29.011 # +failover-state-select-slave master mymaster 127.0.0.1 6360742116:X 23 Feb 2022 16:37:29.066 # +selected-slave slave 127.0.0.1:6362 127.0.0.1 6362 @ mymaster 127.0.0.1 6360742116:X 23 Feb 2022 16:37:29.066 * +failover-state-send-slaveof-noone slave 127.0.0.1:6362 127.0.0.1 6362 @ mymaster 127.0.0.1 6360742116:X 23 Feb 2022 16:37:29.138 * +failover-state-wait-promotion slave 127.0.0.1:6362 127.0.0.1 6362 @ mymaster 127.0.0.1 6360742116:X 23 Feb 2022 16:37:29.419 # +promoted-slave slave 127.0.0.1:6362 127.0.0.1 6362 @ mymaster 127.0.0.1 6360742116:X 23 Feb 2022 16:37:29.420 # +failover-state-reconf-slaves master mymaster 127.0.0.1 6360742116:X 23 Feb 2022 16:37:29.498 * +slave-reconf-sent slave 127.0.0.1:6361 127.0.0.1 6361 @ mymaster 127.0.0.1 6360742116:X 23 Feb 2022 16:37:30.445 * +slave-reconf-inprog slave 127.0.0.1:6361 127.0.0.1 6361 @ mymaster 127.0.0.1 6360742116:X 23 Feb 2022 16:37:30.445 * +slave-reconf-done slave 127.0.0.1:6361 127.0.0.1 6361 @ mymaster 127.0.0.1 6360742116:X 23 Feb 2022 16:37:30.529 # +failover-end master mymaster 127.0.0.1 6360  #故障切换主线742116:X 23 Feb 2022 16:37:30.529 # +switch-master mymaster 127.0.0.1 6360 127.0.0.1 6362   #这里依旧选择了6362来当主节点742116:X 23 Feb 2022 16:37:30.529 * +slave slave 127.0.0.1:6361 127.0.0.1 6361 @ mymaster 127.0.0.1 6362742116:X 23 Feb 2022 16:37:30.529 * +slave slave 127.0.0.1:6360 127.0.0.1 6360 @ mymaster 127.0.0.1 6362742116:X 23 Feb 2022 16:38:00.593 # +sdown slave 127.0.0.1:6360 127.0.0.1 6360 @ mymaster 127.0.0.1 6362<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>我们来看看6362信息：</p><pre class="line-numbers language-none"><code class="language-none">127.0.0.1:6362&gt;  SLAVEOF 127.0.0.1 6360OK Already connected to specified master127.0.0.1:6362&gt; info replication# Replicationrole:master   #身份依旧是主节点了connected_slaves:1slave0:ip=127.0.0.1,port=6361,state=online,offset=191774,lag=1master_replid:01fa8e86c3fa6a51f5c111e46ef4e8622d062f23master_replid2:8009003a269bcd5e8af84c76891fc4bdc72dbf10master_repl_offset:191774second_repl_offset:170703repl_backlog_active:1repl_backlog_size:1048576repl_backlog_first_byte_offset:1repl_backlog_histlen:191774127.0.0.1:6362&gt; <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如果这时6360这个节点重启呢？</p><p>​    如果主机此时回来了，只能归并到新的主机下，当做从机，这就是哨兵模式的规则!</p><p>​    6362：  可以看到 它变成从节点，哨兵也同样会打印信息，我就不打出来了</p><pre class="line-numbers language-none"><code class="language-none">127.0.0.1:6362&gt; info replication# Replicationrole:masterconnected_slaves:2slave0:ip=127.0.0.1,port=6361,state=online,offset=198720,lag=1slave1:ip=127.0.0.1,port=6360,state=online,offset=198720,lag=0master_replid:01fa8e86c3fa6a51f5c111e46ef4e8622d062f23master_replid2:8009003a269bcd5e8af84c76891fc4bdc72dbf10master_repl_offset:198720second_repl_offset:170703repl_backlog_active:1repl_backlog_size:1048576repl_backlog_first_byte_offset:1repl_backlog_histlen:198720127.0.0.1:6362&gt; <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>全部配置信息：</strong></p><pre class="line-numbers language-none"><code class="language-none"># Example sentinel.conf# 哨兵sentinel实例运行的端口 默认26379port 26379# 哨兵sentinel的工作目录dir /tmp# 哨兵sentinel监控的redis主节点的 ip port# master-name 可以自己命名的主节点名字 只能由字母A-z、数字0-9 、这三个字符".-_"组成。# quorum 配置多少个sentinel哨兵统一认为master主节点失联 那么这时客观上认为主节点失联了# sentinel monitor &lt;master-name&gt; &lt;ip&gt; &lt;redis-port&gt; &lt;quorum&gt;sentinel monitor mymaster 127.0.0.1 6379 2# 当在Redis实例中开启了requirepass foobared 授权密码 这样所有连接Redis实例的客户端都要提供密码# 设置哨兵sentinel 连接主从的密码 注意必须为主从设置一样的验证密码# sentinel auth-pass &lt;master-name&gt; &lt;password&gt;sentinel auth-pass mymaster MySUPER--secret-0123passw0rd# 指定多少毫秒之后 主节点没有应答哨兵sentinel 此时 哨兵主观上认为主节点下线 默认30秒# sentinel down-after-milliseconds &lt;master-name&gt; &lt;milliseconds&gt;sentinel down-after-milliseconds mymaster 30000# 这个配置项指定了在发生failover主备切换时最多可以有多少个slave同时对新的master进行 同步，这个数字越小，完成failover所需的时间就越长，但是如果这个数字越大，就意味着越 多的slave因为replication而不可用。可以通过将这个值设为 1 来保证每次只有一个slave 处于不能处理命令请求的状态。# sentinel parallel-syncs &lt;master-name&gt; &lt;numslaves&gt;sentinel parallel-syncs mymaster 1# 故障转移的超时时间 failover-timeout 可以用在以下这些方面：#1. 同一个sentinel对同一个master两次failover之间的间隔时间。#2. 当一个slave从一个错误的master那里同步数据开始计算时间。直到slave被纠正为向正确的master那里同步数据时。#3.当想要取消一个正在进行的failover所需要的时间。 #4.当进行failover时，配置所有slaves指向新的master所需的最大时间。不过，即使过了这个超时，slaves依然会被正确配置为指向master，但是就不按parallel-syncs所配置的规则来了# 默认三分钟# sentinel failover-timeout &lt;master-name&gt; &lt;milliseconds&gt;sentinel failover-timeout mymaster 180000# SCRIPTS EXECUTION#配置当某一事件发生时所需要执行的脚本，可以通过脚本来通知管理员，例如当系统运行不正常时发邮件通知相关人员。#对于脚本的运行结果有以下规则：#若脚本执行后返回1，那么该脚本稍后将会被再次执行，重复次数目前默认为10#若脚本执行后返回2，或者比2更高的一个返回值，脚本将不会重复执行。#如果脚本在执行过程中由于收到系统中断信号被终止了，则同返回值为1时的行为相同。#一个脚本的最大执行时间为60s，如果超过这个时间，脚本将会被一个SIGKILL信号终止，之后重新执行。#通知型脚本:当sentinel有任何警告级别的事件发生时（比如说redis实例的主观失效和客观失效等等），将会去调用这个脚本，这时这个脚本应该通过邮件，SMS等方式去通知系统管理员关于系统不正常运行的信息。调用该脚本时，将传给脚本两个参数，一个是事件的类型，一个是事件的描述。如果sentinel.conf配置文件中配置了这个脚本路径，那么必须保证这个脚本存在于这个路径，并且是可执行的，否则sentinel无法正常启动成功。#通知脚本# shell编程# sentinel notification-script &lt;master-name&gt; &lt;script-path&gt;sentinel notification-script mymaster /var/redis/notify.sh# 客户端重新配置主节点参数脚本# 当一个master由于failover而发生改变时，这个脚本将会被调用，通知相关的客户端关于master地址已经发生改变的信息。# 以下参数将会在调用脚本时传给脚本:# &lt;master-name&gt; &lt;role&gt; &lt;state&gt; &lt;from-ip&gt; &lt;from-port&gt; &lt;to-ip&gt; &lt;to-port&gt;# 目前&lt;state&gt;总是“failover”,# &lt;role&gt;是“leader”或者“observer”中的一个。# 参数 from-ip, from-port, to-ip, to-port是用来和旧的master和新的master(即旧的slave)通信的# 这个脚本应该是通用的，能被多次调用，不是针对性的。# sentinel client-reconfig-script &lt;master-name&gt; &lt;script-path&gt;sentinel client-reconfig-script mymaster /var/redis/reconfig.sh # 一般都是由运维来配置！<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="哨兵模式优缺点："><a href="#哨兵模式优缺点：" class="headerlink" title="哨兵模式优缺点："></a>哨兵模式优缺点：</h2><p>哨兵模式<br>优点︰<br>1、哨兵集群，基于主从复制模式，所有的主从配置优点，它全有2、主从可以切接，故障可以转移﹐系统的可用性就会史好3、哨兵模式就是主从模式的升级，手动到自动，更加建壮!缺点:</p><ol><li>Redis不好啊在。扩容的,集群容量一旦到达上限，在线扩容就十分麻烦!2、实现哨兵模式的配置只实是很麻烦的，里面有很多选择!</li></ol>]]></content>
      
      
      <categories>
          
          <category> redis </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据库 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>redis集群（主从复制）</title>
      <link href="/2022/02/21/redis%E9%9B%86%E7%BE%A4%EF%BC%88%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%EF%BC%89/"/>
      <url>/2022/02/21/redis%E9%9B%86%E7%BE%A4%EF%BC%88%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%EF%BC%89/</url>
      
        <content type="html"><![CDATA[<h1 id="Redis主从复制："><a href="#Redis主从复制：" class="headerlink" title="Redis主从复制："></a>Redis主从复制：</h1><h2 id="Redis主从复制概念"><a href="#Redis主从复制概念" class="headerlink" title="Redis主从复制概念"></a>Redis主从复制概念</h2><p>主从复制,是指将一台Redis服务器的数据，复制到其他的Redis服务器。前者称为主节点(master/leader)，后者称为从节点(slave/follower);数据的复制是单向的，只能由主节点到从节点。Master以写为主，Slave以读为主。</p><p>默认情况下，每台Redis服务器都是主节点;且一个主节点可以有多个从节点(或没有从节点)，但一个从节点只能有一个主节点。主从复制的作用主要包括:</p><p>1、数据冗余:主从复制实现了数据的热备份,是持久化之外的一种数据冗余方式。</p><p>2、故障恢复:当主节点出现问题时，可以由从节点提供服务，实现快速的故障恢复;实际上是一种服务的冗余。</p><p>3、负载均衡:在主从复制的基础上，配合读写分离，可以由主节点提供写服务，由从节点提供读服务（即写Redis数据时应用连教主节点，读Redis数据时应用连接从节点)，分担服务器负载;尤其是在写少读多的场景下，通过多个从节点分担读负载，可以大大提高Redis服务器的并发量。</p><p>4、高可用(集群)基石:除了上述作用以外，主从复制还是哨兵和集群能够实施的基础，因此说主从复制是Redis高可用的基础.<br>一般来说，要将Redis运用于工程项目中，只使用一台Redis是万万不能的（宕机），原因如下:</p><p>​    1、从结构上，单个Redis服务器会发生单点故障，并且一台服务器需要处理所有的请求负载，压力较大;<br>​    </p><p>​    2、从容量上，单个Redis服务器内存容量有限，就算一台Redis服务器内存容量为256G，也不能将所有内存用作Redis存储内存，一般来说，单台Redis最大使用    内存不应该超过20G。</p><p>​    电商网站上的商品，一般都是一次上传，无数次浏览的，说专业点也就是”多读少写”。对于这种场景，我们可以使如下这种架构:</p><p>​    这是一主三从</p><p><img src="https://s2.loli.net/2022/02/21/UTkJjV2ZfAeiNrE.png" alt="image-20220221153646023"></p><p>​     3、负载均衡:在主从复制的基础上，配合读写分离，可以由主节点提供写服务，由从节点提供读服务（即写Redis数据时应用连教主节点，读Redis数据时应用连    接 从节点)，分担服务器负载;尤其是在写少读多的场景下，通过多个从节点分担读负载，可以大大提高Redis服务器的并发量。</p><h2 id="一主二从："><a href="#一主二从：" class="headerlink" title="一主二从："></a>一主二从：</h2><p>由于没有多个服务器，就在本机上多开几个redis，当端口什么都不一样，如果在一台服务器是测试：</p><p>在一个主机上测试需要多个配置文件，并且配置文件需要修改</p><p>port     端口</p><p>pidfile   名字</p><p>log   log文件名字</p><p>dump.rdb   名字</p><p>如果开了aof还需要修改aof的配置</p><p>开启三个服务</p><p><strong>查看当前redis</strong></p><p><img src="https://s2.loli.net/2022/02/21/g2UXIiE6lrMvcG5.png" alt="image-20220221235035363"></p><p><strong>默认情况下，每台redis服务器都是主节点</strong>；一般情况下我们只需要配置从机就可以了！</p><p><strong>设置从机:</strong></p><p>注意，认主需要在从机是去认，而不是主机</p><p>我们需要在redis中去设置主机是谁，也就是认老大。假设  主为（6360），二从为（61，62）；</p><p>使用命令：SLAVEOF    IP   端口   ；这就是找谁当老大，这里只演示连接一个，另一个自己去连</p><pre class="line-numbers language-none"><code class="language-none">127.0.0.1:6362&gt; SLAVEOF 127.0.0.1 6360OK127.0.0.1:6362&gt; info replication# Replicationrole:slave      #角色从 master  变成了 slavemaster_host:127.0.0.1    #主机IPmaster_port:6360#主机端口master_link_status:upmaster_last_io_seconds_ago:6master_sync_in_progress:0slave_repl_offset:28slave_priority:100slave_read_only:1connected_slaves:0master_replid:7f946868186fe88c13209f6a40cb8a41349df88cmaster_replid2:0000000000000000000000000000000000000000master_repl_offset:28second_repl_offset:-1repl_backlog_active:1repl_backlog_size:1048576repl_backlog_first_byte_offset:1repl_backlog_histlen:28127.0.0.1:6362&gt; <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>查看下主机的身份信息:</strong></p><pre class="line-numbers language-none"><code class="language-none">127.0.0.1:6360&gt; info replication# Replicationrole:master    #角色connected_slaves:2   #从机数量slave0:ip=127.0.0.1,port=6362,state=online,offset=630,lag=0   #从机基本信息slave1:ip=127.0.0.1,port=6361,state=online,offset=630,lag=1   #从机基本信息master_replid:7f946868186fe88c13209f6a40cb8a41349df88cmaster_replid2:0000000000000000000000000000000000000000master_repl_offset:630second_repl_offset:-1repl_backlog_active:1repl_backlog_size:1048576repl_backlog_first_byte_offset:1repl_backlog_histlen:630127.0.0.1:6360&gt; <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>读写与特殊情况演示：</strong></p><p>主机复制些，而从机负责读，尽管主机宕机，从机依旧可以继续读到数据，</p><p><strong>使用主机写：</strong></p><pre class="line-numbers language-none"><code class="language-none">127.0.0.1:6360&gt; set key 1OK       #成功<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><strong>使用从机读：</strong></p><pre class="line-numbers language-none"><code class="language-none">127.0.0.1:6362&gt; get key"1"    #成功<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><strong>使用从机写：</strong></p><pre class="line-numbers language-none"><code class="language-none">127.0.0.1:6362&gt; set key1 v1(error) READONLY You can't write against a read only replica.     #不能对只读从机写<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><strong>关闭主机  从机是否还能进行读：</strong></p><pre class="line-numbers language-none"><code class="language-none">[root@VM-4-12-centos ~]# ps -ef|grep redis     #现在么有主机6360了root      304584  304199  0 11:38 pts/1    00:00:00 redis-cli -p 6361root      304652  304153  0 11:38 pts/0    00:00:00 redis-cli -p 6362root      312884  304314  0 12:11 pts/2    00:00:00 grep --color=auto redisroot     4193030       1  0 Feb21 ?        00:00:47 redis-server 0.0.0.0:6361root     4193050       1  0 Feb21 ?        00:00:47 redis-server 0.0.0.0:6362[root@VM-4-12-centos ~]# <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>关闭主机情况下进行读：</strong></p><pre class="line-numbers language-none"><code class="language-none">127.0.0.1:6362&gt; get key"1"   #依旧成功<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><strong>主机关闭后的角色基本信息</strong></p><pre class="line-numbers language-none"><code class="language-none">127.0.0.1:6362&gt; info replication# Replicationrole:slavemaster_host:127.0.0.1master_port:6360master_link_status:downmaster_last_io_seconds_ago:-1master_sync_in_progress:0slave_repl_offset:1396master_link_down_since_seconds:125slave_priority:100slave_read_only:1connected_slaves:0master_replid:7f946868186fe88c13209f6a40cb8a41349df88cmaster_replid2:0000000000000000000000000000000000000000master_repl_offset:1396second_repl_offset:-1repl_backlog_active:1repl_backlog_size:1048576repl_backlog_first_byte_offset:1repl_backlog_histlen:1396<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>主机重启后写的值是否还能被从机读取到</strong></p><pre class="line-numbers language-none"><code class="language-none">#主机[root@VM-4-12-centos ~]# redis-server /usr/local/bin/StudyHardConfig/redis60.conf [root@VM-4-12-centos ~]# redis-cli -p 6360127.0.0.1:6360&gt; pingPONG127.0.0.1:6360&gt; set key3 v3OK127.0.0.1:6360&gt; <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-none"><code class="language-none">#从机  依旧可以读取到127.0.0.1:6362&gt; get key3"v3"       #成功<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><strong>从机关机的情况下</strong></p><p>可看出从机必须连接主机后才能拿到数据，并且关机后会恢复成主机</p><pre class="line-numbers language-none"><code class="language-none">[root@VM-4-12-centos ~]# ps -ef|grep redisroot      304652  304153  0 11:38 pts/0    00:00:00 redis-cli -p 6362root      313867       1  0 12:15 ?        00:00:01 redis-server 0.0.0.0:6360root      313941  304314  0 12:15 pts/2    00:00:00 redis-cli -p 6360root      318505  304199  0 12:33 pts/1    00:00:00 grep --color=auto redisroot     4193050       1  0 Feb21 ?        00:00:48 redis-server 0.0.0.0:6362[root@VM-4-12-centos ~]# redis-server /usr/local/bin/StudyHardConfig/redis61.conf [root@VM-4-12-centos ~]# redis-cli -p 6361127.0.0.1:6361&gt; pingPONG127.0.0.1:6361&gt; get key(nil)127.0.0.1:6361&gt; keys *(empty array)127.0.0.1:6361&gt; info replication# Replicationrole:masterconnected_slaves:0master_replid:f8962d2e0a43dc37e21770cc7a27e3b7664dbb72master_replid2:0000000000000000000000000000000000000000master_repl_offset:0second_repl_offset:-1repl_backlog_active:0repl_backlog_size:1048576repl_backlog_first_byte_offset:0repl_backlog_histlen:0127.0.0.1:6361&gt; SLAVEOF 127.0.0.1 6360OK127.0.0.1:6361&gt; keys *1) "key3"127.0.0.1:6361&gt; get key3"v3"127.0.0.1:6361&gt; <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>注意：这种命令行的主从设置是一次性的，关机后就会恢复成主机，想要永久设置需要去配置文件中配置；</p><p>#replicaof <masterip> <masterport>      //在配置文件中将该配置注释去掉，并填写上主机的ip 与端口</masterport></masterip></p><p>如果主机有密码：</p><p>#masterauth <master-password>        //在配置文件中将该配置注释去掉，并填写主机密码</master-password></p><p><strong>主从复制原理</strong></p><p>Slave启动成功连接到master后会发送一个sync同步命令<br>Master接到命令，启动后台的存盘进程，同时收集所有接收到的用于修改数据集命令，在后台进程执行完毕之后，master将传送整个数据文件到slave，并完成一次完全同步。<br>全量复制:而slave服务在接收到数据库文件数据后,将其存盘并加载到内存中。增量复制:Master继续将新的所有收集到的修改命令依次传给slave，完成同步<br>但是只要是重新连接master，一次完全同步(全量复制）将被自动执行!我们的数据一定可以在从机中看到!</p><p>还有一种主从方式，</p><p>a  – b  – c   这种连接方式，a宕机了我们可以手动将b选为老大，</p><p>命令：SLAVEOF no one   ； 这样将原来是从节点的redis改为主节点</p><p>这里都是手动的；而哨兵模式就是自动选取老大</p>]]></content>
      
      
      
        <tags>
            
            <tag> 集群 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>redis总笔记</title>
      <link href="/2022/02/21/redis%E6%80%BB%E7%AC%94%E8%AE%B0/"/>
      <url>/2022/02/21/redis%E6%80%BB%E7%AC%94%E8%AE%B0/</url>
      
        <content type="html"><![CDATA[<p>这个博主的redis会比较详细，可以去观看它的，还有可以去看看它的视频</p><p>博主：狂神说</p><p><a href="https://www.cnblogs.com/meditation5201314/p/14882992.htm">https://www.cnblogs.com/meditation5201314/p/14882992.htm</a></p><p><strong>发布订阅简单使用：</strong></p><p><img src="https://s2.loli.net/2022/02/21/CilvKd8sFBtSJo9.png" alt="image-20220221140950917"></p>]]></content>
      
      
      
        <tags>
            
            <tag> 优秀文章 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用jedis操作Redis</title>
      <link href="/2022/02/21/%E4%BD%BF%E7%94%A8jedis%E6%93%8D%E4%BD%9CRedis/"/>
      <url>/2022/02/21/%E4%BD%BF%E7%94%A8jedis%E6%93%8D%E4%BD%9CRedis/</url>
      
        <content type="html"><![CDATA[<h2 id="使用jedis操作Redis"><a href="#使用jedis操作Redis" class="headerlink" title="使用jedis操作Redis"></a>使用jedis操作Redis</h2><p>Jedis是redis推荐的java连接工具</p><h2 id="如何使用："><a href="#如何使用：" class="headerlink" title="如何使用："></a>如何使用：</h2><h3 id="第一步：导入依赖包"><a href="#第一步：导入依赖包" class="headerlink" title="## 第一步：导入依赖包"></a>## 第一步：导入依赖包</h3><p><strong>Jedis的依赖包</strong></p><pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>redis.clients<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>jedis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.6.3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>fastjson依赖包</strong>（1.6.7版本以上都以修复了漏洞）</p><pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>fastjson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.2.78<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="第二步：测试能否连接"><a href="#第二步：测试能否连接" class="headerlink" title="第二步：测试能否连接"></a>第二步：测试能否连接</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token namespace">redis<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>jedis<span class="token punctuation">.</span></span><span class="token class-name">Jedis</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestPing</span> <span class="token punctuation">{</span> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//Jedis有不同的构造方法，常用的是使用 ip+端口的这个构造器 Jedis jedis = new Jedis("124.223.79.104",6379); //这是输入密码，有设置密码才需要使用当前方法，没有设置密码不需要 jedis.auth("031215"); System.out.println(jedis.ping()); //使用完后关闭连接 jedis.close(); } }</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>结果如果是输入打印PONG则表示ping成功了！</p><h2 id="第三步：使用"><a href="#第三步：使用" class="headerlink" title="第三步：使用"></a>第三步：使用</h2><p>使用就和使用命令一样 hash类型示例：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>jedis<span class="token punctuation">.</span><span class="token function">flushDB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> map<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"k1"</span><span class="token punctuation">,</span><span class="token string">"v1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"k2"</span><span class="token punctuation">,</span><span class="token string">"v2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>jedis<span class="token punctuation">.</span><span class="token function">hset</span><span class="token punctuation">(</span><span class="token string">"hash"</span><span class="token punctuation">,</span>map<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>jedis<span class="token punctuation">.</span><span class="token function">hget</span><span class="token punctuation">(</span><span class="token string">"hash"</span><span class="token punctuation">,</span> <span class="token string">"k1"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>jedis<span class="token punctuation">.</span><span class="token function">hkeys</span><span class="token punctuation">(</span><span class="token string">"hash"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="使用事务"><a href="#使用事务" class="headerlink" title="使用事务"></a>使用事务</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//开启事务</span>   <span class="token class-name">Transaction</span> multi <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">multi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token keyword">try</span> <span class="token punctuation">{</span>       <span class="token class-name">JSONObject</span> jsonObject <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JSONObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       jsonObject<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span><span class="token string">"dog"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       jsonObject<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"age"</span><span class="token punctuation">,</span><span class="token string">"2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token class-name">String</span> s <span class="token operator">=</span> jsonObject<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>       multi<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"key1"</span><span class="token punctuation">,</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">//提交</span>       multi<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>       <span class="token comment">//如果出现异常就放弃当前事务</span>       multi<span class="token punctuation">.</span><span class="token function">discard</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>       jedis<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> redis </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 使用 </tag>
            
            <tag> 整合 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Redis事务</title>
      <link href="/2022/02/21/Redis%E4%BA%8B%E5%8A%A1/"/>
      <url>/2022/02/21/Redis%E4%BA%8B%E5%8A%A1/</url>
      
        <content type="html"><![CDATA[<h2 id="Redis事务"><a href="#Redis事务" class="headerlink" title="Redis事务"></a>Redis事务</h2><p>Redis事务本质：一组命令的集合！一个事务中的所有命令都会被序列号，在事务执行过程中，会按照顺序执行！ 一次性，顺序性，排他性！执行一些列的命令！</p><p><strong>Redis事务没有隔离级别的概念！</strong> 所有的命令在事务中，并没有直接被执行！只有发起执行命令的时候才会执行（Exec）</p><p><strong>Redis单条命令式保存原则性的，但是事务不保证原子性！</strong> 在事务中，就算中途发生错误后面的命令依旧会执行</p><p><strong>redis的事务：</strong> 1，开启命令（multi） 2，命令入队(…) 3，执行事务(exec) 4,退出事务（DISCARD）</p><p><strong>正常使用事务</strong></p><pre class="line-numbers language-none"><code class="language-none">127.0.0.1:6379&gt; multiOK127.0.0.1:6379&gt; set key1 value1QUEUED127.0.0.1:6379&gt; set key2 value2QUEUED127.0.0.1:6379&gt; LPUSH list 1QUEUED127.0.0.1:6379&gt; exec1) OK2) OK3) (integer) 1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>退出事务</strong></p><pre class="line-numbers language-none"><code class="language-none">127.0.0.1:6379&gt; multiOK127.0.0.1:6379&gt; set key aaQUEUED127.0.0.1:6379&gt; DISCARDOK127.0.0.1:6379&gt; <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>编译型异常（代码有问题！命令有错！），事务中所有的命令都不会执行！</strong></p><pre class="line-numbers language-none"><code class="language-none">127.0.0.1:6379&gt; multiOK127.0.0.1:6379&gt; set s1 v1QUEUED127.0.0.1:6379&gt; getset sss(error) ERR wrong number of arguments for 'getset' command127.0.0.1:6379&gt; set s2 v2QUEUED127.0.0.1:6379&gt; exec(error) EXECABORT Transaction discarded because of previous errors.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>运行时异常（如果出现错误会打印出来，但并不妨碍接下来的命令执行）</strong></p><pre class="line-numbers language-none"><code class="language-none">127.0.0.1:6379&gt; set key1 v1OK127.0.0.1:6379&gt; multiOK127.0.0.1:6379&gt; incr key1   #加1QUEUED127.0.0.1:6379&gt; set key2 v2QUEUED127.0.0.1:6379&gt; get key2QUEUED127.0.0.1:6379&gt; exec1) (error) ERR value is not an integer or out of range2) OK3) "v2"127.0.0.1:6379&gt; <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="使用乐观锁"><a href="#使用乐观锁" class="headerlink" title="使用乐观锁"></a>使用乐观锁</h3><p>使用watch可充当乐观锁</p><pre class="line-numbers language-none"><code class="language-none">watch key  #选择要监控的keyunwatch   #当执行失败时放弃监视，并重新监视执行失败是因为值改变了，所以需要重新监视<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>实际这部分是接着事务那一块，加了一个watch命令。</p><p>这里要有一个乐观锁和悲观锁的概念：<br>悲观锁：</p><p>很悲观，认为什么时候都会出现问题，无论做什么都会加锁</p><p>乐观锁：</p><p>很乐观，认为什么时候都不会出现问题，所以不会上锁！更新数据的时候去判断一下，在此期间是否有人修改过这个数据<br>获取version<br>更新的时候比较version</p><p>watch命令<br>使用watch key监控指定数据，相当于乐观锁加锁。类似一个CAS操作。</p><pre class="line-numbers language-none"><code class="language-none">127.0.0.1:6379&gt; set money 100 # 设置余额:100OK127.0.0.1:6379&gt; set use 0 # 支出使用:0OK127.0.0.1:6379&gt; watch money # 监视money (上锁)OK127.0.0.1:6379&gt; multiOK127.0.0.1:6379&gt; DECRBY money 20QUEUED127.0.0.1:6379&gt; INCRBY use 20QUEUED127.0.0.1:6379&gt; exec # 监视值没有被中途修改，事务正常执行1) (integer) 802) (integer) 20<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>测试多线程修改值，使用watch可以当做redis的乐观锁操作（相当于getversion）</p><p>起两个客户端模拟多线程<br>线程一</p><pre class="line-numbers language-none"><code class="language-none">127.0.0.1:6379&gt; watch money # money上锁OK127.0.0.1:6379&gt; multiOK127.0.0.1:6379&gt; DECRBY money 20QUEUED127.0.0.1:6379&gt; INCRBY use 20QUEUED127.0.0.1:6379&gt; # 此时事务并没有执行<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>线程二</p><pre class="line-numbers language-none"><code class="language-none">127.0.0.1:6379&gt; INCRBY money 500 # 修改了线程一中监视的money(integer) 600<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>回到线程一客户端</p><pre class="line-numbers language-none"><code class="language-none">127.0.0.1:6379&gt; EXEC # 执行之前，另一个线程修改了我们的值，这个时候就会导致事务执行失败(nil) # 没有结果，说明事务执行失败127.0.0.1:6379&gt; get money # 线程2 修改生效"600"127.0.0.1:6379&gt; get use # 线程1事务执行失败，数值没有被修改"0"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>解锁获取最新值，然后再加锁进行事务。</p><p>unwatch进行解锁。</p><p>实际上用得不多，很多利用redis分布式锁一般是setex+lua脚本（Redisson）</p><p>但是redis分布式锁是最简单实现的，但是也会有问题GC阻塞时间太长，导致时间失效，或者是redis服务器时钟漂移（就是两台服务器时间不一致，一个快导致两个服务器一把锁），还有单点故障master挂掉slave成为master也会带来问题。</p><p>解决单点故障有redlock，就是对多个端设置时间，但是对于每个redis实例设置一个超时时间，比如书1min有效时间，超时时间是1秒，你在1秒内获取不到这个实例，就取获取下一个锁。</p><p><strong>Redis乐观锁摘抄链接</strong>：<a href="https://blog.csdn.net/FeiChangWuRao/article/details/122824426">https://blog.csdn.net/FeiChangWuRao/article/details/122824426</a></p>]]></content>
      
      
      <categories>
          
          <category> redis </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据库 </tag>
            
            <tag> 事务 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Redis的三大特殊类型</title>
      <link href="/2022/02/21/Redis%E7%9A%84%E4%B8%89%E5%A4%A7%E7%89%B9%E6%AE%8A%E7%B1%BB%E5%9E%8B/"/>
      <url>/2022/02/21/Redis%E7%9A%84%E4%B8%89%E5%A4%A7%E7%89%B9%E6%AE%8A%E7%B1%BB%E5%9E%8B/</url>
      
        <content type="html"><![CDATA[<h2 id="Redis的三大特殊类型"><a href="#Redis的三大特殊类型" class="headerlink" title="Redis的三大特殊类型"></a>Redis的三大特殊类型</h2><h2 id="geospatial地理位置"><a href="#geospatial地理位置" class="headerlink" title="geospatial地理位置"></a>geospatial地理位置</h2><p>使用场景：朋友定位，附近的人，打车距离计数</p><p>Redis的Geo在Redis3.2版本就推出了</p><p>查询经度纬度：<a href="https://www.toolnb.com/tools/gps.html">https://www.toolnb.com/tools/gps.html</a></p><h3 id="相关命令："><a href="#相关命令：" class="headerlink" title="相关命令："></a>相关命令：</h3><h4 id="GEOADD（添加地理位置）"><a href="#GEOADD（添加地理位置）" class="headerlink" title="GEOADD（添加地理位置）"></a>GEOADD（添加地理位置）</h4><p>将指定的地理空间位置（经度、纬度、名称）添加到指定的key中 保存精度维度： 规则：南极北极不能添加，我们一般都是下载城市数据，使用java程序导入 参数：key-value（经度、纬度、名称）</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; geoadd china:city 116.405289 39.904987 beijin</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; geoadd china:city 102.71 25.04 kunming</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; geoadd china:city 115.89 28.67 nanchang</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; geoadd china:city 121.47 31.23 shanghai</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; geoadd china:city 120.15 30.28 hanzuo</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; geoadd china:city 113.28 23.12 guanzuo</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; geoadd china:city 104.06 30.65 chengdu 123.42 41.79 shenyang</span><br><span class="line">(integer) 2</span><br></pre></td></tr></tbody></table></figure><h4 id="GEOPOS（读取存入的地理位置）"><a href="#GEOPOS（读取存入的地理位置）" class="headerlink" title="GEOPOS（读取存入的地理位置）"></a>GEOPOS（读取存入的地理位置）</h4><p>注意是直线距离</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; GEOPOS china:city beijin</span><br><span class="line">1) 1) "116.40528827905654907"</span><br><span class="line">   2) "39.90498588819134085"</span><br><span class="line">127.0.0.1:6379&gt; GEOPOS china:city beijin hanzuo</span><br><span class="line">1) 1) "116.40528827905654907"</span><br><span class="line">   2) "39.90498588819134085"</span><br><span class="line">2) 1) "120.15000075101852417"</span><br><span class="line">   2) "30.2800007575645509"</span><br><span class="line">127.0.0.1:6379&gt; </span><br></pre></td></tr></tbody></table></figure><h4 id="GEODIST（返回两个维度之间的距离）"><a href="#GEODIST（返回两个维度之间的距离）" class="headerlink" title="GEODIST（返回两个维度之间的距离）"></a>GEODIST（返回两个维度之间的距离）</h4><p>127.0.0.1:6379&gt; GEODIST china:city beijin hanzuo km “1123.1795” 末尾是输入以那种发生计数距离，如显示km还是m GEOHASH</p><h4 id="GEORADIUS（以给定的极度伟度为中心，找出给定半径的城市）"><a href="#GEORADIUS（以给定的极度伟度为中心，找出给定半径的城市）" class="headerlink" title="GEORADIUS（以给定的极度伟度为中心，找出给定半径的城市）"></a>GEORADIUS（以给定的极度伟度为中心，找出给定半径的城市）</h4><p>注意：找的是已在集合中的地理位置</p><p>georadius key 精度 维度 距离 单位</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; georadius china:city 110 30 1000 km</span><br><span class="line">1) "kunming"</span><br><span class="line">2) "chengdu"</span><br><span class="line">3) "guanzuo"</span><br><span class="line">4) "nanchang"</span><br><span class="line">5) "hanzuo"</span><br></pre></td></tr></tbody></table></figure><p>加上withdist会显示直线距离</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; georadius china:city 110 30 1000 km withdist</span><br><span class="line">1) 1) "kunming"</span><br><span class="line">   2) "905.9321"</span><br><span class="line">2) 1) "chengdu"</span><br><span class="line">   2) "574.7802"</span><br><span class="line">3) 1) "guanzuo"</span><br><span class="line">   2) "831.7713"</span><br><span class="line">4) 1) "nanchang"</span><br><span class="line">   2) "589.8814"</span><br><span class="line">5) 1) "hanzuo"</span><br><span class="line">   2) "976.4868"</span><br></pre></td></tr></tbody></table></figure><p>加上withcoord 显示经度纬度</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; georadius china:city 110 30 1000 km withcoord</span><br><span class="line">1) 1) "kunming"</span><br><span class="line">   2) 1) "102.70999878644943237"</span><br><span class="line">      2) "25.03999958679589355"</span><br><span class="line">2) 1) "chengdu"</span><br><span class="line">   2) 1) "104.05999749898910522"</span><br><span class="line">      2) "30.6499990746355806"</span><br><span class="line">3) 1) "guanzuo"</span><br><span class="line">   2) 1) "113.27999979257583618"</span><br><span class="line">      2) "23.1199990030198208"</span><br><span class="line">4) 1) "nanchang"</span><br><span class="line">   2) 1) "115.88999837636947632"</span><br><span class="line">      2) "28.66999910629679249"</span><br><span class="line">5) 1) "hanzuo"</span><br><span class="line">   2) 1) "120.15000075101852417"</span><br><span class="line">      2) "30.2800007575645509"</span><br></pre></td></tr></tbody></table></figure><p>加上count * 可以限制显示几个</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; georadius china:city 110 30 1000 km  count 2</span><br><span class="line">1) "chengdu"</span><br><span class="line">2) "nanchang"</span><br></pre></td></tr></tbody></table></figure><p>withdist，withcoord，count *，在末尾可随意组合添加</p><h4 id="GEORADIUSBYMEMBER（根据指定的城市，查询他的半径的元素）"><a href="#GEORADIUSBYMEMBER（根据指定的城市，查询他的半径的元素）" class="headerlink" title="GEORADIUSBYMEMBER（根据指定的城市，查询他的半径的元素）"></a>GEORADIUSBYMEMBER（根据指定的城市，查询他的半径的元素）</h4><p>使用集合中的元素查询</p><p>普通查询：GEORADIUSBYMEMBER key 距离 单位</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; GEORADIUSBYMEMBER china:city beijin 1000 km  </span><br><span class="line">1) "beijin"</span><br><span class="line">2) "shenyang"</span><br></pre></td></tr></tbody></table></figure><p>加上withdist会显示直线距离</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; GEORADIUSBYMEMBER china:city beijin 1000 km withdist</span><br><span class="line">1) 1) "beijin"</span><br><span class="line">   2) "0.0000"</span><br><span class="line">2) 1) "shenyang"</span><br><span class="line">   2) "626.1044"</span><br></pre></td></tr></tbody></table></figure><p>加上withcoord 显示经度纬度</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; GEORADIUSBYMEMBER china:city beijin 1000 km withcoord</span><br><span class="line">1) 1) "beijin"</span><br><span class="line">   2) 1) "116.40528827905654907"</span><br><span class="line">      2) "39.90498588819134085"</span><br><span class="line">2) 1) "shenyang"</span><br><span class="line">   2) 1) "123.41999977827072144"</span><br><span class="line">      2) "41.78999971580505246"</span><br></pre></td></tr></tbody></table></figure><p>加上count * 可以限制显示几个</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; GEORADIUSBYMEMBER china:city beijin 1000 km count 1</span><br><span class="line">1) "beijin"</span><br></pre></td></tr></tbody></table></figure><p>withdist，withcoord，count *，在末尾可随意组合添加</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; GEORADIUSBYMEMBER china:city beijin 1500 km withcoord withdist count 2</span><br><span class="line">1) 1) "beijin"</span><br><span class="line">   2) "0.0000"</span><br><span class="line">   3) 1) "116.40528827905654907"</span><br><span class="line">      2) "39.90498588819134085"</span><br><span class="line">2) 1) "shenyang"</span><br><span class="line">   2) "626.1044"</span><br><span class="line">   3) 1) "123.41999977827072144"</span><br><span class="line">      2) "41.78999971580505246"</span><br></pre></td></tr></tbody></table></figure><h4 id="GEOHASH（返回11个字符的Geohash字符串）"><a href="#GEOHASH（返回11个字符的Geohash字符串）" class="headerlink" title="GEOHASH（返回11个字符的Geohash字符串）"></a>GEOHASH（返回11个字符的Geohash字符串）</h4><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; GEOHASH china:city beijin </span><br><span class="line">1) "wx4g0b7xru0"</span><br></pre></td></tr></tbody></table></figure><p>GEO底层的实现原来其实就是Zset,我们可以使用Zset命令来操作GEO 如： ZRANGE china:city 0 -1 #显示指定geo可以的数据 127.0.0.1:6379&gt; zrem china:city chengdu #删除</p><h2 id="Hyperloglog"><a href="#Hyperloglog" class="headerlink" title="Hyperloglog"></a>Hyperloglog</h2><h3 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h3><p>Redis2.8.9版本就跟新了Hyperlogog数据结构！ Redis Htperloglog 基数统计的算法！ 优点：占用的内存是固定，只需要废12KB内存！如果要从内存角度来比较的话Hyperloglog首选！ <strong>网页的UV（一个人访问一个网站多次，但是还是算做一个人）</strong> 传统的方式，set保存用户的id，然后就可以统计set中的元素数量作为标准判断！（set不可重复） 这个方式如果保存大量的用户id，就会比较麻烦！我们的目的是为了计数，而不是保存用户id；（使用Hyperloglog会有0.18的错误率！统计UV任务，可以忽略不计，如果要精确则不可使用）</p><h3 id="使用："><a href="#使用：" class="headerlink" title="使用："></a>使用：</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">PFadd key element [element...]  #添加 将用户id存进去</span><br><span class="line">PFCOUNT key  #读取当前keu总数</span><br><span class="line">PFMERGE key3  key1  key2   #将key1和key2的数据合并到key3中，重复的会去除</span><br></pre></td></tr></tbody></table></figure><h2 id="Bitmaps"><a href="#Bitmaps" class="headerlink" title="### Bitmaps"></a>### Bitmaps</h2><h3 id="介绍："><a href="#介绍：" class="headerlink" title="介绍："></a>介绍：</h3><p>Bitmaps位图，数据结构！都是操作二进制来进行记录，就只有0和1两个状态！</p><p>使用场景：打卡，登录</p><p>操作：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">setbit key offset value  #setbit sign 1 0 末尾只能是0和1</span><br><span class="line">getbit key offset   #获取指定的offset的值</span><br><span class="line">bitcount key   #获取指定的key中有多少个1</span><br></pre></td></tr></tbody></table></figure>]]></content>
      
      
      <categories>
          
          <category> redis </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据库 </tag>
            
            <tag> 数据类型 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2020.3版本idea30天重复试用</title>
      <link href="/2022/02/21/2020-3%E7%89%88%E6%9C%ACidea30%E5%A4%A9%E9%87%8D%E5%A4%8D%E8%AF%95%E7%94%A8/"/>
      <url>/2022/02/21/2020-3%E7%89%88%E6%9C%ACidea30%E5%A4%A9%E9%87%8D%E5%A4%8D%E8%AF%95%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<h2 id="2020-3版本idea30天重复试用"><a href="#2020-3版本idea30天重复试用" class="headerlink" title="2020.3版本idea30天重复试用"></a>2020.3版本idea30天重复试用</h2><h2 id="第一步："><a href="#第一步：" class="headerlink" title="第一步："></a>第一步：</h2><p>下载需要的jar包：<a href="https://pan.baidu.com/s/1r7YX9XCFOt1UPTAjO7tf4A">破解jar包，提取码【H03Z】</a></p><h2 id="第二步："><a href="#第二步：" class="headerlink" title="第二步："></a>第二步：</h2><p>前往插件库导入下载的jar包</p><p>插件库导入位置： File &gt; setting &gt; plugins &gt; Install plugin from Disk 选中下载的jar包即可！</p><p>导入插件后点击重启</p><h2 id="第三步："><a href="#第三步：" class="headerlink" title="第三步："></a>第三步：</h2><p>查看是否安装成功</p><p>点击 Help 菜单，若列表中出现 Eval Reset选项，则代表安装成功 再点击Eval Reset选项</p><p><img src="https://s2.loli.net/2022/02/21/lx2wAq4cFOX65Js.png" alt="image-20220221092805589"></p><h2 id="第四步："><a href="#第四步：" class="headerlink" title="第四步："></a>第四步：</h2><p>勾选【Auto reset befor per restart】则自动重置，重置是静默无感知的。如果勾选了，则自勾选后每次重启/退出IDE时会自动重置试用信息，你无需做额外的事情。（此为自动重置方式） </p><p><img src="https://s2.loli.net/2022/02/22/IRZjNx1O8K6TBEz.png" alt="image-20220222224832179"></p><p>按钮【Reset】点击会询问是否重置试用30天并重启IDE。选择Yes则执行重置操作并重启IDE生效，选择No则什么也不做。（此为手动重置方式）</p><h2 id="第五步："><a href="#第五步：" class="headerlink" title="第五步："></a>第五步：</h2><p>检测是否重置30天</p><p>点击 Help &gt; register查看</p><p> <img src="https://s2.loli.net/2022/02/22/CGZjrokFNWXS5cl.png" alt="image-20220222224903828"></p>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> idea </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>redis的五大数据类型</title>
      <link href="/2022/02/21/redis%E7%9A%84%E4%BA%94%E5%A4%A7%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/"/>
      <url>/2022/02/21/redis%E7%9A%84%E4%BA%94%E5%A4%A7%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/</url>
      
        <content type="html"><![CDATA[<h2 id="Redis简单了解与5大数据类型"><a href="#Redis简单了解与5大数据类型" class="headerlink" title="Redis简单了解与5大数据类型"></a>Redis简单了解与5大数据类型</h2><h2 id="Redis是单线程的"><a href="#Redis是单线程的" class="headerlink" title="Redis是单线程的"></a>Redis是单线程的</h2><p>Redis是很快的，官方表示，Redis是基于内存操作，cpu并不是Redis性能瓶颈，Redis的瓶颈是根据机器和网络带宽。</p><p>Redis是C语言写的，官方提供的数据为 100000+ 的Qps，完成不比同样是使用key-value的Memecahe差！</p><h2 id="Redis为什么单线程还那么快？"><a href="#Redis为什么单线程还那么快？" class="headerlink" title="Redis为什么单线程还那么快？"></a>Redis为什么单线程还那么快？</h2><p>1，高性能的服务器不一定是多线程的 2，多线程不一定比单线程效率高！</p><p>redis是将所有的数据全部放置内存中的，所以使用单线程去操作效率就是最高的，多线程cpu上下文切换耗时，对于内存系统来说，如果没有上下文切换效率就是最高的，多次读写都在一个cpu上的，在内存情况下，这个就是最佳方案</p><p>redis一共有16个数据库 默认使用第0个</p><h2 id="5大数据类型"><a href="#5大数据类型" class="headerlink" title="5大数据类型"></a>5大数据类型</h2><p>不区分大小写</p><h3 id="String-的一些命令"><a href="#String-的一些命令" class="headerlink" title="String 的一些命令"></a>String 的一些命令</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">select <span class="number">1</span> #改变数字可切换数据库</span><br><span class="line">keys *  #查看当前数据库使用的key</span><br><span class="line">set key value  #向数据库填充kv键值对数据</span><br><span class="line">get key  #获取指定key的value</span><br><span class="line">flushall  #清空全部 会将其他库的也清除</span><br><span class="line">flushdb   #清空单前数据库</span><br><span class="line">EXISTS key  #判断当前key是否存在 存在返回<span class="number">1</span> 否者<span class="number">0</span></span><br><span class="line">move key <span class="number">1</span> #将指定的key键值对移动到指定的数据库</span><br><span class="line">EXPIRE key <span class="number">10</span>  #将指定key在指定的时间过期 <span class="number">10</span>为<span class="number">10</span>秒</span><br><span class="line">ttl key  #查看指定的key还剩余多少存活时间 -<span class="number">1</span>为永久存活 -<span class="number">2</span>为死亡</span><br><span class="line">type key  #查看当前key的数据类型</span><br><span class="line">APPEND key content  #追加指定key的value的内容 content为追加内容 </span><br><span class="line">STRLEN key  #查看指定key的value长度</span><br><span class="line">incr key  #可以为指定的key自增</span><br><span class="line">decr key #为指定的key减<span class="number">1</span></span><br><span class="line">INCRBY key i  #为指定的key 加上 i个（数字）</span><br><span class="line">DECRBY key i  #为指定的key 减 i (数字)</span><br><span class="line">GETRANGE key s e  #截取指定长度字符串 ，该方法区间（ }</span><br><span class="line">GETRANGE key i -<span class="number">1</span>  #结尾为-<span class="number">1</span>可以查看全部字符串 和 get一样</span><br><span class="line">SETRANGE key s content  #替换指定位置开始的字符串 输入几个就替换几个</span><br><span class="line">setex key time value  #创建或修改一个键值对，并设置过期时间</span><br><span class="line">setnx key value  #创建一个键值对 、当如何已经有这个键值对了就会创建失败</span><br><span class="line">mset key value [k v...]  #可一次设置多个，kv键值对</span><br><span class="line">mget key [key...]  #一次获取多个value</span><br><span class="line">msetnx key value [k v...]  #可一次设置多个，kv键值对，但要满足原子性，同时成功，同时失败</span><br><span class="line">getset key value  #读取并修改 先读，可以用于更新新内容</span><br></pre></td></tr></tbody></table></figure><h3 id="List"><a href="#List" class="headerlink" title="List"></a>List</h3><p>list可以当作链表来看，左右都可以插入</p><p>可控制向左向右添加后移出，是需要开头加 L（左） 或 R（右），List的命令以L开头，除控制左右外，可存在重复值</p><p>添加后内容顺序为 54321</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">LPUSH key element [element...] #tianj或创建并添加值</span><br><span class="line">LRANGE key s e  ;#查看List的数据 从s开始 到e结束的位置</span><br><span class="line">LPOP #移出左第一个，（左右可调节）</span><br><span class="line">LINDEX key index   #根据下标查看值，必须大写，只能从左</span><br><span class="line">LLEN key   #获取指定list的长度</span><br><span class="line">LREM key count value  #移出指定的内容，并且可以设置移出几个</span><br><span class="line">ltrim key start stop  #通过下标截取要的部分 不在区间的则都移出</span><br><span class="line">rpoplpush key1 key2  #移出key1中最右的第一个并添加到key2的左边第一个</span><br><span class="line">lset key index value  #可修改list中指定下标的value，如果不存在列表就会报错</span><br><span class="line">LINSERT key before|after pivot element #向指定key里的value的前或后插入内容。 pivot key里的内容 element 插入的内容</span><br></pre></td></tr></tbody></table></figure><h3 id="Set"><a href="#Set" class="headerlink" title="Set"></a>Set</h3><p>set的命令都是以s开头的 set中的值是无需不能重复的</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sadd key value  #创建或添加</span><br><span class="line">SMEMBERS key  #查看set中的元素</span><br><span class="line">SISMEMBER key value  #判断当前set中是否有当前value</span><br><span class="line">scard setkey  #获取当前set的个数</span><br><span class="line">srem setkey element[element..]  #移出指定的值</span><br><span class="line">SRANDMEMBER setkey 【count】  #在指定的key中随机获取count个元素</span><br><span class="line">SPOP setkey 【count】  #随机移除count个元素</span><br><span class="line">SMOVE setkey1 setkey2 value  #将setkey1的value移出到setkey2中</span><br><span class="line">SINTER key [key...]  #获取选中key的交集，要都有的才会显示</span><br><span class="line">SUNION key [key...] #获取选中的并集，不会输出重复的 #并集解释：若A和B是集合，则A和B并集是有所有A的元素和所有B的元素，而没有其他元素的集合。A和B的并集通常写作 <span class="string">"A∪B"</span>，读作“A并B”</span><br></pre></td></tr></tbody></table></figure><h3 id="Hash"><a href="#Hash" class="headerlink" title="Hash"></a>Hash</h3><p>Hash类型为key-（key-value） 所有的hash命令是以h开头的</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">hset key field value [field value...]  #创建Hash</span><br><span class="line">#示例：hset hash field1 value1 ；key（hash）-value（field1-value1）</span><br><span class="line">#注意：低版本一次填充多个需要使用hmset命令</span><br><span class="line">hget key field   #获取field value值，需要两个key的值</span><br><span class="line">hmget key field [field...]  #获取多个 field ，高版本可能没有这个命令，而是直接使用hset</span><br><span class="line">hdel key field [field...]  #删除指定的field，</span><br><span class="line">hgetall key    #查看当前key中的value（k-v键值对都会显示）</span><br><span class="line">HEXISTS key field   #查询hash中是否存在指定的key</span><br><span class="line">hkeys key     #查看hash中所有的key</span><br><span class="line">hvals key     #查看hasg中所有的value</span><br><span class="line">HINCRBY key field i    #为指定key中的field 的value进行相加，可以加负数，这样就是相减</span><br><span class="line">hsetnx key field value #如果field存在则无需，不存在创建</span><br></pre></td></tr></tbody></table></figure><h3 id="Zset"><a href="#Zset" class="headerlink" title="Zset"></a>Zset</h3><p>有序集合，，从小到大</p><p>在set的基础上加了一个值， zadd k score v ,多了个score多了了，可以用于表示</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">zadd key sroce value [...]  #添加zset</span><br><span class="line">zrange key start stop  #查看指定key数据范围</span><br><span class="line">ZRANGEBYSCORE key min max [WITHSCORCES] [LIMIT offset ount]   #用于指定key筛选排序  min可以使用-inf 意思为负无限制，max使用+inf 正无限，获取score包含在他们的区间值</span><br><span class="line">ZREVRANGEBYSCORE key max min [WITHSCORCES] [LIMIT offset ount]  #上面排正序，这个是倒叙</span><br><span class="line">zrem key member [member...]   #使用要删除的value并移除</span><br><span class="line">ZCARD key   #查询当前集合key有多少个值</span><br><span class="line">ZCOUNT key min max #获取指定key的指定区间内有多个个值</span><br></pre></td></tr></tbody></table></figure><h2 id="官网地址"><a href="#官网地址" class="headerlink" title="官网地址"></a>官网地址</h2><p>一切以官网为准 <a href="http://www.redis.cn/" title="Redis官网">Redis官网</a></p>]]></content>
      
      
      <categories>
          
          <category> redis </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据库 </tag>
            
            <tag> 数据类型 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>redis的安装</title>
      <link href="/2022/02/21/redis%E7%9A%84%E5%AE%89%E8%A3%85/"/>
      <url>/2022/02/21/redis%E7%9A%84%E5%AE%89%E8%A3%85/</url>
      
        <content type="html"><![CDATA[<h2 id="安装Redis"><a href="#安装Redis" class="headerlink" title="安装Redis"></a>安装Redis</h2><h2 id="如何安装redis"><a href="#如何安装redis" class="headerlink" title="如何安装redis"></a>如何安装redis</h2><p>先去redis的官网下安装redis： <a href="http://www.redis.cn/">Redis中文官网</a></p><p>redis不推荐在windos上安装</p><p>CentOS7以上 安装方法： 安装ridis前需要先安装：gcc</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum -y install gcc</span><br><span class="line">yum -y install gcc-c++</span><br></pre></td></tr></tbody></table></figure><p>安装好gcc后解压你的Redis安装包</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf Reids安装包   #gz为后缀的</span><br></pre></td></tr></tbody></table></figure><p>解压好后进入到redis里make编译</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd rieds</span><br><span class="line">make   #编译</span><br><span class="line">make install  #安装确认一下 也可以不执行</span><br></pre></td></tr></tbody></table></figure><p>到这就安装完成了！</p><p>我们可以去看下我们安装的程序：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/bin</span><br></pre></td></tr></tbody></table></figure><p>我们自己安装的程序都会在里面！</p><p>我们可以在这里创建一个文件夹存放我们配置文件，这里我们创建一个存放Redis的配置文件，以后修改也是修改这里的配置文件而不修改软件里的，可以确保安全性：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir SHconfig</span><br><span class="line">cp /opt/Redis/redis-6.0.6/redis.conf SHconfig</span><br></pre></td></tr></tbody></table></figure><p>redis默认不是后台启动的，需要修改配置文件：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">vim redis.conf</span><br><span class="line">将daemonize no 改为 daemonize yes</span><br><span class="line">设置密码</span><br><span class="line">requirepass foobared</span><br><span class="line">requirepass 123   指定密码123</span><br><span class="line">设置完密码后每次登录操作需要使用auth进行登录才能使用</span><br><span class="line">[root@VM-4-12-centos StudyHardConfig]# redis-cli</span><br><span class="line">127.0.0.1:6379&gt; set key1 q</span><br><span class="line">(error) NOAUTH Authentication required.</span><br><span class="line">127.0.0.1:6379&gt; auth 031215</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; set key1 v1</span><br><span class="line">OK</span><br></pre></td></tr></tbody></table></figure><h2 id="启动Redis："><a href="#启动Redis：" class="headerlink" title="启动Redis："></a>启动Redis：</h2><h3 id="在安装目录下执行："><a href="#在安装目录下执行：" class="headerlink" title="在安装目录下执行："></a>在安装目录下执行：</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-server shconfig/redis.conf #后面的参数是表示选用的配置文件</span><br></pre></td></tr></tbody></table></figure><h3 id="在安装目录下测试连接并退出："><a href="#在安装目录下测试连接并退出：" class="headerlink" title="在安装目录下测试连接并退出："></a>在安装目录下测试连接并退出：</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-4-12-centos bin]# redis-cli -p 6379 #连接</span><br><span class="line">127.0.0.1:6379&gt; ping</span><br><span class="line">PONG</span><br><span class="line">127.0.0.1:6379&gt; set name studyhard</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; get name</span><br><span class="line">"studyhard"</span><br><span class="line">127.0.0.1:6379&gt; keys *</span><br><span class="line">1) "name"</span><br><span class="line">127.0.0.1:6379&gt; shutdown #关闭reids</span><br><span class="line">not connected&gt; exit   #退出</span><br></pre></td></tr></tbody></table></figure><h2 id="当然还有更简单的方法"><a href="#当然还有更简单的方法" class="headerlink" title="当然还有更简单的方法"></a>当然还有更简单的方法</h2><p>使用宝塔面板~~ 十分的快捷</p>]]></content>
      
      
      <categories>
          
          <category> redis </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 安装 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>redis的持久化</title>
      <link href="/2022/02/21/redis%E7%9A%84%E6%8C%81%E4%B9%85%E5%8C%96/"/>
      <url>/2022/02/21/redis%E7%9A%84%E6%8C%81%E4%B9%85%E5%8C%96/</url>
      
        <content type="html"><![CDATA[<h1 id="Redis的持久化"><a href="#Redis的持久化" class="headerlink" title="Redis的持久化"></a>Redis的持久化</h1><p>redis是内存数据库，如果数据不持久化，当程序关闭时将会丢失数据，所以Redis提供了持久化</p><h3 id="RDB"><a href="#RDB" class="headerlink" title="RDB"></a>RDB</h3><p><strong>什么是RDB？</strong></p><p><img src="https://s2.loli.net/2022/02/20/IeEx1JmZS82vk9s.png" alt="image-20220220232522977"></p><p>在指定的时间间隔内将内存中的数据集快照写入磁盘，也就是行话讲的Snapshot快照，它恢复时是将快照文件直接读到内存里。Redis会单独创建 ( fork )一个子进程来进行持久化，会先将数据写入到一个临时文件中，待持久化过程都结束了，再用这个临时文件替换上次持久化好的文件。整个过程中，主进程是不进行任何IO操作的。这就确保了极高的性能。如果需要进行大规模数据的恢复，且对于数据恢复的完整性不是非常敏感，那RDB方式要比AOF方式更加的高效。RDB的缺点是最后一次持久化后的数据可能丢失。我们默认的就是RDB，一般情况不需要修改这个配置！</p><p>在生成环境我们将会对这个文件进行备份</p><p><strong>缺点：</strong></p><p>如果在最后一次宕机了，就没有办法去持久化了，需要一定的时间间隔</p><p>在创建frok进程的时候，会占用一定的空间</p><p><strong>优点：</strong></p><p>RDB比AOF更加的高效，适合大规模恢复数据</p><p>RDB保存的文件是dump.rdb   ，在配置文件中有讲，都是在配置文件中设置的</p><p><strong>持久化触发机制：</strong></p><p>注意：kill的情况下不会触发</p><p>1,save的规则满足的情况下会触发rdb规则</p><p>2,执行flushall命令也会触发rdb规则</p><p>3,当退出redis时也会触发rdb规则   </p><p>会生成一个dump.rdb文件，redis在重启时会读取文件，恢复数据，如果删除，关闭后就不会有之前的数据了</p><p><strong>如恢复rdb文件：</strong></p><p>只需要将rdb文件放置redis启动目录下，</p><p>dump.rdb放在redis-server同级目录</p><h2 id="AOF"><a href="#AOF" class="headerlink" title="AOF"></a>AOF</h2><p>它会将我们所有的命令记录下来，history，恢复的时候就会把这个文件全部执行一遍！</p><p><strong>在redis4.0以后支持混合模式，rdb与aof同时开启会优先aof</strong></p><p><img src="https://s2.loli.net/2022/02/20/r1N7HEity9OXqdA.png" alt="image-20220220233046582"></p><p>以日志的形式来记录每个写操作，将Redis执行过的所有指令记录下来(读操作不记录），只许追加文件但不可以改写文件，redis启动之初会读取该文件重新构建数据，换言之，redis重启的话就根据日志文件的内容将写指令从前到后执行一次以完成数据的恢复工作</p><p><strong>默认不开AOF，需要去配置文件中手动开启</strong></p><p><strong>Aof保存的是appendonly.aof 文件</strong></p><p>文件同样可以在配置文件中修改:</p><p>//The name of the append only file (default: “appendonly.aof”)</p><p>​    appendfilename “appendonly.aof”</p><p><strong>当我们开启时输入了命令后就会生成aod文件：</strong></p><p><img src="https://s2.loli.net/2022/02/21/lDiAuKGo345PORI.png" alt="image-20220221100633418"></p><p><strong>文件的内容为：</strong></p><p><img src="https://s2.loli.net/2022/02/22/DGtZmALfOyTziFh.png" alt="image-20220222225551886"></p><p>这个文件是能破坏的，破坏后启动redis会报错 ，但是系统会生成一个备用文件，我们可以使用它来修改appendonly.aof</p><p>破坏后登录：</p><p><img src="https://s2.loli.net/2022/02/21/JuwqZhENCfp9LIn.png" alt="image-20220221102935481"></p><p>破坏后是可以使用这个文件进行恢复的</p><p><img src="https://s2.loli.net/2022/02/21/X4TEjb1n5VfL2Fk.png" alt="image-20220221103321224"></p><p>使用命令：redis-check-aof –fix appendonly.aof  进行恢复，恢复后 就能正常登录了</p><p>注意：要在appendonly.aof文件位置使用该命令</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-4-12-centos ~]# redis-check-aof --fix appendonly.aof</span><br><span class="line">Cannot open file: appendonly.aof</span><br><span class="line">[root@VM-4-12-centos ~]# cd /usr/local/bin</span><br><span class="line">[root@VM-4-12-centos bin]# redis-check-aof --fix appendonly.aof</span><br><span class="line">0x              3c: Expected \r\n, got: 7765</span><br><span class="line">AOF analyzed: size=143, ok_up_to=52, diff=91</span><br><span class="line">This will shrink the AOF from 143 bytes, with 91 bytes, to 52 bytes</span><br><span class="line">Continue? [y/N]: y</span><br><span class="line">Successfully truncated AOF</span><br><span class="line">[root@VM-4-12-centos bin]# </span><br></pre></td></tr></tbody></table></figure>]]></content>
      
      
      <categories>
          
          <category> redis </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据库 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>redis配置文件介绍</title>
      <link href="/2022/02/20/redis%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E4%BB%8B%E7%BB%8D/"/>
      <url>/2022/02/20/redis%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E4%BB%8B%E7%BB%8D/</url>
      
        <content type="html"><![CDATA[<h1 id="Redis的配置文件解释"><a href="#Redis的配置文件解释" class="headerlink" title="Redis的配置文件解释"></a>Redis的配置文件解释</h1><h2 id="网络"><a href="#网络" class="headerlink" title="网络"></a>网络</h2><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bind 127.0.0.1   #绑定的ip地址 这个是只运行本地访问</span><br><span class="line">protected-mode yes   # 保护模式   是为了禁止公网访问redis cache，加强redis安全的</span><br><span class="line">port  6379   #端口设置</span><br></pre></td></tr></tbody></table></figure><h2 id="通用GENERAL"><a href="#通用GENERAL" class="headerlink" title="通用GENERAL"></a>通用GENERAL</h2><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">daemonize yes     #以守护线程的方式运行，默认是no，我们需要直接开启为yes！</span><br><span class="line"></span><br><span class="line">supervised no</span><br><span class="line">#如果需要在机器启动（upstart模式 或systemd模式）时就启动Redis服务器，可以通过该选项来配置Redis。</span><br><span class="line">#supervised no - 不会与supervised tree进行交互</span><br><span class="line">#supervised upstart - 将Redis服务器添加到SIGSTOP 模式中</span><br><span class="line">#supervised systemd - 将READY=1 写入 $NOTIFY_SOCKET</span><br><span class="line">#supervised auto - 根据环境变量UPSTART_JOB 或 NOTIFY_SOCKET检测upstart 还是 systemd</span><br><span class="line">#上述 supervision 方法（upstart或systemd）仅发出“程序已就绪”信号，不会继续给supervisor返回ping回复。</span><br><span class="line"></span><br><span class="line">pidfile /var/run/redis_6379.pid   # 如果以后台方式运行，我们就需要指定一个pid文件！</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">databases 16   # 有多少个数据库 默认16个</span><br><span class="line"></span><br><span class="line">logfile ""   #日志的文件位置名</span><br><span class="line"></span><br><span class="line">loglevel notice    #需要哪些情况打印log</span><br><span class="line">#日志</span><br><span class="line"># Specify the server verbosity level.</span><br><span class="line"># This can be one of:</span><br><span class="line"># debug (a lot of information, useful for development/testing)</span><br><span class="line"># verbose (many rarely useful info, but not a mess like the debug level)</span><br><span class="line"># notice (moderately verbose, what you want in production probably) 生产环境</span><br><span class="line"># warning (only very important / critical messages are logged)</span><br><span class="line"></span><br><span class="line">always-show-logo yes  #是否总是显示LOGO</span><br></pre></td></tr></tbody></table></figure><h2 id="SNAPSHOTTING-（快照）"><a href="#SNAPSHOTTING-（快照）" class="headerlink" title="SNAPSHOTTING :（快照）"></a>SNAPSHOTTING :（快照）</h2><p><strong>什么是快照？用来做什么？</strong></p><p>快照是特定数据集的一个完整可用的拷贝，该数据集包含源数据在拷贝点的静态映象，它可以是数据再现的一个副本或者复制。</p><p>说起来有些文绉绉的不好理解，那么这究竟是什么意思？<strong>通俗地讲，咱们可以把快照理解成拍照。</strong></p><p>譬如说，在某一时刻用手机给你拍了一张照片，那么照片中的你的状态就定格在了拍照的那一瞬间。当明天的你再来看这张照片的时候，你就能看到拍照时你的状态是如何的，这就是简单意义上的快照。</p><p>那么，快照的实际应用场景是哪些呢？前面其实有说到，快照是备份技术的一种，一旦原来的数据发生了变化（可能因为某些原因数据发生了丢失等等），使用快照就可以恢复原来的数据。</p><p><strong>redis是内存数据库，如果没有持久化，那么数据断电及失！</strong></p><p>持久化，在规定的时间内，执行了对少次操作，则会持久化到文件 .rdb .aof</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#如果在900秒内执行至少有一个 key进行了修改，我们就进行持久化操作</span><br><span class="line">save 900 1</span><br><span class="line">#如果在300秒内执行至少有10个 key进行了修改，我们就进行持久化操作</span><br><span class="line">save 300 10</span><br><span class="line">#如果在60秒内执行至少有10000个 key进行了修改，我们就进行持久化操作</span><br><span class="line">save 60 10000</span><br><span class="line">#这个持久化是可以自定义的，根据同上来自定义</span><br><span class="line"></span><br><span class="line">stop-writes-on-bgsave-error yes   #持久化如果出错。是否停止工作！</span><br><span class="line"></span><br><span class="line">rdbcompression yes   #是否压缩rad文件，是否需要消耗一些cpu资源！</span><br><span class="line"></span><br><span class="line">rdbchecksum yes   #保存rad文件的时候，进行错误的检查校验！</span><br><span class="line"></span><br><span class="line">dbfilename dump.rdb  #持久化数据库的文件名</span><br><span class="line"></span><br><span class="line">dir ./  #rdb 文件保存的目录！</span><br></pre></td></tr></tbody></table></figure><h2 id="CLIENTS-（限制）"><a href="#CLIENTS-（限制）" class="headerlink" title="CLIENTS （限制）"></a>CLIENTS （限制）</h2><p><strong>这些默认不开启</strong></p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">maxclients 10000   #设置能连接上redis的最大客户端数量</span><br><span class="line"></span><br><span class="line">maxmemory &lt;bytes&gt;  # redis 配置最大的内存容量</span><br><span class="line"></span><br><span class="line">maxmemory-policy noeviction  #内存到达上限之后的处理策略</span><br><span class="line"># volatile-lru -&gt; 只对设置了过去时间的key进行LRU（默认值）</span><br><span class="line"># allkeys-lru -&gt; 删除LRU算法的key</span><br><span class="line"># allkeys-lfu -&gt; 随机删除</span><br><span class="line"># volatile-random -&gt; 随机删除即将过期的key</span><br><span class="line"># allkeys-random -&gt; 随机删除</span><br><span class="line"># volatile-ttl -&gt; 删除即将过期的</span><br><span class="line"># noeviction -&gt; 永不过期，返回错误</span><br></pre></td></tr></tbody></table></figure><h2 id="APPEND-ONLY模式-aof配置"><a href="#APPEND-ONLY模式-aof配置" class="headerlink" title="APPEND ONLY模式  aof配置"></a>APPEND ONLY模式  aof配置</h2><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">appendonly no   #默认是不开启aof模式的，默认是使用rdb方式持久化的，在大部分所有的情况下，rdb完全够用！</span><br><span class="line"></span><br><span class="line">appendfilename "appendonly.aof"  #持久化的文件名字</span><br><span class="line"></span><br><span class="line"># appendfsync always  #每次修改都会sync 。 消耗性能</span><br><span class="line">appendfsync everysec  #每次执行sync，可能会丢失这1秒的数据！</span><br><span class="line"># appendfsync no      #不执行sync，这个时候操作系统自己同步数据，速度最快</span><br></pre></td></tr></tbody></table></figure><h2 id="REPLICATION"><a href="#REPLICATION" class="headerlink" title="REPLICATION"></a>REPLICATION</h2><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">replicaof &lt;masterip&gt; &lt;masterport&gt;    #设置连接主机ip 端口</span><br><span class="line">masterauth &lt;master-password&gt;     #设置连接主机需要的密码</span><br></pre></td></tr></tbody></table></figure>]]></content>
      
      
      <categories>
          
          <category> redis </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据库 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SpringBoot集成Redis</title>
      <link href="/2022/02/18/SpringBoot%E9%9B%86%E6%88%90Redis/"/>
      <url>/2022/02/18/SpringBoot%E9%9B%86%E6%88%90Redis/</url>
      
        <content type="html"><![CDATA[<h1 id="SpringBoot该如何集成Redis呢？"><a href="#SpringBoot该如何集成Redis呢？" class="headerlink" title="SpringBoot该如何集成Redis呢？"></a>SpringBoot该如何集成Redis呢？</h1><p>其实很简单，如果只是简单的引用只需要三步，</p><h2 id="第一步：（导入依赖）"><a href="#第一步：（导入依赖）" class="headerlink" title="第一步：（导入依赖）"></a>第一步：（导入依赖）</h2><p>这里因为是集成SpringBoot，我们可以在创建SpringBoot项目时就勾选上：</p><p><img src="https://s2.loli.net/2022/02/22/FX7uhLRwN4kmEjK.png" alt="image-20220222230003946"></p><h2 id="第二步：（配置文件-application）"><a href="#第二步：（配置文件-application）" class="headerlink" title="第二步：（配置文件.application）"></a>第二步：（配置文件.application）</h2><p>这里只介绍几个，其他的可以去看redis配置文件解释：</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>  <span class="token key atrule">redis</span><span class="token punctuation">:</span>    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">6379</span>   <span class="token comment">#端口</span>    <span class="token key atrule">host</span><span class="token punctuation">:</span> 124.223.79.104  <span class="token comment">#ip地址</span>    <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token string">'031215'</span>   <span class="token comment">#密码，这里要注意，不知道什么原因有的人密码需要使用单引号包裹</span>    <span class="token key atrule">database</span><span class="token punctuation">:</span> <span class="token number">0</span>     <span class="token comment">#使用哪个数据库  </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="第三步：（redisTemplate模板）"><a href="#第三步：（redisTemplate模板）" class="headerlink" title="第三步：（redisTemplate模板）"></a>第三步：（redisTemplate模板）</h2><h2 id="介绍："><a href="#介绍：" class="headerlink" title="介绍："></a>介绍：</h2><p>这里我们需要使用redisTemplate这个模板类，它封装了我们需要使用的方法，由于自动装配会到ICO容器中，我们只需要使用@Autowired注解装配它即可；</p><p>RedisTemplate 底层使用的并不是Jedis ，而是lettuce ，为什么使用lettuce呢？ 这就要说下他们的特点了；</p><p>jedis：采用的直连，多个线程操作的话，是不安全的，如果想要避免不安全，使用jedis pool连接池！更像BIO模式</p><p>lettuce: 采用netty，实例可以在多个线程中进行共享，不存在线程不安全的情况，可以减少线程数据，更像NIO模式</p><h2 id="源码："><a href="#源码：" class="headerlink" title="源码："></a>源码：</h2><p>这是redis中自动装配的源码</p><pre class="line-numbers language-none"><code class="language-none">@Bean@ConditionalOnMissingBean(name = {"redisTemplate"})  //这个注解的意思是如果存在名为redisTemplate的bean就不启用当前bean@ConditionalOnSingleCandidate(RedisConnectionFactory.class)public RedisTemplate&lt;Object, Object&gt; redisTemplate(RedisConnectionFactory redisConnectionFactory) {//默认的RedisTemplate没有过多设置，redis对象都需要序列化！    RedisTemplate&lt;Object, Object&gt; template = new RedisTemplate();    template.setConnectionFactory(redisConnectionFactory);    return template;}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>因为看了源码中的注解可以看到，我们自己可以去创建一个备注文件，并编写一个redisTemplate  bean放入ICO容器中，<strong>代替原来的RedisTemplate</strong>，在里面我们可以将内容序列化，使得<strong>放入redis中的数据不会乱码</strong></p><p><strong>不使用序列化：</strong></p><p>运行如下代码：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">redisTemplate<span class="token punctuation">.</span><span class="token function">getConnectionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flushAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"key1"</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token string">"好好学习"</span><span class="token punctuation">,</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"key1"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>在redis查询他的key：</p><pre class="line-numbers language-liunx" data-language="liunx"><code class="language-liunx">127.0.0.1:6379&gt; keys *1) "\xac\xed\x00\x05t\x00\x04key1"127.0.0.1:6379&gt; <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>可看出他的key不是我们想中直接是key1</p><p><strong>使用序列化：</strong></p><p>同样运行同上代码</p><p>创建自定义配置：创建一个RedisTemplate bean</p><p>在其中序列化</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//@Configuration</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisConfig</span> <span class="token punctuation">{</span>    <span class="token comment">//编写自己的redisTemplate</span><span class="token comment">//    @Bean</span>    <span class="token keyword">public</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">redisTemplate</span><span class="token punctuation">(</span><span class="token class-name">RedisConnectionFactory</span> redisConnectionFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//        为了方便自己开发，一般直接使用&lt;String, Object&gt;</span>        <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> template <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RedisTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        template<span class="token punctuation">.</span><span class="token function">setConnectionFactory</span><span class="token punctuation">(</span>redisConnectionFactory<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//        序列化配置</span>        <span class="token comment">//创建Json序列化方式  让json去解析任意的对象</span>        <span class="token class-name">Jackson2JsonRedisSerializer</span> objectJackson2JsonRedisSerializer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Jackson2JsonRedisSerializer</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//Json序列化方式需要通过ObjectMapper来进行一波转义</span>        <span class="token class-name">ObjectMapper</span> om <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        om<span class="token punctuation">.</span><span class="token function">setVisibility</span><span class="token punctuation">(</span><span class="token class-name">PropertyAccessor</span><span class="token punctuation">.</span>ALL<span class="token punctuation">,</span> <span class="token class-name">JsonAutoDetect<span class="token punctuation">.</span>Visibility</span><span class="token punctuation">.</span>ANY<span class="token punctuation">)</span><span class="token punctuation">;</span>        om<span class="token punctuation">.</span><span class="token function">activateDefaultTyping</span><span class="token punctuation">(</span><span class="token class-name">LaissezFaireSubTypeValidator</span><span class="token punctuation">.</span>instance<span class="token punctuation">,</span> <span class="token class-name">ObjectMapper<span class="token punctuation">.</span>DefaultTyping</span><span class="token punctuation">.</span>NON_FINAL<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//String序列化方式</span>        <span class="token class-name">StringRedisSerializer</span> stringRedisSerializer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringRedisSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//配置序列化方式（每个类型可设置不同的序列化方式）</span>        <span class="token comment">//key采用string序列号</span>        template<span class="token punctuation">.</span><span class="token function">setKeySerializer</span><span class="token punctuation">(</span>stringRedisSerializer<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//value类型采用object类型序列号</span>        template<span class="token punctuation">.</span><span class="token function">setValueSerializer</span><span class="token punctuation">(</span>objectJackson2JsonRedisSerializer<span class="token punctuation">)</span><span class="token punctuation">;</span>        template<span class="token punctuation">.</span><span class="token function">setHashKeySerializer</span><span class="token punctuation">(</span>stringRedisSerializer<span class="token punctuation">)</span><span class="token punctuation">;</span>        template<span class="token punctuation">.</span><span class="token function">setHashValueSerializer</span><span class="token punctuation">(</span>objectJackson2JsonRedisSerializer<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//将所有的properties set进去</span>        template<span class="token punctuation">.</span><span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> template<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>结果：</p><pre class="line-numbers language-Liunx" data-language="Liunx"><code class="language-Liunx">127.0.0.1:6379&gt; keys *1) "key1"127.0.0.1:6379&gt; <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><strong>注意，每个类型都有直接要设置的序列化</strong></p><h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"> <span class="token annotation punctuation">@Autowired</span>    <span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span><span class="token string">"redisTemplate"</span><span class="token punctuation">)</span>    <span class="token keyword">private</span> <span class="token class-name">RedisTemplate</span> redisTemplate<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Test</span>    <span class="token keyword">void</span> <span class="token function">contextLoads</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment">// opsForValue 操作字符串的，类似String类型</span>        <span class="token comment">// opsForList  操作list类型</span>        <span class="token comment">// opsForHash  操作Hash类型</span>        <span class="token comment">// opsForSet  操作set类型</span>        <span class="token comment">// opsForZSet  操作ZSet类型</span>        <span class="token comment">//特殊类型也是同上操作</span>        <span class="token comment">//redisTemplate除了指定类型操作，它本身和可以进行事务，和基本的CRUD操作</span>        redisTemplate<span class="token punctuation">.</span><span class="token function">getConnectionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flushAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"key1"</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token string">"好好学习"</span><span class="token punctuation">,</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"key1"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//获取redis的连接对象（一般很少去使用）</span><span class="token comment">//            RedisConnection connection = redisTemplate.getConnectionFactory().getConnection();</span><span class="token comment">//            connection.flushAll();</span><span class="token comment">//            connection.flushDb();</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> redis </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 整合 </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
