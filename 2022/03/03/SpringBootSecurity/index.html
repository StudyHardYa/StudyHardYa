<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="SpringBootSecurity, 好好学习Blog">
    <meta name="description" content="SpringBoot安全框架：HttpBasic认证模式：这是种防君子不防小人的认证，也是最简单的一个认证模式
编写配置类：
@Configuration
public class SecurityConfig extends WebSec">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>SpringBootSecurity | 好好学习Blog</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" type="text/css" href="/css/loading.css">

<meta name="generator" content="Hexo 6.0.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head>




<body>
    <!-- 页面加载 -->
    
<!-- 页面加载动画 -->

    <div id="loading-box">
      <div class="loading-left-bg"></div>
      <div class="loading-right-bg"></div>
      <div class="spinner-box">
        <div class="configure-border-1">
          <div class="configure-core"></div>
        </div>
        <div class="configure-border-2">
          <div class="configure-core"></div>
        </div>
        <div class="loading-word">加载中...</div>
      </div>
    </div>
    <!-- 页面加载动画 -->
    <script>
      $(document).ready(function () {
        document.body.style.overflow = 'auto';
        document.getElementById('loading-box').classList.add("loaded")
      })
    </script>
  
 

    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">好好学习Blog</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于我</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">好好学习Blog</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于我
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
    </ul>
</div>


        </div>

        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/15.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">SpringBootSecurity</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/%E5%AE%89%E5%85%A8%E6%A1%86%E6%9E%B6/">
                                <span class="chip bg-color">安全框架</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/SpringBoot-Security/" class="post-category">
                                SpringBoot-Security
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2022-03-02
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2022-04-20
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    22.2k
                </div>
                

                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.css">
        

        
        <!-- 代码块折行 -->
        <style type="text/css">
            code[class*="language-"], pre[class*="language-"] { white-space: pre-wrap !important; }
        </style>
        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="SpringBoot安全框架："><a href="#SpringBoot安全框架：" class="headerlink" title="SpringBoot安全框架："></a>SpringBoot安全框架：</h1><h2 id="HttpBasic认证模式："><a href="#HttpBasic认证模式：" class="headerlink" title="HttpBasic认证模式："></a>HttpBasic认证模式：</h2><p>这是种防君子不防小人的认证，也是最简单的一个认证模式</p>
<p>编写配置类：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecurityConfig</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token punctuation">{</span>

    <span class="token comment">//进行重写</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">//开启httpBasic认证</span>
        http<span class="token punctuation">.</span><span class="token function">httpBasic</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment">//所有的请求</span>
                <span class="token punctuation">.</span><span class="token function">authorizeHttpRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment">//匹配规则</span>
                <span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment">//所有请求都需要登录认证才可以访问</span>
                <span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p><strong>编写好配置文件后，启动会给出一个密码：</strong></p>
<p>我们使用该密码进行登录</p>
<p>Using generated security password: 8e0f5586-f414-454b-bd96-ffc82e919a6a</p>
<p><strong>我们自己指定用户名，密码修改配置文件application：</strong></p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">security</span><span class="token punctuation">:</span>
    <span class="token comment">#配置httpBasic认证的用户名，密码</span>
    <span class="token key atrule">user</span><span class="token punctuation">:</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> admin
      <span class="token key atrule">password</span><span class="token punctuation">:</span> admin123<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>启动后就不好给我们密码了，但这个密码是可以获取到的，如图：</p>
<p><img src="https://s2.loli.net/2022/03/09/Zvx8aDjWt9eLOY1.png" alt="image-20220302192907115"></p>
<p><strong>我们可以使用工具Postman获取到账户密码：</strong></p>
<p>​                                登录：</p>
<p><img src="https://s2.loli.net/2022/03/09/Peuw2ZW7bDNgGcx.png" alt="image-20220303084206675"></p>
<p><strong>可以看到有给Authorization  这个是我们的账号密码使用ase64加密后的结果我们可以复制加密后的密码去解码就可以获取到账号密码了：</strong></p>
<p><img src="https://s2.loli.net/2022/03/09/zHSoTNCL1tjQf4U.png" alt="image-20220303084235403"></p>
<p><strong>解码结果：</strong></p>
<p><img src="https://s2.loli.net/2022/03/09/STXbo9kga8Ri5FH.png" alt="image-20220303091317694"></p>
<h2 id="passwrodEncoder加密"><a href="#passwrodEncoder加密" class="headerlink" title="passwrodEncoder加密"></a>passwrodEncoder加密</h2><p>passwrodEncoder加密是不可逆的</p>
<p><strong>passwrodEncoder接口：</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">PasswordEncoder</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> <span class="token function">encode</span><span class="token punctuation">(</span><span class="token class-name">CharSequence</span> rawPassword<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//用于加密密码</span>

    <span class="token keyword">boolean</span> <span class="token function">matches</span><span class="token punctuation">(</span><span class="token class-name">CharSequence</span> rawPassword<span class="token punctuation">,</span> <span class="token class-name">String</span> encodedPassword<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//验证输入的密码是否与加密的密码一致</span>

    <span class="token keyword">default</span> <span class="token keyword">boolean</span> <span class="token function">upgradeEncoding</span><span class="token punctuation">(</span><span class="token class-name">String</span> encodedPassword<span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token comment">//密码是否需要被更新，有需要可以重新该方法</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>





<p><strong>推荐使用的实现类BCryptPasswordEncoder：</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">contextLoads</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token class-name">BCryptPasswordEncoder</span> bCryptPasswordEncoder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//密码加密</span>
    <span class="token class-name">String</span> encode <span class="token operator">=</span> bCryptPasswordEncoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token string">"123hzr"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"一次加密:"</span><span class="token operator">+</span>encode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//密码校验对比</span>
    <span class="token keyword">boolean</span> matches <span class="token operator">=</span> bCryptPasswordEncoder<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span><span class="token string">"123"</span><span class="token punctuation">,</span> encode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"密码是否正确"</span><span class="token operator">+</span>matches<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//密码校验对比</span>
    <span class="token keyword">boolean</span> matches1 <span class="token operator">=</span> bCryptPasswordEncoder<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span><span class="token string">"123hzr"</span><span class="token punctuation">,</span> encode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"密码是否正确"</span><span class="token operator">+</span>matches1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//同样密码加密，结果和第一加密码不一样，所以说passwrodEncoder加密是不可逆的</span>
    <span class="token class-name">String</span> encode2 <span class="token operator">=</span> bCryptPasswordEncoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token string">"123hzr"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"二次加密:"</span><span class="token operator">+</span>encode2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>结果</strong>：</p>
<pre class="line-numbers language-none"><code class="language-none">一次加密:$2a$10$6zuzvMqFVq89TerHtThXder6n2VqOMyJF6hpAn8ZBYjA7FaGOPzOy
密码是否正确false
密码是否正确true
二次加密:$2a$10$rAznej1Fv0VGqXkXo7tKiu4c0nBwEYzVykbPfhGE9YSi25xpmTL7G<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>



<p><strong>加密值解释：</strong></p>
<p>$2a  //表示 BCrypt 算法版本</p>
<p>$10    //表示算法强度</p>
<p>$rAznej1Fv0VGqXkXo7tK   //随机生成的盐值</p>
<p>iu4c0nBwEYzVykbPfhGE9YSi25xpmTL7G  //hash值</p>
<h2 id="formLogin登录认证"><a href="#formLogin登录认证" class="headerlink" title="formLogin登录认证"></a>formLogin登录认证</h2><h3 id="同样先编写配置类："><a href="#同样先编写配置类：" class="headerlink" title="同样先编写配置类："></a>同样先编写配置类：</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecurityConfig</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * 登录认证方法
     * @param http
     * @throws Exception
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    
        <span class="token comment">//开启formLogin登录认证</span>
        <span class="token comment">//关闭防御csrf攻击</span>
        http<span class="token punctuation">.</span><span class="token function">csrf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">formLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">loginPage</span><span class="token punctuation">(</span><span class="token string">"/logins"</span><span class="token punctuation">)</span>    <span class="token comment">//用于选择登录页面，没认证时跳转的页面</span>
                <span class="token punctuation">.</span><span class="token function">loginProcessingUrl</span><span class="token punctuation">(</span><span class="token string">"/login"</span><span class="token punctuation">)</span>   <span class="token comment">//选择需要认证的请求，也就是登录表单的提交地址</span>
                <span class="token punctuation">.</span><span class="token function">usernameParameter</span><span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">)</span>   <span class="token comment">//选择登录请求的哪个参数是用户名</span>
                <span class="token punctuation">.</span><span class="token function">passwordParameter</span><span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">)</span>   <span class="token comment">//选择登录请求的哪个参数是密码</span>
                <span class="token punctuation">.</span><span class="token function">defaultSuccessUrl</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span>   <span class="token comment">//登录成功跳转的路径</span>
                <span class="token punctuation">.</span><span class="token function">failureForwardUrl</span><span class="token punctuation">(</span><span class="token string">"/logins"</span><span class="token punctuation">)</span>  <span class="token comment">//登录失败跳转的路径</span>
             <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//自定义过滤拦截请求</span>
                <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/logins"</span><span class="token punctuation">,</span><span class="token string">"/login"</span><span class="token punctuation">)</span> <span class="token comment">//资源路径</span>
                <span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">//当前资源路径不需要认证就可以访问</span>
                <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/business1"</span><span class="token punctuation">,</span><span class="token string">"/business2"</span><span class="token punctuation">,</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token comment">//资源路径</span>
                <span class="token punctuation">.</span><span class="token function">hasAnyAuthority</span><span class="token punctuation">(</span><span class="token string">"ROLE_user"</span><span class="token punctuation">,</span><span class="token string">"ROLE_admin"</span><span class="token punctuation">)</span><span class="token comment">//设置可以访问的角色,user角色和admin角色都可以访问</span>

                    <span class="token comment">//访问角色控制方式1  与授权方法1一起使用</span>
                <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/log"</span><span class="token punctuation">,</span><span class="token string">"/user"</span><span class="token punctuation">)</span><span class="token comment">//资源路径</span>
                <span class="token punctuation">.</span><span class="token function">hasRole</span><span class="token punctuation">(</span><span class="token string">"admin"</span><span class="token punctuation">)</span><span class="token comment">//设置可以访问的角色，和hasAnyAuthority作用相同，但hasAnyAuthority可以设置多个，并且需要加前缀ROLE_</span>

                    <span class="token comment">//访问角色控制方式2  与授权方法2一起使用  这里由于它不是admin角色了，所有访问业务1业务2访问不了但可以修改一下</span>
<span class="token comment">//                .antMatchers("/user").hasAnyAuthority("sys:user")  // /user资源路径 必须拥有sys:user角色才可访问</span>
<span class="token comment">//                .antMatchers("/log").hasAnyAuthority("sys:log") // /log资源路径 必须拥有sys:log角色才可访问</span>

                <span class="token comment">//选择的匹配规则</span>
                <span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment">//所有请求都需要登录认证才可以访问</span>
                <span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//.authorizeHttpRequests()   这样方法表示选中的请求</span>
    <span class="token punctuation">}</span>


    <span class="token comment">/**
     * 授权方法
     * @param auth
     * @throws Exception
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationManagerBuilder</span> auth<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                auth  <span class="token comment">//授权</span>
                <span class="token punctuation">.</span><span class="token function">inMemoryAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">//将这种用户添加到内存中登录认证，   还有其他类型的授权登录认证方法，比如数据库的登录认证</span>
                <span class="token punctuation">.</span><span class="token function">withUser</span><span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">)</span>  <span class="token comment">//用户名</span>
                <span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token string">"123456"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">//密码</span>
                <span class="token punctuation">.</span><span class="token function">roles</span><span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">)</span>  <span class="token comment">//设置使用该用户名登录赋予的角色，</span>
            <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                 <span class="token punctuation">.</span><span class="token function">withUser</span><span class="token punctuation">(</span><span class="token string">"admin"</span><span class="token punctuation">)</span> <span class="token comment">//用户名</span>
                 <span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token string">"123456"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                   <span class="token comment">//第一种授权方式</span>
                 <span class="token punctuation">.</span><span class="token function">roles</span><span class="token punctuation">(</span><span class="token string">"admin"</span><span class="token punctuation">)</span>  <span class="token comment">//设置使用该账号登录赋予的角色</span>
                   <span class="token comment">//第二种授权方式</span>
                 <span class="token comment">//.authorities("sys:log","sys:user") //为当前用户赋予角色</span>
            <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                  <span class="token punctuation">.</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//配置BCrypt加密，这个会自动调用matches（）这个方法来为我们输入的密码进行对比</span>
    <span class="token punctuation">}</span>

	<span class="token comment">/**
	*加密方式
	*/</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">PasswordEncoder</span> <span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 静态资源路径开放
     * @param web
     * @throws Exception
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">WebSecurity</span> web<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">//将项目中的静态资源路径开放出来，在这开放是不需要经过过滤器拦截的</span>
        web<span class="token punctuation">.</span><span class="token function">ignoring</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/css/**"</span><span class="token punctuation">,</span><span class="token string">"/fonts/**"</span><span class="token punctuation">,</span><span class="token string">"/img/**"</span><span class="token punctuation">,</span><span class="token string">"/js/**"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>





<h3 id="controller类："><a href="#controller类：" class="headerlink" title="controller类："></a>controller类：</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Controller</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> indexController <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"/"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

        <span class="token keyword">return</span> <span class="token string">"index"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token comment">//</span>
<span class="token comment">//</span>
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/logins"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

        <span class="token keyword">return</span> <span class="token string">"login"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/user"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">user</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">"user"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/log"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

        <span class="token keyword">return</span> <span class="token string">"log"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/business1"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">business1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

        <span class="token keyword">return</span> <span class="token string">"business1"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/business2"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">business2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

        <span class="token keyword">return</span> <span class="token string">"business2"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>







<h2 id="自定义登录验证处理："><a href="#自定义登录验证处理：" class="headerlink" title="自定义登录验证处理："></a><strong>自定义登录验证处理：</strong></h2><p>这里我们需要了解一下</p>
<p><img src="https://s2.loli.net/2022/03/09/DqCRLYV6WyMAa9Q.png" alt="image-20220304105306887"></p>
<p>这两类，第一个是登录成功后的处理方式，第二给是登录失败的处理方式，我们需要重新它</p>
<p><strong>AuthenticationFailureHandler  登录失败重写：</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * 登录失败后进行的操作
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyAuthenticationFailureHandler</span>
	<span class="token comment">//SimpleUrlAuthenticationFailureHandle 是AuthenticationFailureHandler的一个实现类</span>
    <span class="token keyword">extends</span> <span class="token class-name">SimpleUrlAuthenticationFailureHandler</span> <span class="token punctuation">{</span>

    <span class="token comment">//注意这个一定要使用el表达式，否则这个方法都不会进  ；这个是配置文件中自定义的参数，值为JSON</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${spring.security.loginType}"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> loginType<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ObjectMapper</span> objectMapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 登录失败后进行操作
     * @param request 请求
     * @param response 响应
     * @param exception  异常
     * @throws IOException
     * @throws ServletException
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onAuthenticationFailure</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">AuthenticationException</span> exception<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
        <span class="token comment">//判断要返回的类型</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>loginType<span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span><span class="token string">"JSON"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//告诉浏览器，以json返回</span>
            response<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token string">"application/json;charset=UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//要返回的数据  这里的JsonResult只是单纯的一个返回json信息格式的类</span>
            response<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>objectMapper<span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">JsonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">InputError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">//登录失败后进行的页面跳转，父类已经为我们实现了</span>
            response<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token string">"application/html;charset=UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onAuthenticationFailure</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> exception<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>





<p> <strong>AuthenticationSuccessHandler 登录成功重新:</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * 配置登录成功后需要的操作
 * 实现AuthenticationSuccessHandler登录成功进行的操作
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyAuthenticationSuccessHandler</span>
    <span class="token comment">//SavedRequestAwareAuthenticationSuccessHandler 继承该类，该类实现了AuthenticationSuccessHandler登录成功进行的操作</span>
    <span class="token comment">//这个类中有帮我们实现一些有用的方法，比如说记住用户上一次的操作，登录后跳转的页面就是用户上一次未能进入的页面，而不是首页</span>
    <span class="token keyword">extends</span> <span class="token class-name">SavedRequestAwareAuthenticationSuccessHandler</span> <span class="token punctuation">{</span>

    <span class="token comment">//注意这个一定要使用el表达式，否则这个方法都不会进  ；这个是配置文件中自定义的参数，值为JSON</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${spring.security.loginType}"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> loginType<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ObjectMapper</span> objectMapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token comment">/**
     * 这个方法是登录成功后执行的
     * @param request  请求
     * @param response  响应
     * @param authentication
     * @throws ServletException
     * @throws IOException
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onAuthenticationSuccess</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Authentication</span> authentication<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token comment">//判断要返回的类型</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>loginType<span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span><span class="token string">"JSON"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//告诉浏览器，以json返回</span>
            response<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token string">"application/json;charset=UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//要返回的数据</span>
            response<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>objectMapper<span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">JsonResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">//会帮助我们跳转到上一次请求的页面 ,这个方法也就是我们重新的这个方法</span>
            response<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token string">"application/html;charset=UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onAuthenticationSuccess</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span>response<span class="token punctuation">,</span>authentication<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>





<p><strong>Security配置类：</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecurityConfig</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token punctuation">{</span>


    <span class="token comment">//将我们自定义的这两个类使用IOC容器装配</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">MyAuthenticationSuccessHandler</span> myAuthenticationSuccessHandler<span class="token punctuation">;</span>  <span class="token comment">//登录成功处理</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">MyAuthenticationFailureHandler</span> myAuthenticationFailureHandler<span class="token punctuation">;</span>  <span class="token comment">//登录失败处理</span>


    <span class="token comment">/**
     * 登录认证方法
     * @param http
     * @throws Exception
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>

        <span class="token comment">//开启formLogin登录认证</span>
        <span class="token comment">//关闭防御csrf攻击</span>
        http<span class="token punctuation">.</span><span class="token function">csrf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">formLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//开启formLogin登录认证</span>
                <span class="token punctuation">.</span><span class="token function">loginPage</span><span class="token punctuation">(</span><span class="token string">"/logins"</span><span class="token punctuation">)</span>    <span class="token comment">//用于选择登录页面，没认证时跳转的页面</span>
                <span class="token punctuation">.</span><span class="token function">loginProcessingUrl</span><span class="token punctuation">(</span><span class="token string">"/login"</span><span class="token punctuation">)</span>   <span class="token comment">//选择需要认证的请求，也就是登录表单的提交地址</span>
                <span class="token punctuation">.</span><span class="token function">usernameParameter</span><span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">)</span>   <span class="token comment">//选择登录请求的哪个参数是用户名</span>
                <span class="token punctuation">.</span><span class="token function">passwordParameter</span><span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">)</span>   <span class="token comment">//选择登录请求的哪个参数是密码</span>
                <span class="token comment">//使用自定义的登录失败成功处理方法</span>
                <span class="token punctuation">.</span><span class="token function">successHandler</span><span class="token punctuation">(</span>myAuthenticationSuccessHandler<span class="token punctuation">)</span>  <span class="token comment">//登录成功</span>
                <span class="token punctuation">.</span><span class="token function">failureHandler</span><span class="token punctuation">(</span>myAuthenticationFailureHandler<span class="token punctuation">)</span>  <span class="token comment">//登录失败</span>

                <span class="token comment">//这两会与我们自定义的冲突想要使用自定义的就不能使用这个</span>
<span class="token comment">//                .defaultSuccessUrl("/")   //登录成功跳转的路径</span>
<span class="token comment">//                .failureForwardUrl("/logins")  //登录失败跳转的路径</span>
             <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//自定义过滤拦截请求</span>
                <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/logins"</span><span class="token punctuation">,</span><span class="token string">"/login"</span><span class="token punctuation">)</span> <span class="token comment">//资源路径</span>
                <span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">//当前资源路径不需要认证就可以访问</span>
                <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/business1"</span><span class="token punctuation">,</span><span class="token string">"/business2"</span><span class="token punctuation">,</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token comment">//资源路径</span>
                <span class="token punctuation">.</span><span class="token function">hasAnyAuthority</span><span class="token punctuation">(</span><span class="token string">"ROLE_user"</span><span class="token punctuation">,</span><span class="token string">"ROLE_admin"</span><span class="token punctuation">)</span><span class="token comment">//设置可以访问的角色,user角色和admin角色都可以访问</span>

                    <span class="token comment">//访问角色控制方式1  与授权方法1一起使用</span>
                <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/log"</span><span class="token punctuation">,</span><span class="token string">"/user"</span><span class="token punctuation">)</span><span class="token comment">//资源路径</span>
                <span class="token punctuation">.</span><span class="token function">hasRole</span><span class="token punctuation">(</span><span class="token string">"admin"</span><span class="token punctuation">)</span><span class="token comment">//设置可以访问的角色，和hasAnyAuthority作用相同，但hasAnyAuthority可以设置多个，并且需要加前缀ROLE_</span>

                    <span class="token comment">//访问角色控制方式2  与授权方法2一起使用  这里由于它不是admin角色了，所有访问业务1业务2访问不了但可以修改一下</span>
<span class="token comment">//                .antMatchers("/user").hasAnyAuthority("sys:user")  // /user资源路径 必须拥有sys:user角色才可访问</span>
<span class="token comment">//                .antMatchers("/log").hasAnyAuthority("sys:log") // /log资源路径 必须拥有sys:log角色才可访问</span>

                <span class="token comment">//选择的匹配规则</span>
                <span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment">//所有请求都需要登录认证才可以访问</span>
                <span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//.authorizeHttpRequests()   这样方法表示选中的请求</span>
    <span class="token punctuation">}</span>


    <span class="token comment">/**
     * 授权方法
     * @param auth
     * @throws Exception
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationManagerBuilder</span> auth<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                auth  <span class="token comment">//授权</span>
                <span class="token punctuation">.</span><span class="token function">inMemoryAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">//将这种用户添加到内存中登录认证，   还有其他类型的授权登录认证方法，比如数据库的登录认证</span>
                <span class="token punctuation">.</span><span class="token function">withUser</span><span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">)</span>  <span class="token comment">//用户名</span>
                <span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token string">"123456"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">//密码</span>
                <span class="token punctuation">.</span><span class="token function">roles</span><span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">)</span>  <span class="token comment">//设置使用该用户名登录赋予的角色，</span>
            <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                 <span class="token punctuation">.</span><span class="token function">withUser</span><span class="token punctuation">(</span><span class="token string">"admin"</span><span class="token punctuation">)</span> <span class="token comment">//用户名</span>
                 <span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token string">"123456"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                   <span class="token comment">//第一种授权方式</span>
                 <span class="token punctuation">.</span><span class="token function">roles</span><span class="token punctuation">(</span><span class="token string">"admin"</span><span class="token punctuation">)</span>  <span class="token comment">//设置使用该账号登录赋予的角色</span>
                   <span class="token comment">//第二种授权方式</span>
                 <span class="token comment">//.authorities("sys:log","sys:user") //为当前用户赋予角色</span>
            <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                  <span class="token punctuation">.</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//配置BCrypt加密，这个会自动调用matches（）这个方法来为我们输入的密码进行对比</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">PasswordEncoder</span> <span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 静态资源路径开放
     * @param web
     * @throws Exception
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">WebSecurity</span> web<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">//将项目中的静态资源路径开放出来，在这开放是不需要经过过滤器拦截的</span>
        web<span class="token punctuation">.</span><span class="token function">ignoring</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/css/**"</span><span class="token punctuation">,</span><span class="token string">"/fonts/**"</span><span class="token punctuation">,</span><span class="token string">"/img/**"</span><span class="token punctuation">,</span><span class="token string">"/js/**"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>







<p><strong>由于这里返回的是Json数据，注意，那么login就需要使用Ajax的方式请求数据：</strong></p>
<pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://code.jquery.com/jquery-3.0.0.min.js<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>登录<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/login<span class="token punctuation">"</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>post<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    账号：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>username<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>user<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">&gt;</span></span>
    密码：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>button<span class="token punctuation">"</span></span> <span class="token special-attr"><span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value javascript language-javascript"><span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">"</span></span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>登录<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    <span class="token keyword">function</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> username<span class="token operator">=</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"#username"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> password<span class="token operator">=</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"#password"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        $<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">"POST"</span><span class="token punctuation">,</span>
            <span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token string">"/login"</span><span class="token punctuation">,</span>
            <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token string-property property">"user"</span><span class="token operator">:</span> username<span class="token punctuation">,</span>
                <span class="token string-property property">"password"</span><span class="token operator">:</span> password
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">json</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>json<span class="token punctuation">.</span>state <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span>
                  location<span class="token punctuation">.</span>href<span class="token operator">=</span><span class="token string">"/"</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
                  <span class="token function">alert</span><span class="token punctuation">(</span>json<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
                  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span>
                  location<span class="token punctuation">.</span>href<span class="token operator">=</span><span class="token string">"/logins"</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token function-variable function">error</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>







<h2 id="session会话的安全管理："><a href="#session会话的安全管理：" class="headerlink" title="session会话的安全管理："></a>session会话的安全管理：</h2><p><img src="https://s2.loli.net/2022/03/09/yDC5PVItQqJhvg2.png" alt="image-20220304121119473"></p>
<p><img src="https://s2.loli.net/2022/03/09/HZw4NyRuXetcvqo.png" alt="image-20220304121220680"></p>
<p>添加以上配置示例：</p>
<p><img src="https://s2.loli.net/2022/03/09/VdxHK6JY45FvpBl.png" alt="image-20220304121253830"></p>
<p><strong>session的安全保护：</strong></p>
<p><img src="https://s2.loli.net/2022/03/09/MEb92jfIm6XRuiA.png" alt="image-20220304121414386"></p>
<p><strong>cookie的安全：</strong></p>
<p><img src="https://s2.loli.net/2022/03/09/c874Wyzg2Rf93JD.png" alt="image-20220304121440993"></p>
<h2 id="同账号多登录踢下线："><a href="#同账号多登录踢下线：" class="headerlink" title="同账号多登录踢下线："></a>同账号多登录踢下线：</h2><p><strong>踢下线处理类：</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * 配置当session被踢下线之后的操作，如：跳转页面
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomExpiredSessionStrategy</span>
    <span class="token comment">//需要实现该接口</span>
    <span class="token keyword">implements</span> <span class="token class-name">SessionInformationExpiredStrategy</span> <span class="token punctuation">{</span>

    <span class="token comment">//页面跳转的处理类</span>
    <span class="token keyword">private</span> <span class="token class-name">RedirectStrategy</span> redirectStrategy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultRedirectStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    

    <span class="token comment">//用于将对象转换为json格式</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ObjectMapper</span> objectMapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token comment">/**
     * 当发现session踢下线就会调用该方法处理，前提需要再配置类中使用该类处理
     * @param event  这个类中可以获取到requesty 与 respoense
     * @throws IOException
     * @throws ServletException
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onExpiredSessionDetected</span><span class="token punctuation">(</span><span class="token class-name">SessionInformationExpiredEvent</span> event<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>

        <span class="token comment">//两种方式，前后端分离，JSON格式，与直接跳转页面的的方式</span>


            <span class="token comment">//方式二，json格式</span>
            <span class="token comment">//这里使用map也行，对象也行，就是返回的信息</span>
            <span class="token class-name">Map</span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"stat"</span><span class="token punctuation">,</span><span class="token string">"200"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"message"</span><span class="token punctuation">,</span><span class="token string">"请重新进行登录"</span><span class="token operator">+</span>event<span class="token punctuation">.</span><span class="token function">getSessionInformation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLastRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//后面的登录时间</span>
            <span class="token class-name">String</span> s <span class="token operator">=</span> objectMapper<span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>
            event<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token string">"application/json;charset=UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            event<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//            //方式一，直接跳转  这个方法是重定向到指定的页面</span>
<span class="token comment">//            redirectStrategy.sendRedirect(event.getRequest(),event.getResponse(),"/logins");</span>
<span class="token comment">//</span>



    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>





<p><strong>在securty配置类中配置：</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecurityConfig</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token punctuation">{</span>


    <span class="token comment">//将我们自定义的这两个类使用IOC容器装配</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">MyAuthenticationSuccessHandler</span> myAuthenticationSuccessHandler<span class="token punctuation">;</span>  <span class="token comment">//登录成功处理</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">MyAuthenticationFailureHandler</span> myAuthenticationFailureHandler<span class="token punctuation">;</span>  <span class="token comment">//登录失败处理</span>



        <span class="token comment">//开启formLogin登录认证</span>
        <span class="token comment">//关闭防御csrf攻击</span>
        http<span class="token punctuation">.</span><span class="token function">csrf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">formLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//开启formLogin登录认证</span>
                <span class="token punctuation">.</span><span class="token function">loginPage</span><span class="token punctuation">(</span><span class="token string">"/logins"</span><span class="token punctuation">)</span>    <span class="token comment">//用于选择登录页面，没认证时跳转的页面</span>
                <span class="token punctuation">.</span><span class="token function">loginProcessingUrl</span><span class="token punctuation">(</span><span class="token string">"/login"</span><span class="token punctuation">)</span>   <span class="token comment">//选择需要认证的请求，也就是登录表单的提交地址</span>
                <span class="token punctuation">.</span><span class="token function">usernameParameter</span><span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">)</span>   <span class="token comment">//选择登录请求的哪个参数是用户名</span>
                <span class="token punctuation">.</span><span class="token function">passwordParameter</span><span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">)</span>   <span class="token comment">//选择登录请求的哪个参数是密码</span>
                <span class="token comment">//使用自定义的登录失败成功处理方法</span>
                <span class="token punctuation">.</span><span class="token function">successHandler</span><span class="token punctuation">(</span>myAuthenticationSuccessHandler<span class="token punctuation">)</span>  <span class="token comment">//登录成功</span>
                <span class="token punctuation">.</span><span class="token function">failureHandler</span><span class="token punctuation">(</span>myAuthenticationFailureHandler<span class="token punctuation">)</span>  <span class="token comment">//登录失败</span>

                <span class="token comment">//这两会与我们自定义的冲突想要使用自定义的就不能使用这个</span>
<span class="token comment">//                .defaultSuccessUrl("/")   //登录成功跳转的路径</span>
<span class="token comment">//                .failureForwardUrl("/logins")  //登录失败跳转的路径</span>
             <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//自定义过滤拦截请求</span>
                <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/logins"</span><span class="token punctuation">,</span><span class="token string">"/login"</span><span class="token punctuation">)</span> <span class="token comment">//资源路径</span>
                <span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">//当前资源路径不需要认证就可以访问</span>
                <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/business1"</span><span class="token punctuation">,</span><span class="token string">"/business2"</span><span class="token punctuation">,</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token comment">//资源路径</span>
                <span class="token punctuation">.</span><span class="token function">hasAnyAuthority</span><span class="token punctuation">(</span><span class="token string">"ROLE_user"</span><span class="token punctuation">,</span><span class="token string">"ROLE_admin"</span><span class="token punctuation">)</span><span class="token comment">//设置可以访问的角色,user角色和admin角色都可以访问</span>

                    <span class="token comment">//访问角色控制方式1  与授权方法1一起使用</span>
                <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/log"</span><span class="token punctuation">,</span><span class="token string">"/user"</span><span class="token punctuation">)</span><span class="token comment">//资源路径</span>
                <span class="token punctuation">.</span><span class="token function">hasRole</span><span class="token punctuation">(</span><span class="token string">"admin"</span><span class="token punctuation">)</span><span class="token comment">//设置可以访问的角色，和hasAnyAuthority作用相同，但hasAnyAuthority可以设置多个，并且需要加前缀ROLE_</span>

                    <span class="token comment">//访问角色控制方式2  与授权方法2一起使用  这里由于它不是admin角色了，所有访问业务1业务2访问不了但可以修改一下</span>
<span class="token comment">//                .antMatchers("/user").hasAnyAuthority("sys:user")  // /user资源路径 必须拥有sys:user角色才可访问</span>
<span class="token comment">//                .antMatchers("/log").hasAnyAuthority("sys:log") // /log资源路径 必须拥有sys:log角色才可访问</span>
                <span class="token comment">//选择的匹配规则</span>
                <span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment">//所有请求都需要登录认证才可以访问</span>
                <span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                
                <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">sessionManagement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//启用session管理</span>
                <span class="token punctuation">.</span><span class="token function">maximumSessions</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token comment">//允许一个账号你个人同时登录，也就是一个session可以几个人同时使用</span>
                <span class="token punctuation">.</span><span class="token function">maxSessionsPreventsLogin</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token comment">//false：当登录时，其它登录的登录的地方会被踢下线;true ：当有用户在登录时不允许登录</span>
                <span class="token punctuation">.</span><span class="token function">expiredSessionStrategy</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CustomExpiredSessionStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//session超时，被踢下线的自定义操作</span>



        <span class="token comment">//.authorizeHttpRequests()   这样方法表示选中的请求</span>
    <span class="token punctuation">}</span>


    <span class="token comment">/**
     * 授权方法
     * @param auth
     * @throws Exception
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationManagerBuilder</span> auth<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                auth  <span class="token comment">//授权</span>
                <span class="token punctuation">.</span><span class="token function">inMemoryAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">//将这种用户添加到内存中登录认证，   还有其他类型的授权登录认证方法，比如数据库的登录认证</span>
                <span class="token punctuation">.</span><span class="token function">withUser</span><span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">)</span>  <span class="token comment">//用户名</span>
                <span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token string">"123456"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">//密码</span>
                <span class="token punctuation">.</span><span class="token function">roles</span><span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">)</span>  <span class="token comment">//设置使用该用户名登录赋予的角色，</span>
            <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                 <span class="token punctuation">.</span><span class="token function">withUser</span><span class="token punctuation">(</span><span class="token string">"admin"</span><span class="token punctuation">)</span> <span class="token comment">//用户名</span>
                 <span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token string">"123456"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                   <span class="token comment">//第一种授权方式</span>
                 <span class="token punctuation">.</span><span class="token function">roles</span><span class="token punctuation">(</span><span class="token string">"admin"</span><span class="token punctuation">)</span>  <span class="token comment">//设置使用该账号登录赋予的角色</span>
                   <span class="token comment">//第二种授权方式</span>
                 <span class="token comment">//.authorities("sys:log","sys:user") //为当前用户赋予角色</span>
            <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                  <span class="token punctuation">.</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//配置BCrypt加密，这个会自动调用matches（）这个方法来为我们输入的密码进行对比</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">PasswordEncoder</span> <span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 静态资源路径开放
     * @param web
     * @throws Exception
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">WebSecurity</span> web<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">//将项目中的静态资源路径开放出来，在这开放是不需要经过过滤器拦截的</span>
        web<span class="token punctuation">.</span><span class="token function">ignoring</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/css/**"</span><span class="token punctuation">,</span><span class="token string">"/fonts/**"</span><span class="token punctuation">,</span><span class="token string">"/img/**"</span><span class="token punctuation">,</span><span class="token string">"/js/**"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>





<h2 id="RBAC权限管理控制模型"><a href="#RBAC权限管理控制模型" class="headerlink" title="RBAC权限管理控制模型"></a><strong>RBAC权限管理控制模型</strong></h2><p><img src="https://s2.loli.net/2022/03/09/tsqKGbhigTXQwOS.png" alt="image-20220307195430369"></p>
<p><img src="https://s2.loli.net/2022/03/09/eFplaSkOnAr2TCc.png" alt="image-20220307195418619"></p>
<h2 id="动态加载用户角色权限数据："><a href="#动态加载用户角色权限数据：" class="headerlink" title="动态加载用户角色权限数据："></a>动态加载用户角色权限数据：</h2><p>首先我们需要实现两个类，一个是UserDetails，还有个是UserDetailsService</p>
<p>UserDetails ：这个接口为的是存放用户详细信息，</p>
<p>UserDetailsService：为加载用户的信息填写到UserDetails 中并返回给Security使用</p>
<h3 id="UserDetails："><a href="#UserDetails：" class="headerlink" title="UserDetails："></a><strong>UserDetails：</strong></h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * 用于获取用户详细信息，
 * 需要使用UserDetailsService为当前类绑定信息；
 * 还需要手动创建set方法赋值，已经创建对应的属性存值
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyUserDetails</span> <span class="token keyword">implements</span> <span class="token class-name">UserDetails</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">GrantedAuthority</span><span class="token punctuation">&gt;</span></span> authorities<span class="token punctuation">;</span>  <span class="token comment">//用户的权限集合</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> password<span class="token punctuation">;</span> <span class="token comment">//密码</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> username<span class="token punctuation">;</span> <span class="token comment">//用户名</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setAuthorities</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">GrantedAuthority</span><span class="token punctuation">&gt;</span></span> authorities<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>authorities <span class="token operator">=</span> authorities<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token class-name">String</span> password<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>password <span class="token operator">=</span> password<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setUsername</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>username <span class="token operator">=</span> username<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setAccountNonExpired</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> accountNonExpired<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>accountNonExpired <span class="token operator">=</span> accountNonExpired<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setAccountNonLocked</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> accountNonLocked<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>accountNonLocked <span class="token operator">=</span> accountNonLocked<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setCredentialsNonExpired</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> credentialsNonExpired<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>credentialsNonExpired <span class="token operator">=</span> credentialsNonExpired<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setEnabled</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> enabled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>enabled <span class="token operator">=</span> enabled<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">boolean</span> accountNonExpired<span class="token punctuation">;</span> <span class="token comment">//账号是否没过期</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> accountNonLocked<span class="token punctuation">;</span> <span class="token comment">//账号是否没被锁定</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> credentialsNonExpired<span class="token punctuation">;</span>  <span class="token comment">//用户凭证是否没过期    or 密码是否过期</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> enabled<span class="token punctuation">;</span>  <span class="token comment">//账户是否可用</span>

    <span class="token comment">/**
     * 获取用户的权限集合
     * @return
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">GrantedAuthority</span><span class="token punctuation">&gt;</span></span> <span class="token function">getAuthorities</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> authorities<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 获取密码
     * @return
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> password<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 获取用户名
     * @return
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> username<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 账号是否没过期
     *
     * @return  这里由于我数据库没加这个字段就默认为true了
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isAccountNonExpired</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 账号是否没被锁定
     *
     * @return  这里由于我数据库没加这个字段就默认为true了
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isAccountNonLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 密码是否没过期
     *
     * @return  这里由于我数据库没加这个字段就默认为true了
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isCredentialsNonExpired</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 账户是否可用
     * @return
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> enabled<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
     <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">Object</span> o<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">==</span> o<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>o <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> o<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token class-name">MyUserDetails</span> that <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">MyUserDetails</span><span class="token punctuation">)</span> o<span class="token punctuation">;</span>
        <span class="token keyword">return</span> accountNonExpired <span class="token operator">==</span> that<span class="token punctuation">.</span>accountNonExpired <span class="token operator">&amp;&amp;</span> accountNonLocked <span class="token operator">==</span> that<span class="token punctuation">.</span>accountNonLocked <span class="token operator">&amp;&amp;</span> credentialsNonExpired 			<span class="token operator">==</span> that<span class="token punctuation">.</span>credentialsNonExpired <span class="token operator">&amp;&amp;</span> enabled <span class="token operator">==</span> that<span class="token punctuation">.</span>enabled <span class="token operator">&amp;&amp;</span> <span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>authorities<span class="token punctuation">,</span> that<span class="token punctuation">.</span>authorities<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> 				   <span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> that<span class="token punctuation">.</span>password<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> that<span class="token punctuation">.</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span>authorities<span class="token punctuation">,</span> password<span class="token punctuation">,</span> username<span class="token punctuation">,</span> accountNonExpired<span class="token punctuation">,</span> accountNonLocked<span class="token punctuation">,</span> credentialsNonExpired<span class="token punctuation">,</span> 				enabled<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>





<h3 id="UserDetailsService："><a href="#UserDetailsService：" class="headerlink" title="UserDetailsService："></a>UserDetailsService：</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * 用于加载UserDetails中的详细信息
 * 为替换掉security配置类中的静态授权
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyUserDetailsService</span> <span class="token keyword">implements</span> <span class="token class-name">UserDetailsService</span> <span class="token punctuation">{</span>


    <span class="token comment">//这里三个查询其实可以放一起的，毕竟都是查询用户权限的</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">UserMapper</span> userMapper<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RoleMapper</span> roleMapper<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">MenuMapper</span> menuMapper<span class="token punctuation">;</span>


    <span class="token comment">/**
     *  使用传入的唯一标识（username） 查询用户信息，并组装成为UserDetails类返回，返回后security就会拿到哪些数据并进行验证
     *
     *  动态添加security认证，鉴权，授权相关的基础信息
     *
     * @param username  用户输入的账户，也就是security配置类中的 .usernameParameter("user")
     * @return
     * @throws UsernameNotFoundException
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">UserDetails</span> <span class="token function">loadUserByUsername</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">UsernameNotFoundException</span> <span class="token punctuation">{</span>
        <span class="token class-name">MyUserDetails</span> myUserDetails <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyUserDetails</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//获取用户基本信息</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token class-name"><span class="token namespace">userMapper<span class="token punctuation">.</span></span>UserFiend</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UsernameNotFoundException</span><span class="token punctuation">(</span><span class="token string">"用户不存在"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        myUserDetails<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        myUserDetails<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        myUserDetails<span class="token punctuation">.</span><span class="token function">setEnabled</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">isEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">//查询用户角色,赋予用户角色，我们需要在角色前加上 ROLE_</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> roleMapper<span class="token punctuation">.</span><span class="token function">listByUserId</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Role</span> role <span class="token operator">=</span> roleMapper<span class="token punctuation">.</span><span class="token function">fiendByUserId</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//在每个元素前加上ROLE_，获取角色</span>
        list<span class="token operator">=</span>list<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>rc<span class="token operator">-&gt;</span> <span class="token string">"ROLE_"</span> <span class="token operator">+</span>rc<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//根据角色获取解释对应的权限，这个是只获取要权限的页面</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> list1 <span class="token operator">=</span> menuMapper<span class="token punctuation">.</span><span class="token function">listByRoleId</span><span class="token punctuation">(</span>role<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//将角色与要权限的页面绑定</span>
        list1<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token comment">//这一步就如同为角色赋予权限</span>
        myUserDetails<span class="token punctuation">.</span><span class="token function">setAuthorities</span><span class="token punctuation">(</span>
                <span class="token comment">//由于List不能直接赋值给Authorities 所有使用AuthorityUtils.commaSeparatedStringToAuthorityList()来解决</span>
                <span class="token class-name">AuthorityUtils</span><span class="token punctuation">.</span><span class="token function">commaSeparatedStringToAuthorityList</span><span class="token punctuation">(</span>
                        <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">,</span>list1<span class="token punctuation">)</span>  <span class="token comment">//将授权页面与角色用逗号分开</span>
                <span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//返回当前用户的登录授权信息，交给iSecurity</span>
        <span class="token keyword">return</span> myUserDetails<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="修改Security配置类："><a href="#修改Security配置类：" class="headerlink" title="修改Security配置类："></a>修改Security配置类：</h3><p>注意：这里由于一些我也不知道的问题，这里的同账户登录多人不会被踢下线</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecurityConfig</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token punctuation">{</span>


    <span class="token comment">//将我们自定义的这两个类使用IOC容器装配</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">MyAuthenticationSuccessHandler</span> myAuthenticationSuccessHandler<span class="token punctuation">;</span>  <span class="token comment">//登录成功处理</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">MyAuthenticationFailureHandler</span> myAuthenticationFailureHandler<span class="token punctuation">;</span>  <span class="token comment">//登录失败处理</span>

    <span class="token comment">//导入自定义动态授权</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">MyUserDetailsService</span> myUserDetailsService<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 登录认证方法
     * @param http
     * @throws Exception
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">//开启httpBasic认证</span>
<span class="token comment">//        http.httpBasic()</span>
<span class="token comment">//                .and()</span>
<span class="token comment">//                //所有的请求</span>
<span class="token comment">//                .authorizeHttpRequests()</span>
<span class="token comment">//                //匹配规则</span>
<span class="token comment">//                .anyRequest()</span>
<span class="token comment">//                //所有请求都需要登录认证才可以访问</span>
<span class="token comment">//                .authenticated();</span>


<span class="token comment">//_______________________________________________________________________________________________________-</span>

        <span class="token comment">//开启formLogin登录认证</span>
        <span class="token comment">//关闭防御csrf攻击</span>
        http<span class="token punctuation">.</span><span class="token function">csrf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">formLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//开启formLogin登录认证</span>
                <span class="token punctuation">.</span><span class="token function">loginPage</span><span class="token punctuation">(</span><span class="token string">"/logins"</span><span class="token punctuation">)</span>    <span class="token comment">//用于选择登录页面，没认证时跳转的页面</span>
                <span class="token punctuation">.</span><span class="token function">loginProcessingUrl</span><span class="token punctuation">(</span><span class="token string">"/login"</span><span class="token punctuation">)</span>   <span class="token comment">//选择需要认证的请求，也就是登录表单的提交地址</span>
                <span class="token punctuation">.</span><span class="token function">usernameParameter</span><span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">)</span>   <span class="token comment">//选择登录请求的哪个参数是用户名</span>
                <span class="token punctuation">.</span><span class="token function">passwordParameter</span><span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">)</span>   <span class="token comment">//选择登录请求的哪个参数是密码</span>
                <span class="token comment">//使用自定义的登录失败成功处理方法</span>
                <span class="token punctuation">.</span><span class="token function">successHandler</span><span class="token punctuation">(</span>myAuthenticationSuccessHandler<span class="token punctuation">)</span>  <span class="token comment">//登录成功</span>
                <span class="token punctuation">.</span><span class="token function">failureHandler</span><span class="token punctuation">(</span>myAuthenticationFailureHandler<span class="token punctuation">)</span>  <span class="token comment">//登录失败</span>

                <span class="token comment">//这两会与我们自定义的冲突想要使用自定义的就不能使用这个</span>
<span class="token comment">//                .defaultSuccessUrl("/")   //登录成功跳转的路径</span>
<span class="token comment">//                .failureForwardUrl("/logins")  //登录失败跳转的路径</span>
             <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//自定义过滤拦截请求</span>
                <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/logins"</span><span class="token punctuation">,</span><span class="token string">"/login"</span><span class="token punctuation">,</span><span class="token string">"/"</span><span class="token punctuation">)</span> <span class="token comment">//资源路径</span>
                <span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">//当前资源路径不需要认证就可以访问</span>
                <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/business1"</span><span class="token punctuation">,</span><span class="token string">"/business2"</span><span class="token punctuation">)</span><span class="token comment">//资源路径</span>
                <span class="token punctuation">.</span><span class="token function">hasAnyAuthority</span><span class="token punctuation">(</span><span class="token string">"ROLE_user"</span><span class="token punctuation">,</span><span class="token string">"ROLE_admin"</span><span class="token punctuation">)</span><span class="token comment">//设置可以访问的角色,user角色和admin角色都可以访问</span>

                    <span class="token comment">//访问角色控制方式1  与授权方法1一起使用</span>
                <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/log"</span><span class="token punctuation">,</span><span class="token string">"/user"</span><span class="token punctuation">)</span><span class="token comment">//资源路径</span>
                <span class="token punctuation">.</span><span class="token function">hasRole</span><span class="token punctuation">(</span><span class="token string">"admin"</span><span class="token punctuation">)</span><span class="token comment">//设置可以访问的角色，和hasAnyAuthority作用相同，但hasAnyAuthority可以设置多个，并且需要加前缀ROLE_</span>
                
                <span class="token comment">//选择的匹配规则</span>
                <span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment">//所有请求都需要登录认证才可以访问</span>
                <span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">sessionManagement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//启用session管理</span>
                <span class="token punctuation">.</span><span class="token function">maximumSessions</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token comment">//允许一个账号你个人同时登录，也就是一个session可以几个人同时使用</span>
                <span class="token punctuation">.</span><span class="token function">maxSessionsPreventsLogin</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token comment">//false：当登录时，其它登录的登录的地方会被踢下线;true ：当有用户在登录时不允许登录</span>
                <span class="token punctuation">.</span><span class="token function">expiredSessionStrategy</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CustomExpiredSessionStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//session超时，被踢下线的自定义操作</span>



        <span class="token comment">//.authorizeHttpRequests()   这样方法表示选中的请求</span>
    <span class="token punctuation">}</span>


    <span class="token comment">/**
     * 授权方法
     * @param auth
     * @throws Exception
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationManagerBuilder</span> auth<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>

        <span class="token comment">//____________________静态授权________________________</span>
<span class="token comment">//                auth  //授权</span>
<span class="token comment">//                .inMemoryAuthentication()  //将这种用户添加到内存中登录认证，   还有其他类型的授权登录认证方法，比如数据库的登录认证</span>
<span class="token comment">//                .withUser("user")  //用户名</span>
<span class="token comment">//                .password(passwordEncoder().encode("123456"))  //密码</span>
<span class="token comment">//                .roles("user")  //设置使用该用户名登录赋予的角色，</span>
<span class="token comment">//            .and()</span>
<span class="token comment">//                 .withUser("admin") //用户名</span>
<span class="token comment">//                 .password(passwordEncoder().encode("123456"))</span>
<span class="token comment">//                   //第一种授权方式</span>
<span class="token comment">//                 .roles("admin")  //设置使用该账号登录赋予的角色</span>
<span class="token comment">//                   //第二种授权方式</span>
<span class="token comment">//                 //.authorities("sys:log","sys:user") //</span>


        <span class="token comment">//________________ 动态授权，需要实现UserDetailsService____________________________</span>
            auth<span class="token punctuation">.</span><span class="token function">userDetailsService</span><span class="token punctuation">(</span>myUserDetailsService<span class="token punctuation">)</span>
                  <span class="token punctuation">.</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//配置BCrypt加密，这个会自动调用matches（）这个方法来为我们输入的密码进行对比</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">PasswordEncoder</span> <span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 静态资源路径开放
     * @param web
     * @throws Exception
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">WebSecurity</span> web<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">//将项目中的静态资源路径开放出来，在这开放是不需要经过过滤器拦截的</span>
        web<span class="token punctuation">.</span><span class="token function">ignoring</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/css/**"</span><span class="token punctuation">,</span><span class="token string">"/fonts/**"</span><span class="token punctuation">,</span><span class="token string">"/img/**"</span><span class="token punctuation">,</span><span class="token string">"/js/**"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>









<h2 id="动态鉴权规则："><a href="#动态鉴权规则：" class="headerlink" title="动态鉴权规则："></a><strong>动态鉴权规则：</strong></h2><p>用于代替静态的鉴权规则</p>
<h5 id="自定义鉴权规则："><a href="#自定义鉴权规则：" class="headerlink" title="自定义鉴权规则："></a>自定义鉴权规则：</h5><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * 动态判断用户是否用于访问页面的权限，类名可以随便取
 */</span>
<span class="token annotation punctuation">@Component</span><span class="token punctuation">(</span><span class="token string">"MyRBACService"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyRBACService</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * 用于验证当前用户，是否能访问当前请求的资格与权限
     * @param request 请求
     * @param authentication  通过认证的用户主体详细信息
     * @return 有权限返回true ，没权限返回false
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">hasPermission</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">Authentication</span> authentication<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//获取主体信息UserDetails</span>
        <span class="token class-name">Object</span> principal <span class="token operator">=</span> authentication<span class="token punctuation">.</span><span class="token function">getPrincipal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//判断principal是否是UserDetails</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>principal <span class="token keyword">instanceof</span> <span class="token class-name">UserDetails</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token class-name">UserDetails</span> userDetails <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">UserDetails</span><span class="token punctuation">)</span> principal<span class="token punctuation">;</span>
            <span class="token comment">//将获取到的这一次请求的资源路径转换为SimpleGrantedAuthority类型，</span>
            <span class="token comment">// 因为UserDetails中Authorities存放用户权限的类型是SimpleGrantedAuthority类型</span>
            <span class="token class-name">SimpleGrantedAuthority</span> simpleGrantedAuthority <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleGrantedAuthority</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getRequestURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//判断当前用户的权限中是发拥有可以访问这个资源路径的权限</span>
            <span class="token comment">// contains这个方法是用于判断当前集合是否有相同的</span>
            <span class="token keyword">return</span> userDetails<span class="token punctuation">.</span><span class="token function">getAuthorities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>simpleGrantedAuthority<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>





<h5 id="Security配置类："><a href="#Security配置类：" class="headerlink" title="Security配置类："></a>Security配置类：</h5><p>这里使用动态鉴权规则后就不能使用静态授权，因为静态授权只是当前授权了角色，但角色的权限是没有配置的，我们可以看到动态鉴权是直接对当前当前用户角色可以访问的权限进行对比的，静态的只有单纯的角色，但角色是什么权限都没有的</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecurityConfig</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token punctuation">{</span>


    <span class="token comment">//将我们自定义的这两个类使用IOC容器装配</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">MyAuthenticationSuccessHandler</span> myAuthenticationSuccessHandler<span class="token punctuation">;</span>  <span class="token comment">//登录成功处理</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">MyAuthenticationFailureHandler</span> myAuthenticationFailureHandler<span class="token punctuation">;</span>  <span class="token comment">//登录失败处理</span>

    <span class="token comment">//导入自定义动态授权</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">MyUserDetailsService</span> myUserDetailsService<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 登录认证方法
     * @param http
     * @throws Exception
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">//开启httpBasic认证</span>
<span class="token comment">//        http.httpBasic()</span>
<span class="token comment">//                .and()</span>
<span class="token comment">//                //所有的请求</span>
<span class="token comment">//                .authorizeHttpRequests()</span>
<span class="token comment">//                //匹配规则</span>
<span class="token comment">//                .anyRequest()</span>
<span class="token comment">//                //所有请求都需要登录认证才可以访问</span>
<span class="token comment">//                .authenticated();</span>


<span class="token comment">//_______________________________________________________________________________________________________-</span>

        <span class="token comment">//开启formLogin登录认证</span>
        <span class="token comment">//关闭防御csrf攻击</span>
        http<span class="token punctuation">.</span><span class="token function">csrf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">formLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//开启formLogin登录认证</span>
                <span class="token punctuation">.</span><span class="token function">loginPage</span><span class="token punctuation">(</span><span class="token string">"/logins"</span><span class="token punctuation">)</span>    <span class="token comment">//用于选择登录页面，没认证时跳转的页面</span>
                <span class="token punctuation">.</span><span class="token function">loginProcessingUrl</span><span class="token punctuation">(</span><span class="token string">"/login"</span><span class="token punctuation">)</span>   <span class="token comment">//选择需要认证的请求，也就是登录表单的提交地址</span>
                <span class="token punctuation">.</span><span class="token function">usernameParameter</span><span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">)</span>   <span class="token comment">//选择登录请求的哪个参数是用户名</span>
                <span class="token punctuation">.</span><span class="token function">passwordParameter</span><span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">)</span>   <span class="token comment">//选择登录请求的哪个参数是密码</span>
                <span class="token comment">//使用自定义的登录失败成功处理方法</span>
                <span class="token punctuation">.</span><span class="token function">successHandler</span><span class="token punctuation">(</span>myAuthenticationSuccessHandler<span class="token punctuation">)</span>  <span class="token comment">//登录成功</span>
                <span class="token punctuation">.</span><span class="token function">failureHandler</span><span class="token punctuation">(</span>myAuthenticationFailureHandler<span class="token punctuation">)</span>  <span class="token comment">//登录失败</span>

                <span class="token comment">//这两会与我们自定义的冲突想要使用自定义的就不能使用这个</span>
<span class="token comment">//                .defaultSuccessUrl("/")   //登录成功跳转的路径</span>
<span class="token comment">//                .failureForwardUrl("/logins")  //登录失败跳转的路径</span>
             <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//自定义过滤拦截请求</span>
                <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/logins"</span><span class="token punctuation">,</span><span class="token string">"/login"</span><span class="token punctuation">,</span><span class="token string">"/"</span><span class="token punctuation">)</span> <span class="token comment">//资源路径</span>
                <span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">//当前资源路径不需要认证就可以访问</span>
                <span class="token comment">//____________________静态鉴权____________________________________</span>
<span class="token comment">//                .antMatchers("/business1","/business2")//资源路径</span>
<span class="token comment">//                .hasAnyAuthority("ROLE_user","ROLE_admin")//设置可以访问的角色,user角色和admin角色都可以访问</span>
<span class="token comment">//</span>
<span class="token comment">//                    //访问角色控制方式1  与授权方法1一起使用</span>
<span class="token comment">//                .antMatchers("/log","/user")//资源路径</span>
<span class="token comment">//                .hasRole("admin")//设置可以访问的角色，和hasAnyAuthority作用相同，但hasAnyAuthority可以设置多个，并且需要加前缀ROLE_</span>
<span class="token comment">//</span>
<span class="token comment">//                    //访问角色控制方式2  与授权方法2一起使用  这里由于它不是admin角色了，所有访问业务1业务2访问不了但可以修改一下</span>
<span class="token comment">////                .antMatchers("/user").hasAnyAuthority("sys:user")  // /user资源路径 必须拥有sys:user角色才可访问</span>
<span class="token comment">////                .antMatchers("/log").hasAnyAuthority("sys:log") // /log资源路径 必须拥有sys:log角色才可访问</span>
<span class="token comment">//                //选择的匹配规则</span>
<span class="token comment">//                .anyRequest()</span>
<span class="token comment">//                //所有请求都需要登录认证才可以访问</span>
<span class="token comment">//                .authenticated()</span>

                <span class="token comment">//______________________________动态图鉴权_____________________________________________</span>
                    <span class="token comment">//所有的请求都有经过MyRBACService的hasPermission方法进行鉴权 返回true可以访问，返回false不允许访问</span>
                    <span class="token comment">//anyRequest  所有的请求</span>
                    <span class="token comment">//access   访问权限</span>
                    <span class="token operator">/</span>里面使用<span class="token class-name">SpEL</span>权限表达式
                <span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">access</span><span class="token punctuation">(</span><span class="token string">"@MyRBACService.hasPermission(request,authentication)"</span><span class="token punctuation">)</span>


                <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">sessionManagement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//启用session管理</span>
                <span class="token punctuation">.</span><span class="token function">maximumSessions</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token comment">//允许一个账号你个人同时登录，也就是一个session可以几个人同时使用</span>
                <span class="token punctuation">.</span><span class="token function">maxSessionsPreventsLogin</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token comment">//false：当登录时，其它登录的登录的地方会被踢下线;true ：当有用户在登录时不允许登录</span>
                <span class="token punctuation">.</span><span class="token function">expiredSessionStrategy</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CustomExpiredSessionStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//session超时，被踢下线的自定义操作</span>



        <span class="token comment">//.authorizeHttpRequests()   这样方法表示选中的请求</span>
    <span class="token punctuation">}</span>


    <span class="token comment">/**
     * 授权方法
     * @param auth
     * @throws Exception
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationManagerBuilder</span> auth<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>

        <span class="token comment">//____________________静态授权________________________</span>
<span class="token comment">//                auth  //授权</span>
<span class="token comment">//                .inMemoryAuthentication()  //将这种用户添加到内存中登录认证，   还有其他类型的授权登录认证方法，比如数据库的登录认证</span>
<span class="token comment">//                .withUser("user")  //用户名</span>
<span class="token comment">//                .password(passwordEncoder().encode("123456"))  //密码</span>
<span class="token comment">//                .roles("user")  //设置使用该用户名登录赋予的角色，</span>
<span class="token comment">//            .and()</span>
<span class="token comment">//                 .withUser("admin") //用户名</span>
<span class="token comment">//                 .password(passwordEncoder().encode("123456"))</span>
<span class="token comment">//                   //第一种授权方式</span>
<span class="token comment">//                 .roles("admin")  //设置使用该账号登录赋予的角色</span>
<span class="token comment">//                   //第二种授权方式</span>
<span class="token comment">//                 //.authorities("sys:log","sys:user") //</span>
<span class="token comment">//                    .and().passwordEncoder(passwordEncoder()); //配置BCrypt加密，这个会自动调用matches（）这个方法来为我们输入的密码进行对比</span>
        <span class="token comment">//________________ 动态授权，需要实现UserDetailsService____________________________</span>
            auth<span class="token punctuation">.</span><span class="token function">userDetailsService</span><span class="token punctuation">(</span>myUserDetailsService<span class="token punctuation">)</span>
                  <span class="token punctuation">.</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//配置BCrypt加密，这个会自动调用matches（）这个方法来为我们输入的密码进行对比</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">PasswordEncoder</span> <span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 静态资源路径开放
     * @param web
     * @throws Exception
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">WebSecurity</span> web<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">//将项目中的静态资源路径开放出来，在这开放是不需要经过过滤器拦截的</span>
        web<span class="token punctuation">.</span><span class="token function">ignoring</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/css/**"</span><span class="token punctuation">,</span><span class="token string">"/fonts/**"</span><span class="token punctuation">,</span><span class="token string">"/img/**"</span><span class="token punctuation">,</span><span class="token string">"/js/**"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>





<h5 id="方法增强注解："><a href="#方法增强注解：" class="headerlink" title="方法增强注解："></a>方法增强注解：</h5><p><img src="https://s2.loli.net/2022/03/09/wSlBCNefJyq2sxP.png" alt="image-20220308200231990"></p>
<p><strong>@PreAuthorize(“SPEL”):  方法执行前判断用户调用权限</strong></p>
<p><img src="https://s2.loli.net/2022/03/09/37T2DwRsaM96zSh.png" alt="image-20220308200604674"></p>
<p><strong>@PreFilter(“SPEL”):方法执行前过滤参数</strong></p>
<p><img src="https://s2.loli.net/2022/03/09/QNLUZrw7TIMDj5P.png" alt="image-20220308200655277"></p>
<p><strong>@PostAuthorize(“SPEL”):方法执行后判断</strong></p>
<p><img src="https://s2.loli.net/2022/03/09/IYaygrwcXiAqV7v.png" alt="image-20220308200824019"></p>
<p><strong>@PostFilter（”SPEL“） ： 方法执行完后过滤返回值</strong></p>
<p><img src="https://s2.loli.net/2022/03/09/Hw7KEVztY8FCk52.png" alt="image-20220308200910568"></p>
<p><strong>在Security配置类中开启这个是个注解的使用：</strong></p>
<p><img src="https://s2.loli.net/2022/03/09/iwQUNd5Rg3phnHk.png" alt="image-20220308200954913"></p>
<h2 id="记住我功能："><a href="#记住我功能：" class="headerlink" title="记住我功能："></a>记住我功能：</h2><p>这个配置使用十分的简单</p>
<p><img src="https://s2.loli.net/2022/03/21/I4d1MPALWe8Qumq.png" alt="image-20220309223842857"></p>
<h5 id="Security配置类"><a href="#Security配置类" class="headerlink" title="Security配置类:"></a>Security配置类:</h5><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecurityConfig</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token punctuation">{</span>


    <span class="token comment">//将我们自定义的这两个类使用IOC容器装配</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">MyAuthenticationSuccessHandler</span> myAuthenticationSuccessHandler<span class="token punctuation">;</span>  <span class="token comment">//登录成功处理</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">MyAuthenticationFailureHandler</span> myAuthenticationFailureHandler<span class="token punctuation">;</span>  <span class="token comment">//登录失败处理</span>

    <span class="token comment">//导入自定义动态授权</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">MyUserDetailsService</span> myUserDetailsService<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 登录认证方法
     * @param http
     * @throws Exception
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">//开启httpBasic认证</span>
<span class="token comment">//        http.httpBasic()</span>
<span class="token comment">//                .and()</span>
<span class="token comment">//                //所有的请求</span>
<span class="token comment">//                .authorizeHttpRequests()</span>
<span class="token comment">//                //匹配规则</span>
<span class="token comment">//                .anyRequest()</span>
<span class="token comment">//                //所有请求都需要登录认证才可以访问</span>
<span class="token comment">//                .authenticated();</span>


<span class="token comment">//_______________________________________________________________________________________________________-</span>

        <span class="token comment">//开启formLogin登录认证</span>
        http<span class="token punctuation">.</span><span class="token function">rememberMe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//开启记住我功能  ，前端也需要有记住我字段</span>
                <span class="token punctuation">.</span><span class="token function">rememberMeCookieName</span><span class="token punctuation">(</span><span class="token string">"rememberMe-Cookie"</span><span class="token punctuation">)</span>  <span class="token comment">//存在浏览器中cookie的名称</span>
                <span class="token punctuation">.</span><span class="token function">rememberMeParameter</span><span class="token punctuation">(</span><span class="token string">"remember-me"</span><span class="token punctuation">)</span>  <span class="token comment">//表单中 自动登录 勾选框的参数名</span>
                <span class="token punctuation">.</span><span class="token function">tokenValiditySeconds</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">*</span><span class="token number">24</span><span class="token operator">*</span><span class="token number">60</span><span class="token operator">*</span><span class="token number">60</span><span class="token punctuation">)</span> <span class="token comment">//保存Cookie的有效期，默认2周</span>

                <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

                <span class="token punctuation">.</span><span class="token function">csrf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">//关闭防御csrf攻击</span>
                <span class="token punctuation">.</span><span class="token function">formLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//开启formLogin登录认证</span>
                <span class="token punctuation">.</span><span class="token function">loginPage</span><span class="token punctuation">(</span><span class="token string">"/logins"</span><span class="token punctuation">)</span>    <span class="token comment">//用于选择登录页面，没认证时跳转的页面</span>
                <span class="token punctuation">.</span><span class="token function">loginProcessingUrl</span><span class="token punctuation">(</span><span class="token string">"/login"</span><span class="token punctuation">)</span>   <span class="token comment">//选择需要认证的请求，也就是登录表单的提交地址</span>
                <span class="token punctuation">.</span><span class="token function">usernameParameter</span><span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">)</span>   <span class="token comment">//选择登录请求的哪个参数是用户名</span>
                <span class="token punctuation">.</span><span class="token function">passwordParameter</span><span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">)</span>   <span class="token comment">//选择登录请求的哪个参数是密码</span>
                <span class="token comment">//使用自定义的登录失败成功处理方法</span>
                <span class="token punctuation">.</span><span class="token function">successHandler</span><span class="token punctuation">(</span>myAuthenticationSuccessHandler<span class="token punctuation">)</span>  <span class="token comment">//登录成功</span>
                <span class="token punctuation">.</span><span class="token function">failureHandler</span><span class="token punctuation">(</span>myAuthenticationFailureHandler<span class="token punctuation">)</span>  <span class="token comment">//登录失败</span>

                <span class="token comment">//这两会与我们自定义的冲突想要使用自定义的就不能使用这个</span>
<span class="token comment">//                .defaultSuccessUrl("/")   //登录成功跳转的路径</span>
<span class="token comment">//                .failureForwardUrl("/logins")  //登录失败跳转的路径</span>
             <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//自定义过滤拦截请求</span>
                <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/logins"</span><span class="token punctuation">,</span><span class="token string">"/login"</span><span class="token punctuation">,</span><span class="token string">"/"</span><span class="token punctuation">)</span> <span class="token comment">//资源路径</span>
                <span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">//当前资源路径不需要认证就可以访问</span>

                <span class="token comment">//______________________________动态图鉴权_____________________________________________</span>
                    <span class="token comment">//所有的请求都有经过MyRBACService的hasPermission方法进行鉴权 返回true可以访问，返回false不允许访问</span>
                <span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">access</span><span class="token punctuation">(</span><span class="token string">"@MyRBACService.hasPermission(request,authentication)"</span><span class="token punctuation">)</span>


                <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">sessionManagement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//启用session管理</span>
                <span class="token punctuation">.</span><span class="token function">maximumSessions</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token comment">//允许一个账号你个人同时登录，也就是一个session可以几个人同时使用</span>
                <span class="token punctuation">.</span><span class="token function">maxSessionsPreventsLogin</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token comment">//false：当登录时，其它登录的登录的地方会被踢下线;true ：当有用户在登录时不允许登录</span>
                <span class="token punctuation">.</span><span class="token function">expiredSessionStrategy</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CustomExpiredSessionStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//session超时，被踢下线的自定义操作</span>



        <span class="token comment">//.authorizeHttpRequests()   这样方法表示选中的请求</span>
    <span class="token punctuation">}</span>


    <span class="token comment">/**
     * 授权方法
     * @param auth
     * @throws Exception
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationManagerBuilder</span> auth<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">//________________ 动态授权，需要实现UserDetailsService____________________________</span>
            auth<span class="token punctuation">.</span><span class="token function">userDetailsService</span><span class="token punctuation">(</span>myUserDetailsService<span class="token punctuation">)</span>
                  <span class="token punctuation">.</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//配置BCrypt加密，这个会自动调用matches（）这个方法来为我们输入的密码进行对比</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">PasswordEncoder</span> <span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 静态资源路径开放
     * @param web
     * @throws Exception
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">WebSecurity</span> web<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">//将项目中的静态资源路径开放出来，在这开放是不需要经过过滤器拦截的</span>
        web<span class="token punctuation">.</span><span class="token function">ignoring</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/css/**"</span><span class="token punctuation">,</span><span class="token string">"/fonts/**"</span><span class="token punctuation">,</span><span class="token string">"/img/**"</span><span class="token punctuation">,</span><span class="token string">"/js/**"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>







<h5 id="前端："><a href="#前端：" class="headerlink" title="前端："></a>前端：</h5><pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://code.jquery.com/jquery-3.0.0.min.js<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>登录<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/login<span class="token punctuation">"</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>post<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    账号：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>username<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>user<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">&gt;</span></span>
    密码：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>button<span class="token punctuation">"</span></span> <span class="token special-attr"><span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value javascript language-javascript"><span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">"</span></span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>登录<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
     记住我<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>checkbox<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>remember-me<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>remember-me<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    <span class="token keyword">function</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> username<span class="token operator">=</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"#username"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> password<span class="token operator">=</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"#password"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> remember<span class="token operator">=</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"#remember-me"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">prop</span><span class="token punctuation">(</span><span class="token string">"checked"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">alert</span><span class="token punctuation">(</span>remember<span class="token punctuation">)</span>
        $<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">"POST"</span><span class="token punctuation">,</span>
            <span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token string">"/login"</span><span class="token punctuation">,</span>
            <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token string-property property">"user"</span><span class="token operator">:</span> username<span class="token punctuation">,</span>
                <span class="token string-property property">"password"</span><span class="token operator">:</span> password<span class="token punctuation">,</span>
                <span class="token string-property property">"remember-me"</span><span class="token operator">:</span>remember
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">json</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>json<span class="token punctuation">.</span>state <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span>
                  location<span class="token punctuation">.</span>href<span class="token operator">=</span><span class="token string">"/"</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
                  <span class="token function">alert</span><span class="token punctuation">(</span>json<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
                  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span>
                  location<span class="token punctuation">.</span>href<span class="token operator">=</span><span class="token string">"/logins"</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token function-variable function">error</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>





<p>勾选记住我登录后会出现remember -me这个cookie</p>
<p><img src="https://s2.loli.net/2022/03/21/TPBXH6aGkDcMyuN.png" alt="image-20220309224317467"></p>
<p>其实它是有两层加密，最外层它是使用Base64加密的：</p>
<p>​                        解码</p>
<p><img src="https://s2.loli.net/2022/03/21/tgj25RVxHfU8cXq.png" alt="image-20220309224554252"></p>
<p>密码还使用MD5加密:</p>
<p>TokenBasedRememberMeServices类源码：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token class-name">String</span> <span class="token function">makeTokenSignature</span><span class="token punctuation">(</span><span class="token keyword">long</span> tokenExpiryTime<span class="token punctuation">,</span> <span class="token class-name">String</span> username<span class="token punctuation">,</span> <span class="token class-name">String</span> password<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> data <span class="token operator">=</span> username <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> tokenExpiryTime <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> password <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">MessageDigest</span> digest <span class="token operator">=</span> <span class="token class-name">MessageDigest</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token string">"MD5"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token class-name">Hex</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>digest<span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchAlgorithmException</span> var7<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"No MD5 algorithm available!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这图进行解释</p>
<p><img src="https://s2.loli.net/2022/03/21/P15bc6jrSX9aMuU.png" alt="image-20220309224722249"></p>
<h5 id="个性化配置"><a href="#个性化配置" class="headerlink" title="个性化配置"></a>个性化配置</h5><p><img src="https://s2.loli.net/2022/03/21/GaHOPL49KkQlRyg.png" alt="image-20220309224647471"></p>
<h2 id="记住我功能将验证数据保存到数据库："><a href="#记住我功能将验证数据保存到数据库：" class="headerlink" title="记住我功能将验证数据保存到数据库："></a>记住我功能将验证数据保存到数据库：</h2><p>我们没使用数据库存储令牌校验，当我们关闭程序时，记住我功能则会失效，客户端有session也没有用，在内存中令牌校验的数据被清空了，</p>
<p>为了防止重启程序而导致记住我失效，我们将信息存储到数据库中，</p>
<p>注意：这个存储的不是你的session，你在浏览器删除session那么同样需要重新输入密码，存储到数据库中的是类似令牌校验的信息</p>
<p><strong>先创建数据库：</strong></p>
<p>这个表是固定的，不能修改，在提供的类中，有个方法也可以创建，我们这就手动创建了</p>
<pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">CREATE TABLE `persistent_logins`(
`username` varchar (64) NOT NULL,
`series` varchar (64) NOT NULL,
`token` varchar(64) NOT NULL,
`last_used` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
PRIMARY KEY (series)
)ENGINE=InnoDB DEFAULT CHARSET=utf8;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>





<p>在Security配置类中注入一个数据源：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">DataSource</span> dataSource<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>



<p>再编辑一个bean 指定存储到数据库的操作</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * JdbcTokenRepositoryImpl 这个类是将数据保存到数据操作的类，里面有很多sql语句的，可以自己去看看
 * 这个类中已经固定要存到数据库中的哪个表，我们只需要指定数据源即可
 * initDao() 这个方法有在数据库中创建需要的表，我还没尝试过，我的表是自己手动创建的
 * 设置记住我存储到的数据源是哪个
 * @return
 */</span>
<span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">PersistentTokenRepository</span> <span class="token function">tokenRepository</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">JdbcTokenRepositoryImpl</span> jdbcTokenRepository <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JdbcTokenRepositoryImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    jdbcTokenRepository<span class="token punctuation">.</span><span class="token function">setDataSource</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> jdbcTokenRepository<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>然在告诉security指定使用这个bean</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token punctuation">.</span><span class="token function">rememberMeCookieName</span><span class="token punctuation">(</span><span class="token string">"rememberMe-Cookie"</span><span class="token punctuation">)</span>  <span class="token comment">//存在浏览器中cookie的名称</span>
<span class="token punctuation">.</span><span class="token function">rememberMeParameter</span><span class="token punctuation">(</span><span class="token string">"remember-me"</span><span class="token punctuation">)</span>  <span class="token comment">//表单中 自动登录 勾选框的参数名</span>
<span class="token punctuation">.</span><span class="token function">tokenValiditySeconds</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">*</span><span class="token number">24</span><span class="token operator">*</span><span class="token number">60</span><span class="token operator">*</span><span class="token number">60</span><span class="token punctuation">)</span> <span class="token comment">//保存Cookie的有效期，默认2周</span>
<span class="token punctuation">.</span><span class="token function">tokenRepository</span><span class="token punctuation">(</span><span class="token function">tokenRepository</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">//指定rememberMe存储到数据库规则方法</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>





<p>完整配置：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecurityConfig</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token punctuation">{</span>


    <span class="token comment">//将我们自定义的这两个类使用IOC容器装配</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">MyAuthenticationSuccessHandler</span> myAuthenticationSuccessHandler<span class="token punctuation">;</span>  <span class="token comment">//登录成功处理</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">MyAuthenticationFailureHandler</span> myAuthenticationFailureHandler<span class="token punctuation">;</span>  <span class="token comment">//登录失败处理</span>

    <span class="token comment">//导入自定义动态授权</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">MyUserDetailsService</span> myUserDetailsService<span class="token punctuation">;</span>


    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">DataSource</span> dataSource<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 登录认证方法
     * @param http
     * @throws Exception
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>


        <span class="token comment">//开启formLogin登录认证</span>
        http<span class="token punctuation">.</span><span class="token function">rememberMe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//开启记住我功能  ，前端也需要有记住我字段</span>
                <span class="token punctuation">.</span><span class="token function">rememberMeCookieName</span><span class="token punctuation">(</span><span class="token string">"rememberMe-Cookie"</span><span class="token punctuation">)</span>  <span class="token comment">//存在浏览器中cookie的名称</span>
                <span class="token punctuation">.</span><span class="token function">rememberMeParameter</span><span class="token punctuation">(</span><span class="token string">"remember-me"</span><span class="token punctuation">)</span>  <span class="token comment">//表单中 自动登录 勾选框的参数名</span>
                <span class="token punctuation">.</span><span class="token function">tokenValiditySeconds</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">*</span><span class="token number">24</span><span class="token operator">*</span><span class="token number">60</span><span class="token operator">*</span><span class="token number">60</span><span class="token punctuation">)</span> <span class="token comment">//保存Cookie的有效期，默认2周</span>
                <span class="token punctuation">.</span><span class="token function">tokenRepository</span><span class="token punctuation">(</span><span class="token function">tokenRepository</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">//指定rememberMe存储到数据库规则方法</span>

                <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

                <span class="token punctuation">.</span><span class="token function">csrf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">//关闭防御csrf攻击</span>
                <span class="token punctuation">.</span><span class="token function">formLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//开启formLogin登录认证</span>
                <span class="token punctuation">.</span><span class="token function">loginPage</span><span class="token punctuation">(</span><span class="token string">"/logins"</span><span class="token punctuation">)</span>    <span class="token comment">//用于选择登录页面，没认证时跳转的页面</span>
                <span class="token punctuation">.</span><span class="token function">loginProcessingUrl</span><span class="token punctuation">(</span><span class="token string">"/login"</span><span class="token punctuation">)</span>   <span class="token comment">//选择需要认证的请求，也就是登录表单的提交地址</span>
                <span class="token punctuation">.</span><span class="token function">usernameParameter</span><span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">)</span>   <span class="token comment">//选择登录请求的哪个参数是用户名</span>
                <span class="token punctuation">.</span><span class="token function">passwordParameter</span><span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">)</span>   <span class="token comment">//选择登录请求的哪个参数是密码</span>
                <span class="token comment">//使用自定义的登录失败成功处理方法</span>
                <span class="token punctuation">.</span><span class="token function">successHandler</span><span class="token punctuation">(</span>myAuthenticationSuccessHandler<span class="token punctuation">)</span>  <span class="token comment">//登录成功</span>
                <span class="token punctuation">.</span><span class="token function">failureHandler</span><span class="token punctuation">(</span>myAuthenticationFailureHandler<span class="token punctuation">)</span>  <span class="token comment">//登录失败</span>

                <span class="token comment">//这两会与我们自定义的冲突想要使用自定义的就不能使用这个</span>
<span class="token comment">//                .defaultSuccessUrl("/")   //登录成功跳转的路径</span>
<span class="token comment">//                .failureForwardUrl("/logins")  //登录失败跳转的路径</span>
             <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//自定义过滤拦截请求</span>
                <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/logins"</span><span class="token punctuation">,</span><span class="token string">"/login"</span><span class="token punctuation">,</span><span class="token string">"/"</span><span class="token punctuation">)</span> <span class="token comment">//资源路径</span>
                <span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">//当前资源路径不需要认证就可以访问</span>

                <span class="token comment">//______________________________动态图鉴权_____________________________________________</span>
                    <span class="token comment">//所有的请求都有经过MyRBACService的hasPermission方法进行鉴权 返回true可以访问，返回false不允许访问</span>
                <span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">access</span><span class="token punctuation">(</span><span class="token string">"@MyRBACService.hasPermission(request,authentication)"</span><span class="token punctuation">)</span>


                <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">sessionManagement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//启用session管理</span>
                <span class="token punctuation">.</span><span class="token function">maximumSessions</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token comment">//允许一个账号你个人同时登录，也就是一个session可以几个人同时使用</span>
                <span class="token punctuation">.</span><span class="token function">maxSessionsPreventsLogin</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token comment">//false：当登录时，其它登录的登录的地方会被踢下线;true ：当有用户在登录时不允许登录</span>
                <span class="token punctuation">.</span><span class="token function">expiredSessionStrategy</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CustomExpiredSessionStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//session超时，被踢下线的自定义操作</span>



        <span class="token comment">//.authorizeHttpRequests()   这样方法表示选中的请求</span>
    <span class="token punctuation">}</span>


    <span class="token comment">/**
     * 授权方法
     * @param auth
     * @throws Exception
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationManagerBuilder</span> auth<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>

        <span class="token comment">//________________ 动态授权，需要实现UserDetailsService____________________________</span>
            auth<span class="token punctuation">.</span><span class="token function">userDetailsService</span><span class="token punctuation">(</span>myUserDetailsService<span class="token punctuation">)</span>
                  <span class="token punctuation">.</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//配置BCrypt加密，这个会自动调用matches（）这个方法来为我们输入的密码进行对比</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">PasswordEncoder</span> <span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 静态资源路径开放
     * @param web
     * @throws Exception
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">WebSecurity</span> web<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">//将项目中的静态资源路径开放出来，在这开放是不需要经过过滤器拦截的</span>
        web<span class="token punctuation">.</span><span class="token function">ignoring</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/css/**"</span><span class="token punctuation">,</span><span class="token string">"/fonts/**"</span><span class="token punctuation">,</span><span class="token string">"/img/**"</span><span class="token punctuation">,</span><span class="token string">"/js/**"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * JdbcTokenRepositoryImpl 这个类中已经固定要存到数据库中的哪个表，我们只需要指定数据源即可
     * initDao() 这个方法有在数据库中创建需要的表，我还没尝试过，我的表是自己手动创建的
     * 设置记住我存储到的数据源是哪个
     * @return
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">PersistentTokenRepository</span> <span class="token function">tokenRepository</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">JdbcTokenRepositoryImpl</span> jdbcTokenRepository <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JdbcTokenRepositoryImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        jdbcTokenRepository<span class="token punctuation">.</span><span class="token function">setDataSource</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> jdbcTokenRepository<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>SPEL表达式：</p>
<p><img src="https://s2.loli.net/2022/03/21/nBC3wzYPX4Gocq9.png" alt="image-20220317231517131"></p>
<h2 id="退出登录："><a href="#退出登录：" class="headerlink" title="退出登录："></a>退出登录：</h2><h5 id="最简单的实现"><a href="#最简单的实现" class="headerlink" title="最简单的实现"></a><strong>最简单的实现</strong></h5><p>后端配置：</p>
<pre class="line-numbers language-none"><code class="language-none">.logout()//开启退出登录<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<p>前端代码：</p>
<pre class="line-numbers language-none"><code class="language-none">&lt;a href="/logout"&gt;退出登录&lt;/a&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>





<h5 id="Logout的默认行为"><a href="#Logout的默认行为" class="headerlink" title="Logout的默认行为"></a>Logout的默认行为</h5><p>1，当前session失效，即: logout的核心需求，session失效就是访问权限的回收</p>
<p>2，删除当前用户的remember-me“记住我”功能信息，数据库中的也会删除</p>
<p>3，clear清除当前的SecurityContext ，可以看做清除了也会的主体信息等</p>
<p>4，重定向到登录页面，loginPage配置项指定的页面</p>
<h5 id="个性化配置-1"><a href="#个性化配置-1" class="headerlink" title="个性化配置"></a>个性化配置</h5><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token punctuation">.</span><span class="token function">logoutSuccessUrl</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span> <span class="token comment">//退出后跳转的页面  默认退出到login页面</span>
<span class="token punctuation">.</span><span class="token function">deleteCookies</span><span class="token punctuation">(</span><span class="token string">"JSESSIONID"</span><span class="token punctuation">)</span> <span class="token comment">//退出后要删除的cookie 参数是cookie名称</span>
<span class="token punctuation">.</span><span class="token function">logoutUrl</span><span class="token punctuation">(</span><span class="token string">"/logout"</span><span class="token punctuation">)</span>  <span class="token comment">//退出请求路径，也就是页面上退出登录的路径，别忘了前端页面也要改  默认logout</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>





<h5 id="LogoutSuccessHandler-实现个性化规程功能"><a href="#LogoutSuccessHandler-实现个性化规程功能" class="headerlink" title="LogoutSuccessHandler:实现个性化规程功能"></a>LogoutSuccessHandler:实现个性化规程功能</h5><p>注意，不要与logoutSuccessUrl以前使用，否则会失效</p>
<p><strong>自定义类：</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * 自定义退出后需要进行的操作
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyLogoutSuccessHandler</span> <span class="token keyword">implements</span> <span class="token class-name">LogoutSuccessHandler</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * 进行重新方法失效个性化退出
     * @param request  请求
     * @param response  响应
     * @param authentication  主体信息
     * @throws IOException
     * @throws ServletException
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onLogoutSuccess</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Authentication</span> authentication<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"附加逻辑代码.........."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        response<span class="token punctuation">.</span><span class="token function">sendRedirect</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p><strong>Security配置类:</strong>    </p>
<pre class="line-numbers language-none"><code class="language-none">//退出登录自定义策略
@Autowired
private MyLogoutSuccessHandler myLogoutSuccessHandler;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-none"><code class="language-none">        //开启formLogin登录认证
        http.
                logout()//开启退出登录
//                .logoutSuccessUrl("/") //退出后跳转的页面  默认退出到login页面
                .deleteCookies("JSESSIONID") //指定退出后要删除的cookie
                .logoutUrl("/logout")  //退出请求路径，也就是页面上退出登录访问的地址  默认logout
                .logoutSuccessHandler(myLogoutSuccessHandler) //使用自定义退出策略 ，不能与logoutSuccessUrl共存，否则失效<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p><strong>完整Security配置类：</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecurityConfig</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token punctuation">{</span>


    <span class="token comment">//将我们自定义的这两个类使用IOC容器装配</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">MyAuthenticationSuccessHandler</span> myAuthenticationSuccessHandler<span class="token punctuation">;</span>  <span class="token comment">//登录成功处理</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">MyAuthenticationFailureHandler</span> myAuthenticationFailureHandler<span class="token punctuation">;</span>  <span class="token comment">//登录失败处理</span>

    <span class="token comment">//导入自定义动态授权</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">MyUserDetailsService</span> myUserDetailsService<span class="token punctuation">;</span>


    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">DataSource</span> dataSource<span class="token punctuation">;</span>

    <span class="token comment">//退出登录自定义策略</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">MyLogoutSuccessHandler</span> myLogoutSuccessHandler<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 登录认证方法
     * @param http
     * @throws Exception
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">//开启httpBasic认证</span>
<span class="token comment">//        http.httpBasic()</span>
<span class="token comment">//                .and()</span>
<span class="token comment">//                //所有的请求</span>
<span class="token comment">//                .authorizeHttpRequests()</span>
<span class="token comment">//                //匹配规则</span>
<span class="token comment">//                .anyRequest()</span>
<span class="token comment">//                //所有请求都需要登录认证才可以访问</span>
<span class="token comment">//                .authenticated();</span>


<span class="token comment">//_______________________________________________________________________________________________________-</span>

        <span class="token comment">//开启formLogin登录认证</span>
        http<span class="token punctuation">.</span>
                <span class="token function">logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//开启退出登录</span>
<span class="token comment">//                .logoutSuccessUrl("/") //退出后跳转的页面  默认退出到login页面</span>
                <span class="token punctuation">.</span><span class="token function">deleteCookies</span><span class="token punctuation">(</span><span class="token string">"JSESSIONID"</span><span class="token punctuation">)</span> <span class="token comment">//指定退出后要删除的cookie</span>
                <span class="token punctuation">.</span><span class="token function">logoutUrl</span><span class="token punctuation">(</span><span class="token string">"/logout"</span><span class="token punctuation">)</span>  <span class="token comment">//退出请求路径，也就是页面上退出登录访问的地址  默认logout</span>
                <span class="token punctuation">.</span><span class="token function">logoutSuccessHandler</span><span class="token punctuation">(</span>myLogoutSuccessHandler<span class="token punctuation">)</span> <span class="token comment">//使用自定义退出策略 ，不能与logoutSuccessUrl共存，否则失效</span>


                <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

                <span class="token punctuation">.</span><span class="token function">rememberMe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//开启记住我功能  ，前端也需要有记住我字段</span>
                <span class="token punctuation">.</span><span class="token function">rememberMeCookieName</span><span class="token punctuation">(</span><span class="token string">"rememberMe-Cookie"</span><span class="token punctuation">)</span>  <span class="token comment">//存在浏览器中cookie的名称</span>
                <span class="token punctuation">.</span><span class="token function">rememberMeParameter</span><span class="token punctuation">(</span><span class="token string">"remember-me"</span><span class="token punctuation">)</span>  <span class="token comment">//表单中 自动登录 勾选框的参数名</span>
                <span class="token punctuation">.</span><span class="token function">tokenValiditySeconds</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">*</span><span class="token number">24</span><span class="token operator">*</span><span class="token number">60</span><span class="token operator">*</span><span class="token number">60</span><span class="token punctuation">)</span> <span class="token comment">//保存Cookie的有效期，默认2周</span>
                <span class="token punctuation">.</span><span class="token function">tokenRepository</span><span class="token punctuation">(</span><span class="token function">tokenRepository</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">//指定rememberMe存储到数据库规则方法</span>

                <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

                <span class="token punctuation">.</span><span class="token function">csrf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">//关闭防御csrf攻击</span>
                <span class="token punctuation">.</span><span class="token function">formLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//开启formLogin登录认证</span>
                <span class="token punctuation">.</span><span class="token function">loginPage</span><span class="token punctuation">(</span><span class="token string">"/logins"</span><span class="token punctuation">)</span>    <span class="token comment">//用于选择登录页面，没认证时跳转的页面</span>
                <span class="token punctuation">.</span><span class="token function">loginProcessingUrl</span><span class="token punctuation">(</span><span class="token string">"/login"</span><span class="token punctuation">)</span>   <span class="token comment">//选择需要认证的请求，也就是登录表单的提交地址</span>
                <span class="token punctuation">.</span><span class="token function">usernameParameter</span><span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">)</span>   <span class="token comment">//选择登录请求的哪个参数是用户名</span>
                <span class="token punctuation">.</span><span class="token function">passwordParameter</span><span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">)</span>   <span class="token comment">//选择登录请求的哪个参数是密码</span>
                <span class="token comment">//使用自定义的登录失败成功处理方法</span>
                <span class="token punctuation">.</span><span class="token function">successHandler</span><span class="token punctuation">(</span>myAuthenticationSuccessHandler<span class="token punctuation">)</span>  <span class="token comment">//登录成功</span>
                <span class="token punctuation">.</span><span class="token function">failureHandler</span><span class="token punctuation">(</span>myAuthenticationFailureHandler<span class="token punctuation">)</span>  <span class="token comment">//登录失败</span>

                <span class="token comment">//这两会与我们自定义的冲突想要使用自定义的就不能使用这个</span>
<span class="token comment">//                .defaultSuccessUrl("/")   //登录成功跳转的路径</span>
<span class="token comment">//                .failureForwardUrl("/logins")  //登录失败跳转的路径</span>
             <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//自定义过滤拦截请求</span>
                <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/logins"</span><span class="token punctuation">,</span><span class="token string">"/login"</span><span class="token punctuation">,</span><span class="token string">"/"</span><span class="token punctuation">)</span> <span class="token comment">//资源路径</span>
                <span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">//当前资源路径不需要认证就可以访问</span>
                <span class="token comment">//____________________静态鉴权____________________________________</span>
<span class="token comment">//                .antMatchers("/business1","/business2")//资源路径</span>
<span class="token comment">//                .hasAnyAuthority("ROLE_user","ROLE_admin")//设置可以访问的角色,user角色和admin角色都可以访问</span>
<span class="token comment">//</span>
<span class="token comment">//                    //访问角色控制方式1  与授权方法1一起使用</span>
<span class="token comment">//                .antMatchers("/log","/user")//资源路径</span>
<span class="token comment">//                .hasRole("admin")//设置可以访问的角色，和hasAnyAuthority作用相同，但hasAnyAuthority可以设置多个，并且需要加前缀ROLE_</span>
<span class="token comment">//</span>
<span class="token comment">//                    //访问角色控制方式2  与授权方法2一起使用  这里由于它不是admin角色了，所有访问业务1业务2访问不了但可以修改一下</span>
<span class="token comment">////                .antMatchers("/user").hasAnyAuthority("sys:user")  // /user资源路径 必须拥有sys:user角色才可访问</span>
<span class="token comment">////                .antMatchers("/log").hasAnyAuthority("sys:log") // /log资源路径 必须拥有sys:log角色才可访问</span>
<span class="token comment">//                //选择的匹配规则</span>
<span class="token comment">//                .anyRequest()</span>
<span class="token comment">//                //所有请求都需要登录认证才可以访问</span>
<span class="token comment">//                .authenticated()</span>

                <span class="token comment">//______________________________动态图鉴权_____________________________________________</span>
                    <span class="token comment">//所有的请求都有经过MyRBACService的hasPermission方法进行鉴权 返回true可以访问，返回false不允许访问</span>
                <span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">access</span><span class="token punctuation">(</span><span class="token string">"@MyRBACService.hasPermission(request,authentication)"</span><span class="token punctuation">)</span>


                <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">sessionManagement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//启用session管理</span>
                <span class="token punctuation">.</span><span class="token function">maximumSessions</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token comment">//允许一个账号你个人同时登录，也就是一个session可以几个人同时使用</span>
                <span class="token punctuation">.</span><span class="token function">maxSessionsPreventsLogin</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token comment">//false：当登录时，其它登录的登录的地方会被踢下线;true ：当有用户在登录时不允许登录</span>
                <span class="token punctuation">.</span><span class="token function">expiredSessionStrategy</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CustomExpiredSessionStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//session超时，被踢下线的自定义操作</span>



        <span class="token comment">//.authorizeHttpRequests()   这样方法表示选中的请求</span>
    <span class="token punctuation">}</span>


    <span class="token comment">/**
     * 授权方法
     * @param auth
     * @throws Exception
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationManagerBuilder</span> auth<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>

        <span class="token comment">//____________________静态授权________________________</span>
<span class="token comment">//                auth  //授权</span>
<span class="token comment">//                .inMemoryAuthentication()  //将这种用户添加到内存中登录认证，   还有其他类型的授权登录认证方法，比如数据库的登录认证</span>
<span class="token comment">//                .withUser("user")  //用户名</span>
<span class="token comment">//                .password(passwordEncoder().encode("123456"))  //密码</span>
<span class="token comment">//                .roles("user")  //设置使用该用户名登录赋予的角色，</span>
<span class="token comment">//            .and()</span>
<span class="token comment">//                 .withUser("admin") //用户名</span>
<span class="token comment">//                 .password(passwordEncoder().encode("123456"))</span>
<span class="token comment">//                   //第一种授权方式</span>
<span class="token comment">//                 .roles("admin")  //设置使用该账号登录赋予的角色</span>
<span class="token comment">//                   //第二种授权方式</span>
<span class="token comment">//                 //.authorities("sys:log","sys:user") //</span>
<span class="token comment">//                    .and().passwordEncoder(passwordEncoder()); //配置BCrypt加密，这个会自动调用matches（）这个方法来为我们输入的密码进行对比</span>
        <span class="token comment">//________________ 动态授权，需要实现UserDetailsService____________________________</span>
            auth<span class="token punctuation">.</span><span class="token function">userDetailsService</span><span class="token punctuation">(</span>myUserDetailsService<span class="token punctuation">)</span>
                  <span class="token punctuation">.</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//配置BCrypt加密，这个会自动调用matches（）这个方法来为我们输入的密码进行对比</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">PasswordEncoder</span> <span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 静态资源路径开放
     * @param web
     * @throws Exception
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">WebSecurity</span> web<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">//将项目中的静态资源路径开放出来，在这开放是不需要经过过滤器拦截的</span>
        web<span class="token punctuation">.</span><span class="token function">ignoring</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/css/**"</span><span class="token punctuation">,</span><span class="token string">"/fonts/**"</span><span class="token punctuation">,</span><span class="token string">"/img/**"</span><span class="token punctuation">,</span><span class="token string">"/js/**"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * JdbcTokenRepositoryImpl 这个类中已经固定要存到数据库中的哪个表，我们只需要指定数据源即可
     * initDao() 这个方法有在数据库中创建需要的表，我还没尝试过，我的表是自己手动创建的
     * 设置记住我存储到的数据源是哪个
     * @return
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">PersistentTokenRepository</span> <span class="token function">tokenRepository</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">JdbcTokenRepositoryImpl</span> jdbcTokenRepository <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JdbcTokenRepositoryImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        jdbcTokenRepository<span class="token punctuation">.</span><span class="token function">setDataSource</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> jdbcTokenRepository<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>









<h2 id="Session方式实现图片验证码"><a href="#Session方式实现图片验证码" class="headerlink" title="Session方式实现图片验证码:"></a>Session方式实现图片验证码:</h2><h3 id="配置："><a href="#配置：" class="headerlink" title="配置："></a>配置：</h3><p>我们需要先导入工具类库</p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token comment">&lt;!--   验证码工具类库  这是Google提供的一个类库   --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.github.penggle<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>kaptcha<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.3.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusions</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusion</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>javax.servlet-api<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>javax.servlet<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusion</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusions</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p><img src="https://s2.loli.net/2022/03/21/UtEnrpe3u1wLfqc.png" alt="image-20220312105200767"></p>
<p>如何我们需要这个类库配置一下参数，</p>
<p>有两种方式，第一种是使用application.properties 这种方式直接配置，第二种就是自己直接手动配置</p>
<h5 id="第一种方式："><a href="#第一种方式：" class="headerlink" title="第一种方式："></a><strong>第一种方式：</strong></h5><p>直接将配置文件写入</p>
<pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token attr-name">kaptcha.border</span><span class="token punctuation">=</span><span class="token attr-value">no</span>
<span class="token attr-name">kaptcha.border.color</span><span class="token punctuation">=</span><span class="token attr-value">105,179,90</span>
<span class="token attr-name">kaptcha.image.width</span><span class="token punctuation">=</span><span class="token attr-value">100</span>
<span class="token attr-name">kaptcha.image.height</span><span class="token punctuation">=</span><span class="token attr-value">45</span>
<span class="token attr-name">kaptcha.session.key</span><span class="token punctuation">=</span><span class="token attr-value">code</span>
<span class="token attr-name">kaptcha.textproducer.font.color</span><span class="token punctuation">=</span><span class="token attr-value">blue</span>
<span class="token attr-name">kaptcha.textproducer.font.size</span><span class="token punctuation">=</span><span class="token attr-value">35</span>
<span class="token attr-name">kaptcha.textproducer.font.names</span><span class="token punctuation">=</span><span class="token attr-value">宋体,楷体,微软雅黑</span>
<span class="token attr-name">kaptcha.textproducer.char.length</span><span class="token punctuation">=</span><span class="token attr-value">4</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h5 id="第二种方式："><a href="#第二种方式：" class="headerlink" title="第二种方式："></a><strong>第二种方式：</strong></h5><p>先创建一个properties的普通文件再将这些导入：</p>
<pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token attr-name">kaptcha.border</span><span class="token punctuation">=</span><span class="token attr-value">no</span>
<span class="token attr-name">kaptcha.border.color</span><span class="token punctuation">=</span><span class="token attr-value">105,179,90</span>
<span class="token attr-name">kaptcha.image.width</span><span class="token punctuation">=</span><span class="token attr-value">100</span>
<span class="token attr-name">kaptcha.image.height</span><span class="token punctuation">=</span><span class="token attr-value">45</span>
<span class="token attr-name">kaptcha.session.key</span><span class="token punctuation">=</span><span class="token attr-value">code</span>
<span class="token attr-name">kaptcha.textproducer.font.color</span><span class="token punctuation">=</span><span class="token attr-value">blue</span>
<span class="token attr-name">kaptcha.textproducer.font.size</span><span class="token punctuation">=</span><span class="token attr-value">35</span>
<span class="token attr-name">kaptcha.textproducer.font.names</span><span class="token punctuation">=</span><span class="token attr-value">宋体,楷体,微软雅黑</span>
<span class="token attr-name">kaptcha.textproducer.char.length</span><span class="token punctuation">=</span><span class="token attr-value">4</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h5 id="再创建一个配置类："><a href="#再创建一个配置类：" class="headerlink" title="再创建一个配置类："></a><strong>再创建一个配置类：</strong></h5><p>这个是使用的第二种方式，所以我们这个需要使用@PropertySource()去导入一下我们的properties文件，如何使用2Value注入下 </p>
<p>其实两种方式都一样，只是一个需要使用@PropertySource() 去导入，一个可以直接使用@Value注入</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">
<span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@PropertySource</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"classpath:kaptcha.properties"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">KaptChaConf</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${kaptcha.border}"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> border<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${kaptcha.border.color}"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> borderColor<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${kaptcha.textproducer.font.color}"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> fontColor<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${kaptcha.image.width}"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> imageWidth<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${kaptcha.image.height}"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> imageHeight<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${kaptcha.session.key}"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> sessionKey<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${kaptcha.textproducer.char.length}"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> charLength<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${kaptcha.textproducer.font.names}"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> fontNames<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${kaptcha.textproducer.font.size}"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> fontSize<span class="token punctuation">;</span>


    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span><span class="token string">"captchaProducer"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">DefaultKaptcha</span> <span class="token function">getKaptCha</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//拥有创建谜底和谜面的方法, createImage(String text)创建谜面图片，createText()创建谜底文字</span>
        <span class="token class-name">DefaultKaptcha</span> defaultKaptcha <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultKaptcha</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Properties</span> properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"kaptcha.border"</span><span class="token punctuation">,</span>border<span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"kaptcha.border.color"</span><span class="token punctuation">,</span>borderColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"kaptcha.image.width"</span><span class="token punctuation">,</span>imageWidth<span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"kaptcha.image.height"</span><span class="token punctuation">,</span>imageHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"kaptcha.session.key"</span><span class="token punctuation">,</span>sessionKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"kaptcha.textproducer.font.color"</span><span class="token punctuation">,</span>fontColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"kaptcha.textproducer.font.size"</span><span class="token punctuation">,</span>fontSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"kaptcha.textproducer.font.names"</span><span class="token punctuation">,</span>fontNames<span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"kaptcha.textproducer.char.length"</span><span class="token punctuation">,</span>charLength<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//设置Kaptcha的配置 ,</span>
        defaultKaptcha<span class="token punctuation">.</span><span class="token function">setConfig</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Config</span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token keyword">return</span> defaultKaptcha<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>





<h3 id="实现图片验证码加载："><a href="#实现图片验证码加载：" class="headerlink" title="实现图片验证码加载："></a>实现图片验证码加载：</h3><h5 id="存储谜底与验证码过期时间类"><a href="#存储谜底与验证码过期时间类" class="headerlink" title="存储谜底与验证码过期时间类"></a>存储谜底与验证码过期时间类</h5><p>由于图片验证码有过期时间，我们需要先创建一个类了存储我们图片验证码的谜底与过期数据</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">
<span class="token comment">/**
 * 存储谜底与验证码过期时间
 * 用于实现验证码过期，所有创建此类
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CaptchaImageVo</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> captchaCode<span class="token punctuation">;</span> <span class="token comment">//验证码谜底</span>
    <span class="token keyword">private</span> <span class="token class-name">LocalDateTime</span> expireTime<span class="token punctuation">;</span>  <span class="token comment">//验证码过期时间</span>

    <span class="token comment">/**
     * 用于初始化
     * @param captchaCode  谜底
     * @param expireAfterSeconds  过期秒数
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">CaptchaImageVo</span><span class="token punctuation">(</span><span class="token class-name">String</span> captchaCode<span class="token punctuation">,</span><span class="token keyword">int</span> expireAfterSeconds<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>captchaCode<span class="token operator">=</span>captchaCode<span class="token punctuation">;</span>
        <span class="token comment">//当前时间加上指定的秒数</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>expireTime <span class="token operator">=</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">plusSeconds</span><span class="token punctuation">(</span>expireAfterSeconds<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 判断验证码是否过期
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isExpired</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//判断当前时间是否大于过期时间，大于则失效</span>
        <span class="token keyword">return</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isAfter</span><span class="token punctuation">(</span>expireTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 获取captchaCode
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getCoed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> captchaCode<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h5 id="验证码图片Controller："><a href="#验证码图片Controller：" class="headerlink" title="验证码图片Controller："></a>验证码图片Controller：</h5><p>我们需要将验证码图片输出到页面，所以我们需要一个controller用来输出，图片我们需要使用流来输出：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CaptchaController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">DefaultKaptcha</span> defaultKaptcha<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/kaptcha"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">kaptcha</span><span class="token punctuation">(</span><span class="token class-name">HttpSession</span> session<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>

        response<span class="token punctuation">.</span><span class="token function">setDateHeader</span><span class="token punctuation">(</span><span class="token string">"Expires"</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">"Cache-Control"</span><span class="token punctuation">,</span><span class="token string">"no-store, no-cache, must-revalidate"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">addHeader</span><span class="token punctuation">(</span><span class="token string">"Cache-Control"</span><span class="token punctuation">,</span><span class="token string">"post-check=0, pre-check=0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">"Pragma"</span><span class="token punctuation">,</span><span class="token string">"no-cache"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token string">"image/jpeg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//获取谜底</span>
        <span class="token class-name">String</span> text <span class="token operator">=</span> defaultKaptcha<span class="token punctuation">.</span><span class="token function">createText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//将谜底与过期时间放到session中</span>
        session<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">"captcha_key"</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">CaptchaImageVo</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span><span class="token number">2</span><span class="token operator">*</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//这个方式使用我们不用自己去关闭流，它自动关闭，这是jdk7的语法</span>
        <span class="token keyword">try</span><span class="token punctuation">(</span><span class="token class-name">ServletOutputStream</span> out<span class="token operator">=</span>response<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token class-name">BufferedImage</span> image <span class="token operator">=</span> defaultKaptcha<span class="token punctuation">.</span><span class="token function">createImage</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//将图片以Io输出， 参数： 图片的字节 ， 图片格式 ，输入流</span>
            <span class="token class-name">ImageIO</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>image<span class="token punctuation">,</span><span class="token string">"jpg"</span><span class="token punctuation">,</span>out<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//每当缓冲区数据进入满载状态时，会对数据进行一次写出。</span>
            <span class="token comment">// 假如最后一次的数据量没有达到让缓冲区进入满载状态，这时候不主动调用flush()方法缓冲区数据将会丢失</span>
            out<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>





<h5 id="前端接收："><a href="#前端接收：" class="headerlink" title="前端接收："></a>前端接收：</h5><p>千万记着鉴权那开放访问权限</p>
<pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://code.jquery.com/jquery-3.0.0.min.js<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>登录<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/login<span class="token punctuation">"</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>post<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    账号：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>username<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>user<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">&gt;</span></span>
    密码：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">&gt;</span></span>
    验证码:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>captchaCoed<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>captchaCoed<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/kaptcha<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>kaptcha<span class="token punctuation">"</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>110px<span class="token punctuation">"</span></span> <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>40px<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>button<span class="token punctuation">"</span></span> <span class="token special-attr"><span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value javascript language-javascript"><span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">"</span></span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>登录<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
     记住我<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>checkbox<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>remember-me<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>remember-me<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    <span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//用于点击刷新验证码图片</span>
        <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"#kaptcha"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"#kaptcha"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">"src"</span><span class="token punctuation">,</span><span class="token string">"/kaptcha?"</span><span class="token operator">+</span>Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">function</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> username<span class="token operator">=</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"#username"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> password<span class="token operator">=</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"#password"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> remember<span class="token operator">=</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"#remember-me"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">prop</span><span class="token punctuation">(</span><span class="token string">"checked"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">alert</span><span class="token punctuation">(</span>remember<span class="token punctuation">)</span>
        $<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">"POST"</span><span class="token punctuation">,</span>
            <span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token string">"/login"</span><span class="token punctuation">,</span>
            <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token string-property property">"user"</span><span class="token operator">:</span> username<span class="token punctuation">,</span>
                <span class="token string-property property">"password"</span><span class="token operator">:</span> password<span class="token punctuation">,</span>
                <span class="token string-property property">"remember-me"</span><span class="token operator">:</span>remember
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">json</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>json<span class="token punctuation">.</span>state <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span>
                  location<span class="token punctuation">.</span>href<span class="token operator">=</span><span class="token string">"/"</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
                  <span class="token function">alert</span><span class="token punctuation">(</span>json<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
                  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span>
                  location<span class="token punctuation">.</span>href<span class="token operator">=</span><span class="token string">"/logins"</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token function-variable function">error</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>





<h3 id="图片验证码验证："><a href="#图片验证码验证：" class="headerlink" title="图片验证码验证："></a>图片验证码验证：</h3><p><img src="https://s2.loli.net/2022/03/21/v839L1PAlIVgajO.png" alt="image-20220313101138743"></p>
<p>如图所示，我们需要创建一个验证码过滤器，并且在usernamepasswordAuthentionFilter之前执行</p>
<h5 id="在这其中要我们需要修改下原来的登录错误处理类："><a href="#在这其中要我们需要修改下原来的登录错误处理类：" class="headerlink" title="在这其中要我们需要修改下原来的登录错误处理类："></a><strong>在这其中要我们需要修改下原来的登录错误处理类：</strong></h5><pre class="line-numbers language-none"><code class="language-none">/**
 * 登录失败后进行的操作
 */
@Component
public class MyAuthenticationFailureHandler
    extends SimpleUrlAuthenticationFailureHandler {

    //注意这个一定要使用el表达式，否则这个方法都不会进
    @Value("${spring.security.loginType}")
    private String loginType;

    //用于将对象转换为json格式
    private static ObjectMapper objectMapper = new ObjectMapper();

    /**
     * 登录失败后进行操作
     * @param request 请求
     * @param response 响应
     * @param exception  异常
     * @throws IOException
     * @throws ServletException
     */
    @Override
    public void onAuthenticationFailure(HttpServletRequest request, HttpServletResponse response, AuthenticationException exception) throws IOException, ServletException {

        //错误信息
        String errorMsg="登录失败,用户名或密码错误";

        //判断异常是否是SessionAuthenticationException类型，这个类型是验证码校验那抛出的异常
        if (exception instanceof SessionAuthenticationException){
            //将错误信息赋给错误信息返回出去
            errorMsg=exception.getMessage();
        }

        //判断要返回的类型
        if (loginType.equalsIgnoreCase("JSON")){
            //告诉浏览器，以json返回
            response.setContentType("application/json;charset=UTF-8");
            //要返回的数据
            response.getWriter().write(objectMapper.writeValueAsString(new JsonResult&lt;&gt;().InputError(errorMsg)));
        }else {
            //登录失败后进行的页面跳转，父类已经为我们实现了
            response.setContentType("application/html;charset=UTF-8");
            super.onAuthenticationFailure(request, response, exception);
        }

    }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h5 id="并且我们定义一个常量类，为了跟方便记住重复参数信息："><a href="#并且我们定义一个常量类，为了跟方便记住重复参数信息：" class="headerlink" title="并且我们定义一个常量类，为了跟方便记住重复参数信息："></a><strong>并且我们定义一个常量类，为了跟方便记住重复参数信息：</strong></h5><pre class="line-numbers language-none"><code class="language-none">public class CaptchaConstant {
    public static final String CAPTCHA_SESSION_KEY="captcha_key";
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>



<h5 id="创建过滤器："><a href="#创建过滤器：" class="headerlink" title="创建过滤器："></a>创建过滤器：</h5><pre class="line-numbers language-none"><code class="language-none">/**
 * 自定义过滤器 ，在登录身份校验前先进行检查，验证码是否正确
 * 也可以使用Filter
 * OncePerRequestFilter是Filter的实现类
 * OncePerRequestFilter 每次登录都拦截一次，
 */
@Component
public class CaptchaCodeFilter extends OncePerRequestFilter {

    /**
     * 这是我们自定义登录失败的处理方式
     */
    @Autowired
    private MyAuthenticationFailureHandler myAuthenticationFailureHandler;

    @Override
    protected void doFilterInternal(HttpServletRequest request,
                                    HttpServletResponse response,
                                    FilterChain filterChain)
            throws ServletException, IOException {

        //判断当前请求是否是向/login发送请求，并且是以post请求提交的
        if ("/login".equals(request.getRequestURI())
                &amp;&amp; "post".equalsIgnoreCase(request.getMethod())){

            try {
                //验证码校验操作
                captchaVerify(request);
            }catch (AuthenticationException e){
                //SessionAuthenticationException这个异常是继承了AuthenticationException的
                //我们自定义异常时同样也需继承AuthenticationException
                //我们将错误处理交给登录实现处理类进行操作
                myAuthenticationFailureHandler.onAuthenticationFailure(request,response,e);
                //由于这里已经是发生了异常的，我们就不能让程序再进行往下走了
                return;
            }
        }

        //如果验证成功后不是登录操作就进行放行
        filterChain.doFilter(request,response);
    }

    /**
     * 验证码验证操作
     * 里面的异常是可以自定义的，不一定就要用系统提供的
     */
    private void captchaVerify(HttpServletRequest request){

        //获取session，session中有用户的谜底与验证码过期时间
        HttpSession session = request.getSession();

        //获取用户输入的验证码
        String captchaCoed = request.getParameter("captchaCoed");
        System.out.println(captchaCoed);

        //判断用户输入的验证码是否为空
        if (captchaCoed.trim().isEmpty()){
            throw new SessionAuthenticationException("验证码不能为空");
        }

        //获取我们存入session中的CaptchaImageVo，也就是谜底与过期时间类
        CaptchaImageVo captchaImageVo = (CaptchaImageVo)session.getAttribute(CaptchaConstant.CAPTCHA_SESSION_KEY);
        System.out.println(captchaImageVo.getCoed());
        //判断session中使用有谜底
        if (Objects.isNull(captchaImageVo)){
            throw new SessionAuthenticationException("验证码不存在");
        }

        //判断验证码是否过期
        if (captchaImageVo.isExpired()){
            //移出以前的CaptchaImageVo
            session.removeAttribute(CaptchaConstant.CAPTCHA_SESSION_KEY);
            throw new SessionAuthenticationException("验证码已过期");
        }

        //判断用户输入的验证码是否与谜底一致，getCoed()这个方法就是单纯的获取captchaImageVo中的coed
        if (!captchaCoed.trim().equalsIgnoreCase(captchaImageVo.getCoed())){
            throw new SessionAuthenticationException("验证码不匹配");
        }

    }

}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h5 id="Security配置类：-1"><a href="#Security配置类：-1" class="headerlink" title="Security配置类："></a>Security配置类：</h5><p>在配置中配置在UsernamePasswordAuthenticationFilter之前插入我们创建的过滤器</p>
<pre class="line-numbers language-none"><code class="language-none">@Configuration
public class SecurityConfig extends WebSecurityConfigurerAdapter {


    //将我们自定义的这两个类使用IOC容器装配
    @Autowired
    private MyAuthenticationSuccessHandler myAuthenticationSuccessHandler;  //登录成功处理

    @Autowired
    private MyAuthenticationFailureHandler myAuthenticationFailureHandler;  //登录失败处理

    //导入自定义动态授权

    @Autowired
    private MyUserDetailsService myUserDetailsService;


    @Autowired
    private DataSource dataSource;

    //退出登录自定义策略
    @Autowired
    private MyLogoutSuccessHandler myLogoutSuccessHandler;

    //验证码过滤器
    @Autowired
    private CaptchaCodeFilter captchaCodeFilter;

    /**
     * 登录认证方法
     * @param http
     * @throws Exception
     */
    @Override
    protected void configure(HttpSecurity http) throws Exception {

        //开启formLogin登录认证
        http.
                //将验证码过滤器放置在UsernamePasswordAuthenticationFilter过滤器之前执行，AOP思想
                addFilterBefore(captchaCodeFilter, UsernamePasswordAuthenticationFilter.class)
                .logout()//开启退出登录
//                .logoutSuccessUrl("/") //退出后跳转的页面  默认退出到login页面
                .deleteCookies("JSESSIONID") //指定退出后要删除的cookie
                .logoutUrl("/logout")  //退出请求路径，也就是页面上退出登录访问的地址  默认logout
                .logoutSuccessHandler(myLogoutSuccessHandler) //使用自定义退出策略 ，不能与logoutSuccessUrl共存，否则失效


                .and()

                .rememberMe()//开启记住我功能  ，前端也需要有记住我字段
                .rememberMeCookieName("rememberMe-Cookie")  //存在浏览器中cookie的名称
                .rememberMeParameter("remember-me")  //表单中 自动登录 勾选框的参数名
                .tokenValiditySeconds(2*24*60*60) //保存Cookie的有效期，默认2周
                .tokenRepository(tokenRepository())  //指定rememberMe存储到数据库规则方法

                .and()

                .csrf().disable()  //关闭防御csrf攻击
                .formLogin()//开启formLogin登录认证
                .loginPage("/logins")    //用于选择登录页面，没认证时跳转的页面
                .loginProcessingUrl("/login")   //选择需要认证的请求，也就是登录表单的提交地址
                .usernameParameter("user")   //选择登录请求的哪个参数是用户名
                .passwordParameter("password")   //选择登录请求的哪个参数是密码
                //使用自定义的登录失败成功处理方法
                .successHandler(myAuthenticationSuccessHandler)  //登录成功
                .failureHandler(myAuthenticationFailureHandler)  //登录失败

                //这两会与我们自定义的冲突想要使用自定义的就不能使用这个
//                .defaultSuccessUrl("/")   //登录成功跳转的路径
//                .failureForwardUrl("/logins")  //登录失败跳转的路径
             .and()
                .authorizeRequests() //自定义过滤拦截请求
                .antMatchers("/logins","/login","/","/kaptcha") //资源路径
                .permitAll()  //当前资源路径不需要认证就可以访问

                //______________________________动态图鉴权_____________________________________________
                    //所有的请求都有经过MyRBACService的hasPermission方法进行鉴权 返回true可以访问，返回false不允许访问
                .anyRequest().access("@MyRBACService.hasPermission(request,authentication)")


                .and()
                .sessionManagement()//启用session管理
                .maximumSessions(1)//允许一个账号你个人同时登录，也就是一个session可以几个人同时使用
                .maxSessionsPreventsLogin(false)//false：当登录时，其它登录的登录的地方会被踢下线;true ：当有用户在登录时不允许登录
                .expiredSessionStrategy(new CustomExpiredSessionStrategy());  //session超时，被踢下线的自定义操作



        //.authorizeHttpRequests()   这样方法表示选中的请求
    }


    /**
     * 授权方法
     * @param auth
     * @throws Exception
     */
    @Override
    protected void configure(AuthenticationManagerBuilder auth) throws Exception {

        //________________ 动态授权，需要实现UserDetailsService____________________________
            auth.userDetailsService(myUserDetailsService)
                  .passwordEncoder(passwordEncoder());  //配置BCrypt加密，这个会自动调用matches（）这个方法来为我们输入的密码进行对比
    }

    @Bean
    public PasswordEncoder passwordEncoder(){
        return new BCryptPasswordEncoder();
    }

    /**
     * 静态资源路径开放
     * @param web
     * @throws Exception
     */
    @Override
    public void configure(WebSecurity web) throws Exception {
        //将项目中的静态资源路径开放出来，在这开放是不需要经过过滤器拦截的
        web.ignoring().antMatchers("/css/**","/fonts/**","/img/**","/js/**");
    }

    /**
     * JdbcTokenRepositoryImpl 这个类中已经固定要存到数据库中的哪个表，我们只需要指定数据源即可
     * initDao() 这个方法有在数据库中创建需要的表，我还没尝试过，我的表是自己手动创建的
     * 设置记住我存储到的数据源是哪个
     * @return
     */
    @Bean
    public PersistentTokenRepository tokenRepository(){
        JdbcTokenRepositoryImpl jdbcTokenRepository = new JdbcTokenRepositoryImpl();
        jdbcTokenRepository.setDataSource(dataSource);
        return jdbcTokenRepository;
    }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>









<h2 id="手机号验证码登录："><a href="#手机号验证码登录：" class="headerlink" title="手机号验证码登录："></a>手机号验证码登录：</h2><h3 id="分析："><a href="#分析：" class="headerlink" title="分析："></a>分析：</h3><p><img src="https://s2.loli.net/2022/03/21/7jINUlQWAoY1edS.png" alt="image-20220316233213777"></p>
<p><strong>使用到的常量：</strong>public static final String PHONE_SESSION_KEY = “phoneCaptcha”;</p>
<p>这是我们实现短信验证码登录需要实现发：SMS 在我这用Phone代替</p>
<p>我们需要先创建一个为我们提供发送的验证码的Controller，这个很好理解吧，点击获取验证码，如何发送短信验证码至手机号短信</p>
<h3 id="controller："><a href="#controller：" class="headerlink" title="controller："></a>controller：</h3><p>创建验证码并发送给用户手机号，还有放入session以便登录验证</p>
<pre class="line-numbers language-none"><code class="language-none">@Slf4j
@RestController
public class phoneController {


    @Autowired
    private MyUserDetailsService myUserDetailsService;

    //创建手机验证码
    @GetMapping("/smscode")
    public JsonResult sms(String phone , HttpSession session){

        //判断当前号码用户是否存在
        try {
            UserDetails userDetails = myUserDetailsService.loadUserByUsername(phone);
        }catch (Exception e){
            return new JsonResult().InputError("当前号码还未注册");
        }
        //创建一个验证码信息类，存放验证码（验证码使用随机生成），过期时间，电话号码，
        int captcha = new Random().nextInt(9999);  //随机生成验证码
        PhoneCaptchaVo phoneCaptchaVo = new PhoneCaptchaVo(String.valueOf(captcha),60,phone);

        ///TODO 调用短信服务提供商的接口发送短信
        log.info(phoneCaptchaVo.getCode()+"  &gt;&gt; 验证码已发送至 "  +phone );

        session.setAttribute("phoneCaptcha",phoneCaptchaVo);

        return new JsonResult().success("验证码已发送");
    }

}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>这里我们可以看到有给PhoneCaptchaVo 其实就和图片验证码一样，需要的类封装我们的验证基本信息，再放入session</p>
<h3 id="PhoneCaptchaVo"><a href="#PhoneCaptchaVo" class="headerlink" title="PhoneCaptchaVo :"></a>PhoneCaptchaVo :</h3><pre class="line-numbers language-none"><code class="language-none">public class PhoneCaptchaVo {

    private String captchaCode; //验证码谜底
    private LocalDateTime expireTime;  //验证码过期时间
    private String phone;  //电话号码

    /**
     * 用于初始化
     * @param captchaCode  谜底
     * @param expireAfterSeconds  过期秒数
     */
    public PhoneCaptchaVo(String captchaCode,int expireAfterSeconds,String phone){
        this.captchaCode=captchaCode;
        //当前时间加上指定的秒数
        this.expireTime = LocalDateTime.now().plusSeconds(expireAfterSeconds);
        this.phone=phone;
    }

    /**
     * 判断验证码是否过期
     * @return
     */
    public boolean isExpired(){
        //判断当前时间是否大于过期时间，大于则失效
        return LocalDateTime.now().isAfter(expireTime);
    }

    /**
     * 获取captchaCode
     * @return
     */
    public String getCode(){
        return captchaCode;
    }

    //返回电话号码
    public String getPhone(){
        return phone;
    }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>





<p>这样我们的第一步就完成了，以创建并发送验证码，</p>
<h3 id="使用过滤器进行谜底验证："><a href="#使用过滤器进行谜底验证：" class="headerlink" title="使用过滤器进行谜底验证："></a>使用过滤器进行谜底验证：</h3><p>当我们登录时我们需要进行登录信息的确认，还有谜底对比</p>
<p>这样我们就完成了基本的验证，但这样我们是无法使用的，因为的短信登录请求/PhoneLogin是无法向/login一样被识别的</p>
<p>我们还需要创建PhoneAuthenticationFilter ，就像UsernamePasswordAuthenticationFilter一样，如果给login请求就进行登录的一系列操作</p>
<pre class="line-numbers language-none"><code class="language-none">/**
 * 短信验证码登录验证的过滤器，与我们图片验证码的过滤器可以说是一模一样
 */
@Component
public class PhoneCodeValidateFilter  extends OncePerRequestFilter {
    /**
     * 这是我们自定义登录失败的处理方式
     */
    @Autowired
    private MyAuthenticationFailureHandler myAuthenticationFailureHandler;

    @Override
    protected void doFilterInternal(HttpServletRequest request,
                                    HttpServletResponse response,
                                    FilterChain filterChain)
            throws ServletException, IOException {

        //判断当前请求是否是向/login发送请求，并且是以post请求提交的
        if ("/PhoneLogin".equals(request.getRequestURI())
                &amp;&amp; "post".equalsIgnoreCase(request.getMethod())){

            try {
                //验证码校验操作
                captchaVerify(request);
            }catch (AuthenticationException e){
                //SessionAuthenticationException这个异常是继承了AuthenticationException的
                //我们自定义异常时同样也需继承AuthenticationException
                //我们将错误处理交给登录实现处理类进行操作
                myAuthenticationFailureHandler.onAuthenticationFailure(request,response,e);
                //由于这里已经是发生了异常的，我们就不能让程序再进行往下走了
                return;
            }
        }

        //如果验证成功后不是登录操作就进行放行
        filterChain.doFilter(request,response);
    }

    /**
     * 验证码验证操作
     * 里面的异常是可以自定义的，不一定就要用系统提供的
     */
    private void captchaVerify(HttpServletRequest request){

        //获取session，session中有用户的谜底与验证码过期时间
        HttpSession session = request.getSession();

        //获取用户输入的验证码
            String phone = request.getParameter("phone"); //输入的手机号码
            String phoneCode = request.getParameter("phoneCode"); //输入的验证码


        //判断用户输入的手机号是否为空
        if (phone.trim().isEmpty()){
            throw new SessionAuthenticationException("手机号不能为空");
        }

        //判断用户输入的验证码是否为空
        if (phoneCode.trim().isEmpty()){
            throw new SessionAuthenticationException("验证码不能为空");
        }

        //获取我们存入session中的CaptchaImageVo，也就是谜底与过期时间类
        PhoneCaptchaVo phoneCaptchaVo = (PhoneCaptchaVo) session.getAttribute(CaptchaConstant.PHONE_SESSION_KEY);

        //判断session中使用有谜底
        if (Objects.isNull(phoneCaptchaVo)){
            throw new SessionAuthenticationException("验证码不存在");
        }

        //判断验证码是否过期
        if (phoneCaptchaVo.isExpired()){
            //移出以前的CaptchaImageVo
            session.removeAttribute(CaptchaConstant.PHONE_SESSION_KEY);
            throw new SessionAuthenticationException("验证码已过期");
        }

        //判断用户输入的验证码是否与谜底一致
        if (!phoneCode.trim().equalsIgnoreCase(phoneCaptchaVo.getCode())){
            throw new SessionAuthenticationException("验证码不匹配");
        }

        //判断用户输入的验证码是否与谜底一致
        if (!phone.trim().equalsIgnoreCase(phoneCaptchaVo.getPhone())){
            throw new SessionAuthenticationException("手机号不匹配");
        }

        //验证完后删除验证码，不管成功还是失败
        session.removeAttribute(CaptchaConstant.PHONE_SESSION_KEY);



    }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>





<h3 id="短信鉴定登录过滤器："><a href="#短信鉴定登录过滤器：" class="headerlink" title="短信鉴定登录过滤器："></a>短信鉴定登录过滤器：</h3><p><img src="https://s2.loli.net/2022/03/21/XhP7JmLgucOi5sI.png" alt="image-20220316234227700"></p>
<p>如果所示，我们需要自定义我们的短信登录日志过滤器，当我们短信登录进来时绕过用户名密码登录过滤器。而是走我们自定义的过滤器</p>
<h4 id="实现图中第一个步骤"><a href="#实现图中第一个步骤" class="headerlink" title="实现图中第一个步骤:"></a>实现图中第一个步骤:</h4><p>创建自定义鉴定过滤器</p>
<h5 id="PhoneAuthenticationFilter："><a href="#PhoneAuthenticationFilter：" class="headerlink" title="PhoneAuthenticationFilter："></a>PhoneAuthenticationFilter：</h5><p>这个类就是图中的SmsCodeAuthenticationFilter</p>
<p>这个我们可以模仿UsernamePasswordAuthenticationFilter</p>
<pre class="line-numbers language-none"><code class="language-none">/**
 * 由于我们需要为手机号登录，
 * 我们可以仿照UsernamePasswordAuthenticationFilter用户名密码登录创建一个手机号登录过滤器交给Security
 *
 *
 */
public class PhoneAuthenticationFilter extends AbstractAuthenticationProcessingFilter {

    public static final String SPRING_SECURITY_FORM_PHONE_KEY = "phone";
    private static final AntPathRequestMatcher DEFAULT_ANT_PATH_REQUEST_MATCHER = new AntPathRequestMatcher("/PhoneLogin", "POST");
    private String phoneParameter = "phone";
    private boolean postOnly = true;

    public PhoneAuthenticationFilter() {
        super(DEFAULT_ANT_PATH_REQUEST_MATCHER);
    }

    public PhoneAuthenticationFilter(AuthenticationManager authenticationManager) {
        super(DEFAULT_ANT_PATH_REQUEST_MATCHER, authenticationManager);
    }

    public Authentication attemptAuthentication(HttpServletRequest request, HttpServletResponse response) throws AuthenticationException {
        if (this.postOnly &amp;&amp; !request.getMethod().equals("POST")) {
            throw new AuthenticationServiceException("Authentication method not supported: " + request.getMethod());
        } else {
            String phone = this.obtainPhone(request);
            phone = phone != null ? phone : "";

            //我们需要自己创建一个PhoneAuthenticationToken，可以模仿UserNameAuthenticationToken
            PhoneAuthenticationToken authRequest = new PhoneAuthenticationToken(phone);
            this.setDetails(request, authRequest);
            return this.getAuthenticationManager().authenticate(authRequest);
        }
    }

    @Nullable
    protected String obtainPhone(HttpServletRequest request) {
        return request.getParameter(this.phoneParameter);
    }

    protected void setDetails(HttpServletRequest request, PhoneAuthenticationToken authRequest) {
        authRequest.setDetails(this.authenticationDetailsSource.buildDetails(request));
    }

    public void setPhoneParameter(String usernameParameter) {
        Assert.hasText(usernameParameter, "Phone parameter must not be empty or null");
        this.phoneParameter = usernameParameter;
    }

    public void setPostOnly(boolean postOnly) {
        this.postOnly = postOnly;
    }

    public final String getUsernameParameter() {
        return this.phoneParameter;
    }

}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>





<p>再改写这个PhoneAuthenticationFilter类时我们发现UsernamePasswordAuthenticationToken令牌不是我们需要的，所以我们同样要改写，去自定义一个</p>
<p><strong>解下UsernamePasswordAuthenticationToken：</strong></p>
<p>通过类名可以的看出来，用户名密码方式进行认证。就是我们见的最多的认证方式通过用户名密码进行登录。咱们话不多说看看具体实现：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UsernamePasswordAuthenticationToken</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractAuthenticationToken</span> <span class="token punctuation">{</span>
    <span class="token comment">// 序列化id</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">530L</span><span class="token punctuation">;</span>
    <span class="token comment">// 一般指的是用户名</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Object</span> principal<span class="token punctuation">;</span>
    <span class="token comment">// 一般指的是密码</span>
    <span class="token keyword">private</span> <span class="token class-name">Object</span> credentials<span class="token punctuation">;</span>
    
    <span class="token comment">// 构造器</span>
    <span class="token comment">// principal  一般指的是用户名</span>
    <span class="token comment">// credentials  一般指的是密码</span>
    <span class="token keyword">public</span> <span class="token class-name">UsernamePasswordAuthenticationToken</span><span class="token punctuation">(</span><span class="token class-name">Object</span> principal<span class="token punctuation">,</span> <span class="token class-name">Object</span> credentials<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 初始化父类构造 权限集合为空</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token punctuation">)</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>principal <span class="token operator">=</span> principal<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>credentials <span class="token operator">=</span> credentials<span class="token punctuation">;</span>
        <span class="token comment">// 设置是否已认证 默认为false</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setAuthenticated</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 构造器</span>
     <span class="token comment">// principal  一般指的是用户名</span>
    <span class="token comment">// credentials  一般指的是密码</span>
    <span class="token comment">// authorities 权限</span>
    <span class="token keyword">public</span> <span class="token class-name">UsernamePasswordAuthenticationToken</span><span class="token punctuation">(</span><span class="token class-name">Object</span> principal<span class="token punctuation">,</span> <span class="token class-name">Object</span> credentials<span class="token punctuation">,</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">GrantedAuthority</span><span class="token punctuation">&gt;</span></span> authorities<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment">// // 初始化父类构造 权限集合</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>authorities<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>principal <span class="token operator">=</span> principal<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>credentials <span class="token operator">=</span> credentials<span class="token punctuation">;</span>
        <span class="token comment">// 设置父类方法表示已经认证</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">setAuthenticated</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 获取密码</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getCredentials</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>credentials<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 获取用户名</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getPrincipal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>principal<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 设置是否已认证 默认为false</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setAuthenticated</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> isAuthenticated<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IllegalArgumentException</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果为true</span>
        <span class="token comment">// 抛出非法参数异常</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isAuthenticated<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"Cannot set this token to trusted - use constructor which takes a GrantedAuthority list instead"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// 设置父类是否已认证</span>
            <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">setAuthenticated</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 擦除凭证</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">eraseCredentials</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
        <span class="token comment">// 调用父类方法</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">eraseCredentials</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 将密码设置为空</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>credentials <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h5 id="PhoneAuthenticationToken："><a href="#PhoneAuthenticationToken：" class="headerlink" title="PhoneAuthenticationToken："></a>PhoneAuthenticationToken：</h5><pre class="line-numbers language-none"><code class="language-none">public class PhoneAuthenticationToken  extends AbstractAuthenticationToken {

    private static final long serialVersionUID = 560L;
    //存放认证信息，认证之前放的是手机号码，认证之后存放UserDetails
    private final Object principal;

    public PhoneAuthenticationToken(Object principal) {
        super((Collection)null);
        this.principal = principal;
        this.setAuthenticated(false);
    }

    public PhoneAuthenticationToken(Object principal, Collection&lt;? extends GrantedAuthority&gt; authorities) {
        super(authorities);
        this.principal = principal;
        super.setAuthenticated(true);
    }

    //由于我们手机号登录不需要密码，这个是获取密码的，我们没有密码就返回null，
    //接口中要求实现
    public Object getCredentials() {
        return null;
    }

    public Object getPrincipal() {
        return this.principal;
    }

    public void setAuthenticated(boolean isAuthenticated) throws IllegalArgumentException {
        Assert.isTrue(!isAuthenticated, "Cannot set this token to trusted - use constructor which takes a GrantedAuthority list instead");
        super.setAuthenticated(false);
    }

    public void eraseCredentials() {
        super.eraseCredentials();
    }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h4 id="然后再实现图中第二个步骤："><a href="#然后再实现图中第二个步骤：" class="headerlink" title="然后再实现图中第二个步骤："></a>然后再实现图中第二个步骤：</h4><h5 id="实现鉴定提供者"><a href="#实现鉴定提供者" class="headerlink" title="实现鉴定提供者"></a>实现鉴定提供者</h5><pre class="line-numbers language-none"><code class="language-none">/**
 *创建一个电话号码的鉴定提供者，
 */
public class PhoneAuthenticationProvider implements AuthenticationProvider {

//这个其实我认为是多余的可以去掉，因为这个我们再使用过滤器进行谜底验证时就已经验证过电话号码的正确性
    private UserDetailsService userDetailsService;

    public void setUserDetailsService(UserDetailsService userDetailsService){
        this.userDetailsService = userDetailsService;
    }

    protected  UserDetailsService getUserDetailsService(){
        return userDetailsService;
    }

    // 具体认证流程
    @Override
    public Authentication authenticate(Authentication authentication) throws AuthenticationException {
        //获取存放的Token
        PhoneAuthenticationToken phoneAuthenticationToken = (PhoneAuthenticationToken) authentication;
        //phoneAuthenticationToken中的Principal，初始存储的电话号码
        UserDetails userDetails = userDetailsService.loadUserByUsername((String) phoneAuthenticationToken.getPrincipal());

        //判断使用当前号码是否能获取到用户信息，一般都不会出问题，以为我们在获取验证码时就验证了
        // 也就是PhoneCodeValidateFilter过滤器中验证码了
        if (userDetails == null){
            throw new InternalAuthenticationServiceException("无法根据手机号获取用户信息");
        }
        //我们在这创建一个Token这次他的Principal就变成了userDetails,
        PhoneAuthenticationToken authenticationToken = new PhoneAuthenticationToken(userDetails,userDetails.getAuthorities());
        //由于我们直接创建的details是没有值的，所以我们要将原来的details赋为我们的details
        authenticationToken.setDetails(phoneAuthenticationToken.getDetails());
        return authenticationToken;
    }

    /**
     *    supports函数用来指明该Provider是否适用于该类型的认证，如果不合适，则寻找另一个Provider进行验证处理。
     *    就好比，判断当前Provider是否适用于电话号码的认证，不适合，则寻找另一个Provider进行验证处理。
     */
    @Override
    public boolean supports(Class&lt;?&gt; authentication) {
        //判断当前Provider是否适用于authentication认证
        return PhoneAuthenticationToken.class.isAssignableFrom(authentication);
    }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>





<p>把这个都完成后，再把他们配置到Security配置类中，但是，这个如果配置的话会显得很多，所以我们可以先创建一个电话号码验证单独的配置类，然后再将它放入到核心Security配置类中，</p>
<h5 id="单独配置类"><a href="#单独配置类" class="headerlink" title="单独配置类"></a>单独配置类</h5><pre class="line-numbers language-none"><code class="language-none">/**
 * 由于要配置电话号码登录配置的话，需要配置很多，
 * 所以我们交配置整合好后在去Security配置类中配置
 */
@Component
public class PhoneSecurityConfig extends SecurityConfigurerAdapter&lt;DefaultSecurityFilterChain, HttpSecurity&gt; {

    @Autowired
    private MyAuthenticationFailureHandler myAuthenticationFailureHandler;

    @Autowired
    private MyAuthenticationSuccessHandler myAuthenticationSuccessHandler;

    @Autowired
    private MyUserDetailsService myUserDetailsService;

    //登录信息校验过滤器，也就是过滤登录信息是否正常
    @Autowired
    private PhoneCodeValidateFilter phoneCodeValidateFilter;

    @Override
    public void configure(HttpSecurity http) throws Exception {
        //创建一个电话号码登录过滤器，也就是如UsernamePasswordAuthenticationFilter一样的
        PhoneAuthenticationFilter phoneAuthenticationFilter = new PhoneAuthenticationFilter();

        phoneAuthenticationFilter.setAuthenticationManager(http.getSharedObject(AuthenticationManager.class));
        phoneAuthenticationFilter.setAuthenticationSuccessHandler(myAuthenticationSuccessHandler);//登录成功处理方式
        phoneAuthenticationFilter.setAuthenticationFailureHandler(myAuthenticationFailureHandler);//登录失败处理方式

        //创建一个我们自定义鉴定提供者，他会自己去匹配当前信息能使用鉴定提供者
        PhoneAuthenticationProvider phoneAuthenticationProvider = new PhoneAuthenticationProvider();
        //其实这个都可以不用，如果不要也就删除PhoneAuthenticationProvider中他对应的操作
        phoneAuthenticationProvider.setUserDetailsService(myUserDetailsService);

        http.addFilterBefore(phoneCodeValidateFilter, UsernamePasswordAuthenticationFilter.class);
        http.authenticationProvider(phoneAuthenticationProvider)
                .addFilterAfter(phoneAuthenticationFilter,UsernamePasswordAuthenticationFilter.class);
    }


}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h5 id="Securty配置类："><a href="#Securty配置类：" class="headerlink" title="Securty配置类："></a>Securty配置类：</h5><p>在配置类中加入.apply(phoneSecurityConfig)//添加我们的手机号码登录配置类</p>
<pre class="line-numbers language-none"><code class="language-none">@Configuration
public class SecurityConfig extends WebSecurityConfigurerAdapter {


    //将我们自定义的这两个类使用IOC容器装配
    @Autowired
    private MyAuthenticationSuccessHandler myAuthenticationSuccessHandler;  //登录成功处理

    @Autowired
    private MyAuthenticationFailureHandler myAuthenticationFailureHandler;  //登录失败处理

    //导入自定义动态授权

    @Autowired
    private MyUserDetailsService myUserDetailsService;


    @Autowired
    private DataSource dataSource;

    //退出登录自定义策略
    @Autowired
    private MyLogoutSuccessHandler myLogoutSuccessHandler;

    //验证码过滤器
    @Autowired
    private CaptchaCodeFilter captchaCodeFilter;

    @Autowired
    private PhoneSecurityConfig phoneSecurityConfig;

    /**
     * 登录认证方法
     * @param http
     * @throws Exception
     */
    @Override
    protected void configure(HttpSecurity http) throws Exception {

        //开启formLogin登录认证
        http
                //将验证码过滤器放置在UsernamePasswordAuthenticationFilter过滤器之前执行，AOP思想
                .addFilterBefore(captchaCodeFilter, UsernamePasswordAuthenticationFilter.class)
                .logout()//开启退出登录
//                .logoutSuccessUrl("/") //退出后跳转的页面  默认退出到login页面
                .deleteCookies("JSESSIONID") //指定退出后要删除的cookie
                .logoutUrl("/logout")  //退出请求路径，也就是页面上退出登录访问的地址  默认logout
                .logoutSuccessHandler(myLogoutSuccessHandler) //使用自定义退出策略 ，不能与logoutSuccessUrl共存，否则失效


                .and()

                .rememberMe()//开启记住我功能  ，前端也需要有记住我字段
                .rememberMeCookieName("rememberMe-Cookie")  //存在浏览器中cookie的名称
                .rememberMeParameter("remember-me")  //表单中 自动登录 勾选框的参数名
                .tokenValiditySeconds(2*24*60*60) //保存Cookie的有效期，默认2周
                .tokenRepository(tokenRepository())  //指定rememberMe存储到数据库规则方法

                .and()

                .csrf().disable()  //关闭防御csrf攻击
                .formLogin()//开启formLogin登录认证
                .loginPage("/logins")    //用于选择登录页面，没认证时跳转的页面
                .loginProcessingUrl("/login")   //选择需要认证的请求，也就是登录表单的提交地址
                .usernameParameter("user")   //选择登录请求的哪个参数是用户名
                .passwordParameter("password")   //选择登录请求的哪个参数是密码
                //使用自定义的登录失败成功处理方法
                .successHandler(myAuthenticationSuccessHandler)  //登录成功
                .failureHandler(myAuthenticationFailureHandler)  //登录失败

                //这两会与我们自定义的冲突想要使用自定义的就不能使用这个
//                .defaultSuccessUrl("/")   //登录成功跳转的路径
//                .failureForwardUrl("/logins")  //登录失败跳转的路径
             .and()
                .apply(phoneSecurityConfig)//添加我们的手机号码登录配置类
                .and()
                .authorizeRequests() //自定义过滤拦截请求
                .antMatchers("/logins","/login","/","/kaptcha","/smscode","/PhoneLogin") //资源路径
                .permitAll()  //当前资源路径不需要认证就可以访问


                //______________________________动态图鉴权_____________________________________________
                    //所有的请求都有经过MyRBACService的hasPermission方法进行鉴权 返回true可以访问，返回false不允许访问，
                    // 也就是验证用户能访问哪些页面
                .anyRequest().access("@MyRBACService.hasPermission(request,authentication)")


                .and()
                .sessionManagement()//启用session管理
                .maximumSessions(1)//允许一个账号你个人同时登录，也就是一个session可以几个人同时使用
                .maxSessionsPreventsLogin(false)//false：当登录时，其它登录的登录的地方会被踢下线;true ：当有用户在登录时不允许登录
                .expiredSessionStrategy(new CustomExpiredSessionStrategy());  //session超时，被踢下线的自定义操作



        //.authorizeHttpRequests()   这样方法表示选中的请求
    }


    /**
     * 授权方法
     * @param auth
     * @throws Exception
     */
    @Override
    protected void configure(AuthenticationManagerBuilder auth) throws Exception {

        //________________ 动态授权，需要实现UserDetailsService____________________________
            //这里才是验证登录信息的
            auth.userDetailsService(myUserDetailsService)
                  .passwordEncoder(passwordEncoder());  //配置BCrypt加密，这个会自动调用matches（）这个方法来为我们输入的密码进行对比
    }

    @Bean
    public PasswordEncoder passwordEncoder(){
        return new BCryptPasswordEncoder();
    }

    /**
     * 静态资源路径开放
     * @param web
     * @throws Exception
     */
    @Override
    public void configure(WebSecurity web) throws Exception {
        //将项目中的静态资源路径开放出来，在这开放是不需要经过过滤器拦截的
        web.ignoring().antMatchers("/css/**","/fonts/**","/img/**","/js/**");
    }

    /**
     * 向数据库操作关于记住我的验证信息
     * JdbcTokenRepositoryImpl 这个类中已经固定要存到数据库中的哪个表，我们只需要指定数据源即可
     * initDao() 这个方法有在数据库中创建需要的表，我还没尝试过，我的表是自己手动创建的
     * 设置记住我存储到的数据源是哪个
     * @return
     */
    @Bean
    public PersistentTokenRepository tokenRepository(){
        JdbcTokenRepositoryImpl jdbcTokenRepository = new JdbcTokenRepositoryImpl();
        jdbcTokenRepository.setDataSource(dataSource);
        return jdbcTokenRepository;
    }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>









<p><img src="https://s2.loli.net/2022/03/21/4zJVputoWcDh5P3.png" alt="image-20220317000050986"></p>
<h3 id="前端代码"><a href="#前端代码" class="headerlink" title="前端代码"></a>前端代码</h3><pre class="line-numbers language-none"><code class="language-none">&lt;body&gt;
&lt;script src="https://code.jquery.com/jquery-3.0.0.min.js"&gt;&lt;/script&gt;
&lt;h1&gt;登录&lt;/h1&gt;
&lt;form action="/login" method="post"&gt;
    账号：&lt;input type="text" id="username" name="user"&gt;&lt;br&gt;
    密码：&lt;input type="password" id="password" name="password"&gt;&lt;br&gt;
    验证码:&lt;input type="text" id="captchaCoed" name="captchaCoed"&gt;&lt;img src="/kaptcha" id="kaptcha" width="110px" height="40px"&gt;&lt;br&gt;
    &lt;input type="button" onclick="login()" value="登录"&gt;
     记住我&lt;input type="checkbox" name="remember-me" id="remember-me"&gt;
&lt;/form&gt;

&lt;h1&gt;手机验证码&lt;/h1&gt;
&lt;form action="/" method="post"&gt;
    手机号：&lt;input type="text" id="phone" name="phone"&gt;&lt;br&gt;
    验证码:&lt;input type="text" id="phoneCode" name="phoneCode"&gt;&lt;input type="button" id="submitPhone"  onclick="getPhone()" value="获取验证码"  &gt;&lt;br&gt;
    &lt;input type="button" onclick="PhoneLogin()" value="登录"&gt;
&lt;/form&gt;

&lt;script&gt;
    $(function () {
        //用于点击刷新验证码图片
        $("#kaptcha").click(function () {
            $("#kaptcha").attr("src","/kaptcha?"+Math.floor(Math.random()*100))
        })

    })
    function login() {
        let username=$("#username").val();
        let password=$("#password").val();
        let remember=$("#remember-me").prop("checked");
        let captchaCoed=$("#captchaCoed").val();
        $.ajax({
            type: "POST",
            url: "/login",
            data: {
                "user": username,
                "password": password,
                "remember-me":remember,
                "captchaCoed":captchaCoed
            },
            success: function (json) {
              if (json.state == 200){
                  console.log(json)
                  location.href="/";
              }else {
                  alert(json.message)
                  console.log(json)
                  location.href="/logins";
              }
            },
            error: function (e) {
                
            }

        })


    }
    function getPhone() {
        let phone = $("#phone").val();
        $.ajax({
            type: "GET",
            url: "/smscode",
            data: {
                "phone": phone,
            },
            success: function (json) {
                if (json.state == 200) {
                    console.log(json)
                    alert("验证码已发送")

                } else {
                    alert(json.message)
                    console.log(json)
                }
            },
            error: function (e) {

            }

        })
    }
    function PhoneLogin() {
        let phone = $("#phone").val();
        let phoneCode = $("#phoneCode").val();
        $.ajax({
            type: "POST",
            url: "/PhoneLogin",
            data: {
                "phone": phone,
                "phoneCode":phoneCode
            },
            success: function (json) {
                if (json.state == 200) {
                    console.log(json)
                    location.href="/";

                } else {
                    alert(json.message)
                    console.log(json)
                }
            },
            error: function (e) {

            }

        })
    }
&lt;/script&gt;
&lt;/body&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>





<h2 id="JWT"><a href="#JWT" class="headerlink" title="JWT"></a>JWT</h2><h3 id="jwt介绍："><a href="#jwt介绍：" class="headerlink" title="jwt介绍："></a>jwt介绍：</h3><p><img src="https://s2.loli.net/2022/03/21/kKPDMLRAVIpHrvX.png" alt="image-20220317231621407"></p>
<p><img src="https://s2.loli.net/2022/03/21/W1stHFYOvjKd6Uk.png" alt="image-20220317231629433"></p>
<p><img src="https://s2.loli.net/2022/03/21/P2Ik1z493SyCuFO.png" alt="image-20220317231635981"></p>
<p><img src="https://s2.loli.net/2022/03/21/X3od2kYmL4vnl7B.png" alt="image-20220317231642172"></p>
<h3 id="创建JWT工具类："><a href="#创建JWT工具类：" class="headerlink" title="创建JWT工具类："></a>创建JWT工具类：</h3><p>我需要先创建一jwt工具类，这样可以在我们需要给地方使用更方便</p>
<p>注意：获取用户名之类的方法都会去判断jwt令牌是否过期，过期后是获取不到用户名的</p>
<pre class="line-numbers language-none"><code class="language-none">/**
 * JWT的工具类
 * 三个属性需要在配置文件中定义
 */
@Data
@ConfigurationProperties(prefix = "jwt") //设置application中配置的开头节点
@Component
public class JwtTokenUtil {

//  这三个属性需要在application配置文件中定义
    //JWT的密钥
    @Value("${jwt.secret}")
    private String secret;
    //JWT的过期时间
    @Value("${jwt.expiration}")
    private Long expiration;
    //在http对象头中携带jwt的key的名称
    @Value("${jwt.header}")
    private String header;

    /**
     * 生成JWT token令牌
     *
     * @param userDetails 用户信息
     * @return JWT token令牌
     */
    public String generateToken(UserDetails userDetails){
        //存放用户不敏感信息，等要放入jwt令牌中
        Map&lt;String,Object&gt; claims = new HashMap&lt;&gt;(2);
        claims.put("sub",userDetails.getUsername()); //将用户名放入claims
        claims.put("created",new Date()); //将令牌创建时间放入claims

        return generateToken(claims);
    }

    /**
     * 从claims中获取用户不敏感信息生成令牌
     *
     * @param claims 用户不敏感信息
     * @return 令牌
     */
    public String generateToken(Map&lt;String,Object&gt; claims){
           Date expirationDate = new Date(System.currentTimeMillis() + expiration); //获取当前数据，加上过期是长，生成过期时间
        //返回生成的jwt令牌
        return Jwts.builder()//
                .setClaims(claims)  //加入用户名，与用户创建时间
                .setExpiration(System.currentTimeMillis()+expirationDate*1000)//令牌过期时间
                //进行jwt令牌的签约 参数1：设置使用声明方式签名（加密方式）,参数2：使用的密钥（等解签也需要这个密钥）
                .signWith(SignatureAlgorithm.HS512,secret)
                .compact();
    }


    /**
     * 从令牌中获取用户名
     * @param token 令牌
     * @return 该令牌用户名
     */
    public String getUsernameFromToken(String token){
        String username;
        try {
            //Claims jwt信息类（数据声明），获取jwt信息类
            Claims claims = getClaimsFromToken(token);
            username = claims.getSubject(); //在jwt信息类中获取用户名，这个方法是获取用户名的
        }catch (Exception e){
            username = null;
        }

        return username;
    }

    /**
     * 从令牌中获取jwt令牌信息
     * @param token 令牌
     * @return jwt令牌信息类（数据声明）
     */
    public Claims getClaimsFromToken(String token){
        //jwt令牌信息类
        Claims claims;
        try {
            //将jwt进行解析，获取jwt信息类
            claims = Jwts.parser()
                    .setSigningKey(secret)//解签的密钥
                    .parseClaimsJws(token)//解签的令牌
                    .getBody();
        }catch (Exception e){
            claims = null;
        }
        return claims;
    }


    /**
     * 判断令牌是否过期
     * @param token 令牌
     * @return 是否过期
     */
    public Boolean isTokenExpired(String token){
        try {
            Claims claims = getClaimsFromToken(token);
            //获取jwt令牌过期时间，过期使用使用这个方法获取
            Date expiration = claims.getExpiration();
            //判断当前时间是否在过期时间之前，也就是判断是否过期
            return expiration.before(new Date());
        }catch (Exception e){
            return false;
        }
    }

    /**
     * 刷新令牌（令牌过期就表示登录过期，为了保证用户体验，在用户使用中要刷新令牌）
     * @param token 原令牌
     * @return 新令牌
     */
    public String refreshToken(String token){
        String refreshToken;
        try {
            //获取jwt信息类
            Claims claims = getClaimsFromToken(token);
            //修改jwt中的新的创建时间
            claims.put("created",new Date());
            //生成一个新的令牌，更新它的过期时间
            refreshToken = generateToken(claims);
        }catch (Exception e){
            refreshToken = null;
        }
        return refreshToken;
    }

    /**
     * 验证令牌
     * @param token 令牌
     * @param userDetails 用户详细信息
     * @return 是否有效
     */
    public Boolean validateToken(String token,UserDetails userDetails){
        //获取用户名
        String username = getUsernameFromToken(token);
        //判断当前jwt令牌用户名是否与登录用户的用户名相同，并且jwt令牌是否过期
        return (username.equals(userDetails.getUsername()) &amp;&amp; !isTokenExpired(token));
    }

}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>yml配置：</p>
<pre class="line-numbers language-none"><code class="language-none">jwt:
  secret: ahjkvhajkhkss2ajdfaj #密钥，签名（加密），解签（解密）都需要该密钥
  expiration: 3600000  #过期时长 
  header: JWTHeaderName  #jwt在http头部信息中的key<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="JWT实现登录："><a href="#JWT实现登录：" class="headerlink" title="JWT实现登录："></a>JWT实现登录：</h3><p>我们需要配置Controller实现请求，与Service业务层</p>
<p>这些做完我们就可以获取基本的jwt令牌了</p>
<h4 id="Controller："><a href="#Controller：" class="headerlink" title="Controller："></a>Controller：</h4><p>两个请求，一个获取令牌：也就是登录我们需要创建一个jwt令牌返回给客户端，一个刷新：刷新我们的jwt令牌返回回去</p>
<pre class="line-numbers language-none"><code class="language-none">@RestController
public class JwtAuthController {

    @Autowired
    private JwtAuthService jwtAuthService;

    /**
     * 创建jwt令牌
     * 记得在SecurityConfig中开放访问权限
     * @param map
     * @return
     */
    @RequestMapping("/authentication")
    public JsonResult login(@RequestBody Map&lt;String,String&gt; map){

        //获取用户名和密码
        String username = map.get("username");
        String password = map.get("password");

        //判断用户名与密码是否为空
        if (username.isEmpty() || password.isEmpty()){
            return  new JsonResult().InputError("用户名或密码不能为空");
        }

        try {
            //返回获取到的jwt令牌
            return new JsonResult().success(jwtAuthService.login(username,password));
        }catch (UsernameNotFoundException e){
            //如果没有获取到jwt令牌，返回错误信息
            return new JsonResult().InputError(e.getMessage());
        }

    }

    /**
     * 刷新jwt令牌
     * @param token  获取http对象头中的jwt令牌，我们以及设置jwt令牌的key为jwt.header
     * @return
     */
    @RequestMapping("/refreshToken")
    public JsonResult refresh(@RequestHeader("${jwt.header}") String token){
        return new JsonResult().success(jwtAuthService.refreshToken(token));
    }

}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h4 id="Service："><a href="#Service：" class="headerlink" title="Service："></a>Service：</h4><p>业务操作，实际上还是业务层实现真实的操作，访问层只是做一些校验</p>
<p>注意：AuthenticationManager  这个bean在Security配置类中配置了，可以去看看，下面有完整的Security配置类</p>
<pre class="line-numbers language-none"><code class="language-none">@Service
public class JwtAuthService {

    //鉴定管理员 
    @Autowired
    private AuthenticationManager authenticationManager;

    @Autowired
    private MyUserDetailsService userDetailsService;

    @Autowired
    private JwtTokenUtil jwtTokenUtil;

    /**
     * 登录认证换取JWT令牌
     * @param username
     * @param password
     * @return
     */
    public String login(String username,String password){

        try{
            //创建一个用户名密码鉴定令牌
            UsernamePasswordAuthenticationToken authenticationToken = new 				UsernamePasswordAuthenticationToken(username,password);
            //进行认证，如果认证成功返回一个认证信息，如果没有成功就会抛出AuthenticationException异常
            //这个方法中会去数据库中查询认证信息，具体还得网查询
            Authentication authenticate = authenticationManager.authenticate(authenticationToken);
            //将认证信息给Security
            SecurityContextHolder.getContext().setAuthentication(authenticationToken);
        }catch (AuthenticationException e){
            throw new UsernameNotFoundException("用户名或密码不正确");
        }
        //进行用户查询
        UserDetails userDetails = userDetailsService.loadUserByUsername(username);
        //创建jwt令牌并返回
        return jwtTokenUtil.generateToken(userDetails);

    }


    /**
     * 刷新jwt令牌
     * @param oldToken 旧令牌
     * @return
     */
    public String refreshToken(String oldToken){
        //判断当前令牌是否过期
        if (!jwtTokenUtil.isTokenExpired(oldToken)){
            return jwtTokenUtil.refreshToken(oldToken);
        }
        return null;
    }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>注意，要把当前两个请求路径开放，并将session关闭</strong></p>
<h4 id="实现效果："><a href="#实现效果：" class="headerlink" title="实现效果："></a>实现效果：</h4><p>获取到的令牌是可以使用Base64解码的，但密钥是解码不了的</p>
<p><strong>获取令牌：</strong></p>
<p><img src="https://s2.loli.net/2022/03/21/kWeJDHTntcVMBfh.png" alt="image-20220320190553251"></p>
<p><strong>刷新令牌：</strong></p>
<p><img src="https://s2.loli.net/2022/03/21/etnRIfD1aZVPjTy.png" alt="image-20220320190242450"></p>
<p><strong>解码演示</strong>：</p>
<p>这个图就和介绍中jwt结构分析一样</p>
<p><img src="https://s2.loli.net/2022/03/21/lbj2MnBNmJ87Qoc.png" alt="image-20220320190758729"></p>
<h3 id="jwt用户授权"><a href="#jwt用户授权" class="headerlink" title="jwt用户授权"></a>jwt用户授权</h3><p>我们单纯的只有jwt令牌也没有用，我们需要为当前用户进行授权，那么我们就需要自己去创建一个过滤器放置在UsernamePasswordAuthenticationFilter之前进行授权</p>
<p>介绍下， UsernamePasswordAuthenticationToken authenticationToken<br>        = new UsernamePasswordAuthenticationToken(userDetails,null,userDetails.getAuthorities());</p>
<p>这是个特殊的令牌，这个令牌是Security是可以获取到用户认证信息的，而这个令牌里的认证信息是我们放入的，然后将认证信息交给</p>
<p>SecurityContextHolder.getContext().setAuthentication(authenticationToken); </p>
<p>这个方法是将我们有角色认证信息的令牌交给Security这样就完成了角色的认证，就可以判断用户拥有哪些权限了，但每次访问时都会去重写查询（下面代码里可以看到）所以我们可以使用缓存将它存起来，这样就可以提高效率</p>
<h4 id="jwt身份授权鉴权过滤器"><a href="#jwt身份授权鉴权过滤器" class="headerlink" title="jwt身份授权鉴权过滤器"></a><strong>jwt身份授权鉴权过滤器</strong></h4><pre class="line-numbers language-none"><code class="language-none">/**
 * 添加jwt过滤器，用于身份授权鉴权
 */
@Component
public class JwtAuthenticationTokenFilter extends OncePerRequestFilter {

    @Autowired
    private JwtTokenUtil jwtTokenUtil;

    @Autowired
    private MyUserDetailsService myUserDetailsService;

    @Override
    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) throws ServletException, IOException {

        //获取http头部信息中的jwtToken
        String jwtToken = request.getHeader(jwtTokenUtil.getHeader());
        //判断是否有jwtToken
        if (!StringUtils.isEmpty(jwtToken)){
            //获取jwt中的用户名,这里已经是判断jwt令牌的有效性，如果无效就获取不到username
            String username = jwtTokenUtil.getUsernameFromToken(jwtToken);

            //判断jwtToken中用户名不为空并且Security中还没有认证信息
            if (!username.isEmpty()
                    &amp;&amp; SecurityContextHolder.getContext().getAuthentication() == null){
                UserDetails userDetails = myUserDetailsService.loadUserByUsername(username);
                //验证令牌正确性，
                if (jwtTokenUtil.validateToken(jwtToken,userDetails)){
                    // 将jwt令牌转换为Security认识的令牌 参数1：用户信息 参数2：密码 参数3：用户的权限信息
                    UsernamePasswordAuthenticationToken authenticationToken
                            = new UsernamePasswordAuthenticationToken(userDetails,null,userDetails.getAuthorities());
                    //把认证权限信息交给Security，如当UsernamePasswordAuthenticationFilter拦截时，发现已经认证过了就不会再次认证
                    SecurityContextHolder.getContext().setAuthentication(authenticationToken);
                }

            }
        }

        filterChain.doFilter(request,response);

    }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>使用aop的思想将它放在UsernamePasswordAuthenticationFilter之前，所以我们需要去配置</p>
<h4 id="Security配置类-1"><a href="#Security配置类-1" class="headerlink" title="Security配置类"></a>Security配置类</h4><pre class="line-numbers language-none"><code class="language-none">@Configuration
public class SecurityConfig extends WebSecurityConfigurerAdapter {



    //导入自定义动态授权
    @Autowired
    private MyUserDetailsService myUserDetailsService;

    @Autowired
    private DataSource dataSource;

    //退出登录自定义策略
    @Autowired
    private MyLogoutSuccessHandler myLogoutSuccessHandler;

    @Autowired
    private JwtAuthenticationTokenFilter jwtAuthenticationTokenFilter;


    /**
     * 登录认证方法
     * @param http
     * @throws Exception
     */
    @Override
    protected void configure(HttpSecurity http) throws Exception {


        http    //将jwtAuthenticationTokenFilter放置在UsernamePasswordAuthenticationFilter之前
                .addFilterBefore(jwtAuthenticationTokenFilter, UsernamePasswordAuthenticationFilter.class)
                .logout()//开启退出登录
//                .logoutSuccessUrl("/") //退出后跳转的页面  默认退出到login页面
                .deleteCookies("JSESSIONID") //指定退出后要删除的cookie
                .logoutUrl("/logout")  //退出请求路径，也就是页面上退出登录访问的地址  默认logout
                .logoutSuccessHandler(myLogoutSuccessHandler) //使用自定义退出策略 ，不能与logoutSuccessUrl共存，否则失效

                .and()

                .rememberMe()//开启记住我功能  ，前端也需要有记住我字段
                .rememberMeCookieName("rememberMe-Cookie")  //存在浏览器中cookie的名称
                .rememberMeParameter("remember-me")  //表单中 自动登录 勾选框的参数名
                .tokenValiditySeconds(2*24*60*60) //保存Cookie的有效期，默认2周
                .tokenRepository(tokenRepository())  //令牌仓库默认是在内存中,我们指定rememberMe存储到数据库规则方法

                .and()

                .csrf().disable()  //关闭防御csrf攻击
                .authorizeRequests() //自定义过滤拦截请求
                .antMatchers("/login","/authentication","/refreshToken") //资源路径
                .permitAll()  //当前资源路径不需要认证就可以访问

                .anyRequest().access("@MyRBACService.hasPermission(request,authentication)")


                .and()
                .sessionManagement()//启用session管理
                .sessionCreationPolicy(SessionCreationPolicy.STATELESS);//不使用session，关闭session




        //.authorizeHttpRequests()   这样方法表示选中的请求
    }


    /**
     * 授权方法
     * @param auth
     * @throws Exception
     */
    @Override
    protected void configure(AuthenticationManagerBuilder auth) throws Exception {

            //这里才是验证登录信息的
            auth.userDetailsService(myUserDetailsService)
                  .passwordEncoder(passwordEncoder());  //配置BCrypt加密，这个会自动调用matches（）这个方法来为我们输入的密码进行对比
    }

    @Bean
    public PasswordEncoder passwordEncoder(){
        return new BCryptPasswordEncoder();
    }

    /**
     * 静态资源路径开放
     * @param web
     * @throws Exception
     */
    @Override
    public void configure(WebSecurity web) throws Exception {
        //将项目中的静态资源路径开放出来，在这开放是不需要经过过滤器拦截的
        web.ignoring().antMatchers("/css/**","/fonts/**","/img/**","/js/**");
    }

    /**
     * 向数据库操作关于记住我的验证信息
     * JdbcTokenRepositoryImpl 这个类中已经固定要存到数据库中的哪个表，我们只需要指定数据源即可
     * initDao() 这个方法有在数据库中创建需要的表，我还没尝试过，我的表是自己手动创建的
     * 设置记住我存储到的数据源是哪个
     * @return
     */
    @Bean
    public PersistentTokenRepository tokenRepository(){
        JdbcTokenRepositoryImpl jdbcTokenRepository = new JdbcTokenRepositoryImpl();
        jdbcTokenRepository.setDataSource(dataSource);
        return jdbcTokenRepository;
    }


    @Bean(name = BeanIds.AUTHENTICATION_MANAGER)
    @Override
    public AuthenticationManager authenticationManagerBean() throws Exception{
        return super.authenticationManagerBean();
    }

}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>由于我们要使用到别的页面查询是否成功授权鉴权，我们需要一个额外的请求资源</p>
<pre class="line-numbers language-none"><code class="language-none">@RestController
public class HelloController {

    @RequestMapping("/hello")
    public String hello(){

        return "world";
    }


}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>注意我们数据库中记得给当前角色这个资源路径的访问资格</p>
<p><strong>现在开始测试：</strong></p>
<p><strong>这是有权限清空访问</strong></p>
<p><img src="https://s2.loli.net/2022/03/21/vzRBIdb9X6WGD5m.png" alt="image-20220320193906937"></p>
<p><img src="https://s2.loli.net/2022/03/21/mjcJ6BY5k3OQ2Rn.png" alt="image-20220320193505218"></p>
<p><strong>无权限清空下访问：</strong></p>
<p><img src="https://s2.loli.net/2022/03/21/RBq4fEZdC6J9FIl.png" alt="image-20220320193746967"></p>
<p><img src="https://s2.loli.net/2022/03/21/uVZkJzhapcOG6rF.png" alt="image-20220320193640084"></p>
<h2 id="跨域访问："><a href="#跨域访问：" class="headerlink" title="跨域访问："></a>跨域访问：</h2><h3 id="介绍："><a href="#介绍：" class="headerlink" title="介绍："></a>介绍：</h3><p>为什么要跨域访问？跨域访问是什么？</p>
<p>跨域访问也就是A网站直接去访问B网站资源路径，这样的行为是不允许的</p>
<p><strong>如图：</strong></p>
<p><img src="https://s2.loli.net/2022/03/21/4arOfdijuIq8bQv.png" alt="image-20220321151443656"></p>
<h3 id="解决方法："><a href="#解决方法：" class="headerlink" title="解决方法："></a><strong>解决方法：</strong></h3><p><img src="https://s2.loli.net/2022/03/21/XlDL1EcG8rdZ5eb.png" alt="image-20220321152423979"></p>
<h4 id="其他解决方法："><a href="#其他解决方法：" class="headerlink" title="其他解决方法："></a>其他解决方法：</h4><p><img src="https://s2.loli.net/2022/03/21/KRpjq6LcIYf8ZGB.png" alt="image-20220321151622759"></p>
<p><img src="https://s2.loli.net/2022/03/21/aQwmgfGkiMPAVl7.png" alt="image-20220321151629992"></p>
<p><img src="https://s2.loli.net/2022/03/21/fWt3wZsPr1Tupka.png" alt="image-20220321151636299"></p>
<h4 id="SpringBoot解决方法："><a href="#SpringBoot解决方法：" class="headerlink" title="SpringBoot解决方法："></a>SpringBoot解决方法：</h4><p><img src="https://s2.loli.net/2022/03/21/Bnjf38uIDyarETp.png" alt="image-20220321151734457"></p>
<p><img src="https://s2.loli.net/2022/03/21/i6q8xQsg7tDBlIm.png" alt="image-20220321151753953"></p>
<p><img src="https://s2.loli.net/2022/03/21/hMqaYJnE4xoyX7Q.png" alt="image-20220321151800818"></p>
<p><img src="https://s2.loli.net/2022/03/21/GtvJUDmACzo1lrn.png" alt="image-20220321151806595"></p>
<h4 id="SpringBoot-Security解决方法："><a href="#SpringBoot-Security解决方法：" class="headerlink" title="SpringBoot-Security解决方法："></a>SpringBoot-Security解决方法：</h4><p>以上四种其实都可以使用在Security中解决，但是Security有它推荐的方法</p>
<p><strong>其实很简单：</strong></p>
<p>A网站中配置跨域访问权限：http .cors()//开启跨域访问</p>
<p>实现bean：</p>
<p>​    注意是这个包下的import org.springframework.web.cors.CorsConfigurationSource;</p>
<pre><code>/**
 * 配置跨域请求CORS源
 * @return
 */
@Bean
public CorsConfigurationSource corsConfigurationSource(){
    CorsConfiguration corsConfiguration = new CorsConfiguration();
    //允许哪些域访问
    corsConfiguration.setAllowedOrigins(Arrays.asList("http://loaclhost:8080"));
    //访问方式
    corsConfiguration.setAllowedMethods(Arrays.asList("GET","POST"));
    //设置默认参数
    corsConfiguration.applyPermitDefaultValues();

    UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
    //允许跨域访问哪些资源
    source.registerCorsConfiguration("/**",corsConfiguration);
    return source;
}
</code></pre>
<p><strong>配置实例：</strong></p>
<pre class="line-numbers language-none"><code class="language-none">    /**
     * 登录认证方法
     * @param http
     * @throws Exception
     */
    @Override
    protected void configure(HttpSecurity http) throws Exception {


        http .cors()//开启跨域访问
                .and()
                //将jwtAuthenticationTokenFilter放置在UsernamePasswordAuthenticationFilter之前
                .addFilterBefore(jwtAuthenticationTokenFilter, UsernamePasswordAuthenticationFilter.class)
                .logout()//开启退出登录
//                .logoutSuccessUrl("/") //退出后跳转的页面  默认退出到login页面
                .deleteCookies("JSESSIONID") //指定退出后要删除的cookie
                .logoutUrl("/logout")  //退出请求路径，也就是页面上退出登录访问的地址  默认logout
                .logoutSuccessHandler(myLogoutSuccessHandler) //使用自定义退出策略 ，不能与logoutSuccessUrl共存，否则失效

                .and()

                .rememberMe()//开启记住我功能  ，前端也需要有记住我字段
                .rememberMeCookieName("rememberMe-Cookie")  //存在浏览器中cookie的名称
                .rememberMeParameter("remember-me")  //表单中 自动登录 勾选框的参数名
                .tokenValiditySeconds(2*24*60*60) //保存Cookie的有效期，默认2周
                .tokenRepository(tokenRepository())  //令牌仓库默认是在内存中,我们指定rememberMe存储到数据库规则方法

                .and()

                .csrf().disable()  //关闭防御csrf攻击
                .authorizeRequests() //自定义过滤拦截请求
                .antMatchers("/login","/authentication","/refreshToken") //资源路径
                .permitAll()  //当前资源路径不需要认证就可以访问

                .anyRequest().access("@MyRBACService.hasPermission(request,authentication)")


                .and()
                .sessionManagement()//启用session管理
                .sessionCreationPolicy(SessionCreationPolicy.STATELESS);//不使用session，关闭session




        //.authorizeHttpRequests()   这样方法表示选中的请求
    }


    /**
     * 授权方法
     * @param auth
     * @throws Exception
     */
    @Override
    protected void configure(AuthenticationManagerBuilder auth) throws Exception {

            //这里才是验证登录信息的
            auth.userDetailsService(myUserDetailsService)
                  .passwordEncoder(passwordEncoder());  //配置BCrypt加密，这个会自动调用matches（）这个方法来为我们输入的密码进行对比
    }

    @Bean
    public PasswordEncoder passwordEncoder(){
        return new BCryptPasswordEncoder();
    }

    /**
     * 静态资源路径开放
     * @param web
     * @throws Exception
     */
    @Override
    public void configure(WebSecurity web) throws Exception {
        //将项目中的静态资源路径开放出来，在这开放是不需要经过过滤器拦截的
        web.ignoring().antMatchers("/css/**","/fonts/**","/img/**","/js/**");
    }

    /**
     * 向数据库操作关于记住我的验证信息
     * JdbcTokenRepositoryImpl 这个类中已经固定要存到数据库中的哪个表，我们只需要指定数据源即可
     * initDao() 这个方法有在数据库中创建需要的表，我还没尝试过，我的表是自己手动创建的
     * 设置记住我存储到的数据源是哪个
     * @return
     */
    @Bean
    public PersistentTokenRepository tokenRepository(){
        JdbcTokenRepositoryImpl jdbcTokenRepository = new JdbcTokenRepositoryImpl();
        jdbcTokenRepository.setDataSource(dataSource);
        return jdbcTokenRepository;
    }


    /**
     * 识别jwt令牌需要的
     * @return
     * @throws Exception
     */
    @Bean(name = BeanIds.AUTHENTICATION_MANAGER)
    @Override
    public AuthenticationManager authenticationManagerBean() throws Exception{
        return super.authenticationManagerBean();
    }

    /**
     * 配置跨域请求CORS源
     * @return
     */
    @Bean
    public CorsConfigurationSource corsConfigurationSource(){
        CorsConfiguration corsConfiguration = new CorsConfiguration();
        //允许哪些域访问  一定要注意最后以/结尾 不让B网站访问就没有用
        corsConfiguration.setAllowedOrigins(Arrays.asList("http://loaclhost:8080/"));
        //访问方式
        corsConfiguration.setAllowedMethods(Arrays.asList("GET","POST"));
        //设置默认参数
        corsConfiguration.applyPermitDefaultValues();

        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
        //允许跨域访问哪些资源
        source.registerCorsConfiguration("/**",corsConfiguration);
        return source;
    }

}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>





<h4 id="测试："><a href="#测试：" class="headerlink" title="测试："></a>测试：</h4><p>这里是使用的Security推荐解决方法</p>
<p><strong>B网站向A网站跨域访问前端代码：</strong></p>
<pre class="line-numbers language-none"><code class="language-none">$.ajax({
    type: "POST",
    url: "http://localhost:8081/hello",
    headers: {
        'JWTHeaderName':'eyJhbGciOiJIUzUxMiJ9.eyJleHAiOjE2NDc4NTMzNTEsInN1YiI6InVzZXIiLCJjcmVhdGVkIjoxNjQ3ODQ5NzUxODY3fQ.5EC4IhutkrR0er-TkLLHSLXaAZQ1gR48tTi3YOyjJzV-eE9Y0wziMoCRfUb0I4S9eeOr4mG3JloT7HQUTlwF_w'
    },
    success: function (json) {
        alert("跨域请求配置成功"+json);
    },
    error: function (e) {
        alert("跨域请求配置失败");
    }

})<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p><strong>A网站未配置B网站跨域访问权限下访问结果：</strong></p>
<p><img src="https://s2.loli.net/2022/03/21/TD8ZIjuQ7gvC94s.png" alt="image-20220321161337254"></p>
<p><strong>A网站配置B网站跨域访问权限下访问结果：</strong></p>
<p>​    配置了后就没有那个提示了</p>
<p><img src="https://s2.loli.net/2022/03/21/B15f4qExDU2nNFo.png" alt="image-20220321161205428"></p>
<h2 id="开启CSRF防御："><a href="#开启CSRF防御：" class="headerlink" title="开启CSRF防御："></a>开启CSRF防御：</h2><h3 id="介绍：-1"><a href="#介绍：-1" class="headerlink" title="介绍："></a>介绍：</h3><p>什么是CSRF防御，那我们先得了解下CSRF攻击</p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/114750961">什么是CSRF攻击？如何防御CRSF攻击？ - 知乎 (zhihu.com)</a></p>
<h3 id="在Security中配置："><a href="#在Security中配置：" class="headerlink" title="在Security中配置："></a><strong>在Security中配置：</strong></h3><p>配置后访问资源http请求头中需要携带CSRF令牌才能访问，（GET请求除外，GET请求不需要携带CSRF就可以访问）</p>
<p>没访问资源一次就会发生一次新的CSRF令牌，一个令牌只能使用一次</p>
<p><img src="https://s2.loli.net/2022/03/21/kZmP971nS8AXgTJ.png" alt="image-20220321174052920"></p>
<pre class="line-numbers language-none"><code class="language-none">http
        .csrf()//开启CSRF防御（GET请求是不会被防御的）
        //使用cookie存储CSRF令牌（每次防御页面都需要携带该令牌），里面的参数表示这个cookie是可以被js脚本获取到的，
        .csrfTokenRepository(CookieCsrfTokenRepository.withHttpOnlyFalse()) //
        .ignoringAntMatchers("/authentication") //排除哪些请求不需要携带CSRF令牌就可以进行访问<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>完整配置：</strong></p>
<pre class="line-numbers language-none"><code class="language-none">@Configuration
public class SecurityConfig extends WebSecurityConfigurerAdapter {



    //导入自定义动态授权
    @Autowired
    private MyUserDetailsService myUserDetailsService;

    @Autowired
    private DataSource dataSource;

    //退出登录自定义策略
    @Autowired
    private MyLogoutSuccessHandler myLogoutSuccessHandler;

    @Autowired
    private JwtAuthenticationTokenFilter jwtAuthenticationTokenFilter;


    /**
     * 登录认证方法
     * @param http
     * @throws Exception
     */
    @Override
    protected void configure(HttpSecurity http) throws Exception {


        http
                .csrf()//开启CSRF防御（GET请求是不会被防御的）
                //使用cookie存储CSRF令牌（每次防御页面都需要携带该令牌），里面的参数表示这个cookie是可以被js脚本获取到的，
                .csrfTokenRepository(CookieCsrfTokenRepository.withHttpOnlyFalse()) //
                .ignoringAntMatchers("/authentication") //排除哪些请求不需要携带CSRF令牌就可以进行访问

                .and()

                .cors()//开启跨域访问
                .and()
                //将jwtAuthenticationTokenFilter放置在UsernamePasswordAuthenticationFilter之前
                .addFilterBefore(jwtAuthenticationTokenFilter, UsernamePasswordAuthenticationFilter.class)
                .logout()//开启退出登录
//                .logoutSuccessUrl("/") //退出后跳转的页面  默认退出到login页面
                .deleteCookies("JSESSIONID") //指定退出后要删除的cookie
                .logoutUrl("/logout")  //退出请求路径，也就是页面上退出登录访问的地址  默认logout
                .logoutSuccessHandler(myLogoutSuccessHandler) //使用自定义退出策略 ，不能与logoutSuccessUrl共存，否则失效

                .and()

                .rememberMe()//开启记住我功能  ，前端也需要有记住我字段
                .rememberMeCookieName("rememberMe-Cookie")  //存在浏览器中cookie的名称
                .rememberMeParameter("remember-me")  //表单中 自动登录 勾选框的参数名
                .tokenValiditySeconds(2*24*60*60) //保存Cookie的有效期，默认2周
                .tokenRepository(tokenRepository())  //令牌仓库默认是在内存中,我们指定rememberMe存储到数据库规则方法


                .and()
                .authorizeRequests() //自定义过滤拦截请求
                .antMatchers("/login","/authentication","/refreshToken") //资源路径
                .permitAll()  //当前资源路径不需要认证就可以访问

                .anyRequest().access("@MyRBACService.hasPermission(request,authentication)")


                .and()
                .sessionManagement()//启用session管理
                .sessionCreationPolicy(SessionCreationPolicy.STATELESS);//不使用session，关闭session




        //.authorizeHttpRequests()   这样方法表示选中的请求
    }


    /**
     * 授权方法
     * @param auth
     * @throws Exception
     */
    @Override
    protected void configure(AuthenticationManagerBuilder auth) throws Exception {

            //这里才是验证登录信息的
            auth.userDetailsService(myUserDetailsService)
                  .passwordEncoder(passwordEncoder());  //配置BCrypt加密，这个会自动调用matches（）这个方法来为我们输入的密码进行对比
    }

    @Bean
    public PasswordEncoder passwordEncoder(){
        return new BCryptPasswordEncoder();
    }

    /**
     * 静态资源路径开放
     * @param web
     * @throws Exception
     */
    @Override
    public void configure(WebSecurity web) throws Exception {
        //将项目中的静态资源路径开放出来，在这开放是不需要经过过滤器拦截的
        web.ignoring().antMatchers("/css/**","/fonts/**","/img/**","/js/**");
    }

    /**
     * 向数据库操作关于记住我的验证信息
     * JdbcTokenRepositoryImpl 这个类中已经固定要存到数据库中的哪个表，我们只需要指定数据源即可
     * initDao() 这个方法有在数据库中创建需要的表，我还没尝试过，我的表是自己手动创建的
     * 设置记住我存储到的数据源是哪个
     * @return
     */
    @Bean
    public PersistentTokenRepository tokenRepository(){
        JdbcTokenRepositoryImpl jdbcTokenRepository = new JdbcTokenRepositoryImpl();
        jdbcTokenRepository.setDataSource(dataSource);
        return jdbcTokenRepository;
    }


    /**
     * 识别jwt令牌需要的
     * @return
     * @throws Exception
     */
    @Bean(name = BeanIds.AUTHENTICATION_MANAGER)
    @Override
    public AuthenticationManager authenticationManagerBean() throws Exception{
        return super.authenticationManagerBean();
    }

    /**
     * 配置跨域请求CORS源
     * @return
     */
    @Bean
    public CorsConfigurationSource corsConfigurationSource(){
        CorsConfiguration corsConfiguration = new CorsConfiguration();
        //允许哪些域访问
        corsConfiguration.setAllowedOrigins(Arrays.asList("http://localhost:8080"));
        //访问方式
        corsConfiguration.setAllowedMethods(Arrays.asList("GET","POST"));
        //设置默认参数
        corsConfiguration.applyPermitDefaultValues();


        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
        //允许跨域访问哪些资源
        source.registerCorsConfiguration("/**",corsConfiguration);
        return source;
    }



}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://s2.loli.net/2022/03/21/2QsiSmgb1pR6c8k.png" alt="image-20220321172831555"></p>
<h3 id="使用测试"><a href="#使用测试" class="headerlink" title="使用测试"></a>使用测试</h3><p><strong>先使用我们登录的请求获取jwt令牌与CSRF令牌</strong></p>
<p><img src="https://s2.loli.net/2022/03/21/zJYNqRbAeBVXd7G.png" alt="image-20220321171847532"></p>
<p><strong>进行访问/hello：</strong></p>
<p>不携带CSRF令牌进行访问：</p>
<p><img src="https://s2.loli.net/2022/03/21/FqsVLNpkCJTfZd7.png" alt="image-20220321171956312"></p>
<p>携带CSRF令牌进行访问：</p>
<p><img src="https://s2.loli.net/2022/03/21/AFh2SfxW9YQv3gH.png" alt="image-20220321172017322"></p>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">Study Hard</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://studyhardya.github.io/2022/03/03/SpringBootSecurity/">https://studyhardya.github.io/2022/03/03/SpringBootSecurity/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">Study Hard</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/%E5%AE%89%E5%85%A8%E6%A1%86%E6%9E%B6/">
                                    <span class="chip bg-color">安全框架</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="qq,qzone,wechat,weibo" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    
        <style>
    .valine-card {
        margin: 1.5rem auto;
    }

    .valine-card .card-content {
        padding: 20px 20px 5px 20px;
    }

    #vcomments textarea {
        box-sizing: border-box;
        background: url("/medias/comment_bg.png") 100% 100% no-repeat;
    }

    #vcomments p {
        margin: 2px 2px 10px;
        font-size: 1.05rem;
        line-height: 1.78rem;
    }

    #vcomments blockquote p {
        text-indent: 0.2rem;
    }

    #vcomments a {
        padding: 0 2px;
        color: #4cbf30;
        font-weight: 500;
        text-decoration: none;
    }

    #vcomments img {
        max-width: 100%;
        height: auto;
        cursor: pointer;
    }

    #vcomments ol li {
        list-style-type: decimal;
    }

    #vcomments ol,
    ul {
        display: block;
        padding-left: 2em;
        word-spacing: 0.05rem;
    }

    #vcomments ul li,
    ol li {
        display: list-item;
        line-height: 1.8rem;
        font-size: 1rem;
    }

    #vcomments ul li {
        list-style-type: disc;
    }

    #vcomments ul ul li {
        list-style-type: circle;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    #vcomments table, th, td {
        border: 0;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments h1 {
        font-size: 1.85rem;
        font-weight: bold;
        line-height: 2.2rem;
    }

    #vcomments h2 {
        font-size: 1.65rem;
        font-weight: bold;
        line-height: 1.9rem;
    }

    #vcomments h3 {
        font-size: 1.45rem;
        font-weight: bold;
        line-height: 1.7rem;
    }

    #vcomments h4 {
        font-size: 1.25rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    #vcomments h5 {
        font-size: 1.1rem;
        font-weight: bold;
        line-height: 1.4rem;
    }

    #vcomments h6 {
        font-size: 1rem;
        line-height: 1.3rem;
    }

    #vcomments p {
        font-size: 1rem;
        line-height: 1.5rem;
    }

    #vcomments hr {
        margin: 12px 0;
        border: 0;
        border-top: 1px solid #ccc;
    }

    #vcomments blockquote {
        margin: 15px 0;
        border-left: 5px solid #42b983;
        padding: 1rem 0.8rem 0.3rem 0.8rem;
        color: #666;
        background-color: rgba(66, 185, 131, .1);
    }

    #vcomments pre {
        font-family: monospace, monospace;
        padding: 1.2em;
        margin: .5em 0;
        background: #272822;
        overflow: auto;
        border-radius: 0.3em;
        tab-size: 4;
    }

    #vcomments code {
        font-family: monospace, monospace;
        padding: 1px 3px;
        font-size: 0.92rem;
        color: #e96900;
        background-color: #f8f8f8;
        border-radius: 2px;
    }

    #vcomments pre code {
        font-family: monospace, monospace;
        padding: 0;
        color: #e8eaf6;
        background-color: #272822;
    }

    #vcomments pre[class*="language-"] {
        padding: 1.2em;
        margin: .5em 0;
    }

    #vcomments code[class*="language-"],
    pre[class*="language-"] {
        color: #e8eaf6;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }

    #vcomments b,
    strong {
        font-weight: bold;
    }

    #vcomments dfn {
        font-style: italic;
    }

    #vcomments small {
        font-size: 85%;
    }

    #vcomments cite {
        font-style: normal;
    }

    #vcomments mark {
        background-color: #fcf8e3;
        padding: .2em;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }
</style>
<!-- 默认的 -->
<div class="card valine-card" data-aos="fade-up">
    <div class="comment_headling" style="font-size: 20px; font-weight: 700; position: relative; padding-left: 20px; top: 15px; padding-bottom: 5px;">
        <i class="fas fa-comments fa-fw" aria-hidden="true"></i>
        <span>评论</span>
    </div>
    <div id="vcomments" class="card-content" style="display: grid">
    </div>
</div>

<!-- 修改的 -->
<!-- <div class="card valine-card" data-aos="fade-up">
    <div id="vcomments" class="card-content"></div>
</div> -->

<script src="/libs/valine/av-min.js"></script>
<script src="/libs/valine/Valine.min.js"></script>
<script>
    new Valine({
        el: '#vcomments',
        appId: 'DG3oz2msbm23K7Jc3TzqbIz0-gzGzoHsz',
        appKey: 'lr9NGqTTn4bG8DCFVxxhMhlr',
        notify: 'true' === 'true',
        verify: 'true' === 'true',
        visitor: 'true' === 'true',
        avatar: 'monsterid',
        pageSize: '10',
        lang: 'zh-cn',
        placeholder: '没有理由,开团！！！'
    });
</script>




<style>


/* 卡片式背景 */
#vcomments .vcards .vcard {
    padding: 15px 20px 0 20px;
    border-radius: 10px;
    margin-bottom: 15px;
    box-shadow: 0 0 4px 1px rgba(0, 0, 0, .12);
    transition: all .3s
}
#vcomments .vcards .vcard:hover {
    box-shadow: 0 0 8px 3px rgba(0, 0, 0, .12)
}
#vcomments .vcards .vcard .vh .vcard {
    border: none;
    box-shadow: none;
}


    
/*鼠标放置头像旋转*/
img.vimg {
    /* 旋转时间为 1s */
    transition: all 1s
}
img.vimg:hover {
    transform: rotate(360deg);
    -webkit-transform: rotate(360deg);
    -moz-transform: rotate(360deg);
    -o-transform: rotate(360deg);
    -ms-transform: rotate(360deg);
}


/*===========背景图输入判断=========*/
#veditor:focus {
    background-position-y: 200px;
    transition: all 0.2s ease-in-out 0s;
}


/*==========修改评论框样式===========start====*/
.v .vwrap {
    padding: 0 0 20px;
}
/*内容框高度*/
.v .veditor {
    min-height: 7rem;
    resize: none;
}
/*==========修改评论框样式===========end======*/



/*头部空白栏高度*/
.valine-card .card-content {
    padding: 20px 20px 5px 20px;
}

/* valine 评论框增加背景图片 */
#vcomments textarea {
    /*背景图贴边*/
    margin-top: -30px;
    box-sizing: border-box;
    background: url("/medias/comment_bg.png") 100% 100% no-repeat;
}



</style>

<script>

    
    // 自定义邮箱审核规则
// document.body.addEventListener('click', function (e) {
//     if (e.target.classList.contains('vsubmit')) {
//         const email = document.querySelector('input[type=email]');
//         const nick = document.querySelector('input[name=nick]');
//         const reg = /^[A-Za-z0-9\u4e00-\u9fa5]+@[a-zA-Z0-9_-]+(\.[a-zA-Z0-9_-]+)+$/;
//         if (!email.value || !nick.value || !reg.test(email.value)) {
//             const str = `<div class="valert text-center"><div class="vtext">请填写正确的昵称和邮箱！</div></div>`;
//             const vmark = document.querySelector('.vmark');
//             vmark.innerHTML = str;
//             vmark.style.display = 'block';
//             setTimeout(function () {
//                 vmark.style.display = 'none';
//                 vmark.innerHTML = '';
//             }, 2500);
//         }
//     }
// })


</script>

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2022/03/25/RabiitMQ/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/19.jpg" class="responsive-img" alt="RabiitMQ">
                        
                        <span class="card-title">RabiitMQ</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2022-03-25
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/" class="post-category">
                                    消息队列
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/java/">
                        <span class="chip bg-color">java</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2022/02/25/Docker%E7%9A%84%E4%BD%BF%E7%94%A8/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/3.jpg" class="responsive-img" alt="Docker的使用">
                        
                        <span class="card-title">Docker的使用</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2022-02-25
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Docker/" class="post-category">
                                    Docker
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E4%BD%BF%E7%94%A8/">
                        <span class="chip bg-color">使用</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    

    <div class="container row center-align"
         style="margin-bottom: 15px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2022</span>
            
            
                &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                        class="white-color">90.1k</span>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
                <span id="sitetime"> Loading ...</span>
                <script>
                    var calcSiteTime = function () {
                        var seconds = 1000;
                        var minutes = seconds * 60;
                        var hours = minutes * 60;
                        var days = hours * 24;
                        var years = days * 365;
                        var today = new Date();
                        var startYear = "2022";
                        var startMonth = "1";
                        var startDate = "1";
                        var startHour = "0";
                        var startMinute = "0";
                        var startSecond = "0";
                        var todayYear = today.getFullYear();
                        var todayMonth = today.getMonth() + 1;
                        var todayDate = today.getDate();
                        var todayHour = today.getHours();
                        var todayMinute = today.getMinutes();
                        var todaySecond = today.getSeconds();
                        var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                        var diff = t2 - t1;
                        var diffYears = Math.floor(diff / years);
                        var diffDays = Math.floor((diff / days) - diffYears * 365);

                        // 区分是否有年份.
                        var language = 'zh-CN';
                        if (startYear === String(todayYear)) {
                            document.getElementById("year").innerHTML = todayYear;
                            var daysTip = 'This site has been running for ' + diffDays + ' days';
                            if (language === 'zh-CN') {
                                daysTip = '本站已运行 ' + diffDays + ' 天';
                            } else if (language === 'zh-HK') {
                                daysTip = '本站已運行 ' + diffDays + ' 天';
                            }
                            document.getElementById("sitetime").innerHTML = daysTip;
                        } else {
                            document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                            var yearsAndDaysTip = 'This site has been running for ' + diffYears + ' years and '
                                + diffDays + ' days';
                            if (language === 'zh-CN') {
                                yearsAndDaysTip = '本站已运行 ' + diffYears + ' 年 ' + diffDays + ' 天';
                            } else if (language === 'zh-HK') {
                                yearsAndDaysTip = '本站已運行 ' + diffYears + ' 年 ' + diffDays + ' 天';
                            }
                            document.getElementById("sitetime").innerHTML = yearsAndDaysTip;
                        }
                    }

                    calcSiteTime();
                </script>
            
            <br>
            
                <span id="icp"><img src="/medias/icp.png"
                                    style="vertical-align: text-bottom;"/>
                <a href="/null" target="_blank">赣ICP备2022000911号</a>
            </span>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/StudyHardYa" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:3502155084@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=3502155084" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 3502155084" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    

    
        
        <script type="text/javascript">
            // 只在桌面版网页启用特效
            var windowWidth = $(window).width();
            if (windowWidth > 768) {
                document.write('<script type="text/javascript" src="/libs/others/sakura.js"><\/script>');
            }
        </script>
    

    <!-- 雪花特效 -->
    

    <!-- 鼠标星星特效 -->
    

     
        <script src="https://ssl.captcha.qq.com/TCaptcha.js"></script>
        <script src="/libs/others/TencentCaptcha.js"></script>
        <button id="TencentCaptcha" data-appid="" data-cbfn="callback" type="button" hidden></button>
    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    
    <script>
        (function (i, s, o, g, r, a, m) {
            i["DaoVoiceObject"] = r;
            i[r] = i[r] || function () {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date();
            a = s.createElement(o), m = s.getElementsByTagName(o)[0];
            a.async = 1;
            a.src = g;
            a.charset = "utf-8";
            m.parentNode.insertBefore(a, m)
        })(window, document, "script", ('https:' == document.location.protocol ? 'https:' : 'http:') +
            "//widget.daovoice.io/widget/6984b559.js", "daovoice")
        daovoice('init', {
            app_id: "af371656"
        });
        daovoice('update');
    </script>
    

    <!--腾讯兔小巢-->
    
    

    

    
    <script type="text/javascript" src="/libs/background/ribbon-dynamic.js" async="async"></script>
    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    
    <!-- 切换页面提示 -->
    <script src="/js/FunnyTitle.js"></script>

    <!-- 烟花爆炸效果 -->
    <canvas class="fireworks" style="position: fixed;left: 0;top: 0;z-index: 1; pointer-events: none;" ></canvas> 
    <script type="text/javascript" src="//cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script> 
    <script type="text/javascript" src="/js/fireworks.js"></script>

</body>

</html>
